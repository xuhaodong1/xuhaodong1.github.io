<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>iOSä¸­çš„å†…å­˜ç®¡ç†ï½œweak</title>
      <link href="/2023/08/06/iOS%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BD%9Cweak/"/>
      <url>/2023/08/06/iOS%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BD%9Cweak/</url>
      
        <content type="html"><![CDATA[<h2 id="å¾ªç¯å¼•ç”¨åŸå› "><a href="#å¾ªç¯å¼•ç”¨åŸå› " class="headerlink" title="å¾ªç¯å¼•ç”¨åŸå› "></a>å¾ªç¯å¼•ç”¨åŸå› </h2><p>åœ¨å¯¹è±¡å›¾ä¸­ç»å¸¸ä¼šå‡ºç°ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯å‡ ä¸ªå¯¹è±¡éƒ½ä»¥æŸç§æ–¹å¼ç›¸äº’å¼•ç”¨ï¼Œä»è€Œå½¢æˆâ€œç¯â€ï¼ˆcycleï¼‰ï¼ŒåŒæ—¶ç”±äº iOS ä¸­é‡‡ç”¨å¼•ç”¨è®¡æ•°å†…å­˜ç®¡ç†æ¨¡å‹ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µé€šå¸¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå› ä¸ºæœ€åæ²¡æœ‰åˆ«çš„ä¸œè¥¿ä¼šå¼•ç”¨ç¯ä¸­çš„å¯¹è±¡ã€‚è¿™æ ·çš„è¯ï¼Œç¯é‡Œçš„å¯¹è±¡å°±æ— æ³•ä¸ºå¤–ç•Œæ‰€è®¿é—®ï¼Œä½†å¯¹è±¡ä¹‹é—´å°šæœ‰å¼•ç”¨ï¼Œè¿™äº›å¼•ç”¨ä½¿å¾—ä»–ä»¬éƒ½èƒ½ç»§ç»­å­˜æ´»ä¸‹å»ï¼Œè€Œä¸ä¼šä¸ºç³»ç»Ÿå›æ”¶ã€‚ä¾‹å¦‚ï¼š</p><span id="more"></span><pre><code class="swift">class Teacher {    var student: Student?}class Student {    var teacher: Teacher?}let teacher = Teacher()let student = Student()teacher.student = studentstudent.teacher = teacher</code></pre><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ<code>teacher</code> ä¸ <code>student</code> ç›¸äº’æŒæœ‰ï¼Œå½¢æˆä¿ç•™ç¯ï¼Œå¦‚æœ <code>teacher</code> å’Œ <code>student</code> å¯¹è±¡æ— æ³•è¢«å¤–ç•Œè®¿é—®åˆ°ï¼Œæ•´ä¸ªä¿ç•™ç¯å°±æ³„æ¼äº†ã€‚ä½†å¦‚æœè¿˜èƒ½è¢«å¤–ç•Œæ‰€è®¿é—®ï¼Œå¤–ç•Œè¿˜èƒ½æ‰‹åŠ¨ç ´é™¤â€œç¯â€ä»¥é¿å…å¾ªç¯å¼•ç”¨ï¼Œæ¯”å¦‚ <code>student.teacher = nil</code>ã€‚</p><p>åœ¨åƒåœ¾å›æ”¶æœºåˆ¶ä¸­ï¼Œè‹¥é‡‡ç”¨ Root Tracing ç®—æ³•ï¼Œå°±èƒ½æ£€æµ‹åˆ°è¿™äº›ä¿ç•™ç¯ï¼Œä»è€Œå›æ”¶æ‰è¿™äº›å¯¹è±¡ã€‚å®ƒé€šè¿‡ä¸€ç³»åˆ—åä¸º â€œGCRootsâ€ çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™ä¸ªèŠ‚ç‚¹å‘ä¸‹æœç´¢ï¼Œæœç´¢èµ°è¿‡çš„è·¯å¾„ç§°ä¸º <code>ReferenceChain</code>ï¼Œå½“ä¸€ä¸ªå¯¹è±¡ä¸ <code>GCRoots</code> æ²¡æœ‰ä»»ä½• <code>ReferenceChain</code> ç›¸è¿æ—¶ï¼Œå°±è¯æ˜è¿™ä¸ªå¯¹è±¡ä¸å¯ç”¨ï¼Œå¯ä»¥è¢«å›æ”¶ã€‚</p><p>åœ¨ iOS ä¸­ï¼Œæä¾›äº† <code>weak</code> æ¥å¸®åŠ©æˆ‘ä»¬è§£å†³å¾ªç¯å¼•ç”¨è¿™ç§å†…å­˜ç®¡ç†é—®é¢˜ï¼Œä½¿ç”¨ <code>weak</code> ä¿®é¥°çš„å¯¹è±¡ä¸ä¼šæŒæœ‰å¯¹è±¡ï¼Œå› æ­¤ä¸ä¼šä½¿å¯¹è±¡çš„å¼•ç”¨è®¡æ•°åŠ  1ï¼ŒåŒæ—¶å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡è¢«åºŸå¼ƒæ—¶ï¼Œå¼±å¼•ç”¨æŒ‡é’ˆä¼šæŒ‡å‘ <code>nil</code>ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œä¾‹å¦‚å°† <code>Student</code> ç±»ä¸­çš„ <code>teacher</code> åŠ ä¸Š <code>weak</code> æ‰€æœ‰æƒä¿®é¥°ç¬¦ï¼Œå°±å¯ä»¥é¿å…å¼ºå¼•ç”¨â€œç¯â€çš„å‡ºç°ã€‚</p><h2 id="å®ç°-weak-çš„æºç "><a href="#å®ç°-weak-çš„æºç " class="headerlink" title="å®ç° weak çš„æºç "></a>å®ç° weak çš„æºç </h2><p>åœ¨ç±»ä¼¼è¿™æ ·ä½¿ç”¨ <code>__weak id weakObj = object;</code> å¼±å¼•ç”¨æ‰€æœ‰æƒä¿®é¥°ç¬¦æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶è½¬æ¢æˆç±»ä¼¼ <code>objc_initWeak(&amp;weakObj, 0);</code>è¿™æ ·çš„ä»£ç ã€‚åŒæ ·çš„ï¼Œè¿˜æœ‰é”€æ¯ <code>weak</code> æŒ‡é’ˆï¼Œ<code>objc_destroyWeak</code>ã€‚</p><p>ä»¥ä¸‹å‚è€ƒçš„æºç ä¸º objc4-838ã€‚</p><h3 id="SideTable-çš„æ•°æ®ç»“æ„"><a href="#SideTable-çš„æ•°æ®ç»“æ„" class="headerlink" title="SideTable çš„æ•°æ®ç»“æ„"></a>SideTable çš„æ•°æ®ç»“æ„</h3><p><code>SideTable</code> ä¸­å­˜å‚¨äº†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä»¥åŠæ‰€å…³è”çš„å¼±å¼•ç”¨æŒ‡é’ˆï¼Œå®ƒæ˜¯ <code>SideTables()</code> è¿™æ ·ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨çš„ <code>value</code>ï¼Œå…¶æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/images/blog/image-20230731154644415-0789607.png" alt="image-20230731154644415"></p><p>å…³äº <code>SideTables()</code>ï¼Œå®ƒæ˜¯ <code>SideTablesMap</code> çš„å°è£…å‡½æ•°ï¼Œå…¶å®é™…ç±»å‹ä¸º <code>StripedMap&lt;SideTable&gt;</code>ï¼Œå®ƒæ˜¯é€šè¿‡ <code>SideTablesMap.get()</code> è·å–ï¼Œè€Œå®é™…çš„ <code>SideTablesMap</code> åˆ™åˆè¢« <code>ExplicitInit</code> æ‰€å°è£…ï¼›ä¸ºä»€ä¹ˆéœ€è¦ <code>ExplicitInit</code> å‘¢ï¼Ÿåœ¨å®˜æ–¹æ³¨é‡Šå¯ä»¥å‘ç°ç­”æ¡ˆï¼šç”±äº C++ çš„é™æ€åˆå§‹åŒ–å™¨åœ¨ Runtime åˆå§‹åŒ–ä¹‹åï¼Œè€Œåœ¨ Runtime åˆå§‹åŒ–æ—¶éœ€è¦ç”¨åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œå› æ­¤éœ€è¦æ˜¾å¼åˆå§‹åŒ–ã€‚<code>StripedMap</code> æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œé€šè¿‡å¯¹è±¡çš„åœ°å€åç§»ä¸ <code>StripeCount</code> å¤§å°æ˜ å°„åˆ°å±äºå¯¹è±¡çš„ <code>SideTable</code> çš„ä¸‹æ ‡ï¼Œè¿™æ ·å¯ä»¥å°†å¯¹è±¡æ”¾åœ¨ä¸åŒçš„ <code>SideTable</code> å­˜å‚¨ï¼Œé¿å…åŒæ—¶è®¿é—®æå‡è®¿é—®æ•ˆç‡ã€‚</p><pre><code class="c++">static objc::ExplicitInit&lt;StripedMap&lt;SideTable&gt;&gt; SideTablesMap;static StripedMap&lt;SideTable&gt;&amp; SideTables() {    return SideTablesMap.get();}static unsigned int indexForPointer(const void *p) {    uintptr_t addr = reinterpret_cast&lt;uintptr_t&gt;(p);    return ((addr &gt;&gt; 4) ^ (addr &gt;&gt; 9)) % StripeCount;}</code></pre><p><code>SideTable</code> ä¸­å­˜å‚¨äº†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å’Œå¼±å¼•ç”¨æŒ‡é’ˆï¼Œåˆ†åˆ«æ˜¯ <code>refcnts</code> å’Œ <code>weak_table</code>ï¼Œ<code>weak_table</code> æœ¬èº«æ˜¯ä¸€ä¸ªç®€æ˜“çš„å“ˆå¸Œè¡¨ï¼Œå®ƒçš„ <code>weak_entries</code> æ˜¯å­˜å‚¨å…·ä½“å¯¹è±¡å¼±å¼•ç”¨æŒ‡é’ˆçš„æ•°ç»„ï¼Œ<code>size_entries</code> è¡¨æ˜æ•°ç»„çš„å¤§å°ï¼Œ<code>mask</code> ç”¨äºå“ˆå¸Œæ˜ å°„ï¼Œ<code>max_hash_displacement</code> åˆ™è¡¨ç¤ºæ•°ç»„ä¸­å¯¹è±¡çš„æœ€å¤§å“ˆå¸Œå†²çªæ¬¡æ•°ï¼Œé‡‡ç”¨çº¿æ€§æ¢æµ‹æ³•è§£å†³å“ˆå¸Œå†²çªã€‚å…¶å…·ä½“ <code>key-value</code> æ˜ å°„é€»è¾‘å¦‚ä¸‹ï¼š</p><pre><code class="c++">static weak_entry_t *weak_entry_for_referent(weak_table_t *weak_table, objc_object *referent){    weak_entry_t *weak_entries = weak_table-&gt;weak_entries;    if (!weak_entries) return nil;    size_t begin = hash_pointer(referent) &amp; weak_table-&gt;mask;    size_t index = begin;    size_t hash_displacement = 0;    while (weak_table-&gt;weak_entries[index].referent != referent) {        index = (index+1) &amp; weak_table-&gt;mask;        if (index == begin) bad_weak_table(weak_table-&gt;weak_entries);        hash_displacement++;        if (hash_displacement &gt; weak_table-&gt;max_hash_displacement) {            return nil;        }    }        return &amp;weak_table-&gt;weak_entries[index];}</code></pre><p>åœ¨å…·ä½“çš„ <code>entry</code> ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼å­˜å‚¨å¼±å¼•ç”¨æŒ‡é’ˆï¼Œå¼±å¼•ç”¨æŒ‡é’ˆæ€»ä¸ªæ•° &lt;= 4 é‡‡ç”¨æ•°ç»„ï¼Œå¤§äº 4 é‡‡ç”¨å“ˆå¸Œè¡¨ã€‚åœ¨é‡‡ç”¨å“ˆå¸Œè¡¨çš„å®ç°ä¸­ï¼Œ<code>out_of_line_ness</code> è¡¨ç¤ºæ˜¯å¦è¶…å‡ºä½¿ç”¨æ•°ç»„çš„å¤§å°èŒƒå›´ï¼ˆ4ï¼‰ï¼Œ<code>num_refs</code> è¡¨ç¤ºå¼±å¼•ç”¨æŒ‡é’ˆä¸ªæ•°ï¼Œ<code>mask</code> ç”¨äºå“ˆå¸Œæ˜ å°„ï¼Œ<code>max_hash_displacement</code> è¡¨ç¤ºæ•°ç»„ä¸­å¯¹è±¡æœ€å¤§å“ˆå¸Œå†²çªçš„ä¸ªæ•°ã€‚å› æ­¤å…¶ <code>key-value</code> çš„æ˜ å°„é€»è¾‘ä¹Ÿä¸ <code>weak_table</code> çš„ç±»ä¼¼ï¼š</p><pre><code class="c++">size_t begin = w_hash_pointer(old_referrer) &amp; (entry-&gt;mask);size_t index = begin;size_t hash_displacement = 0;while (entry-&gt;referrers[index] != old_referrer) {    index = (index+1) &amp; entry-&gt;mask;    if (index == begin) bad_weak_table(entry);    hash_displacement++;    if (hash_displacement &gt; entry-&gt;max_hash_displacement) {        objc_weak_error();        return;    }}</code></pre><h3 id="storeWeak"><a href="#storeWeak" class="headerlink" title="storeWeak"></a>storeWeak</h3><p><code>objc_initWeak</code> ä¸ <code>objc_destroyWeak</code> ç±»ä¼¼ï¼Œæœ€ç»ˆéƒ½æŒ‡å‘ <code>storeWeak</code> æ–¹æ³•ï¼Œåªæ˜¯ä¼ é€’å‚æ•°ä¸åŒã€‚</p><p><code>objc_initWeak</code> è°ƒç”¨ä¸º <code>storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt; (location, (objc_object*)newObj)</code>ï¼›</p><p><code>objc_destroyWeak</code> è°ƒç”¨ä¸º <code>storeWeak&lt;DoHaveOld, DontHaveNew, DontCrashIfDeallocating&gt; (location, nil)</code>ï¼›</p><p><code>HaveOld</code> ä¸ <code>HaveNew</code> æ€»æ˜¯ç›¸åçš„ï¼Œä¸¤è€…ä¸ä¼šåŒæ—¶éƒ½æœ‰å’ŒåŒæ—¶éƒ½æ²¡æœ‰ï¼Œ<code>DontHaveOld, DoHaveNew</code> è¡¨ç¤ºåˆå§‹åŒ–ï¼Œ<code>DoHaveOld, DontHaveNew</code> è¡¨ç¤ºé”€æ¯ï¼›<code>CrashIfDeallocating</code> è¡¨ç¤ºå¦‚æœå¯¹è±¡æ­£å¤„äºé”€æ¯é˜¶æ®µæ˜¯å¦äº§ç”Ÿ Crashï¼Œå› æ­¤åœ¨å¯¹è±¡çš„ <code>dealloc</code> ä¸­ä¸è¦è¯•å›¾ä½¿ç”¨ <code>weak</code> ä¿®é¥° <code>self</code>ï¼›æœ€åçš„å‚æ•°åˆ™æ˜¯å¼±å¼•ç”¨æŒ‡é’ˆå’Œå¯¹è±¡åœ°å€ã€‚</p><pre><code class="c++">// ç®€åŒ–åä»£ç template &lt;HaveOld haveOld, HaveNew haveNew,          enum CrashIfDeallocating crashIfDeallocating&gt;static id storeWeak(id *location, objc_object *newObj){    id oldObj;    SideTable *oldTable;    SideTable *newTable; retry:    if (haveOld) {        oldObj = *location;        oldTable = &amp;SideTables()[oldObj];    } else {        oldTable = nil;    }    if (haveNew) {        newTable = &amp;SideTables()[newObj];    } else {        newTable = nil;    }    // æ ¹æ® table åœ°å€ï¼ŒæŒ‰å¤§å°è¿›è¡ŒåŠ é”ï¼Œé¿å…æ­»é”    SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);    if (haveOld  &amp;&amp;  *location != oldObj) {        SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);        goto retry;    }    // æ¸…é™¤å¼±å¼•ç”¨æŒ‡é’ˆ    if (haveOld) {        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);    }    if (haveNew) {        newObj = (objc_object *)            weak_register_no_lock(&amp;newTable-&gt;weak_table, (id)newObj, location,                                   crashIfDeallocating ? CrashIfDeallocating : ReturnNilIfDeallocating);        // è®¾ç½® isa æŒ‡é’ˆçš„ WeaklyReference ä½åŸŸ        if (!_objc_isTaggedPointerOrNil(newObj)) {            newObj-&gt;setWeaklyReferenced_nolock();        }        *location = (id)newObj;    }        SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);    // å¦‚æœå¯¹è±¡å®ç°äº† _setWeaklyReferenced æ–¹æ³•ï¼Œä¼šè°ƒç”¨é€šçŸ¥    callSetWeaklyReferenced((id)newObj);    return (id)newObj;}</code></pre><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œé¦–å…ˆä¼šè·å–åˆ°ç›¸åº”çš„ <code>SideTable</code>ï¼Œåœ¨è¿›è¡ŒåŠ é”æ—¶æŒ‰ <code>SideTable</code> çš„åœ°å€å¤§å°é¡ºåºè¿›è¡Œæ·é”ï¼Œè¿™å¯ä»¥é¿å…æ­»é”ï¼Œä¹‹åè¿›è¡Œ <code>SideTable</code> çš„æ¸…ç†æˆ–è€…æ·»åŠ ï¼Œæœ€åè®¾ç½® isa æŒ‡é’ˆçš„ <code>weakly_referenced</code> ä½åŸŸã€‚</p><p>åœ¨è¿›è¡Œæ¸…ç†å’Œæ·»åŠ æ—¶ï¼Œä¼šæŒ‰ä¸€å®šé€»è¾‘è¿›è¡Œå‹ç¼©å’Œæ‰©å®¹ï¼š</p><p>åœ¨æ¸…é™¤æ—¶ï¼Œ<code>weak_table</code> å¯èƒ½ä¼šå‹ç¼©ï¼Œå¤§å°å¤§äº 1024 ä¸”å®¹é‡ä¸æ»¡ 1/16ï¼Œå‹ç¼© <code>weak_table</code> åˆ°åŸæ¥çš„ 1/8ï¼š</p><pre><code class="c++">static void weak_compact_maybe(weak_table_t *weak_table){    size_t old_size = TABLE_SIZE(weak_table);    // å¤§å°å¤§äº 1024 ä¸”å®¹é‡ä¸æ»¡ 1/16ï¼Œå‹ç¼© weak_table    if (old_size &gt;= 1024  &amp;&amp; old_size / 16 &gt;= weak_table-&gt;num_entries) {        weak_resize(weak_table, old_size / 8);    }}</code></pre><p>åœ¨æ·»åŠ æ—¶ï¼Œå¦‚æœ <code>entry</code> çš„å¤§å°è¶…è¿‡ 4ï¼Œä¼šè½¬æ¢æˆå“ˆå¸Œè¡¨ï¼Œå¦‚æœå®¹é‡å æ»¡ 3/4ï¼Œä¼šè¿›è¡Œæ‰©å®¹åˆ°åŸæ¥çš„ä¸¤å€ï¼š</p><pre><code class="c++">static void append_referrer(weak_entry_t *entry, objc_object **new_referrer){    if (! entry-&gt;out_of_line()) {        // å°è¯•å¡å…¥åˆ°æ•°ç»„ä¸­        for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) {            if (entry-&gt;inline_referrers[i] == nil) {                entry-&gt;inline_referrers[i] = new_referrer;                return;            }        }        // æ— æ³•å¡å…¥æ•°ç»„ï¼Œè½¬æ¢æˆå“ˆå¸Œè¡¨        weak_referrer_t *new_referrers = (weak_referrer_t *)            calloc(WEAK_INLINE_COUNT, sizeof(weak_referrer_t));        for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) {            new_referrers[i] = entry-&gt;inline_referrers[i];        }        entry-&gt;referrers = new_referrers;        entry-&gt;num_refs = WEAK_INLINE_COUNT;        entry-&gt;out_of_line_ness = REFERRERS_OUT_OF_LINE;        entry-&gt;mask = WEAK_INLINE_COUNT-1;        entry-&gt;max_hash_displacement = 0;    }    if (entry-&gt;num_refs &gt;= TABLE_SIZE(entry) * 3/4) {        return grow_refs_and_insert(entry, new_referrer);    }    size_t begin = w_hash_pointer(new_referrer) &amp; (entry-&gt;mask);    size_t index = begin;    size_t hash_displacement = 0;    while (entry-&gt;referrers[index] != nil) {        hash_displacement++;        index = (index+1) &amp; entry-&gt;mask;        if (index == begin) bad_weak_table(entry);    }    if (hash_displacement &gt; entry-&gt;max_hash_displacement) {        entry-&gt;max_hash_displacement = hash_displacement;    }    weak_referrer_t &amp;ref = entry-&gt;referrers[index];    ref = new_referrer;    entry-&gt;num_refs++;}</code></pre><p>å¦‚æœ <code>weak_table</code> å®¹é‡å æ»¡ 3/4ï¼Œä¼šè¿›è¡Œæ‰©å®¹åˆ°åŸæ¥çš„ä¸¤å€ï¼š</p><pre><code class="c++">static void weak_grow_maybe(weak_table_t *weak_table){    size_t old_size = TABLE_SIZE(weak_table);    if (weak_table-&gt;num_entries &gt;= old_size * 3 / 4) {        weak_resize(weak_table, old_size ? old_size*2 : 64);    }}</code></pre><h3 id="weak-clear-no-lock"><a href="#weak-clear-no-lock" class="headerlink" title="weak_clear_no_lock"></a>weak_clear_no_lock</h3><p>åœ¨å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œä¼šè¿›è¡Œå¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨æŒ‡é’ˆçš„æ¸…ç†ï¼Œå®ƒç”± <code>dealloc</code> è°ƒç”¨ï¼š</p><pre><code class="c++">// ç®€åŒ–åä»£ç void weak_clear_no_lock(weak_table_t *weak_table, id referent_id) {    objc_object *referent = (objc_object *)referent_id;    weak_entry_t *entry = weak_entry_for_referent(weak_table, referent);    weak_referrer_t *referrers;    size_t count;        if (entry-&gt;out_of_line()) {        referrers = entry-&gt;referrers;        count = TABLE_SIZE(entry);    }     else {        referrers = entry-&gt;inline_referrers;        count = WEAK_INLINE_COUNT;    }        for (size_t i = 0; i &lt; count; ++i) {        objc_object **referrer = referrers[i];        if (referrer) {            if (*referrer == referent) {                *referrer = nil;            }        }    }        weak_entry_remove(weak_table, entry);}</code></pre><h2 id="NSTimer-çš„å¾ªç¯å¼•ç”¨é—®é¢˜"><a href="#NSTimer-çš„å¾ªç¯å¼•ç”¨é—®é¢˜" class="headerlink" title="NSTimer çš„å¾ªç¯å¼•ç”¨é—®é¢˜"></a>NSTimer çš„å¾ªç¯å¼•ç”¨é—®é¢˜</h2><p>åœ¨ä½¿ç”¨ <code>NSTimer</code> æ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸¸å¸¸è¿™æ ·ä½¿ç”¨ï¼š</p><pre><code class="objc">#import "ViewController.h"@interface ViewController ()@property (nonatomic, strong) NSTimer *timer;@end@implementation ViewController- (void)viewDidLoad {    [super viewDidLoad];        self.timer = [NSTimer timerWithTimeInterval:1 target:self selector:@selector(timerTriggered:) userInfo:nil repeats:YES];    [[NSRunLoop currentRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];}- (void)timerTriggered:(NSTimer *)timer {    NSLog(@"timerTriggered");}- (void)dealloc {    [self.timer invalidate];    self.timer = nil;    NSLog(@"%s", __func__);}@end</code></pre><p>ä¸Šè¿°ä»£ç ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨ï¼Œè¿™æ˜¯å› ä¸º <code>timer</code> ä¼šä¿ç•™å…¶ç›®æ ‡å¯¹è±¡ï¼Œç­‰åˆ°è‡ªèº«â€œå¤±æ•ˆâ€æ—¶å†é‡Šæ”¾æ­¤å¯¹è±¡ã€‚è°ƒç”¨ <code>invalidate</code> æ–¹æ³•å¯ä»¤è®¡æ—¶å™¨å¤±æ•ˆï¼›æ‰§è¡Œå®Œç›¸å…³ä»»åŠ¡åï¼Œä¸€æ¬¡æ€§å®šæ—¶å™¨ä¹Ÿä¼šå¤±æ•ˆã€‚å¦‚æœæ˜¯é‡å¤æ€§å®šæ—¶å™¨ï¼Œé‚£å¿…é¡»è‡ªå·±è°ƒç”¨ <code>invalidate</code> æ–¹æ³•ï¼Œæ‰èƒ½ä»¤å…¶åœæ­¢ã€‚åœ¨ <code>vc</code> ä¸­å¼ºæŒæœ‰ä¸€ä»½ <code>timer</code>ï¼ŒåŒæ—¶ç”±äºè¿™æ˜¯ä¸€ä¸ªé‡å¤æ€§å®šæ—¶å™¨ï¼Œ<code>NSTimer</code> å§‹ç»ˆä¸ä¼šå¤±æ•ˆï¼Œä¹Ÿä¼šä¸€ç›´å¼ºæŒæœ‰ <code>vc</code>ï¼Œè¿™äº§ç”Ÿäº†å¾ªç¯å¼•ç”¨ã€‚å½“é¡µé¢é€€å‡ºæ—¶ï¼Œ<code>vc</code> å’Œ <code>timer</code> æ²¡æœ‰è¢«å¤–ç•Œå¯¹è±¡å¼•ç”¨ ï¼Œè¿™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p>å®ƒçš„å¯¹è±¡å…³ç³»å›¾å¦‚ä¸‹ï¼š</p><p><img src="/images/blog/image-20230805234705294-1250426.png" alt="image-20230805234705294"></p><p>ä¸‹é¢ç»™å‡ºä¸€äº›å¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>æå‰è°ƒç”¨ <code>invalidate</code> æ–¹æ³•</li></ul><p>å¦‚æœèƒ½æå‰çŸ¥é“ä»€ä¹ˆæ—¶å€™ <code>timer</code> ä¸éœ€è¦äº†ï¼Œå¯ä»¥æå‰è°ƒç”¨ <code>invalidate</code> æ–¹æ³•ï¼Œä¾‹å¦‚ä¸Šä¾‹ä¸­å¯ä»¥åœ¨è¿”å›æŒ‰é’®è¢«ç‚¹å‡»æ—¶è°ƒç”¨ <code>invalidate</code>ï¼Œè¿™å°±ä½¿å¾— <code>RunLoop</code> ä¸ä¼šç»§ç»­æŒæœ‰ <code>timer</code>ï¼Œ<code>timer</code> å› æ­¤å¤±æ•ˆï¼Œä¹Ÿä¸ä¼šå¼ºæŒæœ‰ç›®æ ‡å¯¹è±¡ï¼ˆ<code>vc</code>ï¼‰ï¼Œä½¿å¾—â€œç¯â€è¢«ç ´é™¤ã€‚ä½†è¿™ç§æ–¹å¼å­˜åœ¨å¾ˆå¤§å±€é™æ€§ï¼Œéœ€è¦æ˜ç¡®çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¸€å®šå¯ä»¥è°ƒç”¨ <code>invalidate</code> æ–¹æ³•ã€‚</p><ul><li>ä½¿ç”¨ <code>block</code> æ–¹å¼ä½¿ç”¨ <code>timer</code></li></ul><p>åœ¨ iOS10 ä»¥ä¸Šï¼Œæ–°å¢äº†é‡‡ç”¨ <code>block</code> æ–¹å¼ä½¿ç”¨ <code>timer</code>ï¼Œè¿™é¿å…äº†ä»¥ target-action æ–¹å¼å¼ºæŒæœ‰ç›®æ ‡å¯¹è±¡ï¼Œåªéœ€å¤„ç†å¯¹ <code>block</code> çš„å¾ªç¯å¼•ç”¨å³å¯ï¼š</p><pre><code class="objc">__weak typeof(self) weakSelf = self;self.timer = [NSTimer timerWithTimeInterval:1 repeats:YES block:^(NSTimer * _Nonnull timer) {    __strong typeof(weakSelf) strongSelf = weakSelf;    NSLog(@"timerTriggered");    // ...}];</code></pre><ul><li>é‡‡ç”¨ <code>NSProxy</code> æˆ–è€…ä¸­é—´å¯¹è±¡è¿›è¡Œæ¶ˆæ¯è½¬å‘</li></ul><p>ä½¿ç›®æ ‡å¯¹è±¡ä» <code>vc</code> è½¬æ¢æˆå…¶ä»–å¯¹è±¡ï¼Œå¦‚ <code>NSProxy</code>ï¼Œåœ¨ <code>NSProxy</code> å†…éƒ¨å°†æ¶ˆæ¯è½¬å‘åˆ° <code>vc</code>ï¼Œä¹Ÿå¯ä½¿å¾—â€œç¯â€è¢«æ‰“ç ´ï¼Œä¾‹å¦‚ï¼š</p><pre><code class="objc">@implementation LBWeakProxy+ (instancetype)proxyWithTarget:(id)target {    LBWeakProxy *proxy = [LBWeakProxy alloc];    proxy.target = target;    return proxy;}- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel {    if ([self.target respondsToSelector:sel]) {        NSMethodSignature *signature = [self.target methodSignatureForSelector:sel];        return signature;    }    return [super methodSignatureForSelector:sel];}-(void)forwardInvocation:(NSInvocation *)invocation {    SEL aSelector = invocation.selector;    if ([self.target respondsToSelector:aSelector]) {        invocation.target = self.target;        [invocation invoke];    } else {        [super forwardInvocation:invocation];    }}@end  LBWeakProxy *proxy = [LBWeakProxy proxyWithTarget:self];self.timer = [NSTimer timerWithTimeInterval:1 target:proxy selector:@selector(timerTriggered:) userInfo:nil repeats:YES];[[NSRunLoop currentRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];</code></pre><p>å®ƒçš„å¯¹è±¡å…³ç³»å›¾å¦‚ä¸‹ï¼š</p><p><img src="/images/blog/image-20230805234413206-1250254.png" alt="image-20230805234413206"></p><ul><li>ä½¿ç”¨ <code>GCD</code> ä»£æ›¿ <code>NSTimer</code></li></ul><p>å¯ä»¥åˆ©ç”¨ <code>GCD</code> å®ç°ä¸€ä¸ª <code>timer</code>ï¼Œä¾‹å¦‚å¼€æºåº“ <a href="https://github.com/mindsnacks/MSWeakTimer">MSWeakTimer</a>ï¼Œå®ƒä¸ä¼šä¿ç•™ç›®æ ‡å¯¹è±¡ï¼Œè¿™æ ·åªéœ€è¦åœ¨ <code>dealloc</code> ä¸­é‡Šæ”¾æ‰ timer å°±å¥½ã€‚åŒæ—¶ GCD çš„ timer ä¹Ÿä¸ä¼šæœ‰ RunLoop çš„ Mode åˆ‡æ¢ã€å­çº¿ç¨‹åˆ›å»º timer çš„ç›¸å…³é—®é¢˜ã€‚</p><blockquote><p>NSTimer Special Considerations</p></blockquote><blockquote><p>You must send this message from the thread on which the timer was installed. If you send this message from another thread, the input source associated with the timer may not be removed from its run loop, which could prevent the thread from exiting properly.</p></blockquote><h2 id="ğŸ”—"><a href="#ğŸ”—" class="headerlink" title="ğŸ”—"></a>ğŸ”—</h2><p>[1] <a href="https://book.douban.com/subject/25829244/">Effective Objective-C 2.0 ç¼–å†™é«˜è´¨é‡iOSä¸OS Xä»£ç çš„52ä¸ªæœ‰æ•ˆæ–¹æ³•</a></p><p>[2] <a href="https://stackoverflow.com/questions/64770338/purpose-of-class-explicitinit-in-objc-runtime-source-code">Purpose of class ExplicitInit in objc runtime source code</a></p><p>[3] <a href="https://draveness.me/retain-cycle1/">å¦‚ä½•åœ¨iOSä¸­è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜</a></p><p>[4] <a href="https://huang-libo.github.io/posts/NSTimer-circular-reference/">è­¦æƒ• NSTimer å¼•èµ·çš„å¾ªç¯å¼•ç”¨</a></p><p>[5] <a href="https://nihao201.cn/2021/09/29/2021-09-29-NSTimer%20%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3/">NSTimerå¾ªç¯å¼•ç”¨åˆ†æä¸è§£å†³</a></p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOSä¸­çš„å†…å­˜ç®¡ç†ï½œAutoreleasePool</title>
      <link href="/2023/07/25/iOS%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BD%9CAutoReleasePool/"/>
      <url>/2023/07/25/iOS%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BD%9CAutoReleasePool/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>åœ¨ ARC ä¸­ï¼Œä½¿ç”¨ AutoreleasePool éå¸¸ç®€å•ï¼Œåªéœ€å½¢å¦‚ä»¥ä¸‹æ–¹å¼è°ƒç”¨å³å¯ï¼Œç¼–è¯‘å™¨ä¼šå°†å—ä¸­çš„å¯¹è±¡æ’å…¥ç±»ä¼¼å¦‚ <code>[obj autorelease];</code> ä¸€æ ·çš„ä»£ç ï¼Œåœ¨è¶…å‡º AutoreleasePool å—ä½œç”¨åŸŸåä¼šè‡ªåŠ¨è°ƒç”¨å¯¹è±¡çš„ <code>release</code> æ–¹æ³•ï¼Œè¿™èƒ½å»¶è¿Ÿå¯¹è±¡çš„é‡Šæ”¾ã€‚ä½†ä¸€èˆ¬æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ <code>@autoreleasepool{ }</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä¸»çº¿ç¨‹ RunLoop çš„æ¯ä¸ªå‘¨æœŸä¸­éƒ½ä¼šè‡ªåŠ¨è¿›è¡Œè‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºå’Œé”€æ¯ã€‚</p><span id="more"></span><pre><code class="objc">@autoreleasepool {        }</code></pre><h2 id="ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ°-AutoreleasePool-ä¸­ï¼Ÿ"><a href="#ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ°-AutoreleasePool-ä¸­ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ° AutoreleasePool ä¸­ï¼Ÿ"></a>ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ° AutoreleasePool ä¸­ï¼Ÿ</h2><p>é™¤äº†æ˜¾å¼åŠ å…¥ <code>__autoreleasing</code> æ‰€æœ‰æƒä¿®é¥°å¯¹è±¡å¤–ï¼Œè¿˜æœ‰äº›å¯¹è±¡ä¼šç›´æ¥è¢«éšå¼çº³å…¥ AutoReleasePool ç®¡ç†ã€‚</p><ul><li>éè‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰çš„å¯¹è±¡</li></ul><p>ç¼–è¯‘å™¨ä¼šæ£€æŸ¥æ–¹æ³•åæ˜¯å¦ä»¥ <code>alloc</code>ã€<code>new</code>ã€<code>copy</code>ã€<code>mutableCopy</code> å¼€å§‹ï¼Œå¦‚æœä¸æ˜¯åˆ™è‡ªåŠ¨å°†å…¶è¿”å›å€¼æ³¨å†Œåˆ° AutoreleasePool ä¸­ã€‚ARC é€šè¿‡å‘½åçº¦å®šå°†å†…å­˜ç®¡ç†æ ‡å‡†åŒ–ï¼Œæœ¬æ¥ ARC ä¹Ÿå¯ä»¥ç›´æ¥èˆå¼ƒ autorelease è¿™ä¸ªæ¦‚å¿µï¼Œå¹¶ä¸”è§„å®šï¼Œæ‰€æœ‰ä»æ–¹æ³•ä¸­è¿”å›çš„å¯¹è±¡å…¶å¼•ç”¨è®¡æ•°æ¯”é¢„æœŸçš„å¤š 1ï¼Œä½†è¿™æ ·åšå°±ç ´åäº†å‘åå…¼å®¹æ€§ï¼ˆbackward compatibilityï¼‰ï¼Œæ— æ³•ä¸ä¸ä½¿ç”¨ ARC çš„ä»£ç å…¼å®¹ã€‚</p><p>ä¸è¿‡åˆ©ç”¨ <code>clang attribute</code> ï¼Œå¦‚ <code>- (id)allocObject __attribute__((objc_method_family(none)))</code>ï¼Œä¼šå°†<code>allocObject</code> è¿™ä¸ªæ–¹æ³•å½“åšæ™®é€šæ–¹æ³•è¿”å›å¯¹è±¡çœ‹å¾…ã€‚</p><p>åœ¨æ™®é€šæ–¹æ³•è¿”å›å¯¹è±¡åï¼Œå¯èƒ½ä¼šå°†å¯¹è±¡ <code>retain</code> ä¸€æ¬¡ä»¥è¿›è¡Œå¼ºæŒæœ‰ã€‚ä¾‹å¦‚ä»¥ä¸‹çš„ä»£ç ä¼šè¢«ç¿»è¯‘ä¸ºï¼š</p><pre><code class="objc">EOCPerson _myPerson = [EOCPerson personWithName: @"Bob Smith"]; // ä¼šè°ƒç”¨ `autorelease`// è¢«ç¿»è¯‘ä¸ºEOCPerson *tmp = [EOCPerson personWithName: @"Bob Smith"];_myPerson = [tmp retain];</code></pre><p>å…¶ä¸­ <code>autorelease</code> å’Œ <code>retain</code> ç»“å¯¹å‡ºç°ï¼Œæ˜¯å¤šä½™çš„ï¼Œä¸ºäº†æå‡æ€§èƒ½å¯ä»¥å°†å…¶åˆ é™¤ã€‚äºæ˜¯ç¼–è¯‘å™¨åœ¨è¢«è°ƒç”¨æ–¹é‡‡ç”¨ <code>objc_retainAutoreleaseReturnValue</code> æ–¹æ³•å–ä»£ <code>autorelease</code> ï¼Œä¼šæ£€æŸ¥å³å°†æ‰§è¡Œçš„é‚£æ®µä»£ç æ˜¯å¦ä¼šæ‰§è¡Œ <code>retain</code> æ“ä½œï¼Œè‹¥æœ‰åˆ™ä¼šåœ¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆTLSï¼ŒThread Local Storageï¼‰ä¸­å­˜å‚¨è¿™ä¸ªå¯¹è±¡ï¼Œä¸æ‰§è¡Œ <code>autorelease </code> æ“ä½œï¼›åœ¨è°ƒç”¨æ–¹é‡‡ç”¨ <code>objc_retainAutoreleasedReturnValue</code> æ–¹æ³•å–ä»£ <code>retain</code> ï¼Œä¼šæ£€æµ‹ TLS æ˜¯å¦å­˜äº†è¿™ä¸ªå¯¹è±¡ï¼Œè‹¥æœ‰åˆ™ç›´æ¥è¿”å›è¿™ä¸ªå¯¹è±¡ï¼Œä¸è¿›è¡Œ <code>retain</code> æ“ä½œã€‚</p><ul><li>id çš„æŒ‡é’ˆæˆ–å¯¹è±¡çš„æŒ‡é’ˆ</li></ul><p>id çš„æŒ‡é’ˆï¼ˆ<code>id **</code>ï¼‰å’Œå¯¹è±¡çš„æŒ‡é’ˆï¼ˆ<code>NSError **</code>ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šï¼Œä¼šè‡ªåŠ¨åŠ ä¸Šå…³é”®å­— <code>__autoreleasing</code>ï¼Œæ³¨å†Œåˆ° AutoreleasePool ä¸­ã€‚</p><ul><li>å…³äº <code>__weak1</code> ä¿®é¥°çš„å¯¹è±¡</li></ul><p>åœ¨ LLVM 8.0 ä¹‹å‰çš„ç¼–è¯‘å™¨ï¼Œå…³é”®å­— <code>__weak</code> ä¿®é¥°çš„å¯¹è±¡ï¼Œä¼šè‡ªåŠ¨æ³¨å†Œåˆ° AutoreleasePool ä¸­ï¼›åœ¨ LLVM 8.0 ä»¥åŠä¹‹åçš„ç¼–è¯‘å™¨ï¼Œåˆ™ä¼šç›´æ¥è°ƒç”¨ <code>release</code> æ–¹æ³•ã€‚</p><h2 id="ä»€ä¹ˆæ—¶å€™æ˜¾å¼ä½¿ç”¨-autoreleasepoolï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™æ˜¾å¼ä½¿ç”¨-autoreleasepoolï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™æ˜¾å¼ä½¿ç”¨ @autoreleasepoolï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™æ˜¾å¼ä½¿ç”¨ @autoreleasepoolï¼Ÿ</h2><ul><li>CLIï¼ˆCommand-line interfaceï¼‰ç¨‹åº</li></ul><p>åœ¨ Cocoa æ¡†æ¶ä¸­ç”±äºæœ‰ RunLoop æœºåˆ¶çš„åŸå› ï¼Œæ¯ä¸ªå‘¨æœŸéƒ½ä¼šè¿›è¡Œè‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºä¸é‡Šæ”¾ï¼Œä½†åœ¨ CLI ä¸­æ„å‘³ç€ä¸ä¼šå®šæœŸæ¸…ç†å†…å­˜ï¼Œå› æ­¤éœ€è¦æ›´å¤šå…³æ³¨ã€‚</p><ul><li>å¾ªç¯ä¸­ä½¿ç”Ÿæˆå¤§é‡å±€éƒ¨å˜é‡</li></ul><p>å†å¾ªç¯è¿‡ç¨‹ä¸­äº§ç”Ÿäº†å¤§é‡çš„å±€éƒ¨å˜é‡ï¼Œä¼šå¯¼è‡´å†…å­˜å³°å€¼è¿‡é«˜ï¼Œå› æ­¤æ‰‹åŠ¨åŠ å…¥ <code>@autoreleasepool</code> å¯ä»¥é™ä½å†…å­˜ä½¿ç”¨å³°å€¼ã€‚</p><p>è™½ç„¶åªæœ‰ Autorelease å¯¹è±¡ï¼ˆä¹Ÿå³ä¸Šæ–‡æåˆ°çš„å“ªäº›å¯¹è±¡ä¼šçº³å…¥ AutoreleasePool ç®¡ç†ï¼‰ä¼šçº³å…¥AutoreleasePool ç®¡ç†ï¼Œä½†è¿™å¯ä»¥åˆ©ç”¨å—æœºåˆ¶ï¼Œè®©ç¼–è¯‘å™¨å°†åœ¨å—æœ«å°¾è‡ªåŠ¨æ’å…¥ <code>release</code> ä»£ç ã€‚</p><pre><code class="swift">func loadBigData() {    if let path = NSBundle.mainBundle().pathForResource("big", ofType: "jpg") {        for i in 1...10000 {            autoreleasepool {                let data = NSData.dataWithContentsOfFile(path, options: nil, error: nil)                let person = Person("nihao") //ä¹Ÿä¼šé‡Šæ”¾                NSThread.sleepForTimeInterval(0.5)            }        }    }}</code></pre><ul><li>å¸¸é©»çº¿ç¨‹</li></ul><p>ä¸»çº¿ç¨‹çš„ RunLoop ä¼šåœ¨æ¯ä¸ªå‘¨æœŸè¿›è¡Œè‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºä¸é‡Šæ”¾ï¼Œå­çº¿ç¨‹åˆ™ä¸ä¼šï¼ŒåŒæ—¶å­çº¿ç¨‹ä¹Ÿä¸ä¸€å®šä¼šæœ‰ RunLoopã€‚ä½†åªè¦æ˜¯ Autorelease å¯¹è±¡ï¼Œå°±ä¼šè‡ªåŠ¨çº³å…¥ AutoreleasePool ç®¡ç†ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºå¹¶ç®¡ç†è‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œç­‰åˆ°çº¿ç¨‹é”€æ¯çš„æ—¶å€™é‡Šæ”¾ã€‚ä½†å¸¸é©»çº¿ç¨‹ä¸­çš„å¯¹è±¡å› çº¿ç¨‹æ— æ³•é”€æ¯è¿Ÿè¿Ÿå¾—ä¸åˆ°é‡Šæ”¾ï¼Œè¿™å°±éœ€è¦æ‰‹åŠ¨æ·»åŠ  AutoreleasePoolï¼š</p><pre><code class="swift">class KeepAliveThreadManager {    private init() {}    static let shared = KeepAliveThreadManager()    private(set) var thread: Thread?    /// å¼€å¯å¸¸é©»çº¿ç¨‹    public func start() {        if thread != nil, thread!.isExecuting {            return        }        thread = Thread {            autoreleasepool {                let currentRunLoop = RunLoop.current                // å¦‚æœæƒ³è¦åŠ å¯¹è¯¥RunLoopçš„çŠ¶æ€è§‚å¯Ÿï¼Œéœ€è¦åœ¨è·å–åæ·»åŠ ï¼Œè€Œä¸æ˜¯ç­‰åˆ°å¯åŠ¨ä¹‹åå†æ·»åŠ ï¼Œ                currentRunLoop.add(Port(), forMode: .common)                currentRunLoop.run()            }        }        thread?.start()    }    /// å…³é—­å¸¸é©»çº¿ç¨‹    public func end() {        thread?.cancel()        thread = nil    }}class Test: NSObject {    func test() {        if let thread = KeepAliveThreadManager.shared.thread {            perform(#selector(task), on: thread, with: nil, waitUntilDone: false)        }    }    @objc    func task() {        /// åœ¨ä»»åŠ¡å¤–åŠ ä¸€å±‚ autoreleasepool        autoreleasepool {        }    }}</code></pre><h2 id="ä¸-RunLoop-çš„å…³ç³»"><a href="#ä¸-RunLoop-çš„å…³ç³»" class="headerlink" title="ä¸ RunLoop çš„å…³ç³»"></a>ä¸ RunLoop çš„å…³ç³»</h2><p>ä¸»çº¿ç¨‹åœ¨ RunLoop ä¸­æ³¨å†Œäº†ä¸¤ä¸ª Observerï¼Œå…¶å›è°ƒéƒ½æ˜¯ <code>_wrapRunLoopWithAutoreleasePoolHandler</code>ã€‚</p><ul><li>ç¬¬ä¸€ä¸ª Observer ç›‘æµ‹ <code>Entry</code> äº‹ä»¶ï¼ˆå³å°†è¿›å…¥ RunLoopï¼‰</li></ul><p>å›è°ƒå†…éƒ¨ä¼šè°ƒç”¨ <code>_objc_autoreleasePoolPush</code> åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå…¶ order = -214748364ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± åœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚</p><ul><li>ç¬¬äºŒä¸ª Observer ç›‘æµ‹ <code>BeforeWaiting</code> åŠ <code>Exit</code> äº‹ä»¶</li></ul><p><code>BeforeWaiting</code> æ—¶è°ƒç”¨ <code>_objc_autoreleasePoolPop()</code> å’Œ <code>_objc_autoreleasePoolPush()</code> é‡Šæ”¾æ—§çš„è‡ªåŠ¨é‡Šæ”¾æ± å¹¶åˆ›å»ºæ–°çš„è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p><p><code>Exit</code> æ—¶è°ƒç”¨ <code>_objc_autoreleasePoolPop</code> æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå…¶ order = 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶å…¶å®ƒå›è°ƒéƒ½åœ¨é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ä¹‹å‰ã€‚</p><h2 id="AutoReleasePool-æºç "><a href="#AutoReleasePool-æºç " class="headerlink" title="AutoReleasePool æºç "></a>AutoReleasePool æºç </h2><p>å½¢å¦‚ <code>_objc_autoreleasePoolPush</code> ã€ <code>_objc_autoreleasePoolPush</code> å’Œ <code>objc_autorelease</code> å…¶å†…éƒ¨éƒ½æ˜¯è°ƒç”¨ <code>AutoreleasePoolPage</code> çš„ç›¸å…³é™æ€æ–¹æ³•ã€‚å› æ­¤å…¶æºç ä¸»è¦æ˜¯å¯¹ <code>AutoreleasePoolPage</code> çš„æ¢ç´¢ã€‚</p><p>ä»¥ä¸‹å‚è€ƒçš„æºç ä¸º objc4-838ã€‚</p><pre><code class="c++">void *objc_autoreleasePoolPush(void) {    return AutoreleasePoolPage::push();} void objc_autoreleasePoolPop(void *ctxt) {    AutoreleasePoolPage::pop(ctxt);}__attribute__((noinline,used))id objc_object::rootAutorelease2(){    ASSERT(!isTaggedPointer());    return AutoreleasePoolPage::autorelease((id)this);}</code></pre><h3 id="AutoreleasePoolPage-çš„æ•°æ®ç»“æ„"><a href="#AutoreleasePoolPage-çš„æ•°æ®ç»“æ„" class="headerlink" title="AutoreleasePoolPage çš„æ•°æ®ç»“æ„"></a>AutoreleasePoolPage çš„æ•°æ®ç»“æ„</h3><p><code>AutoreleasePoolPage</code> ç»§æ‰¿è‡ª <code>AutoreleasePoolPageData</code>ï¼Œ<code>AutoreleasePoolPageData</code> å­˜å‚¨äº†è‡ªåŠ¨é‡Šæ”¾æ± å®ä¾‹å¯¹è±¡çš„ä¿¡æ¯ï¼Œè€Œ <code>AutoreleasePoolPage</code> é‡Œåˆ™å­˜å‚¨äº†å…¨å±€æ‰€æœ‰çš„è‡ªåŠ¨é‡Šæ”¾æ± çš„æ‰€éœ€ä¿¡æ¯ï¼Œå› æ­¤å…¶å±æ€§ç±»å‹ä¹Ÿéƒ½æ˜¯ <code>static const</code>ã€‚</p><pre><code class="c++">struct AutoreleasePoolPageData{#if SUPPORT_AUTORELEASEPOOL_DEDUP_PTRS    // ç”¨æ¥ä¼˜åŒ–åŒä¸€å¯¹è±¡å¤šæ¬¡åŠ å…¥ AutoreleasePoolPageï¼Œåªéœ€è®°å½•å…¶åœ°å€ä¸æ•°é‡ï¼Œæ— éœ€é‡å¤é€’å¢ï¼ŒèŠ‚çœç©ºé—´    struct AutoreleasePoolEntry {        uintptr_t ptr: 48;        uintptr_t count: 16;        static const uintptr_t maxCount = 65535; // 2^16 - 1    };#endif  // å¯¹å½“å‰ AutoreleasePool å®Œæ•´æ€§æ ¡éªŒ    magic_t const magic;  // æŒ‡å‘ä¸‹ä¸€ä¸ªå³å°†äº§ç”Ÿçš„ autorelease å¯¹è±¡çš„ä½ç½®    __unsafe_unretained id *next;  // å…³è”çš„çº¿ç¨‹    pthread_t const thread;  // æŒ‡å‘çˆ¶èŠ‚ç‚¹    AutoreleasePoolPage * const parent;  // æŒ‡å‘å­—èŠ‚ç‚¹    AutoreleasePoolPage *child;  // é“¾è¡¨çš„æ·±åº¦    uint32_t const depth;  // æ°´ä½çº¿(DEBUG ä½¿ç”¨ï¼Œç”¨ä½œåˆ¤æ–­ä¸Šæ¬¡å’Œè¿™æ¬¡çš„å¯¹è±¡å¢åŠ æ•°é‡)    uint32_t hiwat;};</code></pre><p>ä» <code>next</code>ã€<code>parent</code>ã€<code>child</code> çš„ç»“æ„æ¥çœ‹ï¼Œæ„æˆäº†ä»¥æ ˆä½œä¸ºèŠ‚ç‚¹çš„åŒå‘é“¾è¡¨ï¼Œæ¯ä¸ª <code>AutorleasePoolPage</code> çš„å¤§å°ä¸º 4096 ä¸ªå­—èŠ‚ã€‚</p><p><img src="/images/blog/image-20230724164816710.png" alt="image-20230724164816710"></p><p>å€¼çš„æ³¨æ„çš„æ˜¯ï¼Œå¼•å…¥äº† <code>AutoreleasePoolEntry</code> ç»“æ„ï¼Œç”¨ä½œå°†åŒä¸€å¯¹è±¡å¤šæ¬¡è¿›è¡Œ <code>autorelease</code> æ“ä½œæ—¶çš„ä¼˜åŒ–ï¼Œè¿™æ—¶ä¸ä¼šå°† <code>next</code> é€’å¢ï¼Œè€Œæ˜¯å°† <code>AutoreleasePoolEntry</code> ä¸­ <code>count</code> é€’å¢ï¼Œå¾—ä»¥ä¼˜åŒ–å†…å­˜ç©ºé—´ã€‚è¿™é‡Œå°† <code>ptr</code> å’Œ <code>count</code> æŒ‡å®šå­˜å‚¨å¤§å°ï¼Œå…¶æ€»å¤§å°ä¸º 64 å­—èŠ‚ï¼Œä¸ <code>id</code> ç±»å‹æŒ‡é’ˆå¤§å°ç›¸åŒï¼Œä½¿å¾— <code>AutoreleasePoolEntry</code> å’Œ æ™®é€šçš„ <code>id</code> ç±»å‹å¯ä»¥äº’æ“ä½œã€‚</p><pre><code class="c++">class AutoreleasePoolPage : private AutoreleasePoolPageData{public:  // æ¯ä¸ª Page çš„å¤§å°ï¼Œä¸º 4096 å­—èŠ‚(è™šæ‹Ÿå†…å­˜ä¸€é¡µçš„å¤§å°)    static size_t const SIZE = PAGE_MIN_SIZE;    private:  // å…³äº AutoreleasePool çš„ Keyï¼Œç”¨æ¥æŸ¥æ‰¾å­˜å‚¨åœ¨ TLS ä¸­çº¿ç¨‹çš„ HotPage    static pthread_key_t const key = AUTORELEASE_POOL_KEY;  // é‡Šæ”¾å¯¹è±¡åç”¨ 0xA3A3A3A3 å ä½    static uint8_t const SCRIBBLE = 0xA3;  // å­˜å‚¨å¯¹è±¡ä¸ªæ•°    static size_t const COUNT = SIZE / sizeof(id);  // æœ€å¤§é”™è¯¯æ•°é‡(DEBUG ä½¿ç”¨)  static size_t const MAX_FAULTS = 2;}</code></pre><p>å…³äº <code>AutoreleasePoolPage</code> çš„é™æ€å±æ€§ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„ï¼š</p><ul><li><code>size</code> å›ºå®šä¸º <code>4096</code>ï¼Œåˆšå¥½ä¸ºè™šæ‹Ÿå†…å­˜å¤§å°çš„ä¸€é¡µã€‚</li><li><code>key</code> ä¸º <code>43</code>ï¼Œç”¨ä½œçº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ <code>Key</code>ï¼Œå­˜å‚¨çš„æ˜¯çº¿ç¨‹æ‰€å±çš„ <code>hotPage</code>ï¼Œéš”ç¦»åŒºåˆ†å…¶ä»–çº¿ç¨‹çš„ <code>AutoreleasePoolPage</code>ã€‚</li><li><code>SCRIBBLE</code> ä¸º <code>0xA3A3A3A3</code>ï¼Œåœ¨ç”¨ä½œå ä½é‡Šæ”¾æ‰çš„ <code>next</code> æŒ‡é’ˆï¼Œæ ‡è¯†ä¸ºæœªåˆå§‹åŒ–çš„åœ°å€ã€‚</li></ul><h3 id="AutoreleasePoolPage-push"><a href="#AutoreleasePoolPage-push" class="headerlink" title="AutoreleasePoolPage::push()"></a>AutoreleasePoolPage::push()</h3><p><code>AutoreleasePoolPage::push() </code> åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå®é™…ä¸Šæ˜¯æ’å…¥ä¸€ä¸ª <code>POOL_BOUNDARY</code> ï¼ˆå“¨å…µå¯¹è±¡ï¼ŒæŒ‡å‘ <code>nil</code>ï¼‰ç”¨æ¥è¡¨ç¤ºä¸åŒçš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå»é™¤æ‰ <code>DEBUG</code> è°ƒè¯•å’Œä¸€äº›è¾¹ç•Œæ¡ä»¶ï¼Œå…¶ä¸»è¦é€»è¾‘é›†ä¸­åœ¨ <code>autoreleaseFast</code> æ–¹æ³•ä¸­ï¼Œæ ¹æ® <code>hotPage</code> çš„çŠ¶æ€åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><p>å…³äº <code>hotPage</code>ï¼Œå…¶å­˜å‚¨åœ¨ TLS ä¸­ï¼Œè¡¨ç¤ºå½“å‰æ­£æ´»è·ƒçš„ <code>Page</code>ï¼›ä¸ä¹‹ç›¸å¯¹åº”æ˜¯ <code>coldPage</code>ï¼ŒæŒ‡å‘çš„æ˜¯åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚</p><pre><code class="c++">// æ­¤å¤„çš„ obj ä¸º POOL_BOUNDARYstatic inline id *autoreleaseFast(id obj) {    AutoreleasePoolPage *page = hotPage();    if (page &amp;&amp; !page-&gt;full()) {        return page-&gt;add(obj);    } else if (page) {        return autoreleaseFullPage(obj, page);    } else {        return autoreleaseNoPage(obj);    }}</code></pre><ul><li>å­˜åœ¨ <code>hotPage</code> å¹¶ä¸” <code>hotPage</code> æœªæ»¡</li></ul><p>è¿™æ˜¯ç›´æ¥è°ƒç”¨ <code>hotPage</code> çš„ <code>add</code> å®ä¾‹æ–¹æ³•ï¼Œæ ¹æ®å®å®šä¹‰ï¼Œåˆ¤æ–­æ˜¯å¦åˆ©ç”¨ <code>AutoreleasePoolEntry</code> ç±»å‹ä¼˜åŒ–åŒä¸€å¯¹è±¡çš„å¤šæ¬¡ <code>autorelease</code>ï¼Œå¦åˆ™ç›´æ¥åŠ å…¥ï¼Œ<code>next</code> æŒ‡å‘ä¸‹ä¸€ä¸ªå°†è¦åŠ å…¥ <code>AutoreleasePoolPage</code> çš„åœ°å€ã€‚</p><ul><li>å­˜åœ¨ <code>hotPage</code> å¹¶ä¸” <code>hotPage</code> å·²æ»¡</li></ul><p>ä» <code>hotPage</code> ï¼Œéå†æ‰¾ä¸€ä¸ªæœªæ»¡çš„å­èŠ‚ç‚¹ï¼Œè‹¥æ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ª <code>AutoreleasePoolPage</code> ï¼Œéšåå°†æ‰¾åˆ°æˆ–ç”Ÿæˆçš„ <code>page</code> ç½®ä¸º <code>hotPage</code> ï¼ˆåˆ©ç”¨ TLS æœºåˆ¶ï¼‰ï¼Œå¹¶å°†å¯¹è±¡ <code>add</code> åˆ° <code>hotPage</code> ä¸­ã€‚</p><ul><li>ä¸å­˜åœ¨ <code>hotPage</code></li></ul><p>åˆ›å»ºä¸€ä¸ª <code>AutoreleasePoolPage</code> ï¼Œå°†å…¶è®¾ç½®ä¸º <code>hotPage</code>ï¼Œå¹¶å°†å¯¹è±¡åŠ å…¥åˆ° <code>hotPage</code> ä¸­ã€‚</p><h3 id="AutoreleasePoolPage-pop-ctxt"><a href="#AutoreleasePoolPage-pop-ctxt" class="headerlink" title="AutoreleasePoolPage::pop(ctxt)"></a>AutoreleasePoolPage::pop(ctxt)</h3><p><code>pop</code> æ–¹æ³•éœ€è¦ä¼ å…¥å‚æ•°ï¼Œåœ¨ <code>_objc_autoreleasePoolPush</code> ä¸­æ˜¯ä¼ å…¥ <code>push</code> æ–¹æ³•è¿”å›çš„å‚æ•°ï¼Œ<code>push</code> è¿”å›çš„æ˜¯å­˜å‚¨çš„å“¨å…µå¯¹è±¡çš„åœ°å€ï¼Œå› æ­¤ä¼ å…¥çš„ä¹Ÿæ˜¯å“¨å…µå¯¹è±¡çš„åœ°å€ã€‚</p><p>ä¸è¿‡è¯¥æ–¹æ³•ä¹Ÿå¯èƒ½åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼Œå¦‚æœæ˜¯å“¨å…µå¯¹è±¡çš„åœ°å€ä¼šé”€æ¯æ•´ä¸ªä»¥å“¨å…µå¯¹è±¡å¼€å§‹çš„å•ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œè¿˜æœ‰å¯èƒ½é”€æ¯æ•´ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå…¶æ–¹æ³•ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><pre><code class="c++">static inline voidpop(void *token){    AutoreleasePoolPage *page;    id *stop;    if (token == (void*)EMPTY_POOL_PLACEHOLDER) {        page = hotPage();        if (!page) {            // å¦‚æœæ•´ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ä¸ºç©ºï¼Œä»…æœ‰å ä½ç¬¦ï¼Œä»¥ nil å¡«å……            return setHotPage(nil);        }        // ä»å¤´èŠ‚ç‚¹å¼€å§‹ï¼Œç§»é™¤è‡ªåŠ¨é‡Šæ”¾æ± ä¸­çš„æ‰€æœ‰å†…å®¹        page = coldPage();        token = page-&gt;begin();    } else {        page = pageForPointer(token);    }    stop = (id *)token;    return popPage&lt;false&gt;(token, page, stop);}</code></pre><p>å¦‚ä½•é€šè¿‡åˆ° <code>token</code>ï¼ˆä¹Ÿå³ä¼ å…¥çš„å“¨å…µå¯¹è±¡çš„åœ°å€ï¼‰ æŸ¥æ‰¾åˆ°æ‰€å¯¹åº”çš„ <code>AutoreleasePoolPage</code> ï¼Œåœ¨ <code>pageForPointer</code> æ–¹æ³•ä¸­ã€‚</p><p>è¿™é‡Œæœ‰ä¸ªå‰ç½®æ¡ä»¶ï¼Œ<code>AutoreleasePoolPage</code> ä¼šé€šè¿‡ <code>malloc_zone_memalign</code> æ–¹å¼åˆ†é…å†…å­˜ï¼Œå› æ­¤æ¯ä¸ª <code>AutoreleasePoolPage</code> çš„åœ°å€éƒ½æ˜¯ <code>SIZE</code>ï¼ˆ4096ï¼‰çš„å€æ•°ï¼Œä¹Ÿå°±æ˜¯åœ°å€ä¼šè¿›è¡Œå¯¹é½ï¼Œåœ¨ä¸ <code>SIZE</code> è¿›è¡Œå–ä½™æ“ä½œåï¼Œå¾—åˆ°ç›¸å¯¹äº <code>token</code> æ‰€åœ¨çš„ <code>AutoreleasePoolPage</code> çš„åç§»ï¼Œç›¸å‡åˆ™å°±èƒ½å¾—åˆ°å…¶é¦–åœ°å€ã€‚</p><pre><code class="c++">static AutoreleasePoolPage *pageForPointer(uintptr_t p) {    AutoreleasePoolPage *result;    uintptr_t offset = p % SIZE;    ASSERT(offset &gt;= sizeof(AutoreleasePoolPage));    result = (AutoreleasePoolPage *)(p - offset);    result-&gt;fastcheck();    return result;}</code></pre><p>åœ¨ <code>popPage</code> æ–¹æ³•ä¸­ï¼Œä» <code>hotPage</code> å¼€å§‹ï¼Œä¸€ç›´è¿›è¡Œå‡ºæ ˆæ“ä½œï¼Œä¹Ÿå³ä¼š <code>objc_release(obj);</code>ï¼Œç›´åˆ°æ»¡è¶³æ ˆé¦–çš„åœ°å€ä¸ <code>stop</code> çš„åœ°å€ä¸€è‡´ï¼Œä¹‹åä¼šè°ƒç”¨ <code>child</code> / <code>child-&gt; child</code> çš„ <code>kill</code> æ–¹æ³•ï¼Œå°†æ‰€æœ‰çš„å­èŠ‚ç‚¹é”€æ¯ã€‚</p><p>æœ‰æ„æ€çš„æ˜¯ï¼Œä¼šæ ¹æ®å­èŠ‚ç‚¹çš„çŠ¶æ€ï¼ˆå­èŠ‚ç‚¹ä¸­å·²å­˜å‚¨å¤§å°å°äºæ€»å¤§å°çš„ä¸€åŠï¼‰è¿›è¡ŒåŒºåˆ†ï¼Œæ›´æœ‰æ„æ€çš„æ˜¯ï¼Œåœ¨è¿›è¡Œ <code>releaseUntil</code> æ–¹æ³•æ—¶ï¼Œä¼šå°†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹æ¸…ç©ºï¼Œé‡Œé¢ä¹Ÿä¼šåˆ¤æ–­ <code>ASSERT(page-&gt;empty());</code>ï¼Œå› æ­¤åªä¼šè°ƒç”¨ <code>page-&gt;child-&gt;kill();</code>ã€‚</p><p>ä¸è¿‡è¿™é‡Œæåˆ°ä¸€ä¸ªæ¦‚å¿µï¼Œè¿Ÿæ»ç°è±¡ï¼ˆhysteresisï¼‰ï¼Œwiki æ˜¯è¿™æ ·è§£é‡Šçš„ï¼š</p><blockquote><p>ä¸€ç³»ç»Ÿç»è¿‡æŸä¸€è¾“å…¥è·¯å¾„ä¹‹è¿ä½œåï¼Œå³ä½¿æ¢å›æœ€åˆçš„çŠ¶æ€æ—¶åŒæ ·çš„è¾“å…¥å€¼ï¼ŒçŠ¶æ€ä¹Ÿä¸èƒ½å›åˆ°å…¶åˆå§‹ã€‚</p></blockquote><p>æ¨æµ‹æ˜¯è™½ç„¶éœ€è¦å°†æ‰€æœ‰å­èŠ‚ç‚¹æ¸…ç©ºï¼Œä½†æ˜¯ç³»ç»Ÿä¸åŒä»¥å¾€äº†ï¼Œå¯èƒ½åç»­éœ€è¦é‡æ–°åˆ›å»ºå­èŠ‚ç‚¹ï¼Œè¿™é‡Œå…ˆä¸æ¸…ç©ºï¼Œä¸ºåç»­ä½¿ç”¨æé«˜æ•ˆç‡ã€‚</p><pre><code class="c++">template&lt;bool allowDebug&gt;static voidpopPage(void *token, AutoreleasePoolPage *page, id *stop){    page-&gt;releaseUntil(stop);    if (page-&gt;child) {        // hysteresis: keep one empty child if page is more than half full        if (page-&gt;lessThanHalfFull()) {            page-&gt;child-&gt;kill();        }        else if (page-&gt;child-&gt;child) {            page-&gt;child-&gt;child-&gt;kill();        }    }}</code></pre><h3 id="objc-autorelease"><a href="#objc-autorelease" class="headerlink" title="objc_autorelease"></a>objc_autorelease</h3><p>å»é™¤æ‰ä¸€äº›ä¼˜åŒ–æ¡ä»¶ï¼Œå¦‚æ˜¯å¦æ˜¯ <code>taggedPointer</code> æŒ‡é’ˆï¼Œæ˜¯å¦é‡‡ç”¨ TLS ä¼˜åŒ– <code>autorelease</code> æ­¥éª¤ ï¼ˆä¸Šæ–‡æåˆ°ï¼‰ï¼Œæ˜¯å¦æ˜¯ç±»å¯¹è±¡ç­‰ã€‚</p><p>ä¸€èˆ¬æœ€ç»ˆä¼šæŒ‡å‘ <code>AutoreleasePoolPage::autorelease((id)this);</code> ï¼Œè¿™ä¸ <code>AutoreleasePoolPage::push()</code> çš„åˆ†ææƒ…å†µä¸€è‡´ã€‚</p><pre><code class="c++">static inline id autorelease(id obj){    ASSERT(!_objc_isTaggedPointerOrNil(obj));    id *dest __unused = autoreleaseFast(obj);#if SUPPORT_AUTORELEASEPOOL_DEDUP_PTRS    ASSERT(!dest  ||  dest == EMPTY_POOL_PLACEHOLDER  ||  (id)((AutoreleasePoolEntry *)dest)-&gt;ptr == obj);#else    ASSERT(!dest  ||  dest == EMPTY_POOL_PLACEHOLDER  ||  *dest == obj);#endif    return obj;}</code></pre><h2 id="ğŸ”—"><a href="#ğŸ”—" class="headerlink" title="ğŸ”—"></a>ğŸ”—</h2><p>[1] <a href="https://stackoverflow.com/questions/9086913/why-is-autoreleasepool-still-needed-with-arc#:~:text=(%2D1)%20%40autoreleasepool%20Forces%20process,footprint%20will%20be%20constantly%20increasing">Why is @autoreleasepool still needed with arc</a></p><p>[2] <a href="https://book.douban.com/subject/24720270/">Objective-C é«˜çº§ç¼–ç¨‹ iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†</a></p><p>[3] <a href="https://mp.weixin.qq.com/s/Z3MWUxR2SLtmzFZ3e5WzYQ">AutoreleasePool</a></p><p>[4] <a href="https://book.douban.com/subject/25829244/">Effective Objective-C 2.0 ç¼–å†™é«˜è´¨é‡iOSä¸OS Xä»£ç çš„52ä¸ªæœ‰æ•ˆæ–¹æ³•</a></p><p>[5] <a href="https://stackoverflow.com/questions/40993809/why-weak-object-will-be-added-to-autorelease-pool">Why __weak object will be added to autorelease pool?</a></p><p>[6] <a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/">é»‘å¹•åçš„Autorelease</a></p><p>[7] <a href="https://zhuanlan.zhihu.com/p/323200445">iOS AutoreleasePool</a></p><p>[8] <a href="https://github.com/xuhaodong1/objc4_838_source_code">nihao_objc4_838</a></p><p>[9] <a href="https://zh.wikipedia.org/zh-sg/%E9%81%B2%E6%BB%AF%E7%8F%BE%E8%B1%A1">è¿Ÿæ»ç°è±¡</a></p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOSä¸­çš„å†…å­˜ç®¡ç†ï½œARC</title>
      <link href="/2023/07/20/iOS%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BD%9CARC/"/>
      <url>/2023/07/20/iOS%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BD%9CARC/</url>
      
        <content type="html"><![CDATA[<h2 id="iOS-é‡‡ç”¨ä»€ä¹ˆå†…å­˜ç®¡ç†æ–¹å¼"><a href="#iOS-é‡‡ç”¨ä»€ä¹ˆå†…å­˜ç®¡ç†æ–¹å¼" class="headerlink" title="iOS é‡‡ç”¨ä»€ä¹ˆå†…å­˜ç®¡ç†æ–¹å¼"></a>iOS é‡‡ç”¨ä»€ä¹ˆå†…å­˜ç®¡ç†æ–¹å¼</h2><p>åœ¨ iOS ä¸­ï¼Œé‡‡ç”¨è‡ªåŠ¨å¼•ç”¨è®¡æ•°ï¼ˆARCï¼ŒAutomatic Reference Countingï¼‰æœºåˆ¶æ¥è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œè®©ç¼–è¯‘å™¨æ¥å¸®åŠ©å†…å­˜ç®¡ç†ï¼Œæ— éœ€ç¨‹åºå‘˜æ‰‹åŠ¨é”®å…¥ retainã€release ç­‰ä»£ç è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ç”±ç¼–è¯‘å™¨æ¥æ’å…¥ç›¸å…³å†…å­˜ç®¡ç†çš„ä»£ç ã€‚è¿™ä¸€ç‚¹çš„å¥½å¤„åœ¨äºèƒ½å¤Ÿé™ä½ç¨‹åºå´©æºƒã€å†…å­˜æ³„æ¼ç­‰é£é™©çš„åŒæ—¶ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šä¹Ÿèƒ½å¤Ÿå‡å°‘ç¨‹åºå‘˜çš„å·¥ä½œé‡ã€‚</p><span id="more"></span><p>ä¸å¼•ç”¨è®¡æ•°ç›¸å¯¹åº”çš„ï¼Œæ˜¯åƒåœ¾å›æ”¶ï¼ˆGCï¼ŒGarbage Collectionï¼‰æœºåˆ¶ï¼ŒJavaScriptã€Javaã€Golong ç­‰è¯­è¨€éƒ½é‡‡ç”¨è¿™ç§æœºåˆ¶è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œå®ƒå°†æ‰€æœ‰çš„å¯¹è±¡çœ‹æˆä¸€ä¸ªé›†åˆï¼Œç„¶ååœ¨ GC å¾ªç¯ä¸­å®šæ—¶ç›‘æµ‹æ´»åŠ¨å¯¹è±¡å’Œéæ´»åŠ¨å¯¹è±¡ï¼ŒåŠæ—¶å°†è¿™äº›ç”¨ä¸åˆ°çš„éæ´»åŠ¨å¯¹è±¡é‡Šæ”¾ä»¥é¿å…å†…å­˜æ³„æ¼ã€‚</p><p>ç›¸å¯¹äº GC æ¥è¯´ï¼Œå¼•ç”¨è®¡æ•°æ˜¯å±€éƒ¨çš„ï¼Œåœ¨è¿è¡Œæ—¶æ— éœ€é¢å¤–å¼€é”€ï¼ŒåŒæ—¶å…¶å†…å­˜å›æ”¶æ˜¯å¹³ç¨³ã€æ—¶æœºæ˜ç¡®çš„ï¼Œæ²¡æœ‰è¢«æŒæœ‰çš„å¯¹è±¡ä¼šè¢«ç«‹å³é‡Šæ”¾ï¼Œä½†åŒæ—¶ä¹Ÿå¼•å…¥äº†å¾ªç¯å¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„æ¼è¿™ç§æ–°çš„å†…å­˜ç®¡ç†é—®é¢˜ã€‚</p><h2 id="å†…å­˜ç®¡ç†çš„ç›¸å…³æ“ä½œ"><a href="#å†…å­˜ç®¡ç†çš„ç›¸å…³æ“ä½œ" class="headerlink" title="å†…å­˜ç®¡ç†çš„ç›¸å…³æ“ä½œ"></a>å†…å­˜ç®¡ç†çš„ç›¸å…³æ“ä½œ</h2><p>å½“ç”Ÿæˆæ–°çš„å¯¹è±¡æ—¶ï¼Œå…¶å¼•ç”¨è®¡æ•°ä¸º 1ï¼Œå½“æœ‰å…¶ä»–æŒ‡é’ˆæŒæœ‰è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œå…¶å¼•ç”¨è®¡æ•°åŠ  1ï¼Œå½“å…¶ä»–æŒ‡é’ˆé‡Šæ”¾è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œå…¶å¼•ç”¨è®¡æ•°å‡ 1ï¼Œå½“è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å˜ä¸º 0 æ—¶ï¼Œå¯¹è±¡ä¼šè¢«åºŸå¼ƒã€‚ä¸Šæ–‡ä¸­å‡ºç°çš„â€œç”Ÿæˆâ€ã€â€œæŒæœ‰â€ã€â€œé‡Šæ”¾â€ã€â€œåºŸå¼ƒâ€å¯¹åº”çš„ Objective-C çš„æ–¹æ³•å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th align="left">å¯¹è±¡æ“ä½œ</th><th>Objective-C æ–¹æ³•</th></tr></thead><tbody><tr><td align="left">ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡</td><td>alloc / new / copy / mutableCopy æ–¹æ³•</td></tr><tr><td align="left">æŒæœ‰å¯¹è±¡</td><td>retain æ–¹æ³•</td></tr><tr><td align="left">é‡Šæ”¾å¯¹è±¡</td><td>release æ–¹æ³•</td></tr><tr><td align="left">åºŸå¼ƒå¯¹è±¡</td><td>dealloc æ–¹æ³•</td></tr></tbody></table><p>åœ¨ MRC æœºåˆ¶ä¸‹ï¼Œç”±äºéœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨æ’å…¥ retainã€release ä»£ç ï¼Œæ— éœ€è€ƒè™‘å¼•ç”¨è®¡æ•°ï¼ŒæŒ‰å¦‚ä¸‹æ€è€ƒæ–¹å¼è¿›è¡Œä»£ç ç¼–å†™å°±å¯ä»¥ç®¡ç†å¥½å†…å­˜ï¼š</p><ul><li>è‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ï¼Œè‡ªå·±æ‰€æŒæœ‰ã€‚</li><li>éè‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ï¼Œè‡ªå·±ä¹Ÿèƒ½æŒæœ‰ã€‚</li><li>ä¸å†éœ€è¦è‡ªå·±æŒæœ‰çš„å¯¹è±¡æ—¶é‡Šæ”¾ã€‚</li><li>éè‡ªå·±æŒæœ‰çš„å¯¹è±¡æ— æ³•é‡Šæ”¾ã€‚</li></ul><p>ä½† ARC ä¸­ï¼Œç”±äºäº¤ç»™äº†ç¼–è¯‘å™¨è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ç›¸å½“äºå¼ºå¼•ç”¨ï¼Œä½†è¿™ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œç”±äºå¼•ç”¨è®¡æ•°ä¸èƒ½è¾¾åˆ° 0ï¼Œå¯¼è‡´å¯¹è±¡æ— æ³•è¢«é‡Šæ”¾ï¼Œå› æ­¤å¼•å…¥äº†æ‰€æœ‰æƒä¿®é¥°ç¬¦æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p><ul><li><p><code>__strong</code>ï¼šå¯¹è±¡çš„é»˜è®¤æ‰€æœ‰æƒä¿®é¥°ç¬¦ï¼Œå®ƒè¡¨ç¤ºå¯¹å¯¹è±¡çš„â€œå¼ºå¼•ç”¨â€ï¼Œåœ¨è¶…å‡ºå…¶ä½œç”¨åŸŸæ—¶ï¼Œå¼ºå¼•ç”¨å¤±æ•ˆã€‚</p></li><li><p><code>__weak</code>ï¼šä½¿ç”¨ <code>__weak </code> ä¿®é¥°çš„å¯¹è±¡ä¸ä¼šæŒæœ‰å¯¹è±¡ï¼Œå› æ­¤ä¸ä¼šä½¿å¯¹è±¡çš„å¼•ç”¨è®¡æ•°åŠ  1ï¼ŒåŒæ—¶å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡è¢«åºŸå¼ƒæ—¶ï¼Œå¼±å¼•ç”¨ä¼šæŒ‡å‘ nilï¼Œåˆ©ç”¨è¿™ä¸€ç‚¹å¯ä»¥æ¥è§£å†³å¾ªç¯å¼•ç”¨çš„åœºæ™¯ã€‚</p></li><li><p><code>__unsafe_unretained</code>ï¼šä¸ <code>__weak</code> ç±»ä¼¼ï¼Œ<code>__unsafe_unretained</code> ä¿®é¥°çš„å¯¹è±¡ä¸ä¼šæŒæœ‰å¯¹è±¡ï¼Œä½†åœ¨æŒ‡å‘çš„å¯¹è±¡è¢«åºŸå¼ƒæ—¶ï¼Œä¸ä¼šæŒ‡å‘ nilï¼Œä¼šå˜æˆé‡æŒ‡é’ˆã€‚ä½¿ç”¨ <code>__unsafe_unretained</code> æ—¶éœ€è¦æ˜ç¡®æ¸…æ¥šå®ƒçš„ç”Ÿå‘½å‘¨æœŸå°äºæˆ–è€…ç­‰äºè¢«æŒ‡å‘å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒä¸ Swift ä¸­çš„ <code>unowned</code> ç±»ä¼¼ï¼ŒåŒæ—¶å®ƒçš„æ•ˆç‡ä¹Ÿæ¯” <code>__weak</code> é«˜ã€‚</p></li><li><p><code>__autoreleasing</code>ï¼šä½¿ç”¨ <code>__autoreleaseing</code> ä¿®é¥°çš„å¯¹è±¡ä¼šè¢«æ³¨å†Œåˆ° AutoReleasePool ä¸­ï¼Œä¼šå»¶è¿Ÿåˆ° AutoReleasePool è¢«é”€æ¯æ—¶æ‰ä¼šè°ƒç”¨å¯¹è±¡çš„ release æ–¹æ³•ï¼Œè¿™ä¼šå»¶é•¿å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚ä½†ç”±äºç¼–è¯‘å™¨ä¼˜åŒ–çš„åŸå› ï¼Œå®é™…ç”¨åˆ°çš„åœ°æ–¹æ˜¯å¾ˆå°‘çš„ã€‚</p></li></ul><blockquote><p>å¾ªç¯å¼•ç”¨ï¼šå¯¹è±¡é—´çš„ç›¸äº’å¼ºå¼•ç”¨äº§ç”Ÿæœ‰å‘ç¯ï¼Œå¯¼è‡´æœ‰å‘ç¯ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ— æ³•è¢«é‡Šæ”¾ï¼ˆæ²¡æœ‰å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º 0ï¼‰ï¼Œè¿›è€Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><pre><code class="objective-c">// test æŒæœ‰è‡ªèº«å¯¼è‡´çš„å¾ªç¯å¼•ç”¨id test = [[Test alloc] init];[test setObject: test];</code></pre></blockquote><h2 id="alloc-amp-retain-amp-release-amp-dealloc-æºç æ¢ç©¶"><a href="#alloc-amp-retain-amp-release-amp-dealloc-æºç æ¢ç©¶" class="headerlink" title="alloc &amp; retain &amp; release &amp; dealloc æºç æ¢ç©¶"></a>alloc &amp; retain &amp; release &amp; dealloc æºç æ¢ç©¶</h2><h3 id="alloc"><a href="#alloc" class="headerlink" title="alloc"></a><code>alloc</code></h3><p>å¯¹è±¡å†…å­˜åˆ†é…çš„ä¸»è¦é€»è¾‘é›†ä¸­åœ¨ <code>callAlloc</code> ä¸ <code>_class_createInstanceFromZone</code> æ–¹æ³•é‡Œã€‚ä¸ºäº†æå‡æ•ˆç‡ï¼Œå…¶åœ¨ <code>callAlloc</code> é‡Œåˆ¤æ–­äº† <code>hasCustomAWZ</code>ï¼ˆè‡ªå®šä¹‰çš„ allocWithZone æ–¹æ³•ï¼‰ï¼Œæ²¡æœ‰æ‰§è¡Œ <code>_objc_rootAllocWithZone</code>ï¼Œæœ‰åˆ™è¿›å…¥æ¶ˆæ¯æ´¾å‘ <code>allocWithZone</code>ã€‚NSZone å·²è¢«ç³»ç»Ÿå¿½ç•¥ï¼Œç”±äºå†å²é—ç•™åŸå› æ‰å¾—ä»¥ä¿ç•™ï¼Œå› æ­¤è™½ç„¶æœ‰è®¸å¤šè·³è½¬æµç¨‹ï¼Œä½†æœ€ç»ˆéƒ½ä¼šæŒ‡å‘ <code>_class_createInstanceFromZone</code> æ–¹æ³•ã€‚</p><pre><code class="objc">static ALWAYS_INLINE idcallAlloc(Class cls, bool checkNil, bool allocWithZone=false){#if __OBJC2__    if (slowpath(checkNil &amp;&amp; !cls)) return nil;    if (fastpath(!cls-&gt;ISA()-&gt;hasCustomAWZ())) {        return _objc_rootAllocWithZone(cls, nil);    }#endif      if (allocWithZone) {        return ((id(*)(id, SEL, struct _NSZone *))objc_msgSend)(cls, @selector(allocWithZone:), nil);    }    return ((id(*)(id, SEL))objc_msgSend)(cls, @selector(alloc));}</code></pre><p><code>_class_createInstanceFromZone</code> ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼Œè·å–å¯¹è±¡å†…å­˜å ç”¨å¤§å°å¹¶åˆ†é…ã€è®¾ç½® <code>isa</code> æŒ‡é’ˆã€ä»¥åŠæ‰§è¡Œ C++ æ„é€ æ–¹æ³•ã€‚</p><p>è·å–å†…å­˜å ç”¨å¹¶åˆ†é…ï¼š<code>cls-&gt;instanceSize(extraBytes);</code> é€šè¿‡åœ¨ <code>cache</code> æˆ–è€… <code>ro()-&gt;instanceSize </code> (ç¼–è¯‘æ—¶ç¡®å®š)è·å–å ç”¨å†…å­˜ï¼Œå¹¶è¿›è¡Œå†…å­˜å¯¹é½ï¼Œæœ€åè°ƒç”¨ <code>calloc</code> æ–¹æ³•è¿›è¡Œå†…å­˜åˆ†é…ã€‚</p><p>è®¾ç½® <code>isa</code> æŒ‡é’ˆï¼šè®¾ç½®å¦‚ has_cxx_dtorï¼ˆæ˜¯å¦æœ‰ C++ ææ„å‡½æ•°ï¼‰ã€shiftclsï¼ˆç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡çš„åœ°å€ï¼‰ã€extra_rcï¼ˆå¼•ç”¨è®¡æ•°ï¼‰ ç­‰ä¿¡æ¯ã€‚</p><p>æ‰§è¡Œ C++ æ„é€ æ–¹æ³•ï¼šä»åŸºç±»å¼€å§‹å‘ä¸‹é€’å½’æ‰§è¡Œ C++ çš„æ„é€ å‡½æ•°ã€‚</p><pre><code class="objc">// ç®€åŒ–åä»£ç static ALWAYS_INLINE id_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone,                              int construct_flags = OBJECT_CONSTRUCT_NONE,                              bool cxxConstruct = true,                              size_t *outAllocatedSize = nil){    bool hasCxxCtor = cxxConstruct &amp;&amp; cls-&gt;hasCxxCtor();    bool hasCxxDtor = cls-&gt;hasCxxDtor();    bool fast = cls-&gt;canAllocNonpointer();    size_t size;    // è·å–å®ä¾‹å˜é‡å†…å­˜å ç”¨å¤§å°    size = cls-&gt;instanceSize(extraBytes);    id obj;    obj = (id)calloc(1, size);           // è®¾ç½® isa æŒ‡é’ˆ    obj-&gt;initInstanceIsa(cls, hasCxxDtor);    if (fastpath(!hasCxxCtor)) {        return obj;    }    construct_flags |= OBJECT_CONSTRUCT_FREE_ONFAILURE;    // æ‰§è¡Œ C++ æ„é€ å‡½æ•°    return object_cxxConstructFromClass(obj, cls, construct_flags);}</code></pre><blockquote><p>NSZoneï¼šå®ƒæ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜ç¢ç‰‡åŒ–è€Œå¼•å…¥çš„ç»“æ„ï¼Œå¯¹å†…å­˜åˆ†é…çš„åŒºåŸŸæœ¬èº«è¿›è¡Œå¤šé‡åŒ–ç®¡ç†ï¼Œæ ¹æ®ä½¿ç”¨å¯¹è±¡çš„ç›®çš„ã€å¯¹è±¡çš„å¤§å°åˆ†é…å†…å­˜ï¼Œä»è€Œæé«˜äº†å†…å­˜ç®¡ç†çš„æ•ˆç‡ã€‚ä½†ç›®å‰è¿è¡Œæ—¶ç³»ç»Ÿä¸­çš„å†…å­˜ç®¡ç†æœ¬èº«å·²æå…·æ•ˆç‡ï¼Œä½¿ç”¨ NSZone æ¥ç®¡ç†åè€Œä¼šå¼•èµ·å†…å­˜ä½¿ç”¨æ•ˆç‡ä½ä¸‹ä»¥åŠæºä»£ç å¤æ‚åŒ–ç­‰é—®é¢˜ï¼Œå› æ­¤è¿è¡Œæ—¶åªæ˜¯ç®€å•åœ°å¿½ç•¥äº† NSZone çš„æ¦‚å¿µã€‚</p></blockquote><h4 id="retain"><a href="#retain" class="headerlink" title="retain"></a>retain</h4><p>retain ä¼šå°†å¯¹è±¡çš„å¼•ç”¨è®¡æ•° + 1ï¼Œå…¶ä¸»è¦é€»è¾‘ä¸»è¦é›†ä¸­åœ¨ rootRetain æ–¹æ³•ä¸­ï¼Œå¼•ç”¨è®¡æ•°ä¸€èˆ¬ä¼šå­˜å‚¨åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼Œé¦–å…ˆæ˜¯ isa æŒ‡é’ˆçš„ extra_rc åŸŸä¸­ï¼Œè‹¥æœ‰æº¢å‡ºåˆ™ä¼šå°†ä¸€åŠçš„å¼•ç”¨è®¡æ•°å€¼å­˜å‚¨åˆ° SideTable ä¸­ã€‚</p><pre><code class="objective-c">// ç®€åŒ–åä»£ç ALWAYS_INLINE idobjc_object::rootRetain(bool tryRetain, objc_object::RRVariant variant){    bool sideTableLocked = false;    bool transcribeToSideTable = false;    isa_t oldisa;    isa_t newisa;    oldisa = LoadExclusive(&amp;isa.bits); // åŠ è½½ isa æŒ‡é’ˆ    do {        newisa = oldisa;        uintptr_t carry;        newisa.bits = addc(newisa.bits, RC_ONE, 0, &amp;carry);  // extra_rc++                  // è‹¥ newisa.extra_rc++ æº¢å‡ºï¼Œå†è°ƒç”¨ä¸€æ¬¡ï¼Œå°† variant è®¾ç½®ä¸º RRVariant::Full        if (slowpath(carry)) {            if (variant != RRVariant::Full) {                ClearExclusive(&amp;isa.bits);                return rootRetain_overflow(tryRetain);            }            // ç•™ä¸‹ä¸€åŠçš„å¼•ç”¨è®¡æ•°å€¼ï¼Œå¹¶å°†å¦ä¸€åŠæ‹·è´åˆ° SideTableä¸­            if (!tryRetain &amp;&amp; !sideTableLocked) sidetable_lock();            sideTableLocked = true;            transcribeToSideTable = true;            newisa.extra_rc = RC_HALF;            newisa.has_sidetable_rc = true;        }    } while (slowpath(!StoreExclusive(&amp;isa.bits, &amp;oldisa.bits, newisa.bits)));    if (variant == RRVariant::Full) {        if (slowpath(transcribeToSideTable)) {            // æ‹·è´ä¸€åŠçš„å¼•ç”¨è®¡æ•°å€¼åˆ° SideTable ä¸­            sidetable_addExtraRC_nolock(RC_HALF);        }        if (slowpath(!tryRetain &amp;&amp; sideTableLocked)) sidetable_unlock();    }    return (id)this;}</code></pre><p>å…³äº SideTableï¼Œå…¶æœ¬èº«æ˜¯å…¨å±€çš„ SideTables() çš„ value å…ƒç´ ï¼Œkey åˆ™æ˜¯é€šè¿‡å¯¹è±¡æŒ‡é’ˆåœ°å€çš„åç§»æ˜ å°„ï¼Œæ‰¾åˆ°å±äºå¯¹è±¡çš„ SideTableï¼Œå†é€šè¿‡å¯¹è±¡çš„åœ°å€ï¼Œè·å¾—å±äºå¯¹è±¡çš„å¼•ç”¨è®¡æ•°è¡¨ã€‚å½“ SideTable ä¸­å¯¹è±¡çš„å¼•ç”¨è®¡æ•°æº¢å‡ºæ—¶ï¼Œä¼šå°†æ ‡å¿—ä½ï¼ˆSIDE_TABLE_RC_PINNEDï¼‰ç½®ä¸º 1ã€‚</p><pre><code class="c++">// é€šè¿‡å¯¹è±¡çš„åœ°å€åç§»ä¸ StripeCount å¤§å°æ˜ å°„åˆ°å±äºå¯¹è±¡çš„ SideTable çš„ä¸‹æ ‡static unsigned int indexForPointer(const void *p) {    uintptr_t addr = reinterpret_cast&lt;uintptr_t&gt;(p);    return ((addr &gt;&gt; 4) ^ (addr &gt;&gt; 9)) % StripeCount;}// åŠ å…¥é¢å¤–çš„å¼•ç”¨è®¡æ•°åˆ° SideTable ä¸­bool objc_object::sidetable_addExtraRC_nolock(size_t delta_rc){    SideTable&amp; table = SideTables()[this];    size_t&amp; refcntStorage = table.refcnts[this];    size_t oldRefcnt = refcntStorage;    if (oldRefcnt &amp; SIDE_TABLE_RC_PINNED) return true;    uintptr_t carry;    size_t newRefcnt =         addc(oldRefcnt, delta_rc &lt;&lt; SIDE_TABLE_RC_SHIFT, 0, &amp;carry);    if (carry) {        refcntStorage =            SIDE_TABLE_RC_PINNED | (oldRefcnt &amp; SIDE_TABLE_FLAG_MASK);        return true;    }    else {        refcntStorage = newRefcnt;        return false;    }}</code></pre><h4 id="release"><a href="#release" class="headerlink" title="release"></a>release</h4><p>ä¸ retain å¯¹åº”ï¼Œrelease æ–¹æ³•çš„ä¸»è¦é€»è¾‘é›†ä¸­åœ¨ rootRelease ä¸­ï¼Œå®ƒä¼šå°†å¯¹è±¡çš„å¼•ç”¨è®¡æ•° - 1ï¼Œå¦‚æœå‘ç”Ÿä¸‹æº¢ï¼ˆunderflowï¼‰ï¼Œåˆ™ä¼šä» SideTable ä¸­å€Ÿå–ä¸€åŠå¼•ç”¨è®¡æ•°å€¼ï¼Œè‹¥å¼•ç”¨è®¡æ•°ä¸º 0 åˆ™é”€æ¯å¯¹è±¡ã€‚</p><pre><code class="c++">// ç®€åŒ–åä»£ç ALWAYS_INLINE boolobjc_object::rootRelease(bool performDealloc, objc_object::RRVariant variant){    if (slowpath(isTaggedPointer())) return false;    bool sideTableLocked = false;    isa_t newisa, oldisa;    oldisa = LoadExclusive(&amp;isa.bits);retry:    do {        newisa = oldisa;        uintptr_t carry;        newisa.bits = subc(newisa.bits, RC_ONE, 0, &amp;carry);  // extra_rc--        if (slowpath(carry)) { // å‘ç”Ÿä¸‹æº¢            goto underflow;        }    } while (slowpath(!StoreReleaseExclusive(&amp;isa.bits, &amp;oldisa.bits, newisa.bits)));        // é”€æ¯å¯¹è±¡    if (slowpath(newisa.isDeallocating()))        goto deallocate;    return false; underflow:    newisa = oldisa;    if (slowpath(newisa.has_sidetable_rc)) {        if (variant != RRVariant::Full) {            ClearExclusive(&amp;isa.bits);            return rootRelease_underflow(performDealloc);        }              auto borrow = sidetable_subExtraRC_nolock(RC_HALF);                bool emptySideTable = borrow.remaining == 0;              if (borrow.borrowed &gt; 0) {            newisa.extra_rc = borrow.borrowed - 1;            newisa.has_sidetable_rc = !emptySideTable;        }        if (emptySideTable)                sidetable_clearExtraRC_nolock();    }deallocate:    if (performDealloc) {        ((void(*)(objc_object *, SEL))objc_msgSend)(this, @selector(dealloc));    }    return true;}</code></pre><h4 id="dealloc"><a href="#dealloc" class="headerlink" title="dealloc"></a>dealloc</h4><p>å¯¹è±¡å†…å­˜é‡Šæ”¾çš„ä¸»è¦é€»è¾‘é›†ä¸­åœ¨ <code>rootDealloc</code> ä¸ <code>objc_destructInstance</code> æ–¹æ³•é‡Œã€‚å…¶ä¸­ï¼ŒtaggedPointer å¯¹è±¡æ— éœ€é‡Šæ”¾(å…¶åœ¨æ ˆä¸Šå­˜å‚¨)ã€è‹¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶åˆ™ç›´æ¥ <code>free</code>ï¼Œå¦åˆ™è¿›å…¥ <code>objc_destructInstance</code>ã€‚</p><p><code>dealloc</code> åœ¨æ‰§è¡Œæœ€ç»ˆé‡Šæ”¾æ“ä½œï¼ˆreleaseï¼‰çš„é‚£ä¸ªçº¿ç¨‹ä¸­è¢«æ‰§è¡Œï¼Œè€Œä¸æ˜¯ä¸»çº¿ç¨‹ï¼›</p><p>åœ¨ <code>dealloc</code> ä¹Ÿä¸è¦ä½¿ç”¨ <code>__weak __typeof(self)weak_self = self</code> è¿™æ ·çš„ä»£ç ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ weak æ³¨å†Œæ—¶ä¼šåˆ¤æ–­å…¶æ˜¯å¦å¤„äº <code>deallocating</code> çŠ¶æ€ï¼Œä¼šäº§ç”Ÿå´©æºƒã€‚</p><ol><li><code>isa.nonpointer</code> ä¸º 1ï¼Œå³å­˜åœ¨ <code>ISA_BITFIELD</code> ä½åŸŸæ•°æ®</li><li>æ­¤å¯¹è±¡ä¸æ˜¯å…¶ä»–å¯¹è±¡çš„å¼±å¼•ç”¨å¯¹è±¡</li><li>æ­¤å¯¹è±¡æ²¡æœ‰å…³è”å¯¹è±¡</li><li>æ²¡æœ‰ C++ çš„ææ„å‡½æ•°</li><li>ä¸å­˜åœ¨ SideTable è®°å½•å¼•ç”¨è®¡æ•°</li></ol><pre><code class="objc">inline voidobjc_object::rootDealloc(){    if (isTaggedPointer()) return;  // fixme necessary?    if (fastpath(isa.nonpointer                     &amp;&amp;                 !isa.weakly_referenced             &amp;&amp;                 !isa.has_assoc                     &amp;&amp;#if ISA_HAS_CXX_DTOR_BIT                 !isa.has_cxx_dtor                  &amp;&amp;#else                 !isa.getClass(false)-&gt;hasCxxDtor() &amp;&amp;#endif                 !isa.has_sidetable_rc))    {        assert(!sidetable_present());        free(this);    }     else {        object_dispose((id)this);    }}</code></pre><p><code>objc_destructInstance</code> åˆ™æ˜¯æ¸…ç†å¯¹è±¡å…³è”çš„èµ„æºï¼ŒC++ çš„ææ„å‡½æ•°ã€å…³è”å¯¹è±¡ã€SideTable ä¸­çš„å¼±å¼•ç”¨æŒ‡é’ˆå’Œå¼•ç”¨è®¡æ•°è¡¨ï¼Œä¹‹åå† <code>free</code>ã€‚åœ¨ C++ ææ„å‡½æ•°ä¸­ï¼Œä¼šéå†å…¶æ‰€æœ‰çš„å®ä¾‹å˜é‡ï¼Œå½¢å¦‚ <code>objc_storeStrong(&amp;ivar, null)</code> è°ƒç”¨ï¼Œåˆ™ä¼šå¯¹æ‰€æœ‰çš„å®ä¾‹å˜é‡è¿›è¡Œ releaseï¼Œå¹¶å°†å…¶ç½®ä¸º nilã€‚åŒæ—¶ç»ç”±ç¼–è¯‘å™¨æ’å…¥ç±»ä¼¼ <code>[super dealloc]</code>ï¼Œåˆ™ä¼šå®ç°äº†ç”±å­ç±»å¼€å§‹éå†åˆ°åŸºç±»çš„ <code>dealloc</code>ã€‚</p><pre><code class="objc">void *objc_destructInstance(id obj) {    if (obj) {        // Read all of the flags at once for performance.        bool cxx = obj-&gt;hasCxxDtor();        bool assoc = obj-&gt;hasAssociatedObjects();        // This order is important.        if (cxx) object_cxxDestruct(obj);        if (assoc) _object_remove_assocations(obj, /*deallocating*/true);        obj-&gt;clearDeallocating();    }    return obj;}</code></pre><h2 id="ä¸è¦åœ¨-init-å’Œ-dealloc-ä¸­è°ƒç”¨-accessor-æ–¹æ³•"><a href="#ä¸è¦åœ¨-init-å’Œ-dealloc-ä¸­è°ƒç”¨-accessor-æ–¹æ³•" class="headerlink" title="ä¸è¦åœ¨ init å’Œ dealloc ä¸­è°ƒç”¨ accessor æ–¹æ³•"></a>ä¸è¦åœ¨ init å’Œ dealloc ä¸­è°ƒç”¨ accessor æ–¹æ³•</h2><p>åœ¨ <code>init</code>ã€å’Œ <code>dealloc</code> ä¸­ï¼Œè¿™ä¸ªé˜¶æ®µå¤„äºæœªå®Œå…¨åˆå§‹åŒ–æˆåŠŸæˆ–è€…æ­£åœ¨åºŸå¼ƒé˜¶æ®µï¼ŒåŒæ—¶ç”±äºç»§æ‰¿ã€å¤šæ€ç‰¹æ€§ï¼Œæœ¬æ¥ç›®çš„åˆ°è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•è°ƒç”¨åˆ°äº†å­ç±»ï¼Œå°±å¯èƒ½ä¼šå‡ºç°é”™è¯¯ï¼Œä¾‹å¦‚åœ¨ init ä¸­ï¼š</p><pre><code class="objc">@interface BaseClass : NSObject@property(nonatomic) NSString* info;@end@implementation BaseClass- (instancetype)init {      if ([super init]) {        self.info = @"baseInfo";     }     return self;}@end@interface SubClass : BaseClass@end@interface SubClass ()@property (nonatomic) NSString* subInfo;@end@implementation SubClass- (instancetype)init {     if (self = [super init]) {         self.subInfo = @"subInfo";     }     return self;}- (void)setInfo:(NSString *)info {    [super setInfo:info];     NSString* copyString = [NSString stringWithString:self.subInfo]; NSLog(@"%@",copyString);}@end</code></pre><p>è¿™æ—¶å€™åˆ›å»ºä¸€ä¸ª SubClass å®ä¾‹å˜é‡ï¼Œç”±äºç»§æ‰¿ã€å¤šæ€ç‰¹æ€§ä¼šè°ƒç”¨åˆ°å­ç±»çš„ <code>setInfo</code>ï¼Œå­ç±»çš„ accessor å®ç°çš„ä»£ç å®Œå…¨ä»¥å­ç±»å·²å®Œå…¨åˆå§‹åŒ–çš„å‰æç¼–å†™çš„ï¼Œæ­¤æ—¶çš„ <code>subInfo</code> è¿˜å¹¶æœªå®Œå…¨åˆå§‹åŒ–ï¼Œè¿›è€Œä¼šé€ æˆå´©æºƒã€‚</p><p>è¿™ä¸€ç‚¹ä¸ Swift ä¸­ï¼Œæ„é€ å™¨åœ¨ç¬¬ä¸€é˜¶æ®µæ„é€ å®Œæˆä¹‹å‰ï¼Œä¸èƒ½è°ƒç”¨ä»»ä½•å®ä¾‹æ–¹æ³•ï¼Œä¸èƒ½è¯»å–ä»»ä½•å®ä¾‹å±æ€§çš„å€¼ï¼Œä¸èƒ½å¼•ç”¨ <code>self</code> ä½œä¸ºä¸€ä¸ªå€¼ç±»ä¼¼ã€‚</p><p>ç¬¬ä¸€é˜¶æ®µï¼šç±»ä¸­çš„æ¯ä¸ªå­˜å‚¨å‹å±æ€§èµ‹ä¸€ä¸ªåˆå§‹å€¼ã€‚</p><p>ç¬¬äºŒé˜¶æ®µï¼šç»™æ¯ä¸ªç±»ä¸€æ¬¡æœºä¼šï¼Œåœ¨æ–°å®ä¾‹å‡†å¤‡ä½¿ç”¨ä¹‹å‰è¿›ä¸€æ­¥è‡ªå®šä¹‰å®ƒä»¬çš„å­˜å‚¨å‹å±æ€§ã€‚</p><p>ä¸¤æ®µå¼æ„é€ è¿‡ç¨‹çš„ä½¿ç”¨è®©æ„é€ è¿‡ç¨‹æ›´å®‰å…¨ï¼ŒåŒæ—¶åœ¨æ•´ä¸ªç±»å±‚çº§ç»“æ„ä¸­ç»™äºˆäº†æ¯ä¸ªç±»å®Œå…¨çš„çµæ´»æ€§ã€‚ä¸¤æ®µå¼æ„é€ è¿‡ç¨‹å¯ä»¥é˜²æ­¢å±æ€§å€¼åœ¨åˆå§‹åŒ–ä¹‹å‰è¢«è®¿é—®ï¼Œä¹Ÿå¯ä»¥é˜²æ­¢å±æ€§è¢«å¦å¤–ä¸€ä¸ªæ„é€ å™¨æ„å¤–åœ°èµ‹äºˆä¸åŒçš„å€¼ã€‚</p><blockquote><p>åœ¨ã€ŠEffective Objective-C 2.0 ç¼–å†™é«˜è´¨é‡iOSä¸OS Xä»£ç çš„æœ‰æ•ˆ52ä¸ªæœ‰æ•ˆæ–¹æ³•ã€‹ä¸­ä¹ŸæŒ‡å‡ºï¼š</p><p>åœ¨deallocé‡Œä¸è¦è°ƒç”¨å±æ€§çš„å­˜å–æ–¹æ³•ï¼Œå› ä¸ºæœ‰äººå¯èƒ½ä¼šè¦†å†™è¿™äº›æ–¹æ³•ï¼Œå¹¶äºå…¶ä¸­åšä¸€äº›æ— æ³•å†å›æ”¶é˜¶æ®µå®‰å…¨æ‰§è¡Œçš„æ“ä½œã€‚æ­¤å¤–ï¼Œå±æ€§å¯èƒ½æ­£å¤„äºâ€œé”®å€¼è§‚å¯Ÿâ€(Key-Value Observationï¼ŒKVO)æœºåˆ¶çš„ç›‘æ§ä¹‹ä¸‹ï¼Œè¯¥å±æ€§çš„è§‚å¯Ÿè€…(Observer)å¯èƒ½ä¼šåœ¨å±æ€§å€¼æ”¹å˜æ—¶â€œä¿ç•™â€æˆ–ä½¿ç”¨è¿™ä¸ªå³å°†å›æ”¶çš„å¯¹è±¡ã€‚è¿™ç§åšæ³•ä¼šä»¤è¿è¡ŒæœŸç³»ç»Ÿçš„çŠ¶æ€å®Œå…¨å¤±è°ƒï¼Œä»è€Œå¯¼è‡´ä¸€äº›è«åå…¶å¦™çš„é”™è¯¯ã€‚</p></blockquote><h2 id="ğŸ”—"><a href="#ğŸ”—" class="headerlink" title="ğŸ”—"></a>ğŸ”—</h2><p>[1] <a href="https://book.douban.com/subject/24720270/">Objective-C é«˜çº§ç¼–ç¨‹ iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†</a></p><p>[2] <a href="http://blog.sunnyxx.com/2014/04/02/objc_dig_arc_dealloc/">ARCä¸‹deallocè¿‡ç¨‹åŠ.cxxdestructçš„æ¢ç©¶</a></p><p>[3] <a href="https://draveness.me/rr/">é»‘ç®±ä¸­çš„ retain å’Œ release</a></p><p>[4] <a href="https://cloud.tencent.com/developer/article/1143323">ä¸ºä»€ä¹ˆä¸èƒ½åœ¨initå’Œdeallocå‡½æ•°ä¸­ä½¿ç”¨accessoræ–¹æ³•</a></p><p>[5] <a href="https://swift.bootcss.com/02_language_guide/14_Initialization#memberwise-initializers-for-structure-types">Swiftæ„é€ è¿‡ç¨‹</a></p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nihao&#39; 2022å¹´ç»ˆæ€»ç»“</title>
      <link href="/2022/12/24/2022-12-24-nihao%E7%9A%842022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
      <url>/2022/12/24/2022-12-24-nihao%E7%9A%842022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p>2022 å¯¹æˆ‘æ¥è¯´è¿‡çš„å¾ˆå¿«ï¼Œè¿˜è®°å¾— 2022 å¹´å¹´åˆçš„æ—¶å€™ï¼Œæ­å·åˆšå¥½çªå‘äº†ç–«æƒ…ï¼Œè€Œæˆ‘æ‰€åœ¨çš„å°åŒºåˆšå¥½æ˜¯ç–«æƒ…çš„é‡ç‚¹é˜²æŠ¤åŒºã€‚å› æ­¤ï¼Œç†æ‰€å½“ç„¶çš„æˆ‘è¢«æ‹‰è¿›äº†é…’åº—éš”ç¦»ï¼Œæ¯å¤©è¿‡ç€æ ¸é…¸ - ç›’é¥­çš„ç”Ÿæ´»ï¼Œè¿™å‡ ä¹èŠ±å…‰äº†æ˜¥èŠ‚çš„æ—¶å…‰ï¼›æ¯å¤©éƒ½æœ‰ä¸€æ¬¡çš„æ ¸é…¸æ£€æµ‹ï¼Œå‡ ä¹æ—¶é—´éƒ½åˆ†é…åœ¨äº†æ—©ä¸Š 6 ç‚¹å·¦å³ï¼Œä¸æ­¤åŒæ—¶ï¼Œèµ°å»Šä¸Šçš„å¤§å–‡å­çš„å™ªéŸ³ä¹Ÿä¸å ªå…¥è€³ï¼Œèµ·åˆæœ€éš¾ä»¥æ¥å—çš„æ˜¯é¼»å’½æ‹­å­ï¼Œæ¯æ¬¡åšå®Œéƒ½æ„Ÿè§‰å¾ˆç”Ÿæ°”ï¼Œä¸è¿‡å¥½åœ¨æˆ‘éƒ½èƒ½æ¥å—ã€‚</p><span id="more"></span><p>ç°åœ¨çœ‹æ¥ï¼Œæˆ‘å¾ˆåº†å¹¸åœ¨é‚£ä¸ªæ—¶å€™èƒ½å¤Ÿæœ‰ä¸€æ®µç‹¬ç«‹æ€è€ƒæ—¶å…‰ã€‚</p><p>å¿ƒæ€çš„ç¬¬ä¸€ä¸ªè½¬å˜æ˜¯åˆ«ç»™è‡ªå·±è®¾é™ï¼Œè‡ªå·±ä»€ä¹ˆéƒ½å¯ä»¥åšï¼Œä¹Ÿæ„¿æ„å°è¯•æ–°é²œçš„ä¸œè¥¿ï¼Œåªè¦æˆ‘æ„¿æ„ã€‚</p><h2 id="é˜…è¯»"><a href="#é˜…è¯»" class="headerlink" title="é˜…è¯»"></a>é˜…è¯»</h2><p>è¯»ä¹¦çš„äººæ˜¯å¾ˆä¸å¸¸è§çš„ï¼Œä¸€ç”Ÿä¸­é‡åˆ°äº†é‚£ä¹ˆå¤šäººï¼Œä¸»åŠ¨è¯»ä¹¦çš„äººåªå äº†å¾ˆå°‘çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ¯ä¸€ä¸ªäººéƒ½çŸ¥é“é˜…è¯»æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œä½†æ˜¯å´éƒ½ä¸æ„¿æ„å»å°è¯•ï¼Œæˆ‘è®¤ä¸ºé€ æˆè¿™ç§çŠ¶å†µçš„åŸå› æ˜¯äººçš„æƒ°æ€§æ€ç»´ï¼Œè·Ÿäººä¸å–œæ¬¢è·³å‡ºè‡ªå·±çš„èˆ’é€‚åœˆå¾ˆç›¸åƒã€‚</p><p><img src="/images/blog/IMG_0120.jpeg" alt="IMG_0120"></p><p>ä¸è¿‡é—æ†¾çš„äº‹ï¼Œçœ‹çš„ä¹¦ä¸ç®—å¤šï¼Œç”šè‡³æœ‰æ•°æœ¬éƒ½æ˜¯çœ‹åˆ°ä¸€åŠå°±æ²¡çœ‹äº†ã€‚åŒæ—¶ï¼Œæ¯å¤©åˆ†é…è¯»ä¹¦çš„æ—¶é—´æ²¡æœ‰ä¸€ä¸ªè‰¯å¥½çš„è§„å¾‹ï¼Œæœ‰äº›æ—¶å€™æŠ½ä¸å‡ºç²¾åŠ›æ¥çœ‹ï¼Œå°±æŠŠå®Œå®Œæ•´æ•´çœ‹å®Œçš„æŒ‰å…¶æ—¶é—´é¡ºåºåšä¸€ä¸ªç®€å•æ¦‚è¿°ï¼š</p><p>ã€Šè°æ€äº†å¥¹ã€‹ï¼š</p><p>æ‚¬ç–‘ä½œå®¶ä¸œé‡åœ­å¾çš„çŸ­ç¯‡å°è¯´ï¼Œä¸è¿‡è¿™ç±»ä¹¦ç±ä¸»è¦åå‘æ‚¬ç–‘ä¸è§£å¯†ï¼Œå°±ä¸ªäººè€Œè¨€è§¦åŠ¨ä¸æ˜¯å¾ˆå¤§ï¼Œä¸ç®—å¾ˆæ¨èã€‚</p><p>ã€Šäººç±»ç®€å²ï¼šä»åŠ¨ç‰©åˆ°ä¸Šå¸ã€‹ï¼š</p><p>å°¤ç“¦å°”Â·èµ«æ‹‰åˆ©çš„äººç±»ç®€å²ä¸‰éƒ¨æ›²çš„é¦–éƒ¨ï¼Œä¸»è¦è®²è¿°äº†äººç±»ä»åŸå§‹ç”Ÿæ´»åˆ°è¿‘ä»£çš„ç§ç§å˜åŒ–ï¼Œä»è®¤çŸ¥é©å‘½ã€å†œä¸šé©å‘½å’Œç§‘å­¦é©å‘½ã€‚å…¶ä¸­è®¸å¤šè§‚ç‚¹éƒ½ç»™äººè€³ç›®ä¸€æ–°çš„æ„Ÿå—ï¼Œç”šè‡³ç§°ä¹‹ä¸ºæŒ¯è‹å‘è©ä¹Ÿä¸è¶³ä¸ºè¿‡ï¼Œååˆ†æ¨èä¸€è¯»ã€‚</p><p>ã€Šåˆ€é”‹ã€‹ï¼š</p><p>å— B ç«™æŸ UP ä¸»æ¨èï¼Œåˆ€é”‹ç®—æ¯›å§†ä¸­æ™šå¹´ä¸­åå“çƒ­çƒˆçš„ä¸€éƒ¨ä½œå“ã€‚è®²è¿°äº†ä¸»è§’ â€œæ‹‰é‡Œâ€ çš„ä¸€ç”Ÿï¼Œæ‹‰ä¸€ä»½ä¹‹å‰å†™çš„ä¹¦è¯„å§ï¼š</p><p>æˆ˜äº‰çš„å‰§çƒˆå†²å‡»è®©æ‹‰é‡Œé€‰æ‹©äº†åœä¸‹æ¥ï¼Œå¥½å¥½çœ‹çœ‹è¿™ä¸ªä¸–ç•Œï¼Œå¯»æ‰¾ç”Ÿå‘½çš„æ„ä¹‰ã€‚åœ¨å¯»æ‰¾è¿‡ç¨‹ä¸­æ¸¸å†å››æ–¹ï¼Œæœ€ç»ˆä»–æ·¡æ³Šä¸”å®é™ï¼Œè¿½å¯»ç€å¿ƒä¸­çš„è‡ªç”±ã€‚è®©æˆ‘ç¾¡æ…•ä¸”å®³æ€•çš„ï¼Œæ˜¯å¯¹ä»»ä½•äº‹éƒ½æœ‰ä¸€ä»½åšå®šçš„ä»å®¹å’Œæœæ–­ã€‚ </p><p>ã€ŠåŠå°æ—¶æ¼«ç”»ç»æµå­¦ã€‹ï¼š</p><p>ä¸€éƒ¨è¶£å‘³æ¼«ç”»å¼çš„ä¹¦ï¼Œä»‹ç»äº†ç»æµå­¦æ–¹é¢çš„åŸºç¡€çŸ¥è¯†ï¼Œç®€å•ä¸”è¯™è°ã€‚å¦‚æœä½ æƒ³äº†è§£æœ‰å…³ç»æµå­¦æ–¹é¢çš„çŸ¥è¯†ï¼Œè¿™æœ¬ä¹¦å¯ä»¥ä½œä¸ºä¸€æœ¬ç®€å•çš„å¯è’™ä¹¦ç±ã€‚</p><p>ã€Šå¯Œçˆ¸çˆ¸ç©·çˆ¸çˆ¸ã€‹ï¼š</p><p>ç½—ä¼¯ç‰¹ Â· æ¸…å´çš„å¯Œçˆ¸çˆ¸ç³»åˆ—çš„é¦–éƒ¨ä½œå“ï¼Œä»¥å€¡å¯¼â€œè´¢å•†â€çš„æ•™è‚²æˆä¸ºç•…é”€ä¹¦ï¼Œå¯ä»¥ä½œä¸ºç»æµæ–¹é¢çš„æ•™è‚²å¯è’™ä¹¦ã€‚å…¶ä¸­æœ‰è®¸å¤šè§‚ç‚¹æ¯”è¾ƒå®ç”¨æˆ–è€…å¯ä»¥ç§°ä¹‹ä¸ºé¸¡è¡€ï¼Œä½†æ€»ä½“è€Œè¨€å®ƒå¼•å¯¼ä½ é¼“èµ·å‹‡æ°”å»åšæå‡è‡ªå·±çš„èµ„äº§ï¼Œå€¡å¯¼å¤šå­¦ä¹ å¤šä¸°å¯Œè‡ªæˆ‘ã€‚</p><h2 id="ç®—æ³•"><a href="#ç®—æ³•" class="headerlink" title="ç®—æ³•"></a>ç®—æ³•</h2><img src="/images/blog/Screenshot 2022-12-24 at 22.39.00.png" alt="Screenshot 2022-12-24 at 22.39.00" style="zoom:100%;"><p>èµ·åˆå­¦ç®—æ³•å•çº¯æ˜¯ä¸ºäº†é¢è¯•ï¼Œä¸è¿‡åæ¥æ…¢æ…¢å˜æˆäº†ä¸€ç§ä¹ æƒ¯ï¼Œè¿›è€Œæ¼”å˜æˆäº†ä¸€ç§å…´è¶£ã€‚</p><p>ä¸ºæ­¤æˆ‘å‚åŠ äº†å·®ä¸å¤šåŠå¹´çš„ LeetCode å‘¨èµ›ï¼Œåœ¨ Github ä¸Šå¼€äº†ä¸€ä¸ªä»“åº“è®°å½• LeetCode æ¯æ—¥ä¸€é¢˜ <a href="https://github.com/xuhaodong1/nihao_algorithm_notes">nihao_algorithm_nots</a>ï¼Œåé¢å¸Œæœ›èƒ½å¤Ÿå¤šå†™ä¸€å†™é¢˜è§£ï¼Œèƒ½å¤Ÿæœ‰ç³»ç»Ÿæ€§çš„æ€»ç»“ã€‚</p><p>å¦‚æœä½ ä¹Ÿå¯¹ç®—æ³•æ„Ÿå…´è¶£ï¼Œä¸å¦¨è”ç³»æˆ‘ä¸€èµ·å­¦ä¹ ä¸è¿›æ­¥ã€‚</p><h2 id="Blogï¼š"><a href="#Blogï¼š" class="headerlink" title="Blogï¼š"></a>Blogï¼š</h2><img src="/images/blog/image-20221226101049638.png" alt="image-20221226101049638" style="zoom:80%;"><p>2022 å¹´ä¸€å…±äº§å‡º 7 ç¯‡åšå®¢ï¼Œå¹³å‡ 1.7 ä¸ªæœˆå‡ºäº§ä¸€ç¯‡ï¼Œå¯¹æˆ‘æ¥è¯´ä¸ç®—é«˜æ•ˆï¼Œä½†ä¹Ÿç»å¯¹ä¸ç®—ä½äº§ã€‚æ¯ä¸€ç¯‡åšå®¢éƒ½ç®—æ˜¯è‰¯è‹¦ç”¨å¿ƒï¼Œç»å†äº†è®¸å¤šæ—¶é—´çš„æ²‰æ·€ï¼ŒæŸ¥é˜…äº†ç›¸å½“å¤šçš„èµ„æ–™ã€‚ä½ ç”šè‡³è§‰å¾—è¿™é‡Œæˆ‘å¯èƒ½åœ¨è‡ªå–è‡ªå¤¸ï¼Œä¸è¿‡å¥½åƒç¡®å®æœ‰ç‚¹ ğŸ˜‚ â€¦</p><p>æ€»çš„æ¥è¯´ï¼Œæˆ‘è®¤ä¸ºè¿›æ­¥å¾ˆå¤§ã€‚ä»ç¬¬ä¸€ç¯‡ä¸çŸ¥é“æ€ä¹ˆæ¦‚æ‹¬ä¸€ä¸ª Blog çš„ç»“æ„ï¼Œæ€ä¹ˆç»„ç»‡æµç•…çš„è¯­è¨€ï¼Œåˆ°ç°åœ¨çš„æœ‰ä¸€äº›äººè®¤å¯çš„ç¨‹åº¦ã€‚æœ€åˆå†™çš„æ—¶å€™å¯¹æˆ‘è€Œè¨€æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œä¾‹å¦‚ä½ æŸ¥åˆ°ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œè¿›è€Œç‰µå¼•å‡ºå¦ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼›å¦‚æœè¿™ä¸ªçŸ¥è¯†ç‚¹æ˜¯å‰ç½®çš„ï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»å¾—å…ˆå­¦å‰ä¸€ä¸ªï¼Œè¿™æ ·åµŒå¥—å‡ æ¬¡å¯¹æ–‡ç« çš„æ•´ä½“æ€è·¯å°±å¾ˆå®¹æ˜“æ··ä¹±ï¼Œä¸è¿‡è¿™æ ·åˆ¨æ ¹é—®åº•ä¹Ÿæœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯èƒ½å¤Ÿå­¦çš„æ›´åŠ æ·±ã€æ›´åŠ å¹¿ï¼Œä»¥åå†é‡åˆ°ç±»ä¼¼çš„é—®é¢˜èƒ½æœ‰ä¸€ä¸ªå¤§è‡´çš„æ€è·¯ã€‚</p><h2 id="2023-å¹´çš„ç›®æ ‡"><a href="#2023-å¹´çš„ç›®æ ‡" class="headerlink" title="2023 å¹´çš„ç›®æ ‡"></a>2023 å¹´çš„ç›®æ ‡</h2><ul><li><input disabled="" type="checkbox"> 5 ç¯‡åŸåˆ›æŠ€æœ¯æ–‡ç« ã€2 ç¯‡æ—¥å¸¸é˜…è¯»æ–‡ç« </li><li><input disabled="" type="checkbox"> é˜…è¯» 5 æœ¬ä»¥ä¸Šä¹¦ç±</li><li><input disabled="" type="checkbox"> ç³»ç»Ÿæ€§é¢˜è§£æ€»ç»“ 5 ç¯‡</li></ul><p>ç›¸å¯¹æ¥è¯´ï¼Œæˆ‘çš„ç›®æ ‡æ¯”è¾ƒä¿å®ˆï¼Œç”šè‡³è®¸å¤šæ¸´æœ›å°è¯•çš„æ–¹é¢éƒ½æ²¡æœ‰æ¶‰åŠã€‚ä¸è¿‡ä»Šå¹´æ˜¯è®°å½•æ€»ç»“çš„ç¬¬ä¸€å¹´ï¼Œç®—æ˜¯ç»™è‡ªå·±ç•™æœ‰ä½™åœ°ï¼Œä»¥åèƒ½å¤Ÿæ ¹æ®è‡ªå·±çš„è½å®æƒ…å†µè¿›è¡Œè°ƒæ•´ã€‚</p><p>2023 å¹´çš„æˆ‘ï¼Œå¸Œæœ›èƒ½ä¿æŒåˆå¿ƒï¼Œä¸æ–­å‰è¡Œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> éšç¬” </tag>
            
            <tag> å¹´ç»ˆæ€»ç»“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CocoaPodsä½¿ç”¨æŒ‡å—</title>
      <link href="/2022/12/20/2022-12-20-CocoaPods%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"/>
      <url>/2022/12/20/2022-12-20-CocoaPods%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¯¹äºå¤§å¤šæ•°è½¯ä»¶å¼€å‘å›¢é˜Ÿæ¥è¯´ï¼Œä¾èµ–ç®¡ç†å·¥å…·å¿…ä¸å¯å°‘ï¼Œå®ƒèƒ½é’ˆå¯¹å¼€æºå’Œç§æœ‰ä¾èµ–è¿›è¡Œå®‰è£…ä¸ç®¡ç†ï¼Œä»è€Œæå‡å¼€å‘æ•ˆç‡ï¼Œé™ä½ç»´æŠ¤æˆæœ¬ã€‚é’ˆå¯¹ä¸åŒçš„è¯­è¨€ä¸å¹³å°ï¼Œå…¶ä¾èµ–ç®¡ç†å·¥å…·ä¹Ÿå„æœ‰ä¸åŒï¼Œä¾‹å¦‚ npm ç®¡ç† Javascriptã€Gradle ã€Maven ç®¡ç† Jar åŒ…ã€pip ç®¡ç† Python åŒ…ï¼ŒBundlerã€RubyGems ç­‰ç­‰ã€‚æœ¬æ–‡èšç„¦äº iOS æ–¹é¢ï¼Œå¯¹ CocoaPods çš„ä½¿ç”¨å’Œéƒ¨åˆ†åŸç†è¿›è¡Œé˜è¿°ã€‚</p><span id="more"></span><h2 id="ç®€å•æ˜“ç”¨çš„-CocoaPods"><a href="#ç®€å•æ˜“ç”¨çš„-CocoaPods" class="headerlink" title="ç®€å•æ˜“ç”¨çš„ CocoaPods"></a>ç®€å•æ˜“ç”¨çš„ CocoaPods</h2><p>å¯¹äº iOSer æ¥è¯´ï¼ŒCocoaPods å¹¶ä¸é™Œç”Ÿï¼Œå‡ ä¹æ‰€æœ‰çš„ iOS å·¥ç¨‹éƒ½ä¼šæœ‰å®ƒçš„èº«å½±ã€‚CocoaPods é‡‡ç”¨ Ruby æ„å»ºï¼Œå®ƒæ˜¯ Swift å’Œ Objective-C Cocoa é¡¹ç›®çš„ä¾èµ–ç®¡ç†å·¥å…·ã€‚åœ¨ MacOS ä¸Šï¼Œæ¨èä½¿ç”¨é»˜è®¤çš„ Ruby è¿›è¡Œå®‰è£… (ä»¥ä¸‹æ“ä½œå‡åœ¨ CocoaPods 1.10.1ã€Ruby 2.7.2 è¿›è¡Œ)ï¼š</p><pre><code class="shell">sudo gem install cocoapods</code></pre><p>å¦‚æœå®‰è£…æˆåŠŸï¼Œä¾¿å¯ä»¥ä½¿ç”¨ pod çš„ç›¸å…³å‘½ä»¤äº†ã€‚é’ˆå¯¹ä¸€ä¸ªç®€å•çš„é¡¹ç›®æ¥è¯´ï¼Œåªéœ€ä¸‰æ­¥ä¾¿å¯å¼•å…¥å…¶ä»–çš„ä¾èµ–ï¼š</p><ol><li>åˆ›å»º Podfile æ–‡ä»¶( CocoaPods æä¾›äº† pod init å‘½ä»¤åˆ›å»º)</li><li>å¯¹ Podfile æ–‡ä»¶è¿›è¡Œç¼–å†™ï¼Œæ·»åŠ ä¾èµ–çš„åº“ï¼Œç‰ˆæœ¬ç­‰ä¿¡æ¯ã€‚</li><li>åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ <code>pod install</code> å‘½ä»¤</li></ol><p>é¡ºåˆ©çš„è¯ï¼Œè¿™æ—¶åœ¨é¡¹ç›®ç›®å½•ä¸‹ä¼šå‡ºç°ä»¥ä¸‹æ–‡ä»¶ï¼š</p><ul><li>.xcworkspaceï¼šCocoaPods å°†é¡¹ç›®åˆ†ä¸ºäº†ä¸»å·¥ç¨‹ä¸ä¾èµ–å·¥ç¨‹(Pods)ã€‚ä¸ .xcodeproj ç›¸æ¯” .xcworkspace å¯¹äºç®¡ç†å¤šä¸ªé¡¹ç›®çš„èƒ½åŠ›æ›´å¼ºï¼Œä½ ä¹Ÿå¯ä»¥å°†å¤æ‚çš„å¤§å‹åº”ç”¨è½¬æ¢ä¸ºä»¥ .xcworkspace æ„å»ºçš„å¤šä¸ªå…„å¼Ÿé¡¹ç›®ï¼Œä»è€Œæ›´è½»æ¾çš„ç»´æŠ¤å’Œå…±äº«åŠŸèƒ½ã€‚</li><li>Podfile.lockï¼šè®°å½•å¹¶è·Ÿè¸ªä¾èµ–åº“ç‰ˆæœ¬ï¼Œå°†ä¾èµ–åº“é”å®šäºæŸä¸ªç‰ˆæœ¬ã€‚</li><li>Pods æ–‡ä»¶å¤¹ï¼šå­˜æ”¾ä¾èµ–åº“ä»£ç ã€‚</li><li>Pods/Manifest.lockï¼šæ¯æ¬¡ <code>pod install</code> æ—¶åˆ›å»ºçš„ Podfile.lock çš„å‰¯æœ¬ï¼Œç”¨äºæ¯”è¾ƒè¿™ä¸¤ä¸ªæ–‡ä»¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒPodfile.lock ä¼šçº³å…¥ç‰ˆæœ¬æ§åˆ¶ç®¡ç†ï¼Œè€Œ Pods æ–‡ä»¶å¤¹åˆ™ä¸ä¼šçº³å…¥ç‰ˆæœ¬æ§åˆ¶å˜æ›´ï¼›è¿™æ„å‘³ç€ Podfile.lock è¡¨ç¤ºé¡¹ç›®åº”è¯¥ä¾èµ–çš„åº“ç‰ˆæœ¬ä¿¡æ¯ï¼Œè€Œ Manifest.lock åˆ™ä»£è¡¨æœ¬åœ° Pods çš„ä¾èµ–åº“ç‰ˆæœ¬ä¿¡æ¯ã€‚åœ¨ pod install åä¼šå°†è„šæœ¬æ’å…¥åˆ° Build Phasesï¼Œåä¸º <code>[CP] Check Pods Manifest.lock</code>ï¼Œä»è€Œä¿è¯å¼€å‘è€…åœ¨è¿è¡Œ app ä¹‹å‰èƒ½å¤Ÿæ›´æ–° Podsï¼Œä»¥ç¡®ä¿ä»£ç æ˜¯æœ€æ–°çš„ã€‚</li></ul><h2 id="pod-install-vs-pod-update"><a href="#pod-install-vs-pod-update" class="headerlink" title="pod install vs. pod update"></a>pod install vs. pod update</h2><ul><li><code>pod install</code>ï¼šåœ¨æ¯ä¸€æ¬¡ç¼–è¾‘ Podfile ä»¥æ·»åŠ ã€æ›´æ–°æˆ–åˆ é™¤ pod æ—¶ä½¿ç”¨ã€‚å®ƒä¼šä¸‹è½½å¹¶å®‰è£…æ–°çš„ Podï¼Œå¹¶å°†å…¶ç‰ˆæœ¬ä¿¡æ¯å†™å…¥ Podfile.lock ä¸­ã€‚</li><li><code>pod outdated</code>ï¼šåˆ—å‡ºæ‰€æœ‰æ¯” Podfile.lock ä¸­å½“å‰è®°å½•çš„ç‰ˆæœ¬ newer ç‰ˆæœ¬çš„ podã€‚</li><li><code>pod update [PODNAME]</code>ï¼šCocoaPods ä¼šæŸ¥æ‰¾ newer ç‰ˆæœ¬çš„ PODNAMEï¼ŒåŒæ—¶å°† pod æ›´æ–°åˆ°å¯èƒ½çš„æœ€æ–°ç‰ˆæœ¬(é¡»ç¬¦åˆ Podfile é™åˆ¶)ã€‚è‹¥æ²¡æœ‰ PODNAMEï¼Œåˆ™ä¼šå°†æ¯ä¸€ä¸ª pod æ›´æ–°åˆ°å¯èƒ½çš„æœ€æ–°ç‰ˆæœ¬ã€‚</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œæ¯æ¬¡ç¼–è¾‘ Podfile æ—¶ä½¿ç”¨ <code>pod install</code>ï¼Œä»…åœ¨éœ€è¦æ›´æ–°æŸä¸ª pod ç‰ˆæœ¬(æ‰€æœ‰ç‰ˆæœ¬)æ—¶æ‰ä½¿ç”¨ pod updateã€‚åŒæ—¶ï¼Œéœ€æäº¤ Podfile.lock æ–‡ä»¶è€Œä¸æ˜¯ Pods æ–‡ä»¶å¤¹æ¥è¾¾åˆ°åŒæ­¥æ‰€æœ‰ pod ç‰ˆæœ¬çš„ç›®çš„ã€‚</p><p>ps: newer ä»£è¡¨æ›´åŠ æ–°çš„ï¼Œè‹¥é‡‡ç”¨ä¸­æ–‡ç†è§£èµ·æ¥æ¯”è¾ƒåˆ«æ‰­ã€‚</p><h2 id="Podfile-è¯­æ³•è§„èŒƒ"><a href="#Podfile-è¯­æ³•è§„èŒƒ" class="headerlink" title="Podfile è¯­æ³•è§„èŒƒ"></a>Podfile è¯­æ³•è§„èŒƒ</h2><p>Podfile æè¿°äº†ä¸€ä¸ªæˆ–å¤šä¸ª Xcode é¡¹ç›®çš„ target ä¾èµ–å…³ç³»ï¼Œå®ƒæ˜¯ä¸€ç§ DSLï¼Œäº†è§£å®ƒå¯¹æˆ‘ä»¬ä½¿ç”¨å¥½ CocoaPods æ˜¯ä¸€ä¸ªå¿…ä¸å¯å°‘çš„æ­¥éª¤ã€‚ä¸‹é¢åˆ—å‡ºå…¶ç›¸å…³çš„è¯­æ³•è§„èŒƒï¼š</p><h3 id="Root-Options"><a href="#Root-Options" class="headerlink" title="Root Options"></a>Root Options</h3><p>installï¼šæŒ‡å®š CocoaPods å®‰è£… Podfile æ—¶ä½¿ç”¨çš„å®‰è£…æ–¹æ³•å’Œé€‰é¡¹ã€‚å¦‚ï¼š</p><pre><code class="ruby">install! 'cocoapods',         :deterministic_uuids =&gt; false,         :integrate_targets =&gt; false</code></pre><ul><li><code>:clean</code>ï¼šæ ¹æ® podspec å’Œé¡¹ç›®æ”¯æŒå¹³å°çš„æŒ‡å®šï¼Œæ¸…ç†æ‰€æœ‰ä¸è¢« pod ä½¿ç”¨çš„æ–‡ä»¶ï¼Œé»˜è®¤ä¸º trueã€‚</li><li><code>:deduplicate_targets</code>ï¼šæ˜¯å¦å¯¹ pod target è¿›è¡Œé‡å¤æ•°æ®åˆ é™¤ï¼Œé»˜è®¤ä¸º trueã€‚</li><li><code>:deterministic_uuids</code>ï¼šåˆ›å»º pod project æ˜¯å¦äº§ç”Ÿç¡®å®šæ€§ UUIDï¼Œé»˜è®¤ä¸º trueã€‚</li><li><code>:integrate_targets</code>ï¼šæ˜¯å¦ç»§æ‰¿åˆ°ç”¨æˆ·é¡¹ç›®ä¸­ï¼Œä¸º false ä¼šå°† Pod ä¸‹è½½å¹¶å®‰è£…åˆ°åˆ° project_path/Pods ç›®å½•ä¸‹ï¼Œé»˜è®¤ä¸º trueã€‚</li><li><code>:lock_pos_sources</code>ï¼šæ˜¯å¦é”å®š pod çš„æºæ–‡ä»¶ï¼Œå½“ Xcode å°è¯•ä¿®æ”¹æ—¶ä¼šæç¤ºè§£é”æ–‡ä»¶ï¼Œé»˜è®¤ä¸º trueã€‚</li><li><code>:warn_for_multiple_pod_sources</code>ï¼šå½“å¤šä¸ª source åŒ…å«åŒååŒç‰ˆæœ¬ pod æ—¶æ˜¯å¦å‘å‡ºè­¦å‘Šï¼Œé»˜è®¤ä¸º trueã€‚</li><li><code>:warn_for_unused_master_specs_repo</code>ï¼šå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å‡º master specs repo çš„ git æ˜¯å¦å‘å‡ºè­¦å‘Šï¼Œé»˜è®¤ä¸º trueã€‚</li><li><code>:share_schemes_for_development_pods</code>ï¼šæ˜¯å¦ä¸ºå¼€å‘ä¸­çš„ pod åˆ†äº« schemesï¼Œé»˜è®¤ä¸º falseã€‚</li><li><code>:disable_input_output_paths</code>ï¼šæ˜¯å¦ç¦ç”¨ CocoaPods è„šæœ¬é˜¶æ®µçš„è¾“å…¥è¾“å‡ºè·¯å¾„ï¼ˆCopy Frameworks å’Œ Copy Resourcesï¼‰ï¼Œé»˜è®¤ä¸º falseã€‚</li><li><code>:preserve_pod_file_structure</code>ï¼šæ˜¯å¦ä¿ç•™æ‰€æœ‰ pod çš„æ–‡ä»¶ç»“æ„ï¼Œé»˜è®¤ä¸º falseã€‚</li><li><code>:generate_multiple_pod_projects</code>ï¼šæ˜¯å¦ä¸ºæ¯ä¸€ä¸ª pod target ç”Ÿæˆ ä¸€ä¸ª projectï¼Œç”Ÿæˆä¸ Pods/Pods æ–‡ä»¶å¤¹ä¸­ï¼Œé»˜è®¤ä¸º falseã€‚</li><li><code>:incremental_installation</code>ï¼šä»…å¯¹è‡ªä¸Šæ¬¡å®‰è£…çš„ target ä¸å…¶å…³è”çš„ project çš„å˜æ›´éƒ¨åˆ†è¿›è¡Œé‡æ–°ç”Ÿæˆï¼Œé»˜è®¤ä¸º falseã€‚</li><li><code>:skip_pods_project_generation</code>ï¼šæ˜¯å¦è·³è¿‡ç”Ÿæˆ Pods.xcodeproj å¹¶ä»…è¿›è¡Œä¾èµ–é¡¹è§£æä¸ä¸‹è½½ï¼Œé»˜è®¤ä¸º falseã€‚</li></ul><p>ensure_bundler!ï¼šå½“ bundler ç‰ˆæœ¬ä¸åŒ¹é…æ—¶å‘å‡ºè­¦å‘Šã€‚</p><pre><code class="ruby">ensure_bundler! '~&gt; 2.0.0'</code></pre><h3 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h3><p><strong>pod</strong>ï¼šæŒ‡å®šé¡¹ç›®çš„ä¾èµ–é¡¹</p><ul><li>ä¾èµ–ç‰ˆæœ¬æ§åˆ¶ï¼š=ã€&gt;ã€&gt;=ã€&lt;ã€&lt;= ä¸ºå­—é¢æ„æ€ï¼›~&gt; 0.1.2 è¡¨ç¤º 0.1.2 &lt;= currVersion &lt; 0.2 ä¹‹é—´çš„ç¬¦åˆè¦æ±‚çš„æœ€æ–°ç‰ˆæœ¬ç‰ˆæœ¬ã€‚</li><li>Build configurationsï¼šé»˜è®¤ä¾èµ–å®‰è£…åœ¨æ‰€æœ‰çš„æ„å»ºé…ç½®ä¸­ï¼Œä½†ä¹Ÿå¯ä»…åœ¨æŒ‡å®šæ„å»ºé…ç½®ä¸­å¯ç”¨ã€‚</li><li>Modular Headersï¼šç”¨äºå°† pod è½¬æ¢ä¸º module ä»¥æ”¯æŒæ¨¡å—ï¼Œè¿™æ—¶åœ¨ Swift ä¸­å¯ä»¥ä¸ç”¨å€ŸåŠ© <code>bridging-header</code> æ¡¥æ¥å°±å¯ä»¥ç›´æ¥å¯¼å…¥ï¼Œç®€åŒ–äº† Swift å¼•ç”¨ Objective-C çš„æ–¹å¼ï¼›ä¹Ÿå¯ä»¥é‡‡ç”¨ <code>use_modular_headers!</code> è¿›è¡Œå…¨å±€çš„å˜æ›´ã€‚</li><li>Sourceï¼šæŒ‡å®šå…·æœ‰ä¾èµ–é¡¹çš„æºï¼ŒåŒæ—¶ä¼šå¿½ç•¥å…¨å±€æºã€‚</li><li>Subspecsï¼šé»˜è®¤ä¼šå®‰è£…æ‰€æœ‰çš„ subspecsï¼Œä½†å¯åˆ¶å®šå®‰è£…æŸäº› subspecsã€‚</li><li>Test Specsï¼šé»˜è®¤ä¸ä¼šå®‰è£… test specsï¼Œä½†å¯é€‰æ‹©æ€§å®‰è£… test specsã€‚</li><li>Local pathï¼šå°†å¼€å‘çš„ pod ä¸å…¶å®¢æˆ·ç«¯ä¸€èµ·ä½¿ç”¨ï¼Œå¯é‡‡ç”¨ pathã€‚</li><li>æŒ‡å®šæŸä¸ªç‰¹æ®Šæˆ–è€…æ›´ä¸ºå…ˆè¿›çš„ pod ç‰ˆæœ¬</li></ul><pre><code class="ruby"># ä¾èµ–ç‰ˆæœ¬æ§åˆ¶pod 'Objection', '~&gt; 0.9' # Build configurationspod 'PonyDebugger', :configurations =&gt; ['Debug', 'Beta'] # Modular Headerspod 'SSZipArchive', :modular_headers =&gt; true # Sourcepod 'PonyDebugger', :source =&gt; 'https://github.com/CocoaPods/Specs.git'# Subspecspod 'QueryKit', :subspecs =&gt; ['Attribute', 'QuerySet'] # Test Specspod 'AFNetworking', :testspecs =&gt; ['UnitTests', 'SomeOtherTests']# Local pathpod 'AFNetworking', :path =&gt; '~/Documents/AFNetworking'# æŒ‡å®šæŸä¸ªç‰¹æ®Šæˆ–è€…æ›´ä¸ºå…ˆè¿›çš„ Pod ç‰ˆæœ¬pod 'AFNetworking', :git =&gt; 'https://github.com/gowalla/AFNetworking.git', :branch =&gt; 'dev'pod 'AFNetworking', :git =&gt; 'https://github.com/gowalla/AFNetworking.git', :tag =&gt; '0.7.0'pod 'AFNetworking', :git =&gt; 'https://github.com/gowalla/AFNetworking.git', :commit =&gt; '082f8319af'# æŒ‡å®šæŸä¸ª podspecpod 'JSONKit', :podspec =&gt; 'https://example.com/JSONKit.podspec'</code></pre><p><strong>inherit</strong>ï¼šè®¾ç½®å½“å‰ target çš„ç»§æ‰¿æ¨¡å¼ã€‚</p><p><code>:complete</code> ç»§æ‰¿çˆ¶çº§ target çš„æ‰€æœ‰è¡Œä¸ºï¼Œ<code>:none</code> ä¸ç»§æ‰¿çˆ¶çº§ target çš„ä»»ä½•è¡Œä¸ºï¼Œ<code>:search_paths</code> ä»…ç»§æ‰¿çˆ¶çº§çš„æœç´¢è·¯å¾„ã€‚</p><pre><code class="ruby">target 'App' do  target 'AppTests' do    inherit! :search_paths  endend</code></pre><p><strong>target</strong>ï¼šä¸ Xcode ä¸­çš„ target ç›¸å¯¹åº”ï¼Œblock ä¸­æ˜¯ target çš„ä¾èµ–é¡¹ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œtarget åŒ…å«åœ¨çˆ¶çº§ target å®šä¹‰çš„ä¾èµ–é¡¹ï¼Œä¹Ÿå³ <code>inherit!</code> ä¸º <code>:complete</code>ã€‚å…³äº <code>:complete</code> å’Œ <code>:search_paths</code>ï¼Œ<code>:complete</code> ä¼šæ‹·è´çˆ¶çº§ target çš„ pod å‰¯æœ¬ï¼Œè€Œ <code>:search_paths</code> åˆ™åªè¿›è¡Œ <code>FRAMEWORK_SEARCH_PATHS</code> å’Œ <code>HEADER_SEARCH_PATHS</code> çš„ç›¸å…³æ‹·è´ï¼Œå…·ä½“å¯é€šè¿‡æ¯”å¯¹ Pods/Target Support Files çš„ç›¸å…³æ–‡ä»¶å¾—ä»¥éªŒè¯ï¼Œä¸€èˆ¬åœ¨ <code>UnitTests</code> ä¸­ä½¿ç”¨ï¼Œä»¥å‡å°‘å¤šä½™çš„ <code>install_framework</code> è¿‡ç¨‹ã€‚</p><pre><code class="ruby">target 'ShowsApp' do  pod 'ShowsKit'  # æ‹¥æœ‰ ShowsKit å’Œ ShowTVAuth çš„æ‹·è´  target 'ShowsTV' do    pod 'ShowTVAuth'  end  # æ‹¥æœ‰ Specta å’Œ Expecta çš„æ‹·è´  # å¹¶ä¸”èƒ½å¤Ÿé€šè¿‡ ShowsApp è¿›è¡Œè®¿é—® ShowsKit, ç›¸å½“äº ShowsApp æ˜¯ ShowsTests çš„å®¿ä¸»APP  target 'ShowsTests' do    inherit! :search_paths    pod 'Specta'    pod 'Expecta'  endend</code></pre><p><strong>abstract_target</strong>ï¼šå®šä¹‰ <code>abstract_target</code>ï¼Œæ–¹ä¾¿ target è¿›è¡Œä¾èµ–ç»§æ‰¿ï¼Œåœ¨ CocoaPods 1.0 ç‰ˆæœ¬ä¹‹å‰ä¸º <code>link_with</code>ã€‚</p><pre><code class="ruby">abstract_target 'Networking' do  pod 'AlamoFire'  target 'Networking App 1'  target 'Networking App 2'end</code></pre><p><strong>abstract</strong>ï¼šè¡¨ç¤ºå½“å‰ target æ˜¯æŠ½è±¡çš„ï¼Œä¸ä¼šé“¾æ¥åˆ° Xcode çš„ target ä¸­ã€‚</p><p><strong>script_phase</strong>ï¼šæ·»åŠ è„šæœ¬é˜¶æ®µã€‚</p><p>åœ¨æ‰§è¡Œå®Œ <code>pod install</code> ä¹‹å CocoaPods ä¼šå°†è„šæœ¬æ·»åŠ åˆ°å¯¹åº”çš„ <code>target build phases</code>ã€‚</p><pre><code class="ruby">target 'App' do    script_phase {        :name =&gt; 'scriptName' # è„šæœ¬åç§°,        :script =&gt; 'echo "nihao"' # è„šæœ¬å†…å®¹,        :execution_position =&gt; :before_compile / :after_compile        :shell_path =&gt; '/usr/bin/ruby' # è„šæœ¬è·¯å¾„        :input_files =&gt; ['/input/filePath'], # è¾“å…¥æ–‡ä»¶        :output_files =&gt; ['/outpput/filePath'] # è¾“å‡ºæ–‡ä»¶    }end</code></pre><h3 id="Target-configuration"><a href="#Target-configuration" class="headerlink" title="Target configuration"></a>Target configuration</h3><p><strong>platform</strong>ï¼šæŒ‡å®šå…¶æ„å»ºå¹³å°ã€‚</p><p>é»˜è®¤å€¼ä¸º iOS 4.3ã€OSX 10.6ã€tvOS 9.0 å’Œ watchOS 2.0ã€‚CocoaPods 1.0 ä¹‹å‰çš„ç‰ˆæœ¬ä¸º xcodeproj</p><pre><code class="ruby">platform :ios, '4.0'</code></pre><p><strong>project</strong>ï¼šæŒ‡å®šåŒ…å« target çš„ Xcode projectã€‚è¿™ä¸€èˆ¬åœ¨ workspace å­˜åœ¨å¤šä¸ª xcode project ä¸­ä½¿ç”¨ï¼š</p><pre><code class="ruby"># åœ¨ FastGPS Project ä¸­å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåä¸º MyGPSApp çš„ targettarget 'MyGPSApp' do  project 'FastGPS'  ...end</code></pre><p><strong>inhibit_all_warnings</strong>!ï¼šç¦æ­¢æ‰€æœ‰è­¦å‘Šã€‚</p><p>å¦‚æœé’ˆå¯¹å•ä¸ª Podï¼Œåˆ™å¯ä»¥é‡‡ç”¨ï¼š</p><pre><code class="ruby">pod 'SSZipArchive', :inhibit_warnings =&gt; truepod 'SSZipArchive', :inhibit_warnings =&gt; true</code></pre><p><strong>user_modular_headers</strong>!ï¼šå°†æ‰€æœ‰ Pod æ¨¡å—åŒ–ã€‚</p><p>å¦‚æœé’ˆå¯¹å•ä¸ª Podï¼Œåˆ™å¯ä»¥é‡‡ç”¨ï¼š</p><pre><code class="ruby">pod 'SSZipArchive', :modular_headers =&gt; truepod 'SSZipArchive', :modular_headers =&gt; false</code></pre><p><strong>user_frameworks</strong>!ï¼šé‡‡ç”¨ framework è€Œä¸æ˜¯ .a æ–‡ä»¶çš„é™æ€åº“ã€‚</p><p>å¯ä»¥é€šè¿‡ <code>:linkage</code> æŒ‡å®šä½¿ç”¨é™æ€åº“è¿˜æ˜¯åŠ¨æ€åº“ï¼š</p><pre><code class="ruby">use_frameworksï¼:linkage =&gt; :dynamic / :static</code></pre><p><strong>supports_swift_versions</strong>ï¼šæŒ‡å®š target definition æ”¯æŒçš„ swift ç‰ˆæœ¬è¦æ±‚</p><pre><code class="ruby">supports_swift_versions '&gt;= 3.0', '&lt; 4.0'</code></pre><h3 id="Workspace"><a href="#Workspace" class="headerlink" title="Workspace"></a>Workspace</h3><p><strong>workspace</strong>ï¼šæŒ‡å®šåŒ…å«æ‰€æœ‰é¡¹ç›®çš„ Xcode workspaceã€‚</p><pre><code class="ruby">workspace 'MyWorkspace'</code></pre><h3 id="Sources"><a href="#Sources" class="headerlink" title="Sources"></a>Sources</h3><p><strong>sources</strong>ï¼šPodfile ä»æŒ‡å®šçš„æºåˆ—è¡¨ä¸­è¿›è¡Œæ£€ç´¢ã€‚sources é»˜è®¤å­˜å‚¨åœ¨ ~/.cocoapods/repos ä¸­ï¼Œæ˜¯å…¨å±€çš„è€ŒéæŒ‰ target definition å­˜å‚¨ã€‚å½“æœ‰å¤šä¸ªç›¸åŒçš„ Pod æ—¶ï¼Œä¼˜å…ˆé‡‡ç”¨æ£€ç´¢åˆ°çš„ Pod çš„ç¬¬ä¸€ä¸ªæºï¼Œå› æ­¤å½“æŒ‡å®šå¦ä¸€ä¸ªæ¥æºæ—¶ï¼Œåˆ™éœ€æ˜¾ç¤ºæŒ‡å®š CocoaPods çš„æºã€‚</p><pre><code class="ruby">source 'https://github.com/artsy/Specs.git'source 'https://github.com/CocoaPods/Specs.git'</code></pre><h3 id="Hooks"><a href="#Hooks" class="headerlink" title="Hooks"></a>Hooks</h3><p><strong>plugin</strong>ï¼šæŒ‡å®šåœ¨å®‰è£…æœŸé—´ä½¿ç”¨çš„æ’ä»¶ã€‚</p><pre><code class="ruby">plugin 'cocoapods-keys', :keyring =&gt; 'Eidolon'plugin 'slather'</code></pre><p><strong>pre_install</strong>ï¼šåœ¨ä¸‹è½½åå’Œåœ¨å®‰è£… Pod å‰è¿›è¡Œæ›´æ”¹ã€‚</p><pre><code class="ruby">pre_install do |installer|  # Do something fancy!end</code></pre><p><strong>pre_integrate</strong>ï¼šåœ¨ project å†™å…¥ç£ç›˜å‰è¿›è¡Œæ›´æ”¹ã€‚</p><pre><code class="ruby">pre_integrate do |installer|  # perform some changes on dependenciesend</code></pre><p><strong>post_install</strong>ï¼šå¯¹ç”Ÿæˆ project å†™å…¥ç£ç›˜å‰è¿›è¡Œæœ€åçš„ä¿®æ”¹ã€‚</p><pre><code class="ruby">post_install do |installer|  installer.pods_project.targets.each do |target|    target.build_configurations.each do |config|      config.build_settings['GCC_ENABLE_OBJC_GC'] = 'supported'    end  endend</code></pre><p><strong>post_integrate</strong>ï¼šåœ¨ project å†™å…¥ç£ç›˜åè¿›è¡Œæœ€åæ›´æ”¹ã€‚</p><pre><code class="ruby">post_integrate do |installer|  # some change after project write to diskend</code></pre><h2 id="podspec-è¯­æ³•è§„èŒƒ"><a href="#podspec-è¯­æ³•è§„èŒƒ" class="headerlink" title="podspec è¯­æ³•è§„èŒƒ"></a>podspec è¯­æ³•è§„èŒƒ</h2><p>podspec = pod Specificationï¼Œæ„ä¸º pod è§„èŒƒï¼Œå®ƒæ˜¯ä¸€ä¸ª Ruby æ–‡ä»¶ã€‚åŒ…å«äº† Pod çš„åº“ç‰ˆæœ¬è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚åº”ä»ä½•å¤„è·å–æºã€ä½¿ç”¨å“ªäº›æ–‡ä»¶ã€è¦åº”ç”¨æ„å»ºè®¾ç½®ç­‰ä¿¡æ¯ï¼›ä¹Ÿå¯ä»¥çœ‹ä½œè¯¥æ–‡ä»¶æ˜¯æ•´ä¸ªä»“åº“çš„ç´¢å¼•æ–‡ä»¶ï¼Œäº†è§£å®ƒå¯¹æˆ‘ä»¬çŸ¥é“ Pod åº“æ˜¯å¦‚ä½•ç»„ç»‡ã€è¿ä½œçš„æä¾›äº†å¾ˆå¤§å¸®åŠ©ã€‚podspec çš„ DSL æä¾›äº†æå¤§çš„çµæ´»æ€§ï¼Œæ–‡ä»¶å¯é€šè¿‡ <code>pod spec create</code> åˆ›å»ºã€‚</p><h3 id="Root"><a href="#Root" class="headerlink" title="Root"></a>Root</h3><table><thead><tr><th>åç§°</th><th>ç”¨é€”</th><th>å¿…éœ€</th></tr></thead><tbody><tr><td><code>name</code></td><td>pod åç§°</td><td>required</td></tr><tr><td><code>version</code></td><td>pod ç‰ˆæœ¬ï¼Œéµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶</td><td>required</td></tr><tr><td><code>swift_version</code></td><td>æ”¯æŒçš„ Swift ç‰ˆæœ¬</td><td></td></tr><tr><td><code>cocoapods_version</code></td><td>æ”¯æŒçš„ CocoaPods ç‰ˆæœ¬</td><td></td></tr><tr><td><code>authors</code></td><td>pod ç»´æŠ¤è€…çš„å§“åå’Œç”µå­é‚®ä»¶ï¼Œç”¨â€œ, â€è¿›è¡Œåˆ†å‰²</td><td>required</td></tr><tr><td><code>license</code></td><td>pod çš„è®¸å¯è¯</td><td>required</td></tr><tr><td><code>homepage</code></td><td>pod ä¸»é¡µçš„ URL</td><td>required</td></tr><tr><td><code>source</code></td><td>æºåœ°å€ï¼Œå³æºæ–‡ä»¶çš„å­˜æ”¾åœ°å€ï¼Œæ”¯æŒå¤šç§å½¢å¼æº</td><td>required</td></tr><tr><td><code>summary</code></td><td>pod çš„ç®€çŸ­æè¿°</td><td>required</td></tr><tr><td><code>prepare_command</code></td><td>ä¸‹è½½ pod åæ‰§è¡Œçš„ bash è„šæœ¬</td><td></td></tr><tr><td><code>static_framework</code></td><td>æ˜¯å¦é‡‡ç”¨é™æ€ framework åˆ†å‘</td><td></td></tr><tr><td><code>deprecated</code></td><td>è¯¥åº“æ˜¯å¦å·²è¢«å¼ƒç”¨</td><td></td></tr><tr><td><code>deprecated_in_favor_of</code></td><td>è¯¥åº“åç§°å·²è¢«å¼ƒç”¨ï¼Œå–è€Œä»£ä¹‹</td><td></td></tr></tbody></table><pre><code class="ruby">Pod::Spec.new do |s|  s.name             = 'CustomPod'  s.version          = '0.1.0'  s.summary          = 'A short description of CustomPod.'  s.swift_versions   = ['3.0', '4.0', '4.2']  s.cocoapods_version  =  '&gt;= 0.36'  s.author           = { 'nihao' =&gt; 'XXXX@qq.com' }  s.license          = { :type =&gt; 'MIT', :file =&gt; 'LICENSE' }  s.homepage         = 'https://github.com/XXX/CustomPod'# Supported Key# :git=&gt; :tag, :branch, :commit,:submodules# :svn=&gt; :folder, :tag,:revision# :hg=&gt;:revision# :http=&gt; :flatten, :type, :sha256, :sha1,:headers  s.source           = { :git =&gt; 'https://github.com/XX/CustomPod.git', :tag =&gt; s.version.to_s }  s.prepare_command  =  'ruby build_files.rb'  s.static_framework = true  s.deprecated       = true  s.deprecated_in_favor_of  =  'NewMoreAwesomePod'end</code></pre><h3 id="Platform"><a href="#Platform" class="headerlink" title="Platform"></a>Platform</h3><p><strong>platform</strong>ï¼špod æ”¯æŒçš„å¹³å°ï¼Œç•™ç©ºæ„å‘³ç€ pod æ”¯æŒæ‰€æœ‰å¹³å°ã€‚å½“æ”¯æŒå¤šå¹³å°æ—¶åº”è¯¥ç”¨ <code>deployment_target</code> ä»£æ›¿ã€‚</p><pre><code class="ruby">spec.platform = :osx, '10.8'</code></pre><p><strong>deployment_target</strong>ï¼šå…è®¸æŒ‡å®šæ”¯æŒæ­¤ pod çš„å¤šä¸ªå¹³å°ï¼Œä¸ºæ¯ä¸ªå¹³å°æŒ‡å®šä¸åŒçš„éƒ¨ç½²ç›®æ ‡ã€‚</p><pre><code class="ruby">spec.ios.deployment_target = '6.0'spec.osx.deployment_target = '10.8'</code></pre><h3 id="Build-settings"><a href="#Build-settings" class="headerlink" title="Build settings"></a>Build settings</h3><p><strong>dependency</strong>ï¼šåŸºäºå…¶ä»– pods æˆ–å­è§„èŒƒçš„ä¾èµ–</p><pre><code class="ruby">spec.dependency 'AFNetworking', '~&gt; 1.0', :configurations =&gt; ['Debug']</code></pre><p><strong>info_plist</strong>ï¼šåŠ å…¥åˆ°ç”Ÿæˆçš„ Info.plist çš„é”®å€¼å¯¹ï¼Œä¼šå¯¹ CocoaPods ç”Ÿæˆçš„é»˜è®¤å€¼è¿›è¡Œè¦†ç›–ã€‚ä»…å¯¹ä½¿ç”¨ framework çš„æ¡†æ¶æœ‰å½±å“ï¼Œå¯¹é™æ€åº“æ— æ•ˆã€‚å¯¹äºåº”ç”¨è§„èŒƒï¼Œè¿™äº›å€¼å°†åˆå¹¶åˆ°åº”ç”¨ç¨‹åºä¸»æœºçš„ <code>Info.plist</code>ï¼›å¯¹äºæµ‹è¯•è§„èŒƒï¼Œè¿™äº›å€¼å°†åˆå¹¶åˆ°æµ‹è¯•åŒ…çš„ Info.plistã€‚</p><pre><code class="ruby">spec.info_plist = {  'CFBundleIdentifier' =&gt; 'com.myorg.MyLib',  'MY_VAR' =&gt; 'SOME_VALUE'}</code></pre><p><strong>requires_arc</strong>ï¼šå…è®¸æŒ‡å®šå“ªäº› source_files é‡‡ç”¨ ARCï¼Œä¸ä½¿ç”¨ ARC çš„æ–‡ä»¶å°†å…·æœ‰ <code>-fno-objc-arc</code> ç¼–è¯‘å™¨æ ‡å¿—</p><pre><code class="ruby">spec.requires_arc = falsespec.requires_arc = 'Classes/Arc'spec.requires_arc = ['Classes/*ARC.m', 'Classes/ARC.mm']</code></pre><p><strong>frameworks</strong>ï¼šä½¿ç”¨è€… target éœ€è¦é“¾æ¥çš„ç³»ç»Ÿæ¡†æ¶åˆ—è¡¨</p><pre><code class="ruby">spec.ios.framework = 'CFNetwork'spec.frameworks = 'QuartzCore', 'CoreData'</code></pre><p><strong>weak_frameworks</strong>ï¼šä½¿ç”¨è€… target éœ€è¦å¼±é“¾æ¥çš„æ¡†æ¶åˆ—è¡¨</p><pre><code class="swift">spec.weak_framework = 'Twitter'spec.weak_frameworks = 'Twitter', 'SafariServices'</code></pre><p><strong>libraries</strong>ï¼šä½¿ç”¨è€… target éœ€è¦é“¾æ¥çš„ç³»ç»Ÿåº“åˆ—è¡¨</p><pre><code class="ruby">spec.ios.library = 'xml2'spec.libraries = 'xml2', 'z'</code></pre><p><strong>compiler_flags</strong>ï¼šåº”ä¼ é€’ç»™ç¼–è¯‘å™¨çš„ flags</p><pre><code class="ruby">spec.compiler_flags = '-DOS_OBJECT_USE_OBJC=0', '-Wno-format'</code></pre><p><strong>pod_target_xcconfig</strong>ï¼šå°†æŒ‡å®š flag æ·»åŠ åˆ°æœ€ç»ˆ pod çš„ xcconfig æ–‡ä»¶</p><pre><code class="ruby">spec.pod_target_xcconfig = { 'OTHER_LDFLAGS' =&gt; '-lObjC' }</code></pre><p><strong>user_target_xcconfig</strong>ï¼šğŸ™… å°†æŒ‡å®š flag æ·»åŠ åˆ°æœ€ç»ˆèšåˆçš„ target çš„ xcconfigï¼Œä¸æ¨èä½¿ç”¨æ­¤å±æ€§ï¼Œå› ä¸ºä¼šæ±¡æŸ“ç”¨æˆ·çš„æ„å»ºè®¾ç½®ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†²çªã€‚</p><pre><code class="ruby">spec.user_target_xcconfig = { 'MY_SUBSPEC' =&gt; 'YES' }</code></pre><p><strong>prefix_header_contents</strong>ï¼šğŸ™… åœ¨ Pod ä¸­æ³¨å…¥çš„é¢„ç¼–è¯‘å†…å®¹ï¼Œä¸æ¨èä½¿ç”¨æ­¤å±æ€§ï¼Œå› ä¸ºå…¶ä¼šæ±¡æŸ“ç”¨æˆ·æˆ–è€…å…¶ä»–åº“çš„é¢„ç¼–è¯‘å¤´ã€‚</p><pre><code class="ruby">spec.prefix_header_contents = '#import &lt;UIKit/UIKit.h&gt;', '#import &lt;Foundation/Foundation.h&gt;'</code></pre><p><strong>prefix_header_file</strong>ï¼šé¢„ç¼–è¯‘å¤´æ–‡ä»¶ï¼Œfalse è¡¨ç¤ºä¸ç”Ÿæˆé»˜è®¤çš„ CocoaPods çš„ä¸ç¼–è¯‘å¤´æ–‡ä»¶ã€‚ğŸ™… ä¸æ¨èä½¿ç”¨è·¯å¾„å½¢å¼ï¼Œå› ä¸ºå…¶ä¼šæ±¡æŸ“ç”¨æˆ·æˆ–è€…å…¶ä»–åº“çš„é¢„ç¼–è¯‘å¤´ã€‚</p><pre><code class="ruby">spec.prefix_header_file = 'iphone/include/prefix.pch'spec.prefix_header_file = false</code></pre><p><strong>module_name</strong>ï¼šç”Ÿæˆçš„ framrwork / clang module ä½¿ç”¨çš„åç§°ï¼Œè€Œéé»˜è®¤åç§°ã€‚</p><pre><code class="ruby">spec.module_name = 'Three20'</code></pre><p><strong>header_dir</strong>ï¼šå­˜å‚¨å¤´æ–‡ä»¶çš„ç›®å½•ï¼Œè¿™æ ·å®ƒä»¬å°±ä¸ä¼šè¢«ç ´åã€‚</p><pre><code class="ruby">spec.header_dir = 'Three20Core'</code></pre><p><strong>header_mappings_dir</strong>ï¼šç”¨äºä¿ç•™å¤´æ–‡ä»¶æ–‡ä»¶å¤¹çš„ç›®å½•ã€‚å¦‚æœªæä¾›ï¼Œå¤´æ–‡ä»¶å°†è¢«ç¢¾å¹³ã€‚</p><pre><code class="ruby">spec.header_mappings_dir = 'src/include'</code></pre><p><strong>script_phases</strong>ï¼šè¯¥å±æ€§å…è®¸å®šä¹‰è„šæœ¬åœ¨ pod ç¼–è¯‘æ—¶æ‰§è¡Œï¼Œå…¶ä½œä¸º <code>xcode build</code> å‘½ä»¤çš„ä¸€éƒ¨åˆ†æ‰§è¡Œï¼Œè¿˜å¯ä»¥åˆ©ç”¨ç¼–è¯‘æœŸé—´æ‰€è®¾ç½®çš„ç¯å¢ƒå˜é‡ã€‚</p><pre><code class="ruby">spec.script_phases = [    { :name =&gt; 'Hello World', :script =&gt; 'echo "Hello World"' },    { :name =&gt; 'Hello Ruby World', :script =&gt; 'puts "Hello World"', :shell_path =&gt; '/usr/bin/ruby' },  ]</code></pre><h3 id="File-patterns"><a href="#File-patterns" class="headerlink" title="File patterns"></a>File patterns</h3><p>æ–‡ä»¶æ¨¡å¼æŒ‡å®šäº†åº“çš„æ‰€æœ‰æ–‡ä»¶ç®¡ç†æ–¹å¼ï¼Œå¦‚æºä»£ç ã€å¤´æ–‡ä»¶ã€frameworkã€libariesã€ä»¥åŠå„ç§èµ„æºã€‚å…¶æ–‡ä»¶æ¨¡å¼é€šé…ç¬¦å½¢å¼å¯å‚è€ƒ <a href="https://guides.cocoapods.org/syntax/podspec.html#group_file_patterns">LINK</a>ã€‚</p><p><strong>source_files</strong>ï¼šæŒ‡å®šæºæ–‡ä»¶</p><pre><code class="ruby">spec.source_files = 'Classes/**/*.{h,m}', 'More_Classes/**/*.{h,m}'</code></pre><p><strong>public_header_files</strong>ï¼šæŒ‡å®šå…¬å…±å¤´æ–‡ä»¶ï¼Œè¿™äº›å¤´æ–‡ä»¶ä¸æºæ–‡ä»¶åŒ¹é…ï¼Œå¹¶ç”Ÿæˆæ–‡æ¡£å‘ç”¨æˆ·æä¾›ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™å°† source_files ä¸­çš„æ‰€æœ‰å¤´æ–‡ä»¶éƒ½åŒ…å«ç”Ÿæˆã€‚</p><pre><code class="ruby">spec.public_header_files = 'Headers/Public/*.h'</code></pre><p><strong>project_header_files</strong>ï¼šæŒ‡å®šé¡¹ç›®å¤´æ–‡ä»¶ï¼Œä¸å…¬å…±å¤´æ–‡ä»¶ç›¸å¯¹åº”ï¼Œä»¥æ’é™¤ä¸åº”å‘ç”¨æˆ·é¡¹ç›®å…¬å¼€ä¸”ä¸åº”ç”¨äºç”Ÿæˆæ–‡æ¡£çš„æ ‡å¤´ï¼Œä¸”ä¸ä¼šå‡ºç°åœ¨æ„å»ºç›®å½•ä¸­ã€‚</p><pre><code class="ruby">spec.project_header_files = 'Headers/Project/*.h'</code></pre><p><strong>private_header_files</strong>ï¼šç§æœ‰å¤´æ–‡ä»¶ï¼Œä¸å…¬å…±å¤´æ–‡ä»¶å¯¹åº”ï¼Œä»¥æ’é™¤ä¸åº”å‘ç”¨æˆ·é¡¹ç›®å…¬å¼€ä¸”ä¸åº”ç”¨äºç”Ÿæˆæ–‡æ¡£çš„æ ‡å¤´ï¼Œè¿™äº›å¤´æ–‡ä»¶ä¼šå‡ºç°åœ¨äº§ç‰©ä¸­çš„ PrivateHeader æ–‡ä»¶å¤¹ä¸­ã€‚</p><pre><code class="ruby">spec.private_header_files = 'Headers/Private/*.h'</code></pre><p><strong>vendered_frameworks</strong>ï¼špod é™„åŠ çš„ framework è·¯å¾„</p><pre><code class="ruby">spec.ios.vendored_frameworks = 'Frameworks/MyFramework.framework'spec.vendored_frameworks = 'MyFramework.framework', 'TheirFramework.xcframework'    </code></pre><p><strong>vendered_libraries</strong>ï¼špod é™„åŠ çš„ libraries è·¯å¾„</p><pre><code class="ruby">spec.ios.vendored_library = 'Libraries/libProj4.a'spec.vendored_libraries = 'libProj4.a', 'libJavaScriptCore.a'</code></pre><p><strong>on_demand_resources</strong>ï¼šæ ¹æ® <a href="https://developer.apple.com/videos/play/wwdc2015/214/">Introducing On demand Resources</a> æŒ‰éœ€åŠ è½½èµ„æºï¼Œä¸æ¨èä¸ä¸»å·¥ç¨‹å…±äº«æ ‡ç­¾ï¼Œé»˜è®¤ç±»åˆ«ä¸º <code>category =&gt; :download_on_demand</code></p><pre><code class="ruby">s.on_demand_resources = {  'Tag1' =&gt; { :paths =&gt; ['file1.png', 'file2.png'], :category =&gt; :download_on_demand }}s.on_demand_resources = {  'Tag1' =&gt; { :paths =&gt; ['file1.png', 'file2.png'], :category =&gt; :initial_install }}</code></pre><p><strong>resources</strong>ï¼šä¸º pod æ„å»ºçš„ bundle çš„åç§°å’Œèµ„æºæ–‡ä»¶ï¼Œå…¶ä¸­ key ä¸º bundle åç§°ï¼Œå€¼ä»£è¡¨å®ƒä»¬åº”ç”¨çš„æ–‡ä»¶æ¨¡å¼ã€‚</p><pre><code class="ruby">spec.resource_bundles = {    'MapBox' =&gt; ['MapView/Map/Resources/*.png'],    'MapBoxOtherResources' =&gt; ['MapView/Map/OtherResources/*.png']}</code></pre><p><strong>exclude_files</strong>ï¼šæ’é™¤çš„æ–‡ä»¶æ¨¡å¼åˆ—è¡¨</p><pre><code class="ruby">spec.ios.exclude_files = 'Classes/osx'spec.exclude_files = 'Classes/**/unused.{h,m}'</code></pre><p><strong>preserve_paths</strong>ï¼šä¸‹è½½åä¸åº”åˆ é™¤çš„æ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCocoaPods ä¼šåˆ é™¤ä¸å…¶ä»–æ–‡ä»¶æ¨¡å¼ä¸åŒ¹é…çš„æ‰€æœ‰æ–‡ä»¶</p><pre><code class="ruby">spec.preserve_path = 'IMPORTANT.txt'spec.preserve_paths = 'Frameworks/*.framework'</code></pre><p><strong>module_map</strong>ï¼špod ç»§æ‰¿ä¸º framework æ—¶ä½¿ç”¨çš„æ¨¡å—æ˜ å°„æ–‡ä»¶ï¼Œé»˜è®¤ä¸º trueï¼ŒCocoaPods æ ¹æ® å…¬å…±å¤´æ–‡ä»¶åˆ›å»º module_map æ–‡ä»¶ã€‚</p><pre><code class="ruby">spec.module_map = 'source/module.modulemap'spec.module_map = false</code></pre><h3 id="Subspecs"><a href="#Subspecs" class="headerlink" title="Subspecs"></a>Subspecs</h3><p><strong>subspec</strong>ï¼šå­æ¨¡å—çš„è§„èŒƒï¼›å®è¡ŒåŒé‡ç»§æ‰¿ï¼šspecs è‡ªåŠ¨ç»§æ‰¿æ‰€æœ‰ subspec ä½œä¸ºä¾èµ–é¡¹(é™¤éæŒ‡å®šé»˜è®¤ spec)ï¼›subspec ç»§æ‰¿äº†çˆ¶çº§çš„å±æ€§ï¼›</p><pre><code class="ruby"># é‡‡ç”¨ä¸åŒæºæ–‡ä»¶çš„ Specs, CocoaPods è‡ªåŠ¨å¤„ç†é‡å¤å¼•ç”¨é—®é¢˜subspec 'Twitter' do |sp|  sp.source_files = 'Classes/Twitter'endsubspec 'Pinboard' do |sp|  sp.source_files = 'Classes/Pinboard'end# å¼•ç”¨å…¶ä»–å­è§„èŒƒs.subspec "Core" do |ss|    ss.source_files  = "Sources/Moya/", "Sources/Moya/Plugins/"    ss.dependency "Alamofire", "~&gt; 5.0"    ss.framework  = "Foundation"  end  s.subspec "ReactiveSwift" do |ss|    ss.source_files = "Sources/ReactiveMoya/"    ss.dependency "Moya/Core"    ss.dependency "ReactiveSwift", "~&gt; 6.0"  end  s.subspec "RxSwift" do |ss|    ss.source_files = "Sources/RxMoya/"    ss.dependency "Moya/Core"    ss.dependency "RxSwift", "~&gt; 5.0"  endend# åµŒå¥—å­è§„èŒƒPod::Spec.new do |s|  s.name = 'Root'  s.subspec 'Level_1' do |sp|    sp.subspec 'Level_2' do |ssp|    end  endend</code></pre><p><strong>default_subspecs</strong>ï¼šé»˜è®¤å­è§„èŒƒæ•°ç»„åç§°ï¼Œä¸æŒ‡å®šå°†å…¨éƒ¨å­è§„èŒƒä½œä¸ºé»˜è®¤å­è§„èŒƒï¼Œ<code>:none</code> è¡¨ç¤ºä¸éœ€è¦ä»»ä½•å­è§„èŒƒã€‚</p><pre><code class="ruby">spec.default_subspec = 'Core'spec.default_subspecs = 'Core', 'UI'spec.default_subspecs = :none    </code></pre><p><strong>scheme</strong>ï¼šç”¨ä»¥ç»™æŒ‡å®š scheme configuration æ·»åŠ æ‹“å±•</p><pre><code class="ruby">spec.scheme = { :launch_arguments =&gt; ['Arg1'] }spec.scheme = { :launch_arguments =&gt; ['Arg1', 'Arg2'], :environment_variables =&gt; { 'Key1' =&gt; 'Val1'} }</code></pre><p><strong>test_spec</strong>ï¼šæµ‹è¯•è§„èŒƒï¼Œåœ¨ 1.8 ç‰ˆæœ¬æ”¯æŒã€‚å¯å‚è€ƒï¼š<a href="https://blog.cocoapods.org/CocoaPods-1.8.0-beta/">CocoaPods 1.8 Beta</a></p><p><strong>requires_app_host</strong>ï¼šæ˜¯å¦éœ€è¦å®¿ä¸» APP è¿è¡Œæµ‹è¯•ï¼Œä»…é€‚ç”¨äºæµ‹è¯•è§„èŒƒã€‚</p><p><strong>app_host_name</strong>ï¼šå¿…è¦æ—¶ä½œç”¨äºåº”ç”¨ç¨‹åºçš„åº”ç”¨ç¨‹åºè§„èŒƒåç§°</p><p><strong>app_spec</strong>ï¼šå®¿ä¸» APP è§„èŒƒ</p><pre><code class="ruby">Pod::Spec.new do |s|  s.name         = 'CannonPodder'  s.version      = '1.0.0'  # ...rest of attributes here  s.app_spec 'DemoApp' do |app_spec|    app_spec.source_files = 'DemoApp/**/*.swift'    # Dependency used only by this app spec.    app_spec.dependency 'Alamofire'  end  s.test_spec 'Tests' do |test_spec|    test_spec.requires_app_host = true    # Use 'DemoApp' as the app host.    test_spec.app_host_name = 'CannonPodder/DemoApp'    # ...rest of attributes here    # This is required since 'DemoApp' is specified as the app host.    test_spec.dependency 'CannonPodder/DemoApp'  endend</code></pre><h3 id="Multi-Platform-support"><a href="#Multi-Platform-support" class="headerlink" title="Multi-Platform support"></a>Multi-Platform support</h3><p>å­˜å‚¨ç‰¹å®šäºæŸä¸€ä¸ªå¹³å°çš„å€¼ï¼Œåˆ†åˆ«ä¸º iosã€osxã€macOSã€tvosã€watchosï¼š</p><pre><code class="ruby">spec.resources = 'Resources/**/*.png'spec.ios.resources = 'Resources_ios/**/*.png'</code></pre><h2 id="Pod-çš„å¼€å‘æµç¨‹"><a href="#Pod-çš„å¼€å‘æµç¨‹" class="headerlink" title="Pod çš„å¼€å‘æµç¨‹"></a>Pod çš„å¼€å‘æµç¨‹</h2><p>äº†è§£å®Œ Podfile å’Œ podspec çš„ç›¸å…³çš„è§„èŒƒä¹‹åï¼Œé‚£ä¹ˆå¼€å‘è‡ªå·±çš„ pod åº”è¯¥æ˜¯ä¸€ä»¶é©¾è½»å°±ç†Ÿçš„äº‹ã€‚</p><h3 id="Spec-Repo"><a href="#Spec-Repo" class="headerlink" title="Spec Repo"></a>Spec Repo</h3><p>Spec Repo æ˜¯ podspec çš„ä»“åº“ï¼Œå³æ˜¯å­˜å‚¨ç›¸å…³çš„ podspec æ–‡ä»¶çš„åœ°æ–¹ã€‚æœ¬åœ°æºå­˜å‚¨äº ~/.cocoapods/reposä¸­ï¼Œå®ƒä» git ä¸Šæ‹‰å–å¹¶å®Œå…¨ä¿ç•™ç›®å½•ç»“æ„ã€‚å¯ä»¥å‘ç°ï¼Œ Master Specs Repo çš„ç°åœ¨ç›®å½•ç»“æ„æœ‰äº›ç‰¹æ®Šï¼›ä»¥å¾€ç‰ˆæœ¬çš„ Master Spec Repo æ˜¯å®Œå…¨åœ¨åŒä¸€ç›®å½•ä¸‹çš„ï¼Œä½†è‹¥å¤§é‡æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸­ä¼šå¯¼è‡´äº† <a href="https://github.com/CocoaPods/CocoaPods/issues/4989#issuecomment-193772935">Github ä¸‹è½½æ…¢</a> çš„é—®é¢˜ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé‡‡ç”¨æ•£åˆ—è¡¨å½¢å¼å¤„ç†ã€‚å…·ä½“æ–¹å¼ä¸ºå¯¹åç§°è¿›è¡Œ MD5 è®¡ç®—å¾—åˆ°æ•£åˆ—å€¼ï¼Œå–å‰ä¸‰ä½ä½œä¸ºç›®å½•å‰ç¼€ï¼Œä»¥å¯¹æ–‡ä»¶åˆ†æ•£åŒ–ã€‚åˆæ¬¡ä¹‹å¤–ï¼ŒCocoaPods åç»­è¿˜é‡‡ç”¨ CDN ä»¥åŠ trunk è¿›ä¸€æ­¥åŠ å¿«ä¸‹è½½é€Ÿåº¦ï¼Œæœ‰å…´è¶£å¯ä»¥å‚è€ƒ <a href="http://chuquan.me/2022/01/07/source-analyze-principle/">CocoaPods Source ç®¡ç†æœºåˆ¶</a>ã€‚</p><p>å¦‚ï¼š<code>md5("CJFoundation") =&gt; 044d913fdd5a52b303222c357521f744</code>ï¼›<code>CJFoundation</code> åˆ™åœ¨ /Specs/0/4/4 ç›®å½•ä¸­</p><p><img src="https://raw.githubusercontent.com/xuhaodong1/resource/master/image-20221215171557476.png" alt="image-20221215171557476"></p><h3 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h3><p>åªéœ€åˆ©ç”¨  <code>pod lib create [PodName]</code> å‘½ä»¤ä¾¿å¯ä»¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè‡ªå·±çš„ pod ã€‚å¡«å†™å¥½ä½¿ç”¨å¹³å°ã€ä½¿ç”¨è¯­è¨€ã€æ˜¯å¦åŒ…å« Demoã€æµ‹è¯•æ¡†æ¶ç­‰ä¿¡æ¯ï¼ŒCocoaPods ä¼šä»é»˜è®¤çš„ Git åœ°å€ä¸­æ‹‰å–ä¸€ä»½ pod æ¨¡ç‰ˆï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡ <code>--template-url=URL</code> æŒ‡å®šæ¨¡ç‰ˆåœ°å€ã€‚åœ¨æ‰§è¡Œå®Œåï¼Œæ•´ä¸ªæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><pre><code class="swift">tree CustomPod -L 2CustomPodâ”œâ”€â”€ CustomPodâ”‚   â”œâ”€â”€ Assets // å­˜æ”¾èµ„æºæ–‡ä»¶â”‚   â””â”€â”€ Classesâ”‚       â””â”€â”€ RemoveMe.[swift/m] // å•ä¸€æ–‡ä»¶ä»¥ç¡®ä¿æœ€åˆç¼–è¯‘å·¥ä½œâ”œâ”€â”€ CustomPod.podspec // Pod çš„ spec æ–‡ä»¶, æ˜¯ä¸€ä¸ª Pod ä¾èµ–çš„ç´¢å¼•ä»¥åŠè§„èŒƒä¿¡æ¯â”œâ”€â”€ Example // ç”¨ä½œæ¼”ç¤º/æµ‹è¯•çš„ç¤ºä¾‹é¡¹ç›®â”‚   â”œâ”€â”€ CustomPodâ”‚   â”œâ”€â”€ CustomPod.xcodeprojâ”‚   â”œâ”€â”€ CustomPod.xcworkspaceâ”‚   â”œâ”€â”€ Podfileâ”‚   â”œâ”€â”€ Podfile.lockâ”‚   â”œâ”€â”€ Podsâ”‚   â””â”€â”€ Testsâ”œâ”€â”€ _Pods.xcodeproj -&gt; Example/Pods/Pods.xcodeproj // æŒ‡å‘ Pods é¡¹ç›®çš„ä»¥è·å¾— Carthage æ”¯æŒâ”œâ”€â”€ LICENSE // è®¸å¯è¯â””â”€â”€ README.md  // è‡ªè¿°æ–‡ä»¶</code></pre><h3 id="Development"><a href="#Development" class="headerlink" title="Development"></a>Development</h3><p>å°†æºæ–‡ä»¶å’Œèµ„æºåˆ†åˆ«æ”¾å…¥ Classes / Assets æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ–è€…æŒ‰ä½ å–œæ¬¢çš„æ–¹å¼ç»„ç»‡æ–‡ä»¶ï¼Œå¹¶åœ¨ podspec æ–‡ä»¶ä¸­ç¼–è¾‘ç›¸åº”é¡¹ã€‚å¦‚æœä½ æœ‰ä»»ä½•æƒ³ä½¿ç”¨çš„é…ç½®é¡¹ï¼Œå¯å‚è€ƒå‰é¢çš„podsepc è¯­æ³•è§„èŒƒ ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¼€å‘ Pod ä¸€èˆ¬éƒ½æ˜¯ä½œä¸ºæœ¬åœ° Pod è¢«å…¶ä»– Project æ‰€ä¾èµ–è¿›è¡Œå¼€å‘ï¼Œæ— è®ºæ˜¯ä½¿ç”¨ example æ–‡ä»¶å¤¹çš„ project æˆ–è€…å…¶ä»–çš„ Projectã€‚</p><p><code>pod 'Name', :path =&gt; '~/CustomPod/'</code></p><h3 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h3><p>é€šè¿‡ <code>pod lib lint</code> ä»¥éªŒè¯ Pod ä»“åº“çš„ä½¿ç”¨æ˜¯å¦æ­£å¸¸ã€‚</p><h3 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h3><p>å‰é¢æåˆ°è¿‡ podspec å¯ä»¥çœ‹ä½œæ˜¯æ•´ä¸ªä»“åº“çš„ç´¢å¼•æ–‡ä»¶ï¼Œæœ‰äº†è¿™ä¸ªæ–‡ä»¶ä¹Ÿå°±èƒ½ç»„ç»‡èµ·ä¸€ä¸ª Podã€‚å› æ­¤å®˜æ–¹çš„æºä»¥åŠç§æœ‰æºéƒ½åªéœ€è¦ podspec å³å¯ï¼Œè€Œå…¶ä»–æ–‡ä»¶åˆ™åº”æ¨é€åˆ° podspec ä¸­ source ä¸­æŒ‡å®šä»“åº“ï¼Œè¿™ä¸ªä»“åº“åº”è¯¥æ˜¯ä½ è‡ªåˆ›å»ºçš„ã€‚</p><p>åœ¨å‡†å¤‡å‘å¸ƒæ¨é€æºä»£ç æ—¶ï¼Œéœ€è¦æ›´æ–°ç‰ˆæœ¬å·ä»¥åŠåœ¨ git ä¸Šæ‰“ä¸Š tagï¼Œè¿™æ˜¯ä¸ºäº†è¿›è¡Œç‰ˆæœ¬å·åŒ¹é…ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹çš„ podspec æ–‡ä»¶ä¸­ï¼š</p><pre><code class="ruby">s.source = { :git =&gt; 'https://github.com/XXX/CustomPod.git', :tag =&gt; s.version.to_s }</code></pre><p>å¯èƒ½ä½ çš„å·¥ä½œæµæ“ä½œå¦‚ä¸‹ï¼š</p><pre><code class="shell">$ cd ~/code/Pods/NAME$ edit NAME.podspec# set the new version to 0.0.1# set the new tag to 0.0.1$ pod lib lint$ git add -A &amp;&amp; git commit -m "Release 0.0.1."$ git tag '0.0.1'$ git push --tags</code></pre><p>å­˜æœ‰å‡ ç§æ–¹å¼æ¨é€ podspec æ–‡ä»¶ï¼š</p><ol><li>æ¨é€åˆ°<a href="https://github.com/CocoaPods/Specs.git">å…¬å…±ä»“åº“</a>ï¼Œéœ€è¦ç”¨åˆ°çš„ trunk å­å‘½ä»¤ï¼Œæ›´å¤šå¯ä»¥å‚è€ƒ <a href="https://guides.cocoapods.org/making/getting-setup-with-trunk">Getting setup with Trunk</a>ï¼š</li></ol><pre><code class="shell"># é€šè¿‡ç”µå­é‚®ç®±è¿›è¡Œæ³¨å†Œpod trunk register orta@cocoapods.org 'Orta Therox' --description='macbook air' # å°†æŒ‡å®špodspecæ–‡ä»¶æ¨é€åˆ°å…¬å…±ä»“åº“ä¸­pod trunk push [NAME.podspec] # æ·»åŠ å…¶ä»–äººä½œä¸ºåä½œè€…pod trunk add-owner ARAnalytics kyle@cocoapods.org </code></pre><ol start="2"><li>æ¨é€åˆ°ç§æœ‰æºï¼Œä¾‹å¦‚ <a href="https://github.com/artsy/Specs">Artsy/Specs</a>ï¼Œéœ€è¦ç”¨åˆ° repo å­å‘½ä»¤ï¼Œæ›´å¤šå¯ä»¥å‚è€ƒ <a href="https://guides.cocoapods.org/making/private-cocoapods">Private Pods</a>ï¼š</li></ol><pre><code class="shell"># å°†ç§æœ‰æºåœ°å€æ·»åŠ åˆ°æœ¬åœ°pod repo add REPO_NAME SOURCE_URL # æ£€æŸ¥ç§æœ‰æºæ˜¯å¦å®‰è£…æˆåŠŸå¹¶å‡†å¤‡å°±ç»ªcd ~/.cocoapods/repos/REPO_NAMEpod repo lint .# å°†Podçš„podspecæ·»åŠ åˆ°æŒ‡å®šREPO_NAMEä¸­pod repo push REPO_NAME SPEC_NAME.podspec</code></pre><ol start="3"><li>ä¸æ¨é€åˆ°ä»»ä½•æºä¸­ï¼Œè‹¥èƒ½å­˜åœ¨ä»¥ URL æ–¹å¼æ£€ç´¢åˆ° podspecæ–‡ä»¶ï¼Œåˆ™å¯ç”¨è¯¥ URLï¼Œä¸€èˆ¬é‡‡ç”¨ä»“åº“åœ°å€ï¼Œä¾‹å¦‚ï¼š</li></ol><pre><code class="ruby">pod 'AFNetworking', :git =&gt; 'https://github.com/XXX/CustomPod.git'</code></pre><h3 id="Semantic-Versioning"><a href="#Semantic-Versioning" class="headerlink" title="Semantic Versioning"></a>Semantic Versioning</h3><p>è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶é¡¾åæ€ä¹‰æ˜¯ä¸€ç§è¯­ä¹‰ä¸Šçš„ç‰ˆæœ¬æ§åˆ¶ï¼Œå®ƒä¸è¦æ±‚å¼ºåˆ¶éµå¾ªï¼Œåªæ˜¯å¸Œæœ›å¼€å‘è€…èƒ½å¤Ÿå°½é‡éµå®ˆã€‚å¦‚æœåº“ä¹‹é—´ä¾èµ–å…³ç³»è¿‡é«˜ï¼Œå¯èƒ½é¢ä¸´ç‰ˆæœ¬æ§åˆ¶è¢«é”æ­»çš„é£é™©ï¼ˆå¯èƒ½éœ€è¦å¯¹æ¯ä¸€ä¸ªä¾èµ–åº“æ”¹ç‰ˆæ‰èƒ½å®ŒæˆæŸæ¬¡å‡çº§ï¼‰ï¼›å¦‚æœåº“ä¹‹é—´ä¾èµ–å…³ç³»è¿‡äºæ¾æ•£ï¼Œåˆå°†æ— æ³•é¿å…ç‰ˆæœ¬çš„æ··ä¹±ï¼ˆå¯èƒ½åº“å…¼å®¹æ€§ä¸å†èƒ½æ”¯æŒä»¥å¾€ç‰ˆæœ¬ï¼‰ï¼Œè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶æ­£æ˜¯ä½œä¸ºè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚æ— è®ºåœ¨ CocoaPods ä¸­ï¼Œè¿˜æ˜¯ Swift Packager Manager ä¸Šï¼Œå®˜æ–¹éƒ½å¸Œæœ›åº“å¼€å‘è€…çš„çš„ç‰ˆæœ¬å·èƒ½éµå¾ªè¿™ä¸€åŸåˆ™ï¼š</p><p>ä¾‹å¦‚ï¼Œç»™å®šç‰ˆæœ¬å· <code>MAJOR.MINOR.PATCH</code>ï¼š</p><ol><li><code>MAJOR</code>ï¼šè¿›è¡Œä¸å…¼å®¹çš„ API æ›´æ”¹æ—¶è¿›è¡Œä¿®æ”¹</li><li><code>MINOR</code>ï¼šå‘åå…¼å®¹çš„æ–¹å¼æ·»åŠ æ–°åŠŸèƒ½æ—¶è¿›è¡Œä¿®æ”¹</li><li><code>PATCH</code>ï¼šè¿›è¡Œå‘åå…¼å®¹çš„é”™è¯¯ä¿®å¤æ—¶è¿›è¡Œä¿®æ”¹</li></ol><p>å…ˆè¡Œç‰ˆæœ¬å·ä»¥åŠç‰ˆæœ¬ç¼–è¯‘ä¿¡æ¯å¯ä»¥æ·»åŠ åˆ° <code>MAJOR.MINOR.PATCH</code> åé¢ä»¥ä½œä¸ºå»¶ä¼¸ã€‚</p><h2 id="CocoaPods-åŸç†æµ…æ"><a href="#CocoaPods-åŸç†æµ…æ" class="headerlink" title="CocoaPods åŸç†æµ…æ"></a>CocoaPods åŸç†æµ…æ</h2><h3 id="CococaPods-æ ¸å¿ƒç»„ä»¶"><a href="#CococaPods-æ ¸å¿ƒç»„ä»¶" class="headerlink" title="CococaPods æ ¸å¿ƒç»„ä»¶"></a>CococaPods æ ¸å¿ƒç»„ä»¶</h3><p>CocoaPods è¢« Ruby ç®¡ç†ï¼Œå…¶æ ¸å¿ƒéƒ¨åˆ†ä¹Ÿè¢«åˆ†ä¸ºä¸€ä¸ªä¸€ä¸ªç»„ä»¶ã€‚ä¸‹è½½æºç ï¼Œå¯ä»¥çœ‹åˆ° Gemfile æ–‡ä»¶å¦‚ä¸‹ï¼Œå…¶ä¾èµ–äº†è‹¥å¹²ä¸ª gemï¼Œæœ‰æ„æ€çš„æ˜¯ <code>cp_gem</code> å‡½æ•°ï¼Œé€šè¿‡ <code>SKIP_UNRELEASED_VERSIONS</code> ä¸ <code>path</code> æ¥æ§åˆ¶æ˜¯å¦é‡‡ç”¨æœ¬åœ°çš„ gem è·¯å¾„ï¼Œå®ç°äº† DEVELOPMENT ä¸ RELEASE ç¯å¢ƒçš„åˆ‡æ¢ã€‚</p><pre><code class="ruby">SKIP_UNRELEASED_VERSIONS = false# Declares a dependency to the git repo of CocoaPods gem. This declaration is# compatible with the local git repos feature of Bundler.def cp_gem(name, repo_name, branch = 'master', path: false)  return gem name if SKIP_UNRELEASED_VERSIONS  opts = if path           { :path =&gt; "../#{repo_name}" }         else           url = "https://github.com/CocoaPods/#{repo_name}.git"           { :git =&gt; url, :branch =&gt; branch }         end  gem name, optsendsource 'https://rubygems.org'gemspecgroup :development do  cp_gem 'claide',                'CLAide'  cp_gem 'cocoapods-core',        'Core'  cp_gem 'cocoapods-deintegrate', 'cocoapods-deintegrate'  cp_gem 'cocoapods-downloader',  'cocoapods-downloader'  cp_gem 'cocoapods-plugins',     'cocoapods-plugins'  cp_gem 'cocoapods-search',      'cocoapods-search'  cp_gem 'cocoapods-trunk',       'cocoapods-trunk'  cp_gem 'cocoapods-try',         'cocoapods-try'  cp_gem 'molinillo',             'Molinillo'  cp_gem 'nanaimo',               'Nanaimo'  cp_gem 'xcodeproj',             'Xcodeproj'  gem 'cocoapods-dependencies', '~&gt; 1.0.beta.1'  ...end</code></pre><p>è¿™äº›ç»„ä»¶ç›¸å¯¹ç‹¬ç«‹ï¼Œè¢«åˆ†æˆä¸€ä¸ªä¸€ä¸ª Gem åŒ…ï¼Œåœ¨ <a href="https://guides.cocoapods.org/contributing/components.html">Core Components</a> ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°å¯¹è¿™äº›ç»„ä»¶çš„ç®€è¦æè¿°ã€‚åŒæ—¶ä¹Ÿå¯ä»¥åˆ° CocoaPods çš„ Github ä¸­å»çœ‹è¯¦ç»†æ–‡æ¡£ã€‚</p><img src="https://raw.githubusercontent.com/xuhaodong1/resource/master/image-20221216104815073.png" style="zoom:40%;"><ul><li><strong>CocoaPods</strong>ï¼šå‘½ä»¤è¡Œæ”¯æŒä¸å®‰è£…ç¨‹åºï¼Œä¹Ÿä¼šå¤„ç† CocoaPods çš„æ‰€æœ‰ç”¨æˆ·äº¤äº’ã€‚</li><li><strong>cocoapods-core</strong>ï¼šå¯¹æ¨¡ç‰ˆæ–‡ä»¶çš„è§£æï¼Œå¦‚ Podfileã€.podspec ç­‰æ–‡ä»¶ã€‚</li><li><strong>CLAide</strong>ï¼šä¸€ä¸ªç®€å•çš„å‘½ä»¤è§£æå™¨ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå¿«é€Ÿåˆ›å»ºåŠŸèƒ½é½å…¨çš„å‘½ä»¤è¡Œç•Œé¢çš„ APIã€‚</li><li><strong>cocoapods-downloader</strong>ï¼šç”¨äºä¸‹è½½æºç ï¼Œä¸ºå„ç§ç±»å‹çš„æºä»£ç æ§åˆ¶å™¨(HTTP/SVN/Git/Mercurial) æä¾›ä¸‹è½½å™¨ã€‚å®ƒæä¾› tagsã€commitesã€revisionsã€branches ä»¥åŠ zips æ–‡ä»¶çš„ä¸‹è½½ä¸è§£å‹ç¼©æ“ä½œã€‚</li><li><strong>Monlinilloï¼šCocoaPods</strong>ï¼šå¯¹äºä¾èµ–ä»²è£ç®—æ³•çš„å°è£…ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…·æœ‰å‰é¡¹æ£€å¯Ÿçš„å›æº¯ç®—æ³•ã€‚ä¸ä»…åœ¨ pods ä¸­ï¼ŒBundler å’Œ RubyGems ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸€å¥—ä»²è£ç®—æ³•ã€‚</li><li><strong>Xcodeproj</strong>ï¼šé€šè¿‡ Ruby æ¥å¯¹ Xcode projects è¿›è¡Œåˆ›å»ºäºä¿®æ”¹ã€‚å¦‚ï¼šè„šæœ¬ç®¡ç†ã€libraries æ„å»ºã€Xcode workspece å’Œé…ç½®æ–‡ä»¶çš„ç®¡ç†ã€‚</li><li><strong>cocoapods-plugins</strong>ï¼šæ’ä»¶ç®¡ç†ï¼Œå…¶ä¸­æœ‰ pod plugins å‘½ä»¤å¸®åŠ©ä½ è·å–çš„å¯ç”¨æ’ä»¶åˆ—è¡¨ä»¥åŠå¼€å‘ä¸€ä¸ªæ–°æ’ä»¶ç­‰åŠŸèƒ½ï¼Œå…·ä½“å¯ç”¨ <code>pod plugins --help</code> äº†è§£ã€‚</li></ul><h3 id="pod-install-åšäº†ä»€ä¹ˆ"><a href="#pod-install-åšäº†ä»€ä¹ˆ" class="headerlink" title="pod install åšäº†ä»€ä¹ˆ"></a>pod install åšäº†ä»€ä¹ˆ</h3><p>æ‰§è¡Œ <code>pod install --verbose</code>ï¼Œä¼šæ˜¾ç¤º pod install è¿‡ç¨‹ä¸­çš„æ›´å¤š debugging ä¿¡æ¯ã€‚ä¸‹æ–‡ä¸»è¦å‚è€ƒï¼š<a href="https://www.desgard.com/2020/08/17/cocoapods-story-2.html">æ•´ä½“æŠŠæ¡ CocoaPods æ ¸å¿ƒç»„ä»¶</a></p><p>ç»è¿‡æ¶ˆæ¯è½¬å‘ä¸ CLAide å‘½ä»¤è§£æï¼Œæœ€ç»ˆè°ƒç”¨äº† CocoaPods/lib/cocoapods/installer.rb çš„ install! å‡½æ•°ï¼Œä¸»è¦æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><img src="https://raw.githubusercontent.com/xuhaodong1/resource/master/image-20221216145652667.png" style="zoom:45%;"><pre><code class="ruby">def install!    prepare    resolve_dependencies    download_dependencies    validate_targets    clean_sandbox    if installation_options.skip_pods_project_generation?        show_skip_pods_project_generation_message        run_podfile_post_install_hooks    else    integrate    end    write_lockfiles    perform_post_install_actionsend</code></pre><h4 id="1-Install-ç¯å¢ƒå‡†å¤‡ï¼ˆprepareï¼‰"><a href="#1-Install-ç¯å¢ƒå‡†å¤‡ï¼ˆprepareï¼‰" class="headerlink" title="1. Install ç¯å¢ƒå‡†å¤‡ï¼ˆprepareï¼‰"></a>1. Install ç¯å¢ƒå‡†å¤‡ï¼ˆprepareï¼‰</h4><pre><code class="ruby">def prepare  # å¦‚æœæ£€æµ‹å‡ºå½“å‰ç›®å½•æ˜¯ Podsï¼Œç›´æ¥ raise ç»ˆæ­¢  if Dir.pwd.start_with?(sandbox.root.to_path)    message = 'Command should be run from a directory outside Pods directory.'    message &lt;&lt; "\n\n\tCurrent directory is #{UI.path(Pathname.pwd)}\n"    raise Informative, message  end  UI.message 'Preparing' do    # å¦‚æœ lock æ–‡ä»¶çš„ CocoaPods ä¸»ç‰ˆæœ¬å’Œå½“å‰ç‰ˆæœ¬ä¸åŒï¼Œå°†ä»¥æ–°ç‰ˆæœ¬çš„é…ç½®å¯¹ xcodeproj å·¥ç¨‹æ–‡ä»¶è¿›è¡Œæ›´æ–°    deintegrate_if_different_major_version    # å¯¹ sandbox(Pods) ç›®å½•å»ºç«‹å­ç›®å½•ç»“æ„    sandbox.prepare    # æ£€æµ‹ PluginManager æ˜¯å¦æœ‰ pre-install çš„ plugin    ensure_plugins_are_installed!    # æ‰§è¡Œæ’ä»¶ä¸­ pre-install çš„æ‰€æœ‰ hooks æ–¹æ³•    run_plugins_pre_install_hooks  endend</code></pre><p>åœ¨ prepare é˜¶æ®µä¼šå®Œæˆ <code>pod install</code> çš„ç¯å¢ƒå‡†å¤‡ï¼ŒåŒ…æ‹¬ç›®å½•ç»“æ„ã€ç‰ˆæœ¬ä¸€è‡´æ€§ä»¥åŠ <code>pre_install</code> çš„ hookã€‚</p><h4 id="2-è§£å†³ä¾èµ–å†²çªï¼ˆresolve-dependenciesï¼‰"><a href="#2-è§£å†³ä¾èµ–å†²çªï¼ˆresolve-dependenciesï¼‰" class="headerlink" title="2. è§£å†³ä¾èµ–å†²çªï¼ˆresolve dependenciesï¼‰"></a>2. è§£å†³ä¾èµ–å†²çªï¼ˆresolve dependenciesï¼‰</h4><pre><code class="ruby">def resolve_dependencies    # è·å– Sources    plugin_sources = run_source_provider_hooks    # åˆ›å»ºä¸€ä¸ª Analyzer    analyzer = create_analyzer(plugin_sources)    # å¦‚æœå¸¦æœ‰ repo_update æ ‡è®°    UI.section 'Updating local specs repositories' do        # æ‰§è¡Œ Analyzer çš„æ›´æ–° Repo æ“ä½œ        analyzer.update_repositories    end if repo_update?    UI.section 'Analyzing dependencies' do        # ä» analyzer å–å‡ºæœ€æ–°çš„åˆ†æç»“æœï¼Œ@analysis_resultï¼Œ@aggregate_targetsï¼Œ@pod_targets        analyze(analyzer)        # æ‹¼å†™é”™è¯¯é™çº§è¯†åˆ«ï¼Œç™½åå•è¿‡æ»¤        validate_build_configurations    end    # å¦‚æœ deployment? ä¸º trueï¼Œä¼šéªŒè¯ podfile &amp; lockfile æ˜¯å¦éœ€è¦æ›´æ–°    UI.section 'Verifying no changes' do        verify_no_podfile_changes!        verify_no_lockfile_changes!    end if deployment?    analyzerend</code></pre><p>é€šè¿‡ Podfileã€Podfile.lock ä»¥åŠ manifest.lock ç­‰ç”Ÿæˆ Analyzer å¯¹è±¡ï¼Œå…¶å†…éƒ¨ä¼šä½¿ç”¨ä¸ª Molinillo ç®—æ³•è§£æå¾—åˆ°ä¸€å¼ ä¾èµ–å…³ç³»è¡¨ï¼Œè¿›è¡Œä¸€ç³»åˆ—çš„åˆ†æä¸ä¾èµ–å†²çªè§£å†³ã€‚</p><h4 id="3-ä¸‹è½½ä¾èµ–æ–‡ä»¶ï¼ˆdownload-dependenciesï¼‰"><a href="#3-ä¸‹è½½ä¾èµ–æ–‡ä»¶ï¼ˆdownload-dependenciesï¼‰" class="headerlink" title="3. ä¸‹è½½ä¾èµ–æ–‡ä»¶ï¼ˆdownload dependenciesï¼‰"></a>3. ä¸‹è½½ä¾èµ–æ–‡ä»¶ï¼ˆdownload dependenciesï¼‰</h4><pre><code class="ruby">def download_dependencies  UI.section 'Downloading dependencies' do    # æ„é€  Pod Source Installer    install_pod_sources    # æ‰§è¡Œ podfile å®šä¹‰çš„ pre install çš„ hooks    run_podfile_pre_install_hooks    # æ ¹æ®é…ç½®æ¸…ç† pod sources ä¿¡æ¯ï¼Œä¸»è¦æ˜¯æ¸…ç†æ— ç”¨ platform ç›¸å…³å†…å®¹    clean_pod_sources  endend</code></pre><p>â€‹    ç»è¿‡å‰é¢åˆ†æä¸è§£å†³ä¾èµ–å†²çªåï¼Œè¿™æ˜¯ä¼šè¿›è¡Œä¾èµ–ä¸‹è½½ã€‚ä¼šæ ¹æ®ä¾èµ–ä¿¡æ¯æ˜¯å¦è¢«æ–°æ·»åŠ æˆ–è€…ä¿®æ”¹ç­‰ä¿¡æ¯è¿›è¡Œä¸‹è½½ï¼ŒåŒæ—¶ä¸‹è½½åä¹Ÿä¼šåœ¨æœ¬åœ°ç•™æœ‰ä¸€ä»½ç¼“å­˜ï¼Œå…¶ç›®å½•åœ¨ ï½/Library/Caches/CocoaPods ã€‚</p><h4 id="4-éªŒè¯-targetsï¼ˆvalidate-targetsï¼‰"><a href="#4-éªŒè¯-targetsï¼ˆvalidate-targetsï¼‰" class="headerlink" title="4. éªŒè¯ targetsï¼ˆvalidate targetsï¼‰"></a>4. éªŒè¯ targetsï¼ˆvalidate targetsï¼‰</h4><pre><code class="ruby">def validate_targets    validator = Xcode::TargetValidator.new(aggregate_targets, pod_targets, installation_options)    validator.validate!enddef validate!    verify_no_duplicate_framework_and_library_names    verify_no_static_framework_transitive_dependencies    verify_swift_pods_swift_version    verify_swift_pods_have_module_dependencies    verify_no_multiple_project_names if installation_options.generate_multiple_pod_projects?end</code></pre><p><strong>verify_no_duplicate_framework_and_library_names</strong>ï¼šéªŒè¯æ˜¯å¦æœ‰é‡åçš„ framework / library</p><p><strong>verify_no_static_framework_transitive_dependencies</strong>ï¼šéªŒè¯åŠ¨æ€åº“æ˜¯å¦æœ‰é™æ€é“¾æ¥åº“ä¾èµ–ã€‚ä¸ªäººè®¤ä¸ºï¼Œè¿™ä¸ªéªŒè¯æ˜¯ä¸å¿…è¦çš„ï¼Œèµ·ç ä¸å¿…è¦ errorã€‚</p><p><strong>verify_swift_pods_swift_version</strong>ï¼šéªŒè¯ Swift pod çš„ Swift ç‰ˆæœ¬é…ç½®ä¸”ç›¸äº’å…¼å®¹</p><p><strong>verify_swift_pods_have_module_dependencies</strong>ï¼šéªŒè¯ Swift pod æ˜¯å¦æ”¯æŒ module</p><p><strong>verify_no_multiple_project_names</strong>ï¼šéªŒè¯æ²¡æœ‰é‡åçš„ project åç§°</p><h4 id="5-ç”Ÿæˆå·¥ç¨‹ï¼ˆIntegrateï¼‰"><a href="#5-ç”Ÿæˆå·¥ç¨‹ï¼ˆIntegrateï¼‰" class="headerlink" title="5. ç”Ÿæˆå·¥ç¨‹ï¼ˆIntegrateï¼‰"></a>5. ç”Ÿæˆå·¥ç¨‹ï¼ˆIntegrateï¼‰</h4><pre><code class="ruby">def integrate    generate_pods_project    if installation_options.integrate_targets?        # é›†æˆç”¨æˆ·é…ç½®ï¼Œè¯»å–ä¾èµ–é¡¹ï¼Œä½¿ç”¨ xcconfig æ¥é…ç½®        integrate_user_project    else        UI.section 'Skipping User Project Integration'    endenddef generate_pods_project    # åˆ›å»º stage sanbox ç”¨äºä¿å­˜å®‰è£…å‰çš„æ²™ç›’çŠ¶æ€ï¼Œä»¥æ”¯æŒå¢é‡ç¼–è¯‘çš„å¯¹æ¯”    stage_sandbox(sandbox, pod_targets)    # æ£€æŸ¥æ˜¯å¦æ”¯æŒå¢é‡ç¼–è¯‘ï¼Œå¦‚æœæ”¯æŒå°†è¿”å› cache result    cache_analysis_result = analyze_project_cache    # éœ€è¦é‡æ–°ç”Ÿæˆçš„ target    pod_targets_to_generate = cache_analysis_result.pod_targets_to_generate    # éœ€è¦é‡æ–°ç”Ÿæˆçš„ aggregate target    aggregate_targets_to_generate = cache_analysis_result.aggregate_targets_to_generate    # æ¸…ç†éœ€è¦é‡æ–°ç”Ÿæˆ target çš„ header å’Œ pod folders    clean_sandbox(pod_targets_to_generate)    # ç”Ÿæˆ Pod Projectï¼Œç»„è£… sandbox ä¸­æ‰€æœ‰ Pod çš„ pathã€build settingã€æºæ–‡ä»¶å¼•ç”¨ã€é™æ€åº“æ–‡ä»¶ã€èµ„æºæ–‡ä»¶ç­‰    create_and_save_projects(pod_targets_to_generate, aggregate_targets_to_generate,                                cache_analysis_result.build_configurations, cache_analysis_result.project_object_version)    # SandboxDirCleaner ç”¨äºæ¸…ç†å¢é‡ pod å®‰è£…ä¸­çš„æ— ç”¨ headersã€target support files ç›®å½•    SandboxDirCleaner.new(sandbox, pod_targets, aggregate_targets).clean!    # æ›´æ–°å®‰è£…åçš„ cache ç»“æœåˆ°ç›®å½• `Pods/.project_cache` ä¸‹    update_project_cache(cache_analysis_result, target_installation_results)end</code></pre><p>å°†ä¹‹å‰ç‰ˆæœ¬ä»²è£çš„æ‰€æœ‰ç»„ä»¶é€šè¿‡ project æ–‡ä»¶çš„å½¢å¼ç»„ç»‡èµ·æ¥ï¼Œå¹¶å¯¹ project ä¸­åšä¸€äº›ç”¨æˆ·æŒ‡å®šçš„é…ç½®ã€‚</p><h4 id="6-å†™å…¥ä¾èµ–ï¼ˆwrite-lockfilesï¼‰"><a href="#6-å†™å…¥ä¾èµ–ï¼ˆwrite-lockfilesï¼‰" class="headerlink" title="6. å†™å…¥ä¾èµ–ï¼ˆwrite lockfilesï¼‰"></a>6. å†™å…¥ä¾èµ–ï¼ˆwrite lockfilesï¼‰</h4><pre><code class="ruby">def write_lockfiles  @lockfile = generate_lockfile  UI.message "- Writing Lockfile in #{UI.path config.lockfile_path}" do    # No need to invoke Sandbox#update_changed_file here since this logic already handles checking if the    # contents of the file are the same.    @lockfile.write_to_disk(config.lockfile_path)  end  UI.message "- Writing Manifest in #{UI.path sandbox.manifest_path}" do    # No need to invoke Sandbox#update_changed_file here since this logic already handles checking if the    # contents of the file are the same.    @lockfile.write_to_disk(sandbox.manifest_path)  endend</code></pre><p>å°†ä¾èµ–æ›´æ–°å†™å…¥ Podfile.lock ä¸ Manifest.lock</p><h4 id="7-ç»“æŸå›è°ƒï¼ˆperform-post-install-actionï¼‰"><a href="#7-ç»“æŸå›è°ƒï¼ˆperform-post-install-actionï¼‰" class="headerlink" title="7. ç»“æŸå›è°ƒï¼ˆperform post install actionï¼‰"></a>7. ç»“æŸå›è°ƒï¼ˆperform post install actionï¼‰</h4><pre><code class="ruby">def perform_post_install_actions  # è°ƒç”¨ HooksManager æ‰§è¡Œæ¯ä¸ªæ’ä»¶çš„ post_install æ–¹æ³•   run_plugins_post_install_hooks  # æ‰“å°è¿‡æœŸ pod target è­¦å‘Š  warn_for_deprecations  # å¦‚æœ pod é…ç½®äº† script phases è„šæœ¬ï¼Œä¼šä¸»åŠ¨è¾“å‡ºä¸€æ¡æç¤ºæ¶ˆæ¯  warn_for_installed_script_phases  # è­¦å‘Šç§»é™¤çš„ master specs repo çš„ specs  warn_for_removing_git_master_specs_repo  # è¾“å‡ºç»“æŸä¿¡æ¯ `Pod installation complete!`  print_post_install_messageend</code></pre><p>æœ€åçš„æ”¶å°¾å·¥ä½œï¼Œè¿›è¡Œ <code>post install action</code> çš„ hook æ‰§è¡Œä»¥åŠä¸€äº› warning æ‰“å°ã€‚</p><h2 id="CocoaPods-Plugins"><a href="#CocoaPods-Plugins" class="headerlink" title="CocoaPods + Plugins"></a>CocoaPods + Plugins</h2><p>æ—©åœ¨ 2013 å¹´ï¼ŒCocoaPods å°±æ·»åŠ äº†å¯¹æ’ä»¶çš„æ”¯æŒï¼Œä»¥æ·»åŠ ä¸ç¬¦åˆä¾èµ–ç®¡ç†å’Œç”Ÿæ€ç³»ç»Ÿå¢é•¿ä¸ºä¸»è¦ç›®æ ‡çš„åŠŸèƒ½ã€‚CocoaPods Plugins å¯ä»¥ï¼šåœ¨ install å‰åæ·»åŠ  hookã€æ·»åŠ æ–°å‘½ä»¤åˆ° podã€ä»¥åŠåˆ©ç”¨ Ruby åŠ¨æ€æ€§åšä»»ä½•äº‹ã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹å¸¸è§çš„æ’ä»¶ï¼š</p><ul><li><p><a href="https://github.com/leavez/cocoapods-binary">cocoapods-binary</a>ï¼šä¸€ä¸ªæ¯”è¾ƒæ—©æœŸçš„äºŒè¿›åˆ¶æ’ä»¶åº“ï¼Œæ˜¯è¯¸å¤šäºŒè¿›åˆ¶æ–¹æ¡ˆçš„çµæ„Ÿæ¥æº</p></li><li><p><a href="https://github.com/wordpress-mobile/cocoapods-repo-update">cocoapods-repo-update</a>ï¼šè‡ªåŠ¨åŒ– pod repo update</p></li><li><p><a href="https://github.com/upgrad/cocoapods-integrate-flutter">cocoapods-integrate-flutter</a>ï¼šå°† flutter ä¸ç°æœ‰ iOS åº”ç”¨ç¨‹åºé›†æˆ</p></li><li><p><a href="https://github.com/alibaba/cocoapods-uploader">cocoapods-uploader</a>ï¼šä¸Šä¼ æ–‡ä»¶/ç›®å½•åˆ°è¿œç¨‹ä»“åº“</p></li></ul><p>psï¼šè®¸å¤šæ’ä»¶å¯èƒ½è®¸ä¹…æœªç»´æŠ¤ï¼Œè¯»è€…ä½¿ç”¨éœ€è‡ªè¡Œæ–Ÿé…Œã€‚</p><h2 id="ä¸å¤ªå¸¸è§æ¦‚å¿µ"><a href="#ä¸å¤ªå¸¸è§æ¦‚å¿µ" class="headerlink" title="ä¸å¤ªå¸¸è§æ¦‚å¿µ"></a>ä¸å¤ªå¸¸è§æ¦‚å¿µ</h2><p>CocoaPods çš„é…ç½®å†…å®¹å‡ ä¹åŒ…å«äº† Xcode Build çš„æ–¹æ–¹é¢é¢ï¼Œå› æ­¤å­˜åœ¨è®¸å¤šä¸å¤ªå¸¸è§çš„æ¦‚å¿µï¼Œåœ¨æ­¤åšä¸€ä¸ªé“¾æ¥èšåˆä»¥ä¾›å‚è€ƒã€‚</p><ul><li>Clang Module / module_map / umbrella headerï¼šClang Module æ˜¯ Clang 16.0.0 ä¸­å¼•å…¥çš„æ¦‚å¿µï¼Œç”¨ä»¥è§£å†³ #include / #import å¤´æ–‡ä»¶å¼•å…¥å¯¼è‡´çš„ç›¸å…³é—®é¢˜ï¼›module_map æ˜¯ç”¨ä»¥æè¿° clang module ä¸ header çš„å…³ç³»ï¼›umbrella header åˆ™æ˜¯ module_map ä¸­çš„è¯­æ³•è§„èŒƒï¼Œè¡¨ç¤ºæŒ‡å®šç›®å½•ä¸­çš„å¤´æ–‡ä»¶éƒ½åº”åŒ…å«åœ¨æ¨¡å—ä¸­ã€‚</li></ul><p><a href="https://clang.llvm.org/docs/Modules.html#introduction">Modules</a></p><p><a href="http://chuquan.me/2021/02/11/clang-module/">Clang Module</a></p><p><a href="https://www.stephenw.cc/2017/08/23/llvm-modules/">LLVM ä¸­çš„ Module</a></p><ul><li>Hmap / Xcode Header / CocoaPods Headers</li></ul><p>Header Map æ˜¯ä¸€ç»„å¤´æ–‡ä»¶ä¿¡æ¯æ˜ å°„è¡¨ï¼Œç”¨ .hmap åç¼€è¡¨ç¤ºï¼Œæ•´ä½“ç»“æ„ä»¥ Key-Value å½¢å¼å­˜å‚¨ï¼›Keyä¸ºå¤´æ–‡ä»¶åç§°ã€Value ä¸º å¤´æ–‡ä»¶ç‰©ç†åœ°å€ã€‚</p><p>Xcode Phases - Header åœ¨æ„å»ºé…ç½®ä¸­åˆ†ä¸º publicã€private ä¸ project ï¼Œç”¨ä»¥ä¸ target å…³è”ï¼›å…¶ä¸­ public ã€private å°±å¤åˆ¶åˆ°æœ€ç»ˆäº§ç‰©çš„ header å’Œ PrivateHeaders ä¸­ï¼Œè€Œ project å¤´æ–‡ä»¶ä¸å¯¹å¤–ä½¿ç”¨ï¼Œåˆ™ä¸ä¼šæ”¾åˆ°æœ€ç»ˆäº§ç‰©ã€‚</p><p><a href="https://tech.meituan.com/2021/02/25/cocoapods-hmap-prebuilt.html">ä¸€æ¬¾å¯ä»¥è®©å¤§å‹iOSå·¥ç¨‹ç¼–è¯‘é€Ÿåº¦æå‡50%çš„å·¥å…·</a></p><p><a href="https://help.apple.com/xcode/mac/current/#/dev50bab713d">What are build phases?</a></p><ul><li>Xcconfigï¼š</li></ul><p>ä¸€ç§é…ç½®æ–‡ä»¶ï¼Œç”¨ä»¥å¯¹æ„å»ºè®¾ç½®è¿›è¡Œå£°æ˜ä¸ç®¡ç†ï¼Œæ¯”å¦‚åŒºåˆ†ä¸åŒçš„å¼€å‘ç¯å¢ƒç­‰ã€‚</p><p><a href="https://nshipster.com/xcconfig/">Xcode Build Configuration Files</a></p><ul><li>On demand resourceï¼šWWDC 2015 å¼•å…¥çš„æ¦‚å¿µï¼Œå¯¹èµ„æºæ–‡ä»¶çš„æŒ‰éœ€åŠ è½½ã€‚</li></ul><p><a href="https://developer.apple.com/videos/play/wwdc2015/214/">Introducing On Demand Resources</a></p><h2 id="ğŸ”—ï¼š"><a href="#ğŸ”—ï¼š" class="headerlink" title="ğŸ”—ï¼š"></a>ğŸ”—ï¼š</h2><p>[1] <a href="https://cocoapods.org/">Cocoapods.org</a></p><p>[2] <a href="https://medium.com/orion-innovation-turkey/xcode-workspace-with-multiple-projects-1b42f5182c45">Xcode Workspace with multiple projects</a></p><p>[3] <a href="https://objccn.io/issue-6-4/">æ·±å…¥ç†è§£ CocoaPods</a></p><p>[4] <a href="http://chuquan.me/2021/02/14/understand-ios-library-and-framework/">ç³»ç»Ÿç†è§£ iOS åº“ä¸æ¡†æ¶</a></p><p>[5] <a href="https://swiftunwrap.com/article/cocoapods-script-phases/">Cocoapods script phases</a></p><p>[6] <a href="http://chuquan.me/2021/12/24/podfile-analyze-principle/">CocoaPods Podfile è§£æåŸç†</a></p><p>[7] <a href="https://semver.org/">Semantic Versioning 2.0.0</a></p><p>[8] <a href="https://tech.meituan.com/2021/02/25/cocoapods-hmap-prebuilt.html">ä¸€æ¬¾å¯ä»¥è®©å¤§å‹iOSå·¥ç¨‹ç¼–è¯‘é€Ÿåº¦æå‡50%çš„å·¥å…·</a></p><p>[9] <a href="http://chuquan.me/2022/01/07/source-analyze-principle/#more">CocoaPods Source ç®¡ç†æœºåˆ¶</a></p><p>[10] <a href="https://www.desgard.com/2020/06/11/cocoapods-story-1.html#podfilelock">ç‰ˆæœ¬ç®¡ç†å·¥å…·åŠ Ruby å·¥å…·é“¾ç¯å¢ƒ</a></p><p>[11] <a href="https://www.desgard.com/2020/08/17/cocoapods-story-2.html">æ•´ä½“æŠŠæ¡ CocoaPods æ ¸å¿ƒç»„ä»¶</a></p><p>[12] <a href="https://binlogo.github.io/post/gong-cheng-xiao-lu-you-hua-cocoapods-you-hua/">å·¥ç¨‹æ•ˆç‡ä¼˜åŒ–ï¼šCocoaPodsä¼˜åŒ–</a></p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CocoaPods </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOSä¸­çš„äº‹ä»¶ä»¥åŠäº‹ä»¶ä¼ é€’æœºåˆ¶</title>
      <link href="/2022/07/08/iOS%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BB%A5%E5%8F%8A%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6/"/>
      <url>/2022/07/08/iOS%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BB%A5%E5%8F%8A%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>iOS ä¸­æœ‰ 8 ç§äº‹ä»¶ï¼Œæœ¬æ–‡é‡ç‚¹ä»‹ç»è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’æœºåˆ¶ä¸å“åº”æµç¨‹ã€‚å¯ä»¥å¸¦ç€ä»¥ä¸‹é—®é¢˜é˜…è¯»ï¼š</p><ul><li>iOS ä¸­æœ‰å“ªäº›äº‹ä»¶ç±»å‹ï¼Œè°æ¥è¿›è¡Œäº‹ä»¶çš„å“åº”ï¼Œæ€ä¹ˆæ¥å“åº”å‘¢ï¼Ÿ</li><li>è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’ä¸å“åº”æµç¨‹</li><li><code>hitTest</code> æ–¹æ³•çš„ä½œç”¨ï¼Œå®ƒæœ‰ä»€ä¹ˆå®è·µåœºæ™¯ï¼Ÿ</li><li><code>UIControl</code> ä¸ <code>UIGestureRecognizer</code> ä¹Ÿèƒ½å“åº”è§¦æ‘¸äº‹ä»¶ï¼Œ<code>UIResponder</code> çš„å“åº”æ–¹å¼æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ<span id="more"></span></li></ul><h2 id="å“åº”è€…-amp-å“åº”è€…é“¾"><a href="#å“åº”è€…-amp-å“åº”è€…é“¾" class="headerlink" title="å“åº”è€… &amp; å“åº”è€…é“¾"></a>å“åº”è€… &amp; å“åº”è€…é“¾</h2><ul><li>å“åº”è€…å³ <code>UIResponder class</code> çš„ä¸€ä¸ªå®ä¾‹ï¼›</li><li>å“åº”è€…é“¾ä¸ºå“åº”è€…ç»„æˆçš„ä¸€ä¸ªé“¾å¼ç»“æ„ï¼Œä¸åŒçš„é“¾å¼ç»“æ„ç»„åˆèµ·æ¥çœ‹èµ·æ¥åƒä¸€ä¸ªå€’è¿‡æ¥çš„æ ‘å½¢ç»“æ„ã€‚</li><li><code>UIResponder</code> ä¸­åŒ…å«äº†è®¸å¤šå¤„ç†äº‹ä»¶çš„æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨è¿™ä¸ªå¯¹è±¡é‡Œå“åº”äº‹ä»¶ï¼Œé‚£ä¹ˆé‡å†™è¿™ä¸ªæ–¹æ³•å³å¯ã€‚</li></ul><img src="/images/blog/responderChain.png" alt="A flow diagram: On the left, a sample app contains a label (UILabel), a text field for the user to input text (UITextField), and a button (UIButton) to  press after entering text in the field. On the right, the flow diagram shows how, after the user pressed the button, the event moves through the responder chainâ€”from UIView, to UIViewController, to UIWindow, UIApplication, and finally to UIApplicationDelegate." style="zoom:67%;"><ul><li><strong>UIView</strong>ï¼šå¦‚æœ <code>view</code> æ˜¯ <code>UIViewController</code> çš„ <code>root view</code>ï¼Œä¸‹ä¸€ä¸ªå“åº”è€…ä¸º <code>UIViewController</code>ï¼Œå¦åˆ™ä¸‹ä¸€ä¸ªå“åº”è€…ä¸º<code>superview</code>ã€‚</li><li><strong>UIViewController</strong>ï¼šå¦‚æœ <code>UIViewController</code> çš„ <code>view</code> æ˜¯ <code>UIWindow</code> çš„ <code>root view</code> ä¸‹ä¸€ä¸ªå“åº”è€…å¯¹è±¡æ˜¯ <code>window</code>ï¼›å¦‚æœ å½“å‰ <code>UIViewController</code> ç”±å¦ä¸€ä¸ª <code>UIViewController push</code> æˆ–è€… <code>presented</code>ï¼Œåˆ™ä¸‹ä¸€ä¸ªå“åº”è€…ä¸º å¼¹å‡ºè¯¥ <code>vc</code> çš„ <code>UIViewController</code>ï¼Œä¾‹å¦‚ <code>UINavigationController</code>ã€<code>UITableBarController</code>ã€‚</li><li><strong>UIWindow</strong>ï¼šä¸‹ä¸€ä¸ªå“åº”è€…ä¸º <code>UIApplication</code></li><li><strong>UIApplication</strong>ï¼šä¸‹ä¸€ä¸ªå“åº”è€…ä¸º <code>UIApplicationDelegate</code>ï¼Œå‰ææ˜¯å®ƒä¸æ˜¯ <code>UIView</code>ã€<code>UIViewController</code>ã€ä»¥åŠä¸æ˜¯ <code>UIApplication</code> æœ¬èº«ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯æŒ‡ <code>AppDelegate</code>ã€‚</li></ul><h2 id="äº‹ä»¶-amp-è°æ˜¯äº‹ä»¶çš„ç¬¬ä¸€å“åº”è€…"><a href="#äº‹ä»¶-amp-è°æ˜¯äº‹ä»¶çš„ç¬¬ä¸€å“åº”è€…" class="headerlink" title="äº‹ä»¶ &amp; è°æ˜¯äº‹ä»¶çš„ç¬¬ä¸€å“åº”è€…"></a>äº‹ä»¶ &amp; è°æ˜¯äº‹ä»¶çš„ç¬¬ä¸€å“åº”è€…</h2><table><thead><tr><th>äº‹ä»¶ç±»å‹</th><th>ç¬¬ä¸€å“åº”è€…</th></tr></thead><tbody><tr><td>è§¦æ‘¸äº‹ä»¶ touch events</td><td>å‘ç”Ÿè§¦æ‘¸çš„è§†å›¾</td></tr><tr><td>æŒ‰å‹äº‹ä»¶ press events</td><td>è¢«èšç„¦çš„å¯¹è±¡</td></tr><tr><td>æ‘‡åŠ¨äº‹ä»¶ shake-motion events</td><td>ä½ (or UIKit)æŒ‡å®šçš„å¯¹è±¡</td></tr><tr><td>è¿œç¨‹æ§åˆ¶äº‹ä»¶ remote-control event</td><td>ä½ (or UIKit)æŒ‡å®šçš„å¯¹è±¡</td></tr><tr><td>ç¼–è¾‘èœå•æ¶ˆæ¯ editing menu messages</td><td>ä½ (or UIKit)æŒ‡å®šçš„å¯¹è±¡</td></tr><tr><td>åŠ é€Ÿå™¨ accelerometers</td><td>å§”ä»»çš„å¯¹è±¡</td></tr><tr><td>é™€èº gyroscopes</td><td>å§”ä»»çš„å¯¹è±¡</td></tr><tr><td>ç£åŠ›ä»ª magnetometer</td><td>å§”ä»»çš„å¯¹è±¡</td></tr></tbody></table><p>åœ¨ iOS ä¸­ï¼Œæœ‰ 8 ç§ç±»å‹çš„äº‹ä»¶ï¼Œå“åº”è¿™äº›äº‹ä»¶çš„å¯¹è±¡è¢«ç§°ä¸ºå“åº”è€…ï¼Œç³»ç»Ÿçš„ä¸€äº›å¸¸è§çš„å“åº”è€…ä¸º <code>UIView</code>ã€<code>UIViewController</code>ã€<code>UIWindow</code>ã€<code>UIAppllication</code>ã€<code>AppDelegate</code>ï¼Œåœ¨æ‰¾åˆ°æœ€ä½³å“åº”è€…åï¼Œå¦‚æœäº‹ä»¶æ²¡æœ‰è¢«å¤„ç†ï¼Œäº‹ä»¶ä¼šéšç€å“åº”è€…é“¾è¿›è¡Œä¼ é€’ã€‚ä¸è¿‡æœ‰äº›äº‹ä»¶åœ¨è¿›è¡Œä¼ é€’çš„æ—¶å€™ï¼Œå³ä½¿é‡å†™äº†å“åº”äº‹ä»¶çš„æ–¹æ³•ï¼Œç‰¹å®šå¯¹è±¡ä¸ä¼šè¿›è¡Œå“åº”ï¼Œä¾‹å¦‚ <code>shake-motion events</code> ä¸ä¼šç”± <code>UIView</code>ã€<code>UIApplication</code>ã€<code>AppDelegate</code> è¿›è¡Œå“åº”ã€‚</p><ul><li>è§¦æ‘¸äº‹ä»¶ <code>touch events</code>ï¼Œæ˜¯ iOS ä¸­æœ€å¸¸è§çš„äº‹ä»¶ï¼Œæ¯ä¸€æ¬¡è§¦ç¢°éƒ½ä¼šç”± IOKit é€šè¿‡ IPC äº¤ç»™ SpringBoardï¼Œè¿›è€Œé€šè¿‡ <code>mach port</code> ä¼ é€’ç»™åˆé€‚çš„è¿›ç¨‹è¿›è¡Œå“åº”ï¼Œç¬¬ä¸€å“åº”è€…æ˜¯å‘ç”Ÿè§¦ç¢°çš„è§†å›¾ï¼Œåé¢ä¼šé‡ç‚¹è®²è§£ã€‚</li></ul><pre><code class="swift">open func touchesBegan(_ touches: Set&lt;UITouch&gt;, with event: UIEvent?)open func touchesMoved(_ touches: Set&lt;UITouch&gt;, with event: UIEvent?)open func touchesEnded(_ touches: Set&lt;UITouch&gt;, with event: UIEvent?)open func touchesCancelled(_ touches: Set&lt;UITouch&gt;, with event: UIEvent?)@available(iOS 9.1, *)open func touchesEstimatedPropertiesUpdated(_ touches: Set&lt;UITouch&gt;)</code></pre><ul><li>æŒ‰å‹äº‹ä»¶<code>press events</code>ï¼Œè¡¨ç¤ºå¦‚é¥æ§å™¨æˆ–è€…æ¸¸æˆæ‰‹æŸ„ä¸­è¿›è¡ŒæŒ‰å‹è§¦ç¢°è€Œäº§ç”Ÿçš„äº‹ä»¶ï¼Œç”±å½“å‰èšç„¦çš„å¯¹è±¡è¿›è¡Œå“åº”ã€‚</li></ul><pre><code class="swift">@available(iOS 9.0, *)open func pressesBegan(_ presses: Set&lt;UIPress&gt;, with event: UIPressesEvent?)@available(iOS 9.0, *)open func pressesChanged(_ presses: Set&lt;UIPress&gt;, with event: UIPressesEvent?)@available(iOS 9.0, *)open func pressesEnded(_ presses: Set&lt;UIPress&gt;, with event: UIPressesEvent?)@available(iOS 9.0, *)open func pressesCancelled(_ presses: Set&lt;UIPress&gt;, with event: UIPressesEvent?)</code></pre><ul><li>æ‘‡åŠ¨äº‹ä»¶ <code>shake-motion events</code>ï¼Œæ™ƒåŠ¨è®¾å¤‡è¿›è¡Œè§¦å‘ã€‚</li></ul><pre><code class="swift">open func motionBegan(_ motion: UIEvent.EventSubtype, with event: UIEvent?)open func motionEnded(_ motion: UIEvent.EventSubtype, with event: UIEvent?) open func motionCancelled(_ motion: UIEvent.EventSubtype, with event: UIEvent?)</code></pre><ul><li>è¿œç¨‹æ§åˆ¶äº‹ä»¶ <code>remote-control event</code>ï¼Œåœ¨éŸ³è§†é¢‘æ’­æ”¾æ—¶ï¼Œé”å±ç•Œé¢æˆ–è€…æ§åˆ¶ä¸­å¿ƒä¸­ç‚¹å‡» â€œä¸Šä¸€ä¸ªâ€ã€â€œä¸‹ä¸€ä¸ªâ€ã€â€œæš‚åœâ€å’Œâ€œç»§ç»­â€ç­‰æ“ä½œæ—¶è§¦å‘çš„äº‹ä»¶ã€‚</li></ul><pre><code class="swift">@available(iOS 4.0, *)open func remoteControlReceived(with event: UIEvent?)</code></pre><ul><li>ç¼–è¾‘èœå•æ¶ˆæ¯ <code>editing menu messages</code>ï¼Œç¼–è¾‘æ–‡æœ¬å‡ºç°çš„èœå•åˆ—è¡¨äº§ç”Ÿçš„äº‹ä»¶ã€‚</li></ul><pre><code class="swift">open func buildMenu(with builder: UIMenuBuilder)@available(iOS 13.0, *)open func validate(_ command: UICommand)@available(iOS 3.0, *)open var undoManager: UndoManager? { get }@available(iOS 13.0, *)open var editingInteractionConfiguration: UIEditingInteractionConfiguration { get }</code></pre><ul><li>åŠ é€Ÿå™¨äº‹ä»¶ã€é™€èºäº‹ä»¶ã€ç£åŠ›ä»ªäº‹ä»¶ä¸è·Ÿéšå“åº”è€…é“¾ï¼Œ<code>Core Motion</code> å°†è¿™äº›äº‹ä»¶ç›´æ¥ä¼ é€’ç»™æŒ‡å®šçš„å§”ä»»å¯¹è±¡ã€‚</li></ul><h2 id="è§¦æ‘¸äº‹ä»¶æµç¨‹"><a href="#è§¦æ‘¸äº‹ä»¶æµç¨‹" class="headerlink" title="è§¦æ‘¸äº‹ä»¶æµç¨‹"></a>è§¦æ‘¸äº‹ä»¶æµç¨‹</h2><img src="/images/blog/image-20220620215940554.png" alt="image-20220620215940554" style="zoom:80%;"><p>å½“è§¦æ‘¸äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¢«ç”¨æˆ·é¢æ¿å³ç¡¬ä»¶ç”±ç”µä¿¡å·é‡‡é›†åˆ°ï¼Œä¹‹åå†ä¼ é€’ç»™ <code>IOKit.framework</code>ï¼Œå¹¶å°†äº‹ä»¶å°è£…ä¸º <code>IOHIDEvent</code>ï¼›ä¹‹åé€šè¿‡ IPC è½¬å‘ç»™ <code>SpringBoard</code> è¿›ç¨‹ï¼›å†ç”± <code>SpringBoard</code> è¿›ç¨‹å†æ¬¡é€šè¿‡ <code>IPC</code> å°†äº‹ä»¶ä¼ é€’ç»™åˆé€‚çš„ APP è¿›ç¨‹ï¼›ç”±ä¸»çº¿ç¨‹ <code>RunLoop</code> è¿›è¡Œå¤„ç†ï¼Œå…ˆè§¦å‘ <code>source1</code> å›è°ƒï¼Œåè§¦å‘äº† <code>source0</code> å›è°ƒï¼Œå¹¶å°†äº‹ä»¶å°è£…ä¸º <code>UIEvent</code>ï¼›ç„¶åå°†äº‹ä»¶åŠ å…¥ <code>UIApplication</code> å¯¹è±¡çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œå‡ºé˜Ÿåï¼Œå¼€å§‹å¯»æ‰¾æœ€ä½³å“åº”è€… <code>hit-Testing</code>ï¼Œæ‰¾åˆ°æœ€ä½³å“åº”è€…åã€‚ç”± <code>UIApplication</code> å¯¹è±¡ ä» <code>sendEvent</code> æ–¹æ³•å°†äº‹ä»¶ä¼ é€’ç»™ <code>window</code> å¯¹è±¡ï¼Œå†ç”± <code>window</code> å¯¹è±¡ <code>sendEvent</code> åˆ°æœ€ä½³å“åº”è€…ï¼Œéšåè¿›è¡Œäº‹ä»¶å“åº”ä»¥åŠä¼ é€’ã€‚å¯»æ‰¾æœ€ä½³å“åº”è€…ä»¥åŠäº‹ä»¶å“åº”åé¢ä¼šé‡ç‚¹æåŠï¼Œè¿™é‡Œå…ˆç®€å•å¯¹ IOKit.frameworkã€SpringBoard ä»¥åŠ IPC è¿›è¡Œç®€å•ä»‹ç»ï¼š</p><ul><li>IOKit.frameworkï¼šå®ƒä¸ºè®¾å¤‡é©±åŠ¨ç¨‹åº(IOKit)çš„ç”¨æˆ·æ€ç»„ä»¶ï¼ŒIOKit æ¥æºäº NeXTSTEP çš„ DriverKitï¼ŒIOKit.framework æä¾›äº†å†…æ ¸æ€ä»¥åŠç”¨æˆ·æ€åŒå‘é€šä¿¡çš„æ¥å£ã€‚</li><li>SpringBoardï¼šiOS ä¸­çš„ SpringBoard ç›¸å½“äº macOS ä¸­çš„ Finderï¼Œå®ƒå‘ç”¨æˆ·æä¾›äº†ç†Ÿæ‚‰çš„å›¾æ ‡ç•Œé¢ï¼Œå®ƒè®°å½•äº†å¤šè§¦æ‘¸äº‹ä»¶ã€åŠ é€Ÿå™¨äº‹ä»¶ã€æŒ‰å‹äº‹ä»¶ç­‰ã€‚</li><li>IPCï¼šmacOS å’Œ iOS ä¸­çš„è¿›ç¨‹é—´é€šä¿¡(InterProcess Communication) æ˜¯åŸºäº machï¼Œmach æ˜¯ iOS å’Œ macOS ä¸­çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯æœ‰åˆ«äºå…¶ä»–æ“ä½œç³»ç»Ÿçš„é‡ç‚¹ï¼Œmach é‡‡ç”¨å¾®å†…æ ¸çš„æ¦‚å¿µï¼Œå³å†…æ ¸ä»…æä¾›ä¸€äº›å¿…è¦çš„åŠŸèƒ½ï¼Œå…¶ä»–å·¥ä½œç”±ç”¨æˆ·æ€å®ç°ã€‚mach çš„ IPC æ˜¯é€šè¿‡åœ¨ä¸¤ä¸ªç«¯å£ä¹‹é—´å‘é€æ¶ˆæ¯å®ç°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ ã€Šæ·±å…¥è§£æMac OS X &amp; iOS æ“ä½œç³»ç»Ÿã€‹ã€‚</li></ul><h3 id="å¯»æ‰¾æœ€ä½³å“åº”è€…"><a href="#å¯»æ‰¾æœ€ä½³å“åº”è€…" class="headerlink" title="å¯»æ‰¾æœ€ä½³å“åº”è€…"></a>å¯»æ‰¾æœ€ä½³å“åº”è€…</h3><ol><li>ç”± <code>UIApplication</code> ä¼ é€’ç»™ <code>UIWindow</code>ï¼Œå¦‚æœæœ‰å¤šä¸ª <code>UIWindow</code> å¯¹è±¡ï¼Œåˆ™æŒ‰å€’åºè¿›è¡ŒæŸ¥è¯¢ã€‚</li><li>å¯¹äºæ¯ä¸€ä¸ª <code>UIWindow</code>ã€<code>UIView</code> å¯¹è±¡æ¥è¯´ï¼Œä¹Ÿæ˜¯å€’å™æŸ¥è¯¢å…¶å­è§†å›¾å’Œæœ¬è§†å›¾èƒ½å¦å“åº”ã€‚</li></ol><p>å¦‚æœä»éå†æ–¹å¼æ¥çœ‹ï¼Œæ˜¯ä¸€ä¸ªåè¿‡æ¥çš„ <code>dfs</code>ã€‚å€’å™æ˜¯å› ä¸ºå¦‚æœæœ‰è§†å›¾é‡å ï¼Œåœ¨ä¸Šæ–¹çš„æ˜¯ååŠ å…¥çš„å¯¹è±¡ï¼›å…·ä½“æ¥è¯´éƒ½æ˜¯é€šè¿‡ <code>UIView</code> çš„ <code>hitTest</code> æ–¹æ³•è¿›è¡Œåˆ¤æ–­æ˜¯ä¸æ˜¯æœ€ä½³å“åº”è€…ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›è¯¥ <code>UIView</code>ï¼Œä¸å­˜åœ¨åˆ™è¿”å› <code>nil</code>ã€‚</p><ul><li><code>hitTest(_ point: CGPoint, with event: UIEvent?)</code> <strong>æ¨¡æ‹Ÿä»£ç </strong></li></ul><pre><code class="swift">override func hitTest(_ point: CGPoint, with event: UIEvent?) -&gt; UIView? {    guard self.isUserInteractionEnabled &amp;&amp; !self.isHidden &amp;&amp; self.alpha &gt; 0.01 else {        return nil    }    if self.point(inside: point, with: event) {        for subview in subviews.reversed() {            let convertedPoint = subview.convert(point, from: self)            let hitTestView = subview.hitTest(convertedPoint, with: event)            if let hitTestView = hitTestView {                return hitTestView            }        }      return self    }    return nil}</code></pre><ol><li><p>éœ€è¦ <code>isUserInteractionEnabled</code> ä¸º <code>true</code>ã€<code>isHidden</code> ä¸º <code>fasle</code> ä¸”é€æ˜åº¦ &gt; 0.01</p></li><li><p>å¦‚æœå‘½ä¸­ç‚¹åœ¨è§†å›¾å†…ï¼Œå°è¯•å€’åºéå†å­è§†å›¾ï¼ŒæŸ¥æ‰¾æ˜¯å¦æœ‰æ›´åˆé€‚çš„ç‚¹ï¼Œè‹¥æœ‰åˆ™è¿”å›å­è§†å›¾çš„ <code>hitTest()</code>ï¼Œè‹¥æ— åˆ™è¿”å›æœ¬è§†å›¾(<code>self</code>)ã€‚</p></li><li><p>å¦‚æœå‘½ä¸­ç‚¹ä¸åœ¨è§†å›¾å†…ï¼Œåˆ™è¿”å› <code>nil</code>ã€‚</p></li></ol><ul><li><code>point(inside point: CGPoint, with event: UIEvent?)</code> <strong>æ¨¡æ‹Ÿä»£ç </strong></li></ul><pre><code class="swift">override func point(inside point: CGPoint, with event: UIEvent?) -&gt; Bool {    return bounds.contains(point)}</code></pre><ol><li>åˆ¤æ–­å½“å‰ bounds æ˜¯å¦åŒ…å«è¯¥ç‚¹ã€‚</li></ol><h3 id="è§¦æ‘¸äº‹ä»¶çš„å“åº”ä»¥åŠä¼ é€’"><a href="#è§¦æ‘¸äº‹ä»¶çš„å“åº”ä»¥åŠä¼ é€’" class="headerlink" title="è§¦æ‘¸äº‹ä»¶çš„å“åº”ä»¥åŠä¼ é€’"></a>è§¦æ‘¸äº‹ä»¶çš„å“åº”ä»¥åŠä¼ é€’</h3><p>æ‰¾åˆ°æœ€ä½³å“åº”è€…åï¼Œ<code>UIApplication</code> å¯¹è±¡ <code>sendEvent</code> åˆ°å“åº”è¯¥è§†å›¾çš„ <code>UIWindow</code>ï¼Œå†æœ‰ <code>UIWindow</code> å¯¹è±¡ <code>sendEvent</code> åˆ°æœ€ä½³å“åº”è€…ï¼Œè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡æŸ¥çœ‹è°ƒç”¨æ ˆå¸§çœ‹å‡ºï¼š</p><img src="/images/blog/image-20220704022615988.png" alt="image-20220704022615988" style="zoom:100%;"><p>ä¼ é€’ç»™æœ€ä½³å“åº”è€…åï¼Œä¾¿å¯ä»¥è¿›è¡Œäº‹ä»¶çš„å“åº”äº†ï¼Œå¯¹äºè§¦æ‘¸äº‹ä»¶æ¥è¯´ï¼Œè°ƒç”¨ä¸Šè¿°æåˆ°çš„ 5 ä¸ªæ–¹æ³•å³ä»£è¡¨å“åº”ã€‚äº‹ä»¶çš„æ‹¦æˆªæ˜¯é€šè¿‡ <code>open func touchesBegan(_ touches: Set&lt;UITouch&gt;, with event: UIEvent?)</code> å®ç°çš„ï¼Œä¼ é€’æ–¹å¼ä¸è§„åˆ™è§ä¸Šæ–‡ä¸­ <strong>å“åº”è€… &amp; å“åº”è€…é“¾</strong>ï¼š</p><ul><li>ä¸é‡å†™ï¼Œé»˜è®¤å°†äº‹ä»¶äº¤ç»™å“åº”è€…é“¾ä¼ é€’</li><li>é‡å†™ä¸æ‰ç”¨ <code>super.touchesBegan(touches, with: event)</code>ï¼Œäº‹ä»¶ç”±è¯¥å“åº”è€…å¤„ç†ï¼Œä¸è¿›è¡Œä¼ é€’</li><li>é‡å†™å¹¶è°ƒç”¨ <code>super.touchesBegan(touches, with: event)</code>ï¼Œå°†äº‹ä»¶äº¤ç»™å“åº”è€…é“¾ä¼ é€’</li></ul><p>é‡‡ç”¨ <code>touchesBegan</code> ç­‰ç³»åˆ—æ–¹æ³•ä»¥å“åº”ç®—æ˜¯æ¯”è¾ƒåº•å±‚çš„æ–¹å¼ï¼Œä¸ºå¿«é€Ÿå“åº”å„ç§ç±»å‹çš„è§¦æ‘¸äº‹ä»¶ï¼ŒApple æä¾›äº† <code>UIGestureRecognizer</code> ä¸ <code>UIControl</code> è¿™ä¸¤ç§æ–¹å¼ã€‚</p><h4 id="UIGestureRecognizer"><a href="#UIGestureRecognizer" class="headerlink" title="UIGestureRecognizer"></a>UIGestureRecognizer</h4><p>UIGestureRecognizer æ‰‹åŠ¿è¯†åˆ«å™¨æ˜¯å¤„ç†è§†å›¾ä¸­çš„è§¦æ‘¸å’ŒæŒ‰å‹äº‹ä»¶çš„æœ€å¥½æ–¹å¼ï¼Œå¦‚æœæˆ‘ä»¬ä»…ç”¨è§¦æ‘¸äº‹ä»¶åŸºæœ¬å“åº”æ–¹å¼è¿›è¡Œå¤„ç†çš„è¯ï¼Œéš¾åº¦è¾ƒå¤§ä¸”ä¸ç°å®ã€‚å®ƒæ˜¯ä¸€ä¸ªåŸºç±»ï¼ŒApple æä¾›äº† 8 ç§æ‰‹åŠ¿ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰æ‰‹åŠ¿ã€‚</p><ul><li><code>UITapGestureRecognizer</code>ï¼šè½»ç‚¹æ‰‹åŠ¿</li><li><code>UIPinchGestureRecognizer</code>ï¼šæåˆæ‰‹åŠ¿</li><li><code>UIRotationGestureRecognizer</code>ï¼šæ—‹è½¬æ‰‹åŠ¿</li><li><code>UISwipeGestureRecognizer</code>ï¼šæ»‘åŠ¨æ‰‹åŠ¿</li><li><code>UIPanGestureRecognizer</code>ï¼šæ‹–æ‹½æ‰‹åŠ¿</li><li><code>UIScreenEdgePanGestureRecognizer</code>ï¼šå±å¹•è¾¹ç¼˜æ‹–æ‹½æ‰‹åŠ¿</li><li><code>UILongPressGestureRecognizer</code>ï¼šé•¿æŒ‰æ‰‹åŠ¿</li><li><code>UIHoverGestureRecognizer</code>ï¼šæŒ‡é’ˆæ‚¬åœï¼ˆmacOS &amp; iPadOSï¼‰</li></ul><p>æ‰‹åŠ¿è¯†åˆ«å™¨åˆ†ä¸ºç¦»æ•£å‹å’ŒæŒç»­æ€§ä¸¤ç§ï¼š</p><p>ç¦»æ•£å‹æ‰‹åŠ¿åœ¨è¯†åˆ«åˆ°æ‰‹åŠ¿ååªè°ƒç”¨ä¸€æ¬¡ <code>action</code> æ–¹æ³•ï¼Œå…¶å˜åŒ–è¿‡ç¨‹ä¸ºï¼š</p><ul><li><p>è¯†åˆ«æˆåŠŸï¼šPossible â€”&gt; Recognized</p></li><li><p>è¯†åˆ«å¤±è´¥ï¼šPossible â€”&gt; Failed</p></li></ul><p>æŒç»­æ€§æ‰‹åŠ¿åœ¨æ»¡è¶³æœ€åˆå§‹è¯†åˆ«æ¡ä»¶åï¼Œä¼šåœ¨æ‰‹åŠ¿ä¿¡æ¯å˜åŒ–ä¸­å¤šæ¬¡è°ƒç”¨ action æ–¹æ³•ï¼Œå…¶å˜åŒ–è¿‡ç¨‹ä¸ºï¼š</p><ul><li><p>å®Œæ•´è¯†åˆ«ï¼šPossible â€”&gt; Began â€”&gt; [Changed] â€”&gt; Ended</p></li><li><p>ä¸å®Œæ•´è¯†åˆ«ï¼šPossible â€”&gt; Began â€”&gt; [Changed] â€”&gt; Cancel</p></li></ul><p><strong>å¯¹äº UIResponder çš„è§¦æ‘¸å“åº”ä¼˜å…ˆçº§æ¥è¯´ï¼ŒUIGestureRecognizer çš„å“åº”ä¼˜å…ˆçº§ä¼šæ›´é«˜ä¸€ç‚¹</strong>ï¼›åœ¨ hit-Testing è¿‡ç¨‹ä¸­ï¼Œå°±ä¼šåˆ¤æ–­å½“å‰ <code>view</code> çš„æ‰‹åŠ¿è¯†åˆ«å™¨æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œç¬¦åˆæ¡ä»¶çš„æ‰‹åŠ¿è¯†åˆ«å™¨å¯¹è±¡ä¼šä¿å­˜åœ¨ <code>UIEvent</code> ä¸­ï¼Œå¹¶åœ¨ <code>sendEvent</code> æ—¶é¦–å…ˆå‘é€ç»™å®ƒï¼Œå¦‚æœæ‰‹åŠ¿è¯†åˆ«å™¨è¯†åˆ«æˆåŠŸï¼Œåˆ™é»˜è®¤ä¼šå–æ¶ˆå‰©ä½™çš„è§¦æ‘¸å“åº”äº‹ä»¶ï¼Œè¡¨ç°ä¸ºè°ƒç”¨ <code>touchesCancelled</code> æ–¹æ³•ã€‚</p><p>ä¸‰ä¸ªé‡è¦çš„å±æ€§ä¼šæ”¹å˜ä¸Šè¿°è¿‡ç¨‹ï¼š</p><ul><li><code>cancelsTouchesInView</code>ï¼šé»˜è®¤ä¸º trueï¼Œè¡¨ç¤ºåœ¨è¯†åˆ«æ‰‹åŠ¿æˆåŠŸåï¼Œæ˜¯å¦å–æ¶ˆå‰©ä½™çš„è§¦æ‘¸å“åº”äº‹ä»¶ï¼›</li><li><code>delaysTouchesBegan</code>ï¼šé»˜è®¤ä¸º falseï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨è¯†åˆ«æ‰‹åŠ¿å¤±è´¥åï¼Œæ‰å°†è§¦æ‘¸äº‹ä»¶ä¼ é€’ç»™ <code>hit-Tested view</code>ï¼›</li><li><code>delaysTouchesEnded</code>ï¼šé»˜è®¤ä¸º trueï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨è¯†åˆ«æ‰‹åŠ¿å¤±è´¥åï¼Œæ‰å°† <code>touchesEnded</code> äº‹ä»¶å‘é€ç»™ <code>hit-Tested view</code>ï¼›</li></ul><p>æ‰‹åŠ¿å†²çª</p><p>æ‰‹åŠ¿é»˜è®¤æ˜¯äº’æ–¥çš„ï¼Œä½†å¯ä»¥åˆ©ç”¨ <code>UIGestureRecognizerDelegate</code> è¿›è¡Œæ‰‹åŠ¿ä¼˜å…ˆçº§å¤„ç†ã€‚</p><h4 id="UIControl"><a href="#UIControl" class="headerlink" title="UIControl"></a>UIControl</h4><p>UIControl æ˜¯å“åº”ç‰¹å®šåŠ¨ä½œæˆ–æ„å›¾çš„è§†è§‰å…ƒç´ çš„æ§ä»¶åŸºç±»ï¼Œå®ƒæ˜¯ <code>UIView</code> çš„å­ç±»ï¼Œå› æ­¤å®ƒä¹Ÿæ˜¯å“åº”è€…å¯¹è±¡ï¼›<code>UIButton</code>ã€<code>UISwitch</code>ã€<code>UISlider</code> ç­‰éƒ½æ˜¯å®ƒçš„å­ç±»ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ <code>UIControl</code>ã€‚é€šè¿‡  <code>addTarget(_:action:for:)</code> æŒ‡å®šå“åº”äº‹ä»¶å’Œå¯¹è±¡å’Œæ–¹æ³•ï¼Œå¦‚æœ <code>target</code> ä¸º <code>nil</code>ï¼Œåˆ™æŒ‰ç…§å“åº”é“¾ä¼ é€’è¯¥äº‹ä»¶ã€‚</p><pre><code class="swift">open func beginTracking(_ touch: UITouch, with event: UIEvent?) -&gt; Boolopen func continueTracking(_ touch: UITouch, with event: UIEvent?) -&gt; Boolopen func endTracking(_ touch: UITouch?, with event: UIEvent?) // touch is sometimes nil if cancelTracking calls through to this.open func cancelTracking(with event: UIEvent?) // event may be nil if cancelled for non-event reasons, e.g. removed from window</code></pre><p>ä¸ <code>UIResponder</code> ç±»ä¼¼ï¼Œ<code>UIControl</code> æœ‰ 4 ç§è·Ÿè¸ªè§¦æ‘¸äº‹ä»¶çš„æ–¹æ³•ï¼Œåˆ†åˆ«ä¸ <code>UIResponder</code> çš„ <code>began</code>ã€<code>moved</code>ã€<code>ended</code>ã€<code>cancelled</code> ç›¸å¯¹åº”ã€‚å¦‚æœæŸ¥çœ‹å…¶è°ƒç”¨æ ˆï¼Œå¯ä»¥å‘ç°åœ¨ <code>UIResponder</code> æ–¹æ³•å†…éƒ¨è°ƒç”¨äº† <code>UIControl</code> çš„è·Ÿè¸ªæ–¹æ³•ã€‚</p><p><img src="/images/blog/image-20220707113956921.png" alt="image-20220707113956921"></p><p>å¦‚æœåœ¨å“åº”äº‹ä»¶çš„æ–¹æ³•æ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹è°ƒç”¨æ ˆå¸§ï¼Œä¼šå‘ç° <code>UIControl</code> ä¼šé¦–å…ˆå°†äº‹ä»¶é€šè¿‡ <code>sendAction:to:forEvent:</code> å‘é€ç»™ <code>UIApplication</code>ï¼Œå†é€šè¿‡ <code>sendAction</code> è½¬å‘ç»™å‘é€çš„å¯¹è±¡çš„å¯¹è±¡ã€‚</p><p><img src="/images/blog/image-20220707114606464.png" alt="image-20220707114606464"></p><p>ä¸ <code>UIGestureRecognizer</code> ç›¸æ¯”ï¼Œäº‹ä»¶ä»ä¼šä¼˜å…ˆä¼ é€’åˆ° <code>UIGestureRecognizer</code>ï¼Œè¿™ä¸€ç‚¹å¯ä»¥é‡å†™ <code>UIGestureRecognizer</code> çš„ 4 ä¸ªå“åº”æ–¹æ³•éªŒè¯ã€‚</p><p>å¦‚æœ <code>UIControl</code> æ˜¯å…¶å­è§†å›¾ï¼Œä¼šåˆ¤æ–­å…¶æ˜¯å¦ä¸ºç³»ç»Ÿé»˜è®¤æ§ä»¶ï¼Œç³»ç»Ÿé»˜è®¤æ§ä»¶åˆ™ä¼˜å…ˆå“åº” <code>UIControl</code> çš„ <code>action</code> æ–¹æ³•ï¼Œå¦‚æœä¸ºè‡ªå®šä¹‰æ§ä»¶ï¼Œåˆ™é»˜è®¤ä¼˜å…ˆå“åº” <code>UIGestureRecognizer</code> çš„ <code>action</code>ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå°† <code>UIGestureRecognizer</code> çš„ <code>cancelsTouchesInView</code> æ”¹ä¸º<code> false</code>(é»˜è®¤ä¸º <code>true</code>)ï¼Œåˆ™å‘ç° <code>UIGestureRecognizer</code> ä¹Ÿä¼šè¿›è¡Œå“åº”ï¼Œä¸ªäººç†è§£ä¸º <code>cancelsTouchesInView</code> æ”¹å˜äº†å“åº”äº’æ–¥çš„ç‰¹æ€§ï¼Œå› æ­¤æœ¬èº«ä¹Ÿä¼šå“åº”ã€‚ </p><p>å¦‚æœ <code>UIControl</code> ä¸ºçˆ¶è§†å›¾æˆ–å¹³çº§è§†å›¾ï¼Œç”±äºä»ä¼šä¼˜å…ˆå°†äº‹ä»¶ä¼ é€’åˆ° <code>UIGestureRecognizer</code>ï¼Œ åˆ™å¯ä»¥æ ¹æ®å…¶ <code>cancelsTouchesInView</code>ã€<code>delaysTouchesBegan</code>ã€<code>delaysTouchesEnded</code> åˆ¤æ–­äº‹ä»¶èƒ½å¦ä¼ é€’åˆ° <code>UIControl</code>ï¼Œè¿™ä¸€ç‚¹ <code>UIControl</code> ä¸ <code>UIResponder</code> ä¸€è‡´ã€‚</p><h3 id="åº”ç”¨å®è·µ"><a href="#åº”ç”¨å®è·µ" class="headerlink" title="åº”ç”¨å®è·µ"></a>åº”ç”¨å®è·µ</h3><h4 id="æ‰©å¤§å“åº”åŒºåŸŸ"><a href="#æ‰©å¤§å“åº”åŒºåŸŸ" class="headerlink" title="æ‰©å¤§å“åº”åŒºåŸŸ"></a>æ‰©å¤§å“åº”åŒºåŸŸ</h4><ol><li>é‡å†™æœ¬è§†å›¾çš„ <code>func point(inside point: CGPoint, with event: UIEvent?) -&gt; Bool</code> </li></ol><pre><code class="swift">override func point(inside point: CGPoint, with event: UIEvent?) -&gt; Bool {    // å°†å“åº”åŒºåŸŸæ‰©å¤§ 30    return self.bounds.inset(by: .init(top: -30, left: -30, bottom: -30, right: -30)).contains(point)}</code></pre><ol start="2"><li>é‡å†™çˆ¶è§†å›¾çš„ <code>func hitTest(_ point: CGPoint, with event: UIEvent?) -&gt; UIView?</code></li></ol><pre><code class="swift">override func hitTest(_ point: CGPoint, with event: UIEvent?) -&gt; UIView? {    // å°†å“åº”åŒºåŸŸæ‰©å¤§ 30    // subView ä¸ºåº”æ‰©å¤§å“åº”åŒºåŸŸçš„è§†å›¾    if subView.frame.inset(by: .init(top: -30, left: -30, bottom: -30, right: -30)).contains(point) {        return subView    }    return super.hitTest(point, with: event)}</code></pre><h4 id="æ ¹æ®è§¦æ‘¸å®æ—¶ä¿®æ”¹-view-ä½ç½®"><a href="#æ ¹æ®è§¦æ‘¸å®æ—¶ä¿®æ”¹-view-ä½ç½®" class="headerlink" title="æ ¹æ®è§¦æ‘¸å®æ—¶ä¿®æ”¹ view ä½ç½®"></a>æ ¹æ®è§¦æ‘¸å®æ—¶ä¿®æ”¹ view ä½ç½®</h4><pre><code class="swift">override func touchesMoved(_ touches: Set&lt;UITouch&gt;, with event: UIEvent?) {    let touch = touches.randomElement()    let prePoint = touch?.precisePreviousLocation(in: self)    let currPoint = touch?.location(in: self)    if let prePoint = prePoint, let currPoint = currPoint {        let offsetX = currPoint.x - prePoint.x        let offsetY = currPoint.y - prePoint.y        self.transform = self.transform.translatedBy(x: offsetX, y: offsetY)    }}</code></pre><h2 id="ğŸ”—"><a href="#ğŸ”—" class="headerlink" title="ğŸ”—"></a>ğŸ”—</h2><p><a href="https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events">Using Responders and the Responder Chain to Handle Events</a></p><p><a href="https://www.jianshu.com/p/c294d1bd963d">iOS è§¦æ‘¸äº‹ä»¶å…¨å®¶æ¡¶</a></p><p><a href="https://developer.apple.com/documentation/uikit/uigesturerecognizer?language=objc">Apple - UIGestureRecognizer</a></p><p><a href="http://southpeak.github.io/2015/12/13/cocoa-uikit-uicontrol/">UIKit: UIControl</a></p><p>ã€Šæ·±å…¥è§£æMac OS X &amp; iOS æ“ä½œç³»ç»Ÿã€‹</p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> UI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Xcode ä¸­çš„è°ƒè¯•æŠ€å·§</title>
      <link href="/2022/06/01/debugging_in_xcode/"/>
      <url>/2022/06/01/debugging_in_xcode/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>Xcode</code> å†…ç½®äº†è®¸å¤šå·¥å…·èƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…è¿›è¡Œé«˜æ•ˆå¿«é€Ÿçš„ <code>Debug</code>ï¼Œä¾‹å¦‚ <code>LLDB</code>ã€ <code>Instruments</code>ã€<code>Debug View Hierarchy</code>ã€<code>Debug Memory Graph</code> ç­‰ã€‚æœ¬æ–‡å°†ä»‹ç» <code>LLDB</code> ä¸­å®ç”¨çš„å‘½ä»¤ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨ <code>Instruments</code> è§£å†³å†…å­˜ç›¸å…³çš„é—®é¢˜ã€‚ <span id="more"></span></p><h2 id="LLDB"><a href="#LLDB" class="headerlink" title="LLDB"></a>LLDB</h2><p><code>LLDB</code> æ˜¯ <code>LLVM</code> ä¸­çš„è°ƒè¯•å™¨ç»„ä»¶ï¼Œæ”¯æŒè°ƒè¯• <code>C</code>ã€<code>Objective-C</code>ã€<code>C++</code> ç¼–å†™çš„ç¨‹åºï¼Œ<code>Swift</code> ç¤¾åŒºç»´æŠ¤äº†ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¢åŠ äº†å¯¹è¯¥è¯­è¨€çš„æ”¯æŒï¼Œ<code>LLDB</code> æ˜¯ <code>Xcode</code> çš„é»˜è®¤è°ƒè¯•å™¨ã€‚å¯¹äºç†Ÿç»ƒä½¿ç”¨ <code>Xcode</code> çš„å¼€å‘è€…æ¥è¯´ï¼Œåˆ›å»ºæ–­ç‚¹ã€ä½¿æ–­ç‚¹æ— æ•ˆæ˜¯ä¸€ä»¶å†ç®€å•ä¸è¿‡çš„äº‹æƒ…ï¼Œåªéœ€è¦çš„æºä»£ç çš„å·¦ä¾§è¡Œæ•°ç‚¹å‡»å³å¯ã€‚ä½†æ˜¯åœ¨ <code>LLDB</code> è¿˜æœ‰è®¸å¤šæå‡å¼€å‘æ•ˆç‡çš„äº‹ï¼Œä¾‹å¦‚ <code>frameã€breakpoint</code>ã€<code>expression</code>ã€<code>image</code> ç­‰å‘½ä»¤ã€‚</p><h3 id="expression"><a href="#expression" class="headerlink" title="expression"></a>expression</h3><p><code>expression</code> ä¸»è¦ç”¨äºã€Œåœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œè¡¨è¾¾å¼ï¼Œå¹¶æ˜¾ç¤ºå…¶è¿”å›å€¼ã€ã€‚å…¶è¯­æ³•å¦‚ä¸‹ï¼š<br><code>expression &lt;cmd-options&gt; -- &lt;expr&gt;</code><br>ä¾‹å¦‚è¢«å¤§å®¶æ‰€ç†ŸçŸ¥çš„ <code>po</code>ã€<code>p</code> éƒ½æ˜¯å…³äº <code>expression</code> çš„ç¼©å†™å½¢å¼</p><ul><li>  <code>po</code> æ˜¯ <code>expression -O --</code> çš„ç¼©å†™å½¢å¼</li><li>  <code>p</code> æ˜¯ <code>expression --</code> çš„ç¼©å†™å½¢å¼<br>å¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦æœ‰å¯é€‰å‚æ•°ä¸è¡¨è¾¾å¼ä¸¤éƒ¨åˆ†ï¼›ä¸ºäº†åŒºåˆ†å¯é€‰å‚æ•°ä¸è¡¨è¾¾å¼ï¼Œé‡‡ç”¨ <code>--</code> è¿›è¡Œåˆ†å‰²ï¼Œä¸‹é¢åˆ—ä¸¾å¸¸ç”¨çš„ä¸€äº›å¯é€‰å‚æ•°ï¼š</li><li>  <code>-D</code>ï¼Œè®¾ç½®æœ€å¤§é€’å½’æ·±åº¦è§£æå±‚çº§</li><li>  <code>-O</code>ï¼Œæ‰“å°ç‰¹å®šè¯­è¨€çš„å¯¹è±¡çš„ <code>description</code> æ–¹æ³•</li><li>  <code>-T</code>ï¼Œæ˜¾ç¤ºå˜é‡ç±»å‹</li><li>  <code>-f</code>ï¼Œä»¥ç‰¹å®šæ ¼å¼åŒ–ç±»å‹è¿›è¡Œè¾“å‡º</li><li>  <code>-i</code>ï¼Œæ‰§è¡Œè¡¨è¾¾å¼æ—¶å¿½ç•¥æ–­ç‚¹è§¦å‘<br>æ›´å¤šçš„å¯é€‰å‚æ•°å¯ä»¥é€šè¿‡ <code>help expression</code> è¿›è¡ŒæŸ¥çœ‹<br>åŒæ—¶ï¼Œ<code>expression</code> è¿˜å¯ä»¥å¯ä»¥å®šä¹‰å˜é‡ï¼Œä½†éœ€åœ¨å˜é‡åå‰é¢åŠ å…¥ <code>$</code> æ ‡è¯†ç¬¦ï¼Œä¾‹å¦‚</li></ul><p>åœ¨ <code>Swift</code> ä¸­ï¼š</p><p><code>expression var width: CGFloat = 20.0</code></p><p>åœ¨ <code>OC</code> ä¸­ï¼š</p><p><code>expression NSArray *$array = @[@"one", @"two"];</code></p><h3 id="è¿›ç¨‹æµç¨‹æ§åˆ¶"><a href="#è¿›ç¨‹æµç¨‹æ§åˆ¶" class="headerlink" title="è¿›ç¨‹æµç¨‹æ§åˆ¶"></a>è¿›ç¨‹æµç¨‹æ§åˆ¶</h3><img src="/images/blog/image-20220420112717291.png" alt="image-20220420112717291" style="zoom:200%;"><p>å½“ç¨‹åºè¿è¡Œæˆ–æš‚åœæ—¶ï¼Œåœ¨æ§åˆ¶å°ä¸Šæ–¹ä¼šå‡ºç°ä¸Šå›¾è¿™ 4 ä¸ªæŒ‰é’®ï¼Œè¿™ 4 ä¸ªæŒ‰é’®åˆ†åˆ«å¯¹åº”ç€ã€Œè¿›ç¨‹æš‚åœä¸ç»§ç»­ã€ã€ã€Œæ‰§è¡Œå½“å‰è¡Œã€ã€ã€Œè°ƒå…¥æ‰§è¡Œå‡½æ•°ã€ã€ã€Œè·³å‡ºæ‰§è¡Œå‡½æ•°ã€ï¼Œåˆ†åˆ«å¯¹åº”ç€ä»¥ä¸‹ 4 ä¸ªå‘½ä»¤ï¼š</p><ol><li> <code>process continue(continue)</code></li><li> <code>thread step-over(nextã€n)</code></li><li> <code>thread step in(stepã€s)</code></li><li> <code>thread step out(fin)</code></li></ol><p>æ–­ç‚¹å¯¹äºè°ƒè¯•æ¥è¯´æ˜¯å¾ˆé‡è¦çš„ä¸œè¥¿ï¼Œåªéœ€è¦åœ¨ <code>Xcode</code> æºæ–‡ä»¶å·¦ä¾§ç‚¹å‡»å³å¯æ·»åŠ æ–­ç‚¹ï¼ŒåŒæ—¶ä¹Ÿä¼šå‡ºç°åœ¨ <code>Breakpoint navigator</code> ä¸­ï¼š</p><img src="/images/blog/image-20220511110055321.png" alt="image-20220511110055321" style="zoom:50%;"><p>åŒæ—¶è¿˜å¯ä»¥æ·»åŠ åˆ—æ–­ç‚¹ï¼Œå¦‚æœä½ çš„ä¸€è¡Œä»£ç ä¸­æœ‰å‡ ä¸ªè¡¨è¾¾å¼ï¼Œä½ å¯èƒ½å¸Œæœ›åªåœç•™åœ¨æŸä¸€ä¸ªè¡¨è¾¾å¼ä¸­ï¼Œé‚£ä¹ˆåˆ—æ–­ç‚¹å°±å¾ˆæœ‰ç”¨äº†ï¼Œå³é”®æƒ³è¦æ–­ç‚¹çš„è¡¨è¾¾å¼ï¼Œç‚¹å‡» <code>Create Column Breakpoint</code> å³å¯åˆ›å»ºåˆ—æ–­ç‚¹ã€‚</p><img src="/images/blog/image-20220512110941465.png" alt="image-20220512110941465" style="zoom:67%;"><p>åœ¨ <code>Breakpoint navigator</code> ä¸­ç‚¹å‡»å·¦ä¸‹è§’çš„ <code>+</code> å·ï¼Œå¯ä»¥å‘ç°åˆ›å»ºæœ‰ 6 å¤§ç±»å‹çš„æ–­ç‚¹ï¼Œä¸è¿‡ä¸»è¦æ¥è¯´å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>  å¼‚å¸¸ã€é”™è¯¯æ–­ç‚¹ï¼šæ•è·å¼‚å¸¸å’Œé”™è¯¯ï¼Œåœ¨å°†è¦å‘ç”Ÿ <code>Crash</code> æ—¶ï¼Œæå‰æš‚åœå¹¶å®šä½åˆ°æœ‰é”™è¯¯çš„ä»£ç ä¸­ã€‚</li><li>  ç¬¦å·æ–­ç‚¹ï¼šå³ <code>Symbolic Breakpoint</code>ï¼Œå¯ä»¥é€šè¿‡æ–¹æ³•åç§°åˆ›å»ºæ–­ç‚¹ï¼Œå½“æ‰§è¡Œåˆ°å¯¹åº”çš„æ–¹æ³•æ—¶ï¼Œä¾¿ä¼šæš‚åœã€‚</li></ul><img src="/images/blog/image-20220512111557861.png" alt="image-20220512111557861" style="zoom:67%;"><p>è¿˜å¯ä»¥ä½¿ç”¨ <code>breakpoint</code> å‘½ä»¤æ¥è¿›è¡Œå¯¹æ–­ç‚¹çš„ç®¡ç†ï¼Œä¸‹é¢ä»‹ç»ä¸€äº›å¸¸è§çš„å‘½ä»¤ï¼š</p><ul><li>  <code>breakpoint list</code> æ˜¾ç¤ºæ–­ç‚¹åˆ—è¡¨</li><li>  <code>breakpoint enable / disable / del &lt;breakpointId&gt;</code> é€šè¿‡ id å¼€å¯ã€å…³é—­ã€åˆ é™¤æ–­ç‚¹( <code>id</code> å³ä¸º <code>breakpoint list</code> æ˜¾ç¤ºçš„ <code>id</code> )</li><li>  <code>breakpoint set &lt;cmd-options&gt;</code></li></ul><p>åˆ›å»ºæ–­ç‚¹çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä½†æœ€å¸¸è§çš„æ˜¯é€šè¿‡æ–‡ä»¶åä¸ä»£ç è¡Œæ•°åˆ›å»ºï¼Œæˆ–è€…æ˜¯ç¬¦å·åŒ–è¿›è¡Œåˆ›å»ºï¼š</p><ul><li>  <code>breakpoint set -f &lt;fileName&gt; -l &lt;lineNum&gt;</code> é€šè¿‡æ–‡ä»¶åä¸ä»£ç è¡Œæ•°åˆ›å»º</li><li>  <code>breakpoint set -n &lt;function_name&gt;</code> é€šè¿‡æ–¹æ³•ååˆ›å»º</li></ul><p>åŒæ—¶è¿˜å¯ä»¥åœ¨ <code>Breakpoint navigator</code> ä¸­å¯¹æ–­ç‚¹è¿›è¡Œç¼–è¾‘ï¼Œç»™æ–­ç‚¹åˆ›å»ºåç§°ã€æ–­ç‚¹è§¦å‘æ‰§è¡Œæ¡ä»¶ã€æš‚åœå‰å¿½ç•¥æ¬¡æ•°ã€æ‰§è¡Œ <code>Action</code>ï¼Œä»¥åŠæ‰§è¡Œå®Œ <code>Action</code> åç»§ç»­æ‰§è¡Œã€‚</p><img src="/images/blog/image-20220518170038329.png" alt="image-20220518170038329" style="zoom:67%;"><p>ä¸è¿‡ä¸Šè¿°çš„åŠŸèƒ½éƒ½å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå®ç°ï¼Œä¾‹å¦‚åˆ›å»ºæ‰§è¡Œ <code>Action</code> ä¸ æ–­ç‚¹è§¦å‘æ‰§è¡Œæ¡ä»¶å¦‚ä¸‹ï¼š</p><p><code>breakpoint set -C &lt;command&gt; -c &lt;condition expression&gt; -n &lt;function_name&gt;</code></p><p>æ›´å¤šåŠŸèƒ½å¯é€šè¿‡ <code>help breakpoint</code> è¿›è¡ŒæŸ¥çœ‹ã€‚</p><p>å¦‚æœæƒ³è§‚å¯ŸæŸä¸ªå€¼å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆ <code>watchpoint</code> ä¼šéå¸¸æœ‰ç”¨ï¼ŒåŒæ ·åˆ›å»º <code>watchpoint</code> æœ‰ 2 ç§æ–¹å¼ï¼Œåœ¨ debug æ—¶å³é”®å±æ€§å¹¶ç‚¹å‡» <code>watch "&lt;variable-name&gt;"</code>ã€‚</p><img src="/images/blog/image-20220512153529644.png" alt="image-20220512153529644" style="zoom:67%;"><p>æ§åˆ¶å°åˆ™å¯ä»¥ <code>watchpoint set variable [-w &lt;watch-type&gt;] [-s &lt;byte-size&gt;] &lt;variable-name&gt;</code> è¿›è¡Œåˆ›å»ºã€‚</p><h2 id="å…¶ä»–å¸¸è§çš„å‘½ä»¤"><a href="#å…¶ä»–å¸¸è§çš„å‘½ä»¤" class="headerlink" title="å…¶ä»–å¸¸è§çš„å‘½ä»¤"></a>å…¶ä»–å¸¸è§çš„å‘½ä»¤</h2><p><code>frame</code> å‘½ä»¤å¯ä»¥æ˜¾ç¤ºå½“å‰æ ˆå¸§çš„ä¸€äº›ä¿¡æ¯ï¼š</p><ul><li>  <code>frame info</code>ï¼šæ˜¾ç¤ºæ ˆå¸§æ‰€åœ¨ä½ç½®</li><li>  <code>frame variable &lt;variableName&gt;</code>ï¼šæ˜¾ç¤ºæ ˆå¸§å˜é‡ï¼Œå¦‚æœæ²¡æœ‰ <code>&lt;variableName&gt;</code> åˆ™æ˜¾ç¤ºæ ˆå¸§çš„å˜é‡åˆ—è¡¨ï¼Œåˆ«å v</li></ul><p><code>thread</code> ç”¨äºæ“ä½œå½“å‰è¿›ç¨‹çš„ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹</p><ul><li>  <code>thread list</code>ï¼šæ˜¾ç¤ºæ‰€æœ‰çº¿ç¨‹</li><li>  <code>thread info</code>ï¼šæ˜¾ç¤ºçº¿ç¨‹çš„é¢å¤–æ¦‚è¦</li><li>  <code>thread backtrace</code> ï¼šæ˜¾ç¤ºçº¿ç¨‹çš„è°ƒç”¨æ ˆ</li><li>  <code>thread continue</code>ï¼šç»§ç»­æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®šçº¿ç¨‹</li><li>  <code>thread exception</code>ï¼šæ˜¾ç¤ºçº¿ç¨‹å¼‚å¸¸å¯¹è±¡</li><li>  <code>thread return</code>ï¼šæå‰è¿”å›ä¸€ä¸ªæ ˆå¸§ï¼Œå¹¶å¯æä¾›å¯é€‰è¿”å›å€¼</li></ul><p><code>process</code> åœ¨å½“å‰å¹³å°ä¸è¿›ç¨‹äº¤äº’</p><ul><li>  <code>process continue</code>ï¼šç»§ç»­æ‰§è¡Œå½“å‰è¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹</li><li>  <code>process interrupt</code>ï¼šä¸­æ–­å½“å‰è¿›ç¨‹</li><li>  <code>process kill</code>ï¼šç»“æŸå½“å‰è¿›ç¨‹</li><li>  <code>process status</code>ï¼šæ˜¾ç¤ºå½“å‰è¿›ç¨‹çŠ¶æ€</li></ul><p><code>image</code> å¯ä»¥è®¿é—®ç›®æ ‡æ¨¡å—çš„ä¿¡æ¯ï¼ˆæ˜¯ <code>target modules</code> çš„ç¼©å†™ï¼‰</p><ul><li>  <code>image list</code>ï¼šåˆ—å‡ºå½“å‰å¯æ‰§è¡Œå’Œä¾èµ–çš„å…±äº«åº“é•œåƒ</li><li>  <code>image lookup</code>ï¼šæ ¹æ®å‚æ•°æŸ¥æ‰¾å…¶åœ¨å¯æ‰§è¡Œå’Œä¾èµ–çš„å…±äº«åº“é•œåƒçš„ä¿¡æ¯(å¦‚ï¼šåœ°å€ã€æ–‡ä»¶åã€æ–¹æ³•åã€ç¬¦å·ç­‰)</li><li>  <code>image search-paths</code>ï¼šæœç´¢è·¯å¾„çš„é…ç½®é¡¹</li><li>  <code>image show-unwind</code>ï¼šæ˜¾ç¤ºå‡½æ•°åˆæˆçš„ <code>unwind</code> æŒ‡ä»¤</li></ul><p><code>disassemble</code> æ˜¾ç¤ºå½“å‰ <code>target</code> ä¸­çš„æŒ‡å®šæ±‡ç¼–æŒ‡ä»¤ï¼Œé»˜è®¤æ˜¯å½“å‰çº¿ç¨‹å’Œå½“å‰æ ˆå¸§ä¸­çš„å½“å‰æ–¹æ³•</p><ul><li>  <code>disassemble</code>ï¼šå½“å‰çº¿ç¨‹å’Œå½“å‰æ ˆå¸§ä¸­çš„å½“å‰æ–¹æ³•çš„æ±‡ç¼–æŒ‡ä»¤</li><li>  <code>disassemble -a &lt;address-expression&gt;</code>ï¼šä»æŸä¸€åœ°å€å¼€å§‹</li><li>  <code>disassemble -n &lt;function-name&gt;</code>ï¼šä»æŸä¸€æ–¹æ³•å¼€å§‹</li></ul><p>æœ€åï¼Œè¿˜å¯ä»¥åˆ©ç”¨ <code>commond alias</code> æˆ–è€…ç¼–å†™ <code>python</code> è„šæœ¬æ¥å®ç°è‡ªå·±çš„ <code>LLDB</code> å‘½ä»¤ã€‚</p><h2 id="po-amp-p-amp-v"><a href="#po-amp-p-amp-v" class="headerlink" title="po &amp; p &amp; v"></a>po &amp; p &amp; v</h2><p><code>po</code>ã€<code>p</code>ã€<code>v</code> éƒ½å¯ä»¥ç”¨æ¥æ‰“å°å˜é‡ï¼Œé‚£ä¹ˆå®ƒä»¬æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ</p><ul><li>  <code>po</code> æ˜¾ç¤ºå¯¹è±¡çš„ <code>debugDescription</code> å±æ€§ï¼Œç³»ç»Ÿä¼šæä¾›é»˜è®¤å€¼ï¼Œå¯ä»¥é€šè¿‡å®ç° <code>CustomDebugStringConvertible</code> åè®®è¿›è¡Œè‡ªå®šä¹‰ã€‚</li></ul><p><code>po</code> åé¢è·Ÿè¡¨è¾¾å¼ï¼Œå› æ­¤å¯ä»¥æ‰§è¡Œæ–¹æ³•ï¼Œèµ‹å€¼ç­‰æ“ä½œã€‚<code>po</code> çš„æ‰§è¡Œæ­¥éª¤åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€æ­¥ç”Ÿæˆæºä»£ç ï¼Œå¹¶åœ¨ä¸Šä¸‹æ–‡ä¸­ç¼–è¯‘æ‰§è¡Œï¼Œç¬¬äºŒæ­¥è·å–ç¬¬ä¸€æ­¥è¿”å›çš„å¯¹è±¡ï¼Œå¹¶å†æ¬¡ç”Ÿæˆæºä»£ç å¹¶åœ¨ä¸Šä¸‹æ–‡ä¸­ç¼–è¯‘æ‰§è¡Œï¼Œæœ€åæ˜¾ç¤ºç¬¬äºŒæ­¥è¿”å›çš„å­—ç¬¦ä¸²ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†èƒ½å¤Ÿä½¿ä½ çš„è¡¨è¾¾å¼èƒ½å¤Ÿè¢«å®Œæ•´è¡¨è¾¾ï¼Œ<code>LLDB</code> æ²¡æœ‰é‡‡å–ç›´æ¥è§£æå’Œè¯„ä¼°è¡¨è¾¾å¼æœ¬èº«ï¼Œé‡‡ç”¨ç”Ÿæˆå¯ç¼–è¯‘çš„æºä»£ç è¿›è¡Œå¤„ç†ï¼Œè¿™ç§æ–¹å¼å®Œå…¨ä¿ç•™äº†ä»£ç æœ¬èº«ã€‚ä¾‹å¦‚ï¼Œä½ è¾“å…¥ <code>po view</code>ã€‚</p><p>ç¬¬ä¸€æ­¥ç”Ÿæˆçš„æºä»£ç ä¸ºï¼š</p><pre><code>func __lldb_expr() {     __lldb_res = view}</code></pre><p>ç¬¬äºŒæ­¥ç”Ÿæˆçš„æºä»£ç ä¸ºï¼š</p><pre><code>func __lldb_expr2() -&gt; String {    return __lldb_res.debugDescripution}</code></pre><img src="/images/blog/image-20220522170206675.png" alt="image-20220522170206675" style="zoom:67%;"><ul><li>  <code>p</code> å‘½ä»¤ï¼Œ<code>p</code> ä¸ <code>po</code> çš„è¾“å‡ºç•¥æœ‰ä¸åŒï¼Œä½†éƒ½åŒ…å«ç›¸åŒçš„ä¿¡æ¯ï¼Œæ¯ä¸ªè¡¨è¾¾å¼ç»“æœéƒ½ä¼šè¢«èµ‹äºˆå¢å€¼åç§°ï¼Œå¦‚ <code>$R1</code>ã€<code>$R2</code> ç­‰ï¼Œè¿™äº›ç»“æœå°±ä¼šè¢«å­˜å‚¨èµ·æ¥ï¼Œå¹¶å¯ä»¥åƒæ™®é€šçš„å¯¹è±¡ä¸€æ ·ä½¿ç”¨ã€‚<code>p</code> å‘½ä»¤æ‰§è¡Œåˆ†ä¸º 3 æ­¥ï¼Œç¬¬ä¸€æ­¥ä¸ <code>po</code> å‘½ä»¤ç›¸åŒï¼Œå°†è¡¨è¾¾å¼ç”Ÿæˆæºä»£ç ï¼Œå¹¶è¿›è¡Œç¼–è¯‘æ‰§è¡Œï¼Œä¹‹åä¼šè¿›è¡ŒåŠ¨æ€ç±»å‹è§£æï¼Œå¹¶å°†è§£æç»“æœæ ¼å¼åŒ–ã€‚åŠ¨æ€ç±»å‹è§£ææ˜¯ç”±äºå…¶å¤šæ€æ€§ï¼Œåªæœ‰åœ¨è¿è¡Œæ—¶æ‰èƒ½å¾—çŸ¥å…¶è¿è¡Œæ—¶ç±»å‹ï¼›å¯¹è§£æç»“æœè¿›è¡Œæ ¼å¼åŒ–æ˜¯ç”±äº <code>Swift</code> æ ‡å‡†åº“å³ä½¿é’ˆå¯¹ <code>Int</code>ã€<code>String</code> è¿™æ ·çš„ç®€å•ç±»å‹ï¼Œéƒ½è¿›è¡Œäº†é«˜åº¦å°è£…ä¼˜åŒ–ï¼Œå› æ­¤å…¶æœ‰å¤æ‚è¡¨è¾¾ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œæ ¼å¼åŒ–ã€‚</li></ul><img src="/images/blog/image-20220523174847611.png" alt="image-20220523174847611" style="zoom:35%;"><ul><li>  <code>v</code> å‘½ä»¤ï¼Œ<code>v</code> å‘½ä»¤çš„è¾“å‡ºä¸ <code>p</code> å®Œå…¨ä¸€æ ·ã€‚ä½†ä¸ <code>p</code> å’Œ <code>po</code> ä¸åŒçš„æ˜¯ï¼Œ<code>v</code> å‘½ä»¤å¹¶ä¸è¿›è¡Œç¼–è¯‘ä¸æ‰§è¡Œä»£ç ï¼Œæ‰€ä»¥å®ƒéå¸¸å¿«ï¼Œå®ƒé‡‡ç”¨ç‚¹å’Œä¸‹æ ‡ç¬¦æ¥è®¿é—®å­—æ®µã€‚<code>v</code> å‘½ä»¤æ‰§è¡Œåˆ†ä¸º 4 æ­¥ï¼Œé¦–å…ˆä¼šæŸ¥è¯¢è¿›ç¨‹çŠ¶æ€ä¸ºäº†å†…å­˜ä¸­å®šä½å˜é‡ï¼Œä¹‹åä¾¿ä»å†…å­˜ä¸­è¯»å–å˜é‡ï¼Œå¹¶å¯¹å…¶æ‰§è¡ŒåŠ¨æ€ç±»å‹æ£€æŸ¥ï¼Œå¦‚æœå®ƒæœ‰è®¿é—®å­å±æ€§ï¼Œåˆ™å¤šæ¬¡è¿›è¡Œå†…å­˜è¯»å–å˜é‡ä»¥åŠåŠ¨æ€ç±»å‹æ£€æŸ¥ã€‚æœ€åå°†ç»“æœè¿›è¡Œæ ¼å¼åŒ–ã€‚</li></ul><img src="/images/blog/image-20220523180303016.png" alt="image-20220523180303016" style="zoom:35%;"><h2 id="Debug-View-Hierarchy"><a href="#Debug-View-Hierarchy" class="headerlink" title="Debug View Hierarchy"></a>Debug View Hierarchy</h2><p>é¦–å…ˆä» <code>Xcode</code> ä¸­çš„ <code>Product -&gt; Scheme -&gt; Edit Scheme -&gt; Diagnostics</code> ä¸­å¼€å¯ <code>Malloc Stack Logging</code> é€‰é¡¹ï¼Œå¹¶é€‰æ‹© <code>All Allocation and Free History</code>ã€‚è¿™å¼€å¯äº†åˆ›å»ºå †æ ˆä¿¡æ¯è°ƒç”¨æ—¥å¿—ï¼Œåœ¨ Debug æ—¶ä¾¿å¯é€šè¿‡å¯¹è±¡çš„ä¿¡æ¯å»æŸ¥çœ‹å…¶è°ƒç”¨å †æ ˆã€‚</p><p>æ‰“å¼€ <code>Debug View Hierarchy</code>ï¼Œä¾¿å¯å‘ç°åœ¨å³ä¾§çš„ <code>Backtrace</code> ä¸­æœ‰äº†å†…å®¹ï¼Œå¦‚æœä½ æœ‰çº¦æŸå†²çªï¼Œæˆ–è€…æƒ³æŸ¥çœ‹æŸä¸ªè§†å›¾çš„åˆ›å»ºä¿¡æ¯ï¼Œåªéœ€è¦åœ¨å·¦ä¾§çš„å›¾å±‚ç»“æ„æˆ–è€…ä¸­é—´çš„å›¾åƒé€‰ä¸­ä½ æƒ³è¦çš„å³å¯ã€‚</p><p><img src="/images/blog/image-20220518192011839.png" alt="image-20220518192011839"></p><p>åŒæ ·çš„ <code>LLDB</code> è¿˜ç»™æˆ‘ä»¬å¸¦æ¥äº†æ›´åŠ å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥è¾¾åˆ°ä¸éœ€è¦é‡æ–°ç¼–è¯‘ä»è€Œæ”¹å˜è§†å›¾çš„ä¸€äº›è¡Œä¸ºï¼Œå…·ä½“å®ç°æ–¹æ³•å¯ä»¥ç±»ä¼¼å¦‚ä¸‹ï¼š</p><ol start="0"><li> å®šä½åˆ°æŸä¸ªå…·ä½“çš„å¯¹è±¡ï¼Œå³ä»ç•Œé¢ä¸­é€‰ä¸­æŸä¸€ä¸ªè§†å›¾æˆ–è€…çº¦æŸã€‚</li><li> æŒ‰é’® <code>commond + c</code> ä¾¿å¯å¤åˆ¶å…¶å¸¦æœ‰ç±»å‹çš„å†…å­˜åœ°å€ï¼Œè¿™æ—¶ä¾¿å¯ä»¥å¯¹å®ƒè¿›è¡Œæ“ä½œï¼Œå…·ä½“çš„åœ¨æ§åˆ¶å°ä¸­ï¼Œè¾“å…¥ä½ æƒ³è¦æ”¹å˜çš„æ“ä½œï¼Œå¦‚ï¼š</li></ol><p><code>e [((UIView *)0x7fa9320061a0) setBackgroundColor: [UIColor greenColor]]</code></p><p>æ³¨æ„è¿™é‡Œéœ€è¦ä½¿ç”¨ <code>Objective-C</code> çš„è¯­æ³•ï¼Œå› ä¸º <code>Swift</code> çš„å®‰å…¨æ€§å¯¼è‡´ä¸èƒ½è®¿é—®æ‰€æœ‰å†…å®¹ã€‚</p><ol start="3"><li> è¿™æ—¶ä½ å‘ç°ç•Œé¢æ²¡æœ‰æ”¹å˜ï¼Œéœ€è¦åˆ·æ–°è§†å›¾ï¼š</li></ol><p><code>e (void) [CATransaction flush];</code></p><p>å…·ä½“å…³äº <code>Debug View Hierarchy</code> çš„æ›´å¤šç”¨æ³•å¯å‚è€ƒ<a href="https://www.jianshu.com/p/9800c919e6cc">è¿™é‡Œ</a>ã€‚</p><h2 id="Debug-Memory-Graph"><a href="#Debug-Memory-Graph" class="headerlink" title="Debug Memory Graph"></a>Debug Memory Graph</h2><p>ç‚¹å¼€ <code>Debug Memory Graph</code>ï¼Œä¼šæš‚åœè¿›ç¨‹ï¼Œå¹¶æ˜¾ç¤ºå½“å‰å †çš„æ‰€æœ‰å¯¹è±¡ï¼Œå¹¶ä¸”ä¼šæ˜¾ç¤ºå®ƒä»¬ä¹‹é—´çš„æ‰€å±å…³ç³»å’Œå¼ºå¼•ç”¨ä¸å¼±å¼•ç”¨ï¼ˆæ·±è‰²çš„ä¸ºå¼ºå¼•ç”¨ï¼Œæµ…è‰²çš„ä¸ºå¼±å¼•ç”¨ï¼‰ã€‚</p><p>å¦‚æœä½ å¼€å¯äº† <code>Malloc Stack Logging</code>ï¼Œä¹ŸåŒæ ·èƒ½çœ‹è§å¯¹è±¡çš„å †æ ˆè°ƒç”¨ä¿¡æ¯ã€‚</p><p>ä¸ä»…å¦‚æ­¤ï¼Œè¿˜å¯ä»¥å‘ç°å†…å­˜æ³„æ¼ï¼Œå¯ä»¥ç‚¹å¼€å·¦ä¸‹è§’çš„æ„Ÿå¹å·ï¼Œä»…ç­›é€‰å‡ºå†…å­˜æ³„æ¼å¯¹è±¡ã€‚ä¸è¿‡ä»¤äººé—æ†¾çš„æ˜¯ï¼Œ<code>Debug Memory Graph</code> å¹¶ä¸èƒ½æ˜¾ç¤ºå‡ºæ‰€æœ‰çš„å†…å­˜æ³„æ¼é—®é¢˜ã€‚ä¾‹å¦‚ä¸‹å›¾ï¼Œåœ¨ <code>SecondViewController</code> æŒæœ‰ <code>block</code> ä¸ <code>block</code> ä¸­å»æŒæœ‰ <code>SecondViewController</code> ä¸­çš„ <code>view</code>ï¼Œè¿™æ˜¯ç»å…¸çš„ç”± <code>block</code> å¯¼è‡´çš„å¾ªç¯å¼•ç”¨ï¼Œè™½ç„¶ <code>Debug Memory Graph</code> æ²¡æœ‰æ˜ç¡®æ•æ‰åˆ°ï¼Œä½†æ˜¯ä»ç»™æˆ‘ä»¬æ’æŸ¥æä¾›äº†çº¿ç´¢ã€‚</p><p><img src="/images/blog/image-20220519190816761.png" alt="image-20220519190816761"></p><p>ç‚¹å‡» <code>Edit -&gt; Export Memory Graph</code>ï¼Œå¯ä»¥å¯¼å‡ºå†…å­˜åˆ†å¸ƒå›¾æ–‡ä»¶ã€‚åˆ©ç”¨ <code>vmmap</code>ã€<code>leaks</code>ã€<code>heap</code> ç­‰å‘½ä»¤è¡Œå·¥å…·å¯ä»¥è¿›ä¸€æ­¥åˆ†æå†…å­˜é—®é¢˜ï¼Œå…·ä½“åˆ†æå¯å‚è€ƒ <a href="http://www.yuezyevil.com/2021/01/14/iOS%20%E5%86%85%E5%AD%98%E8%B0%83%E8%AF%95%E7%AF%87%20%E2%80%94%E2%80%94%20memgraph/">iOS å†…å­˜è°ƒè¯•ç¯‡ â€“ memgraph</a>ã€‚</p><h2 id="Instruments"><a href="#Instruments" class="headerlink" title="Instruments"></a>Instruments</h2><p><code>Instruments</code> æä¾›äº†ä¸€å¥—ä¸°å¯Œå·¥å…·å’Œæ¨¡ç‰ˆå»åˆ†æ åº”ç”¨çš„æ€§èƒ½é—®é¢˜ï¼Œå¸¸è§çš„æ¨¡ç‰ˆæœ‰ï¼š</p><table><thead><tr><th>åç§°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>Leaks</td><td>ä¸€èˆ¬çš„æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œæ£€æŸ¥æ³„æ¼çš„å†…å­˜ï¼Œå¹¶æä¾›äº†æ‰€æœ‰æ´»åŠ¨çš„åˆ†é…å’Œæ³„æ¼æ¨¡å—çš„ç±»å¯¹è±¡åˆ†é…ç»Ÿè®¡ä¿¡æ¯ä»¥åŠå†…å­˜åœ°å€å†å²è®°å½•ã€‚</td></tr><tr><td>Time Profiler</td><td>æ‰§è¡Œå¯¹ç³»ç»Ÿçš„ CPUä¸Šè¿è¡Œçš„è¿›ç¨‹ä½è´Ÿè½½æ—¶é—´ä¸ºåŸºç¡€é‡‡æ ·ã€‚</td></tr><tr><td>Allocations</td><td>è·Ÿè¸ªè¿‡ç¨‹çš„åŒ¿åè™šæ‹Ÿå†…å­˜å’Œå †çš„å¯¹è±¡æä¾›ç±»åå’Œå¯é€‰ä¿ç•™/é‡Šæ”¾å†å²ã€‚</td></tr><tr><td>Activity Monitor</td><td>æ˜¾ç¤ºå™¨å¤„ç†çš„ CPUã€å†…å­˜å’Œç½‘ç»œä½¿ç”¨æƒ…å†µç»Ÿè®¡ã€‚</td></tr><tr><td>Blank</td><td>åˆ›å»ºä¸€ä¸ªç©ºçš„æ¨¡æ¿ï¼Œå¯ä»¥ä» Library åº“ä¸­æ·»åŠ å…¶ä»–æ¨¡æ¿ã€‚</td></tr><tr><td>Core Data</td><td>ç›‘æµ‹è¯»å–ã€ç¼“å­˜æœªå‘½ä¸­ã€ä¿å­˜ç­‰æ“ä½œï¼Œèƒ½ç›´è§‚æ˜¾ç¤ºæ˜¯å¦ä¿å­˜æ¬¡æ•°è¿œè¶…å®é™…éœ€è¦ã€‚</td></tr><tr><td>Network</td><td>è·Ÿè¸ª TCP/IP å’Œ UDP/IP è¿æ¥ã€‚</td></tr><tr><td>Engergy Log</td><td>åº”ç”¨çš„ç”µé‡æ¶ˆè€—æƒ…å†µã€‚</td></tr></tbody></table><p>ä¸‹é¢åŸºäº <code>Time Profiler</code> æ¨¡ç‰ˆï¼Œæ¢³ç†å¦‚ä½•ä½¿ç”¨ <code>Instruments</code>ï¼š</p><ol start="0"><li> é¦–å…ˆé€‰ä¸­ <code>Time Profiler</code>ï¼Œä¼šå‡ºç°ç©ºçš„é…ç½®é¡µ</li><li> åœ¨å·¦ä¸Šæ–¹ä¸­é€‰æ‹©åˆ†æçš„è®¾å¤‡ä»¥åŠåº”ç”¨</li><li> ç‚¹å‡»å¼€å§‹ï¼Œè¿™æ—¶ä¾¿å¯æ“ä½œæµ‹è¯•ä½ çš„åº”ç”¨ã€‚</li><li> å½“æ“ä½œå®Œæˆï¼Œç‚¹å‡»æš‚åœæˆ–ç»“æŸï¼Œè¿™æ—¶ä¾¿å¯é’ˆå¯¹æœ‰é—®é¢˜çš„æ•°æ®è¿›è¡Œåˆ†æã€‚</li></ol><p><img src="/images/blog/image-20220531171357436.png" alt="image-20220531171357436"></p><p>é€‰å–ä½ è®¤ä¸ºå¯ç–‘çš„æ—¶é—´æ®µï¼Œä¾‹å¦‚å¤§é‡å ç”¨ <code>CPU</code> çš„æ—¶é—´æ®µï¼Œå…¶æ¬¡é€æ­¥æ ¹æ®å»æ’æŸ¥ä»£ç é—®é¢˜ï¼Œä¾‹å¦‚ä¸»çº¿ç¨‹ä¸­æœ‰è€—æ—¶æ“ä½œã€‚</p><p>æ›´æ¨èçœ‹ä¸‹ <code>WWDC</code> ä¸­å…³äº <code>Instruments</code> çš„ä»‹ç» <a href="https://developer.apple.com/videos/play/wwdc2019/411/">WWDC2019 - Get Started with Instruments</a>ï¼Œç¬”è€…åªæ˜¯ç®€å•çš„æ¦‚è¿°ã€‚å…³äº <code>Instruments</code>ï¼Œå®ƒæ²¡æœ‰è®°å½•æ‰€æœ‰çš„è°ƒç”¨æ ˆå¸§ï¼Œè€Œæ˜¯åœ¨æ¯ç§’å»è®°å½•è®¸å¤šæ¬¡æ ˆå¸§å¿«ç…§ï¼Œè¿™æ˜¯ä¸ºäº†æ›´å¥½çš„æ€§èƒ½ä½“éªŒã€‚</p><h2 id="æ— é™è°ƒè¯•"><a href="#æ— é™è°ƒè¯•" class="headerlink" title="æ— é™è°ƒè¯•"></a>æ— é™è°ƒè¯•</h2><p>è¿˜æœ‰ä¸€ä¸ªå…³äºè°ƒè¯•çš„å°æŠ€å·§ï¼Œå¦‚æœä½ å¸Œæœ›ä¸ä½¿ç”¨æ•°æ®çº¿è¿æ¥ç”µè„‘ï¼Œå¯ä»¥é‡‡ç”¨å±€åŸŸç½‘çš„å½¢å¼è¿æ¥ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥è¿›è¡ŒçœŸæœºè¿è¡Œä¸è°ƒè¯•ã€‚å…·ä½“åœ¨ <code>Device</code> åˆ—è¡¨ä¸­å³é”®è®¾å¤‡å¹¶ç‚¹å‡» <code>Connect via IP Address</code>ã€‚</p><img src="/images/blog/image-20220531144036056.png" alt="image-20220531144036056" style="zoom:67%;"><p>é™¤æ­¤ä¹‹å¤–åœ¨èœå•æ ä¸­é€‰ä¸­ <code>Debug</code> çš„ <code>Attach to Process by Pid or Name</code> æˆ–è€… <code>Attach to Process</code> ï¼Œé€šè¿‡åˆ—è¡¨é€‰ä¸­æƒ³è¦é™„åŠ çš„è¿›ç¨‹ï¼Œå°±å¯ä»¥ä¸ç”¨æƒ³è¦ <code>Debug</code> çš„æ—¶å€™å†æ¬¡æ‰‹åŠ¨ <code>Run</code> ä¸€æ¬¡ã€‚ä¸è¿‡è¿™ä¸¤ç§æ–¹å¼ï¼Œéƒ½ä¼šæœ‰ä¸€å®šæ€§èƒ½æŸè€—ï¼Œä¼šå¯¼è‡´å“åº”æ—¶é—´æ…¢é—®é¢˜ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡æ€»ç»“äº† <code>LLDB</code> çš„ä¸€äº›å¸¸è§å‘½ä»¤ï¼Œæ®ç»Ÿè®¡ï¼Œä¸€åç¨‹åºå‘˜å¤§çº¦æœ‰ 70% çš„æ—¶é—´éƒ½åœ¨ <code>Debug</code>ï¼Œå¦‚æœèƒ½å¤Ÿç†Ÿç»ƒä½¿ç”¨å®ƒä»¬ï¼Œæ— ç–‘ä¼šæå¤§æå‡ç¼–ç¨‹æ•ˆç‡ã€‚åŒæ—¶è¿˜ä»‹ç»äº†å¦‚ <code>Debug View Hierarchy</code>ã€<code>Debug Memory Graph</code> çš„å¸¸è§ç”¨æ³•ã€‚ç‰¹åˆ«æ˜¯ <code>Debug Memory Graph</code>ï¼Œå› ä¸ºå†…å­˜é—®é¢˜å¾€å¾€æ˜¯ä¸æ˜“å¯Ÿè§‰ä¸”ä¸æ˜“æ‰¾åˆ°çš„ï¼Œå¥½å¥½åˆ©ç”¨å®ƒï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬å¯¹å†…å­˜é—®é¢˜ç ”ç©¶çš„æ›´åŠ æ·±å…¥ã€‚æœ€åæ˜¯ <code>Instruments</code>ï¼Œå®ƒé‡Œé¢æœ‰è®¸å¤šå·¥å…·ï¼Œé’ˆå¯¹å„æ–¹é¢çš„æ€§èƒ½é—®é¢˜éƒ½æœ‰æ‰€æ¶µç›–ï¼Œ<code>Jonathan Levin</code> ç§°ï¼Œä¸å…¶ä»–æ“ä½œç³»ç»Ÿç›¸æ¯”ï¼Œ<code>Instruments</code> æ˜¯æœ€å¥½çš„è°ƒè¯•å’Œæ€§èƒ½å‰–æå·¥å…·ã€‚</p><h2 id="ğŸ”—"><a href="#ğŸ”—" class="headerlink" title="ğŸ”—"></a>ğŸ”—</h2><p><a href="https://objccn.io/issue-19-2/">ä¸è°ƒè¯•å™¨å…±èˆ - LLDB çš„åå°”å…¹</a></p><p><a href="https://medium.com/@vin.pradeilles/advanced-debugging-with-xcode-5e6c8dabd311">ç”¨ LLDB è°ƒè¯• Swift ä»£ç </a></p><p><a href="https://developer.apple.com/videos/play/wwdc2018/412/">WWDC2018 - 412 é€šè¿‡ Xcode å’Œ LLDB è¿›è¡Œé«˜çº§è°ƒè¯•</a></p><p><a href="https://developer.apple.com/videos/play/wwdc2019/429/">WWDC2019 - 429 LLDB ä¸é™äº â€œpoâ€</a></p><p><a href="https://developer.apple.com/videos/play/wwdc2019/411/">WWDC2019 - 411 Get Started with Instruments</a></p><p>ã€Šæ·±å…¥è§£æ Mac OS X &amp; iOS æ“ä½œç³»ç»Ÿã€‹</p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LLDB </tag>
            
            <tag> Instrument </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOSä¸­çš„å¤šçº¿ç¨‹ä¸çº¿ç¨‹å®‰å…¨</title>
      <link href="/2022/04/02/iOS%20%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
      <url>/2022/04/02/iOS%20%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ <strong>iOS</strong> ä¸­æœ‰ 3 ç§çº¿ç¨‹ç®¡ç†å®‰å…¨ï¼Œåˆ†åˆ«æ˜¯ <strong>NSThread</strong>ã€<strong>GCD</strong> ä¸ <strong>NSOperation</strong>ï¼Œä¸åŒ…å«å‡ ä¹ä¸ç›´æ¥ä½¿ç”¨çš„ <strong>pthread</strong> ã€‚æœ¬æ–‡å°±å…¶ä½¿ç”¨ç‰¹ç‚¹ä»¥åŠé‡è¦çš„ <strong>API</strong> ï¼Œä»¥åŠçº¿ç¨‹å®‰å…¨ç­‰æ–¹é¢è¿›è¡Œæ€»ç»“ã€‚</p><span id="more"></span><h2 id="NSThread"><a href="#NSThread" class="headerlink" title="NSThread"></a>NSThread</h2><p>è½»é‡çº§çº¿ç¨‹æ“ä½œï¼Œé¢å‘å¯¹è±¡ï¼Œä½†éœ€æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹å£°æ˜å‘¨æœŸï¼ŒåŒæ—¶æ§åˆ¶ä¸åŒçº¿ç¨‹ä¹‹é—´æ‰§è¡Œé¡ºåºä¸æ˜¯å¾ˆå‹å¥½ã€‚</p><h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><pre><code class="swift">init(target: Any, selector: Selector, object argument: Any?) // éœ€è¦æ‰‹åŠ¨ start()init(block: @escaping () -&gt; Void) // éœ€è¦æ‰‹åŠ¨ start()detachNewThread(_ block: @escaping () -&gt; Void) // è‡ªå¯åŠ¨detachNewThreadSelector(_ selector: Selector, toTarget target: Any, with argument: Any?) // è‡ªå¯åŠ¨performSelector(inBackground aSelector: Selector, with arg: Any?) // éšå¼åˆ›å»º</code></pre><h3 id="çº¿ç¨‹çŠ¶æ€æ§åˆ¶"><a href="#çº¿ç¨‹çŠ¶æ€æ§åˆ¶" class="headerlink" title="çº¿ç¨‹çŠ¶æ€æ§åˆ¶"></a>çº¿ç¨‹çŠ¶æ€æ§åˆ¶</h3><pre><code class="swift">start() // å¯åŠ¨sleep(until date: Date) // ä¼‘çœ åˆ°æŒ‡å®šæ—¶é—´sleep(forTimeInterval ti: TimeInterval) // ä¼‘çœ æŒ‡å®šæ—¶é—´exit() // å¼ºåˆ¶ç«‹å³é€€å‡ºï¼Œä¸ç®¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¼‚å¸¸cancel() // ä¸ä¼šç«‹å³é€€å‡ºï¼Œå¾…åˆ°å¤„ç†å®Œçº¿ç¨‹ä¸Šä¸‹æ–‡åé€€å‡ºï¼Œå¯ç”¨ isCancel ç›‘å¬å…¶æ˜¯å¦é€€å‡º</code></pre><h3 id="çº¿ç¨‹é—´é€šä¿¡"><a href="#çº¿ç¨‹é—´é€šä¿¡" class="headerlink" title="çº¿ç¨‹é—´é€šä¿¡"></a>çº¿ç¨‹é—´é€šä¿¡</h3><pre><code class="swift">performSelector(onMainThread aSelector: Selector, with arg: Any?, waitUntilDone wait: Bool, modes array: [String]?) // åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡ŒperformSelector(onMainThread aSelector: Selector, with arg: Any?, waitUntilDone wait: Bool) // åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œperform(_ aSelector: Selector, on thr: Thread, with arg: Any?, waitUntilDone wait: Bool, modes array: [String]?) // åˆ°æŒ‡å®šçº¿ç¨‹ä¸­æ‰§è¡Œperform(_ aSelector: Selector, on thr: Thread, with arg: Any?, waitUntilDone wait: Bool) // åˆ°æŒ‡å®šçº¿ç¨‹ä¸­æ‰§è¡Œ</code></pre><h3 id="çº¿ç¨‹ä¿æ´»"><a href="#çº¿ç¨‹ä¿æ´»" class="headerlink" title="çº¿ç¨‹ä¿æ´»"></a>çº¿ç¨‹ä¿æ´»</h3><pre><code class="swift">let thread = CusThread.init(target: self, selector: #selector(threadAction), object: nil)@objc func threadAction() {    let runLoop = RunLoop.current    runLoop.add(.init(), forMode: .default)    while !Thread.current.isCancelled {        runLoop.run(mode: .default, before: Date.init(timeInterval: 2, since: .now)) // ä¸¤ç§’æ‰§è¡Œä¸€æ¬¡        otherAction()    }    }</code></pre><p><strong>runLoop</strong> éœ€æ·»åŠ  <strong>port</strong> / <strong>timer</strong> ç­‰å†…å®¹ï¼Œå¦åˆ™ <strong>runLoop</strong> ä¼šç«‹å³é€€å‡º<br>åœ¨éœ€é€€å‡ºæ—¶æ‰‹åŠ¨è°ƒç”¨ <strong>cancel</strong>() æ–¹æ³•ï¼Œé˜²æ­¢ <strong>RunLoop</strong> æŒæœ‰ <strong>Thread</strong> å¯¼è‡´å†…å­˜æ³„éœ²é—®é¢˜</p><h2 id="GCD"><a href="#GCD" class="headerlink" title="GCD"></a>GCD</h2><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><blockquote><p><strong>Grand Central Dispatchï¼ˆGCDï¼‰</strong> æ˜¯ Apple å¼€å‘çš„ä¸€ä¸ªå¤šæ ¸ç¼–ç¨‹çš„è¾ƒæ–°çš„è§£å†³æ–¹æ³•ã€‚å®ƒä¸»è¦ç”¨äºä¼˜åŒ–åº”ç”¨ç¨‹åºä»¥æ”¯æŒå¤šæ ¸å¤„ç†å™¨ä»¥åŠå…¶ä»–å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿã€‚å®ƒæ˜¯ä¸€ä¸ªåœ¨çº¿ç¨‹æ± æ¨¡å¼çš„åŸºç¡€ä¸Šæ‰§è¡Œçš„å¹¶å‘ä»»åŠ¡ã€‚åœ¨ Mac OS X 10.6 é›ªè±¹ä¸­é¦–æ¬¡æ¨å‡ºï¼Œä¹Ÿå¯åœ¨ iOS 4 åŠä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨ã€‚</p></blockquote><p><strong>GCD</strong> æ˜¯ <strong>iOS</strong> æ¨å‡ºçš„å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆï¼Œå…¶æ›´å¼ºè°ƒã€Œä»»åŠ¡å—ã€çš„æ¦‚å¿µï¼Œå¿½ç•¥äº†å¯¹çº¿ç¨‹çš„ç®¡ç†ï¼›<strong>GCD</strong> æ˜¯ç”± <strong>C</strong> è¯­è¨€ç¼–å†™çš„è½»é‡çº§çº¿ç¨‹å¤„ç†æ–¹å¼ï¼Œå…¶æºç åœ¨<a href="https://github.com/apple/swift-corelibs-libdispatch">è¿™é‡Œ</a>ï¼Œåœ¨å…¶å†…éƒ¨ç»´æŠ¤äº† <strong>pthread</strong> ç”Ÿæˆçš„çº¿ç¨‹æ± çš„æ¦‚å¿µã€‚</p><h3 id="ä»»åŠ¡-amp-é˜Ÿåˆ—"><a href="#ä»»åŠ¡-amp-é˜Ÿåˆ—" class="headerlink" title="ä»»åŠ¡ &amp; é˜Ÿåˆ—"></a>ä»»åŠ¡ &amp; é˜Ÿåˆ—</h3><p><strong>GCD</strong> ä¸­çš„æ ¸å¿ƒæ¦‚å¿µ ã€Œé˜Ÿåˆ—ã€ ä¸ ã€Œä»»åŠ¡ã€ï¼š</p><p>é˜Ÿåˆ—å³æ‰§è¡Œä»»åŠ¡çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œä»¥å…ˆè¿›å…ˆå‡ºä¸ºåŸåˆ™æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¸»è¦åˆ†ä¸º <strong>ä¸²è¡Œé˜Ÿåˆ—</strong> ä¸ <strong>å¹¶è¡Œé˜Ÿåˆ—</strong></p><ul><li>ä¸²è¡Œé˜Ÿåˆ—ï¼ˆ<strong>Serial Dispatch Queue</strong>ï¼‰ï¼šæ¯æ¬¡åªæœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œã€‚</li><li>å¹¶è¡Œé˜Ÿåˆ—ï¼ˆ<strong>Concurrent Dispatch Queue</strong>ï¼‰ï¼š å¯ä»¥è®©å¤šä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚</li></ul><pre><code class="swift">let queue = DispatchQueue(label: "name") // ä¸²è¡Œé˜Ÿåˆ—åˆ›å»º / é»˜è®¤let queue = DispatchQueue(label: "name", attributes: .concurrent) // å¹¶è¡Œé˜Ÿåˆ—åˆ›å»º</code></pre><p>ä»»åŠ¡å³ä½ æ”¾å…¥ <strong>GCD</strong> ä¸­çš„ä»£ç å—ï¼Œåˆ†ä¸ºåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§</p><ul><li>åŒæ­¥ä»»åŠ¡ï¼ˆ<strong>sync</strong>ï¼‰ï¼šåŒæ­¥ä»»åŠ¡ä¼šç­‰å¾…é˜Ÿåˆ—ä¸­å‰é¢çš„ä»»åŠ¡æ‰§è¡Œå®Œå†æ‰§è¡Œï¼Œåœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€å¯çº¿ç¨‹èƒ½åŠ›ã€‚</li><li>å¼‚æ­¥ä»»åŠ¡ï¼ˆ<strong>async</strong>ï¼‰ï¼šå¼‚æ­¥ä»»åŠ¡æ— éœ€ç­‰å¾…å‰é¢çš„ä»»åŠ¡æ‰§è¡Œå®Œï¼Œå³å¯ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼Œåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå…·å¤‡å¼€å¯çº¿ç¨‹èƒ½åŠ›ã€‚</li></ul><pre><code class="swift">queue.sync { // è¿½åŠ åŒæ­¥ä»»åŠ¡    print(Thread.current)} queue.async { // è¿½åŠ å¼‚æ­¥ä»»åŠ¡    print(Thread.current)} </code></pre><p><strong>ä¸»é˜Ÿåˆ—</strong>ï¼šå³ä¸»çº¿ç¨‹æ‰€åœ¨é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œå¯é€šè¿‡<code>DispatchQueue.main</code> è·å–</p><p><strong>å…¨å±€é˜Ÿåˆ—</strong>ï¼šå¹¶è¡Œé˜Ÿåˆ—ï¼Œå¯é€šè¿‡<code>DispatchQueue.global()</code> è·å–ï¼ŒåŒæ—¶è¿˜å¯æ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§ä¸åŒè·å–ä¸åŒçš„å…¨å±€é˜Ÿåˆ—ï¼š<code>DispatchQueue.global(qos: .background)</code></p><p>ç”±äºä»»åŠ¡æ˜¯è¿½åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå› æ­¤æœ‰ 4 ç§ç»„åˆæ–¹å¼ï¼š</p><table><thead><tr><th align="left"></th><th align="left">å¹¶å‘é˜Ÿåˆ—</th><th align="left">ä¸²è¡Œé˜Ÿåˆ—</th><th>ä¸»é˜Ÿåˆ—</th></tr></thead><tbody><tr><td align="left">åŒæ­¥ï¼ˆsyncï¼‰</td><td align="left">æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ / ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td align="left">æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ / ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td>æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ / ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td></tr><tr><td align="left">å¼‚æ­¥ï¼ˆasyncï¼‰</td><td align="left">å¼€å¯æ–°çº¿ç¨‹ / å¹¶å‘æ‰§è¡Œä»»åŠ¡</td><td align="left">å¼€å¯æ–°çº¿ç¨‹ / ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td>æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ / ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td></tr></tbody></table><h3 id="GCD-ä¸­çš„æ­»é”"><a href="#GCD-ä¸­çš„æ­»é”" class="headerlink" title="GCD ä¸­çš„æ­»é”"></a>GCD ä¸­çš„æ­»é”</h3><blockquote><p>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ï¼Œè¿™äº›æ°¸è¿œåœ¨äº’ç›¸ç­‰å¾…çš„è¿›ç¨‹ç§°ä¸ºæ­»é”è¿›ç¨‹ã€‚</p></blockquote><p>æ­»é”æœ‰å››ä¸ªå¿…è¦æ¡ä»¶ï¼šäº’æ–¥ &amp; è¯·æ±‚ä¿æŒ &amp; ä¸å¯å‰¥å¤º &amp; ç¯è·¯æ¡ä»¶ã€‚</p><p>åœ¨ <strong>GCD</strong> ä¸­ï¼Œç”±äºä¸å½“ä½¿ç”¨ <strong>API</strong> åˆ™å¯èƒ½ä¼šé€ æˆæ­»é”ï¼Œè¿™ä¸ªæ­»é”çš„æ¦‚å¿µä¸åƒä¸Šè¿°è¡¨ç¤ºé‚£æ ·ï¼Œä¸»è¦æ˜¯ä»»åŠ¡é—´çš„ç›¸äº’ç­‰å¾…å¯¼è‡´æ— æ³•æ‰§è¡Œä»»åŠ¡é€ æˆï¼Œè¾ƒä¸ºå¸¸è§çš„å¦‚ä¸‹ï¼š</p><p>åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ</p><pre><code class="swift">DispatchQueue.main.sync {    print(Thread.current) // åŒæ­¥ä»»åŠ¡}// å½“å‰ä»»åŠ¡</code></pre><pre><code class="swift">let queue = DispatchQueue.init(label: "name")    queue.sync {        queue.sync {              print(Thread.current) // åŒæ­¥ä»»åŠ¡        }      } // å½“å‰ä»»åŠ¡    print(Thread.current)  }</code></pre><p>åŸå› ï¼šåŒæ­¥çš„ä»»åŠ¡æ— æ³•å¼€å§‹ï¼Œéœ€ç­‰å¾…å½“å‰é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œï¼Œè€Œå½“å‰ä»»åŠ¡åˆå› åŒæ­¥çš„ä»»åŠ¡å¯¼è‡´æ— æ³•å®Œæˆã€‚</p><h3 id="å…¶ä»–é‡è¦çš„API"><a href="#å…¶ä»–é‡è¦çš„API" class="headerlink" title="å…¶ä»–é‡è¦çš„API"></a>å…¶ä»–é‡è¦çš„<strong>API</strong></h3><h4 id="DiapatchGroup"><a href="#DiapatchGroup" class="headerlink" title="DiapatchGroup"></a>DiapatchGroup</h4><p>åœ¨è¿½åŠ å¤šä¸ªå¼‚æ­¥ä»»åŠ¡åç»Ÿä¸€è¿›è¡Œä»»åŠ¡æ‰§è¡Œï¼Œå¯ä»¥é‡‡ç”¨ <strong>DispatchGroup</strong>ï¼ŒåŒæ ·çš„åŸºäºæ‰‹åŠ¨å°†ä»»åŠ¡åŠ å…¥åˆ° <strong>DispatchGroup</strong> ä¸­(<strong>enter</strong> / <strong>leave</strong>)ä¹Ÿå¯åœ¨å¤šä¸ªç½‘ç»œè¯·æ±‚ååšåŒæ­¥æ“ä½œã€‚</p><pre><code class="swift">// å°†ä»»åŠ¡åŠ å…¥åˆ°DispatchGrouplet group = DispatchGroup()let queue = DispatchQueue.init(label: "name", attributes: .concurrent)for i in 1...5 {    queue.async(group: group, execute: {      print("------ \(i)")    })}group.notify(queue: queue) {    print("end")}// æ‰‹åŠ¨å°†ä»»åŠ¡åŠ å…¥åˆ°DispatchGrouplet group = DispatchGroup()let queue = DispatchQueue.init(label: "name", attributes: .concurrent)for i in 1...5 {    group.enter()    netwrk.api {        group.leave()    }}group.notify(queue: queue) {    print("end")}</code></pre><h4 id="æ …æ å‡½æ•°-barrier"><a href="#æ …æ å‡½æ•°-barrier" class="headerlink" title="æ …æ å‡½æ•°(barrier)"></a>æ …æ å‡½æ•°(barrier)</h4><p>æ …æ ä»»åŠ¡ä¼šåœ¨å‰é¢ä»»åŠ¡éƒ½æ‰§è¡Œå®Œåæ‰§è¡Œï¼Œåœ¨æ …æ ä»»åŠ¡æ‰§è¡Œå®Œåæ‰ä¼šæ‰§è¡Œåé¢è¿½åŠ çš„ä»»åŠ¡ï¼Œåœ¨å…·ä½“åœºæ™¯ä¸­ï¼Œå¯ä»¥ç”¨äºâ€œè¯»è€…-å†™è€…é—®é¢˜â€ï¼Œå³åŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªè¯»è€…ï¼Œä½†åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå†™è€…ï¼Œå¦‚æ•°æ®åº“çš„è¯»å†™æ“ä½œã€‚</p><img src="/images/blog/image-20220328172310546.png" alt="image-20220328172310546" style="zoom: 67%;"><pre><code class="swift">queue.async(group: nil, qos: .default, flags: .barrier) {    print("éš”ç¦»")}</code></pre><h4 id="å»¶è¿Ÿæ‰§è¡Œ-asyncAfter"><a href="#å»¶è¿Ÿæ‰§è¡Œ-asyncAfter" class="headerlink" title="å»¶è¿Ÿæ‰§è¡Œ(asyncAfter)"></a>å»¶è¿Ÿæ‰§è¡Œ(asyncAfter)</h4><p>å»¶è¿ŸæŒ‡å®šæ—¶é—´åå°†å»¶è¿Ÿä»»åŠ¡åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¯ä»¥ä¼ é€’ <strong>DispatchTime</strong> å’Œ <strong>DispatchWallTime</strong> è¿™ä¸¤ä¸ªæ—¶é—´ï¼Œå‰è€…æ˜¯åŸºäºç³»ç»Ÿæ—¶é—´ï¼Œä¸å¯è¢«æ”¹å˜ï¼Œåè€…ä¸ºç³»ç»Ÿæ—¶é’Ÿï¼Œå³é”å±ç•Œé¢çš„æ—¶é—´ã€‚</p><pre><code class="swift">queue.asyncAfter(deadline: .now() + 1) {    print("æ‰§è¡Œ")}</code></pre><h4 id="ä¿¡å·é‡-semaphore"><a href="#ä¿¡å·é‡-semaphore" class="headerlink" title="ä¿¡å·é‡(semaphore)"></a>ä¿¡å·é‡(semaphore)</h4><p><strong>DispatchSemaphore</strong> ä¸ æ“ä½œç³»ç»Ÿä¸­çš„ä¿¡å·é‡ä¸€æ ·ï¼Œéƒ½æ˜¯ç”¨æ¥é¿å…æ•°æ®ç«äº‰è¿™ä¸€ç±»é—®é¢˜çš„ï¼Œåœ¨ <strong>iOS</strong> ä¸­å¸¸ç”¨æ¥æ§åˆ¶å¹¶å‘ä»»åŠ¡æ‰§è¡Œçš„æœ€å¤§æ•°é‡ã€‚</p><ul><li>**singal()**ï¼šå°† ä¿¡å·é‡ + 1</li><li>**wait()**ï¼šè‹¥æ­¤æ—¶ä¿¡å·é‡ &gt;= 1æ—¶ï¼Œå°†ä¿¡å·é‡å‡ 1ï¼Œç„¶åè¿”å›ï¼›è‹¥ä¿¡å·é‡ &lt;= 0æ—¶ï¼Œåˆ™é˜»å¡çº¿ç¨‹è¿›è¡Œç­‰å¾…ã€‚</li></ul><pre><code class="swift">let semaphore = DispatchSemaphore(value: 3) // å°†å¹¶å‘ä»»åŠ¡æ‰§è¡Œæ•°é‡æ§åˆ¶ä¸º3let queue = DispatchQueue.init(label: "name", attributes: .concurrent)for i in 1...5 {    semaphore.wait()    queue.async {        print(i)        semaphore.signal()    }}</code></pre><h4 id="è°ƒåº¦æº-DispatchSource"><a href="#è°ƒåº¦æº-DispatchSource" class="headerlink" title="è°ƒåº¦æº(DispatchSource)"></a>è°ƒåº¦æº(DispatchSource)</h4><p><strong>DispatchSource</strong> ç”¨äºç›‘å¬ç³»ç»Ÿçš„åº•å±‚å¯¹è±¡ï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦ã€<strong>Mach</strong> ç«¯å£ã€ä¿¡å·é‡ã€å†…å­˜è­¦å‘Šç­‰ã€‚ä¸»è¦å¤„ç†æ—¶é—´å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th align="left">å®å®šä¹‰</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">DispatchSourceUserDataAdd</td><td align="left">æ•°æ®å¢åŠ </td></tr><tr><td align="left">DispatchSourceUserDataOr</td><td align="left">æ•°æ®OR</td></tr><tr><td align="left">DispatchSourceMachSend</td><td align="left">Machç«¯å£å‘é€</td></tr><tr><td align="left">DispatchSourceMachReceive</td><td align="left">Machç«¯å£æ¥æ”¶</td></tr><tr><td align="left">DispatchSourceMemoryPressure</td><td align="left">å†…å­˜æƒ…å†µ</td></tr><tr><td align="left">DispatchSourceProcess</td><td align="left">è¿›ç¨‹äº‹ä»¶</td></tr><tr><td align="left">DispatchSourceRead</td><td align="left">è¯»æ•°æ®</td></tr><tr><td align="left">DispatchSourceSignal</td><td align="left">ä¿¡å·</td></tr><tr><td align="left">DispatchSourceTimer</td><td align="left">å®šæ—¶å™¨</td></tr><tr><td align="left">DispatchSourceFileSystemObject</td><td align="left">æ–‡ä»¶ç³»ç»Ÿå˜åŒ–</td></tr><tr><td align="left">DispatchSourceWrite</td><td align="left">æ–‡ä»¶å†™å…¥</td></tr></tbody></table><p>ä¾‹å¦‚ï¼š</p><p><strong>ç›‘å¬å†…å­˜æƒ…å†µ</strong></p><pre><code class="swift">var source = DispatchSource.makeMemoryPressureSource(eventMask: .all, queue: .main)source.setEventHandler {    print(source.data)    // dataä¸ºæšä¸¾å€¼çš„rawValue, ä¸»è¦æœ‰ normalã€warningã€criticalã€all}source.activate()</code></pre><p><strong>å®šæ—¶å™¨</strong></p><pre><code class="swift">var source: DispatchSourceTimer?source = DispatchSource.makeTimerSource(flags: .strict, queue: .main)source?.schedule(deadline: .now() + 1, repeating: 1)source?.setEventHandler {    print("å®šæ—¶å™¨è§¦å‘\(Date.now)")}source?.activate()</code></pre><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ <strong>NSTimer</strong> æ—¶ï¼Œè‹¥åœ¨æ»‘åŠ¨é¡µé¢æ—¶ï¼Œæ­¤ <strong>NSTimer</strong> ä¼šå¤±æ•ˆï¼Œéœ€ç»™ <strong>timer</strong> åŠ å…¥çš„ <strong>RunLoop</strong> æ·»åŠ  <strong>commonMode</strong> æ¨¡å¼ï¼Œè‹¥é‡‡ç”¨  <strong>DispatchSourceTimer</strong>ï¼Œåˆ™ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚</p><p>éœ€æ³¨æ„ä»¥ä¸Šä»£ç  <code>source</code> ä¸è¦ä»¥å±€éƒ¨å˜é‡è¿›è¡Œæµ‹è¯•ï¼Œå¦åˆ™è¶…å‡ºä½œç”¨åŸŸå°±è¢«é‡Šæ”¾ã€‚</p><h4 id="DispatchIO"><a href="#DispatchIO" class="headerlink" title="DispatchIO"></a>DispatchIO</h4><p><strong>DispatchIO</strong> æä¾›ä¸€ä¸ªæ“ä½œæ–‡ä»¶æè¿°ç¬¦çš„é€šé“ï¼Œå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹é«˜æ•ˆçš„è¯»å–æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦æµç¨‹ï¼š</p><ol><li>åˆ›å»º <strong>DispatchIO</strong> å¯¹è±¡ï¼Œåˆ›å»ºé€šé“</li><li>è¿›è¡Œ <strong>read</strong> / <strong>write</strong> æ“ä½œ</li><li>è°ƒç”¨ <strong>close</strong> å…³é—­é€šé“</li><li>è¿›è¡Œ <strong>cleanupHandler</strong> å›è°ƒå¤„ç†</li></ol><pre><code class="swift">var ioWrite: DispatchIO?var ioRead: DispatchIO?let queue = DispatchQueue(label: "com.nihao.serialQueue")let filePath: NSString = (NSTemporaryDirectory() + "text.txt") as NSStringlet fileDescriptor = open(filePath.utf8String!, (O_RDWR | O_CREAT | O_APPEND), (S_IRWXU | S_IRWXG))let cleanupHandler: (Int32) -&gt; Void = { errorNumber in    print("æœ€åçš„å›è°ƒ")}ioWrite = DispatchIO(type: .stream, fileDescriptor: fileDescriptor, queue: queue, cleanupHandler: cleanupHandler)ioRead = DispatchIO(type: .stream, fileDescriptor: fileDescriptor, queue: queue, cleanupHandler: cleanupHandler)let formattedString = "nihao!!!!!"let data = Array(formattedString.utf8).withUnsafeBytes {    DispatchData(bytes: $0)}ioWrite?.write(offset: 0, data: data, queue: queue) { done, data, error in }ioRead?.read(offset: 0, length: Int.max, queue: queue) { done, data, error in }</code></pre><h2 id="NSOperation"><a href="#NSOperation" class="headerlink" title="NSOperation"></a>NSOperation</h2><p><strong>NSOperation</strong> æ˜¯åŸºäº <strong>GCD</strong> çš„é¢å‘å¯¹è±¡çš„å°è£…ï¼Œå› æ­¤ä¹Ÿæœ‰ã€Œä»»åŠ¡ <strong>NSOperation</strong>ã€å’Œã€Œé˜Ÿåˆ— <strong>NSOperationQueue</strong>ã€ä¸¤ä¸ªæ¦‚å¿µï¼ŒåŒæ—¶ä¹Ÿå¢åŠ äº† <strong>NSOperation</strong> ä¹‹é—´ç›¸äº’ä¾èµ–ã€é€šè¿‡ <strong>KVO</strong> ç›‘å¬ <strong>NSOperation</strong> çŠ¶æ€ã€å–æ¶ˆä»»åŠ¡ç­‰ç‰¹æ€§ã€‚</p><p><strong>NSOperation</strong> æ˜¯ä¸€ä¸ªå½¢å¼ä¸Šçš„æŠ½è±¡ç±»ï¼Œç³»ç»Ÿæä¾›äº† <strong>NSInvocationOperation</strong> å’Œ <strong>NSBlockInvocation</strong> ä¸¤ä¸ªå­ç±»ï¼Œä½†ç”±äº <strong>NSInvocation</strong> åœ¨ <strong>Swift</strong> ä¸­ä¸å¯ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨ <strong>Swift</strong> ä¸­ <strong>NSInvocationOperation</strong> ä¹Ÿä¸å¯ç”¨ã€‚åŒæ—¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ <strong>NSOperation</strong>ï¼Œè‹¥ä»…ä½¿ç”¨ <strong>NSOperation</strong> åˆ™ä»»åŠ¡åªä¼šåœ¨ä¸»çº¿ç¨‹è¿è¡Œï¼Œå› æ­¤éœ€å’Œ <strong>NSOperationQueue</strong> æ­é…ä½¿ç”¨ã€‚</p><p><strong>NSOperationQueue</strong> åˆå§‹åŒ–åå°±æ˜¯ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ï¼Œå®ƒä¼šæ ¹æ®ä¼˜å…ˆçº§ä¸å‡†å¤‡æƒ…å†µè°ƒç”¨ä»»åŠ¡ï¼Œå¯é€šè¿‡ç±»å±æ€§ <code>main</code> è·å–ä¸»é˜Ÿåˆ—ï¼Œä¸»è¦æ˜¯é€šè¿‡ç»™é˜Ÿåˆ—æ·»åŠ  <strong>operation</strong> è¿›è¡Œæ“ä½œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“ä»»åŠ¡å·²ç»è¢«æ‰§è¡Œæˆ–æ‰§è¡Œå·²ç»“æŸåå°±ä¸èƒ½è¢«å†æ¬¡æ·»åŠ è¿›é˜Ÿåˆ—ï¼Œå¦åˆ™ä¼šäº§ç”Ÿ <strong>crash</strong>ã€‚ä¸‹é¢æ˜¯ä¸€äº›ä½¿ç”¨èŒƒä¾‹ï¼š</p><pre><code class="swift">let queue = OperationQueue()queue.maxConcurrentOperationCount = 2 //è®¾ç½®æœ€å¤§å¹¶å‘æ•°let operationA = BlockOperation { () -&gt; Void in    print("A - \(Thread.current)")}let operationB = BlockOperation { () -&gt; Void in    print("B - \(Thread.current)")}operationA.addDependency(operationB) // A ä¾èµ–äº B, å½“ B æ‰§è¡Œå A æ‰ä¼šæ‰§è¡Œqueue.addOperation(operationA)queue.addOperation(operationB)queue.addBarrierBlock {    print("æˆ‘æ˜¯å±éšœ")}queue.addOperation { () -&gt; Void in    print("2 - \(Thread.current)")}</code></pre><h3 id="è‡ªå®šä¹‰-NSOperation"><a href="#è‡ªå®šä¹‰-NSOperation" class="headerlink" title="è‡ªå®šä¹‰ NSOperation"></a>è‡ªå®šä¹‰ NSOperation</h3><p>é€šå¸¸æ¥è¯´éå¹¶å‘ <strong>NSOperation</strong>ï¼Œè‡ªå®šä¹‰ <strong>NSOperation</strong> ä¸æ˜¯ä¸€ä»¶å›°éš¾çš„äº‹ï¼Œåªéœ€è¦é‡å†™ <code>start()</code> æ–¹æ³•ï¼Œå°†éœ€è¦æ‰§è¡Œçš„æ“ä½œå†™å…¥å³å¯ã€‚ä½†å¦‚æœæƒ³è¦è‡ªå®šä¹‰å¹¶å‘ <strong>NSOperation</strong>ï¼Œéœ€è¦è‡³å°‘å®ç°ä»¥ä¸‹æ–¹æ³•å’Œå±æ€§ï¼š</p><ul><li><code>start()</code></li><li><code>isAsynchronous</code></li><li><code>isExecuting</code></li><li><code>isFinish</code></li></ul><p>æ€»çš„æ¥è¯´éœ€è¦åœ¨æ‰§è¡Œå‡½æ•°çš„å»ç»´æŠ¤ <strong>NSOperation</strong> çš„ä¸€äº›çŠ¶æ€ï¼Œå¦‚æœè¿˜è¿›è¡Œäº† <strong>KVO</strong> ç›‘å¬ï¼Œè¿˜éœ€è¦å»å‘å‡º <strong>KVO</strong> é€šçŸ¥ä»¥åæ˜ å€¼çš„æ”¹å˜ã€‚å…·ä½“å¯ä»¥å‚è€ƒ <strong>Apple</strong> çš„æ–‡æ¡£ <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW16">è‡ªå®šä¹‰NSOperation å¯¹è±¡</a></p><h2 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h2><blockquote><p>åœ¨æ‹¥æœ‰å…±äº«æ•°æ®çš„å¤šæ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œçš„ç¨‹åºä¸­ï¼Œçº¿ç¨‹å®‰å…¨çš„ä»£ç ä¼šé€šè¿‡åŒæ­¥æœºåˆ¶ä¿è¯å„ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æ­£å¸¸ä¸”æ­£ç¡®çš„æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°æ•°æ®æ±¡æŸ“ç­‰æ„å¤–æƒ…å†µã€‚</p></blockquote><p>å†ä½“ä¼šåˆ°äº†å¤šçº¿ç¨‹çš„å¥½å¤„ä¹‹åï¼Œéœ€è¦å¯¹æ•°æ®çš„å®‰å…¨æƒ…å†µè¿›è¡Œä¿è¯ã€‚çº¿ç¨‹å®‰å…¨å°±æ˜¯ä¸ºäº†ä¿è¯è¢«å¤šçº¿ç¨‹æ‰§è¡Œçš„è¿‡ç¨‹ä¸­èƒ½å¤Ÿå¾—åˆ°æ­£ç¡®çš„ç»“æœï¼Œå³æ•°æ®ä¸è¢«æ±¡æŸ“ã€‚ä¿è¯çº¿ç¨‹å®‰å…¨æœ‰ã€ŒåŒæ­¥ã€å’Œã€ŒéåŒæ­¥ã€ä¸¤ç§æ–¹æ¡ˆã€‚ã€ŒåŒæ­¥ã€æ˜¯æŒ‡åœ¨å¤šçº¿ç¨‹å¹¶å‘è®¿é—®æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä¿è¯å…±äº«æ•°æ®åœ¨åŒä¸€æ—¶åˆ»åªè¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¾‹å¦‚åŠ é”ã€‚ã€ŒéåŒæ­¥ã€æ˜¯æŒ‡åœ¨æŸäº›æƒ…å†µä¸‹ä¸éœ€è¦ã€ŒåŒæ­¥ã€æ“ä½œï¼Œä¾‹å¦‚å‡½æ•°æœ¬èº«å°±ä¸æ¶‰åŠåˆ°å…±äº«ä»£ç ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸éœ€è¦ã€ŒåŒæ­¥ã€å»ä¿è¯æ•°æ®å®‰å…¨ã€‚</p><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><h4 id="æ— åŒæ­¥"><a href="#æ— åŒæ­¥" class="headerlink" title="æ— åŒæ­¥"></a>æ— åŒæ­¥</h4><p><strong>å¯é‡å…¥ä»£ç </strong>ï¼ˆ<strong>ReentrantCode</strong>ï¼‰ï¼šå¯ä»¥åœ¨è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„ä»»ä½•æ—¶åˆ»ä¸­æ–­å®ƒï¼Œè½¬å…¥ **OS **è°ƒåº¦ä¸‹å»æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç ï¼Œè€Œè¿”å›æ§åˆ¶æ—¶ä¸ä¼šå‡ºç°ä»€ä¹ˆé”™è¯¯ï¼Œè¿™æ„å‘³ç€å®ƒé™¤äº†ä½¿ç”¨è‡ªå·±æ ˆä¸Šçš„å˜é‡å¤–ä¸ä¾èµ–äºå…¶ä»–ä»»ä½•å˜é‡ã€‚è¿™ç§æƒ…å†µæ¯æ¬¡æ‰§è¡Œç»“æœéƒ½ä¸€æ ·ï¼Œä¸”ä¸ä¼šä¾èµ–å…±äº«å˜é‡ï¼Œåœ¨æ— åŒæ­¥æƒ…å†µä¸‹ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚</p><p><strong>çº¿ç¨‹æœ¬åœ°å­˜å‚¨</strong>ï¼šè‹¥çº¿ç¨‹ä¸­éœ€è¦çš„æ•°æ®å¿…é¡»ä¸å…¶ä»–çº¿ç¨‹å…±äº«ï¼Œå°è¯•åˆ¤æ–­è¿™ä¸ªå…±äº«çš„æ•°æ®èƒ½å¦ä¿è¯åªåœ¨åŒä¸€çº¿ç¨‹æ‰§è¡Œï¼Œå¦‚æœå¯ä»¥ï¼Œåˆ™å¯ä»¥å¯¹è¯¥çº¿ç¨‹åˆ›å»ºä¸€ä»½å…±äº«å˜é‡çš„å‰¯æœ¬ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å®ç°æ— åŒæ­¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ä¾‹å¦‚ï¼š</p><pre><code class="swift">class Person: NSCopying {    func copy(with zone: NSZone? = nil) -&gt; Any {        return Person(-1, name: "")    }    var age: Int    var name: String    init(_ age: Int, name: String) {        self.age = age        self.name = name    }}var person = Person.init(2, name: "") // å…¨å±€å˜é‡let queue = DispatchQueue.init(label: "name")for i in 0...100 {    queue.async {        var currPerson = self.person.copy()    }}</code></pre><p>è‹¥çº¿ç¨‹ä¸­æ¯æ¬¡éƒ½éœ€è¦è®¿é—® <strong>person</strong>ï¼Œä¸”åœ¨åé¢ä¸éœ€è¦åŒæ­¥å›åŸå§‹ <strong>person</strong>ï¼Œä»…åœ¨å½“å‰çº¿ç¨‹ä¸­æ“ä½œï¼Œä¹Ÿå¯ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><h4 id="åŒæ­¥"><a href="#åŒæ­¥" class="headerlink" title="åŒæ­¥"></a>åŒæ­¥</h4><p><strong>äº’æ–¥åŒæ­¥</strong>ï¼šä¹Ÿç§°éé˜»å¡åŒæ­¥ï¼Œæ˜¯æŒ‡è°ƒç”¨è¿”å›ç»“æœå‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œåªæœ‰åœ¨å¾—åˆ°ç»“æœåæ‰ç»§ç»­ï¼Œæ˜¯ä¸€ç§æ‚²è§‚çš„åŒæ­¥ç­–ç•¥ã€‚åœ¨ <strong>iOS</strong> ä¸­ä»¥ä¸»è¦ä»¥äº’æ–¥é”æ–¹å¼ä½“ç°ï¼Œåœ¨è·å–äº’æ–¥é”å¤±è´¥åï¼Œä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…é”è¢«é‡Šæ”¾ä»¥è¢«å”¤é†’ã€‚</p><p><strong>éé˜»å¡åŒæ­¥</strong>ï¼šæ˜¯æŒ‡åœ¨ä¸èƒ½å¾—åˆ°ç»“æœå‰ï¼Œå½“å‰çº¿ç¨‹ä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæ˜¯ä¸€ç§ä¹è§‚çš„åŒæ­¥ç­–ç•¥ã€‚åœ¨ <strong>iOS</strong> ä¸­ä»¥ä¸»è¦ä»¥è‡ªæ—‹é”çš„æ–¹å¼ä½“ç°ï¼Œåœ¨è·å–é”å¤±è´¥åä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯ä¸æ–­å°è¯•è·å–é”ï¼Œé”è¢«é‡Šæ”¾ï¼Œå› ä¸ºä¸æ¶‰åŠçº¿ç¨‹çŠ¶æ€åˆ‡æ¢ï¼Œæ‰€ä»¥æ•ˆç‡é«˜äºäº’æ–¥é”ã€‚</p><p>é™¤äº†é”ä¹‹å¤–è¿˜æœ‰çš„åŒæ­¥å·¥å…·ï¼Œå¦‚ <strong>Atomic Operations</strong>ã€<strong>Memory Barries</strong>ã€<strong>Volatile Variables</strong>ï¼Œä¸‹é¢è¿›è¡Œç®€è¦ä»‹ç»ï¼š</p><ul><li><strong>Atomic Operations</strong>ï¼šåŸå­æ“ä½œæ˜¯ä¸€ç§ç®€å•çš„åŒæ­¥å½¢å¼ï¼Œé€‚ç”¨äºç®€å•çš„æ•°æ®ç»“æ„ï¼Œå®ƒä¸ä¼šé˜»å¡ç«äº‰çº¿ç¨‹ï¼›<strong>OS X</strong> å’Œ <strong>iOS</strong> åŒ…å«äº†è®¸å¤šå¯¹ 32 ä½å’Œ 64 ä½å€¼æ‰§è¡ŒåŸºæœ¬æ•°å­¦å’Œé€»è¾‘è¿ç®—æ“ä½œã€‚å¦‚<code>atomic_fetch_add</code>ã€<code>atomic_exchange</code>ç­‰ï¼Œå…·ä½“å¯<a href="https://en.cppreference.com/w/c/atomic">å‚è€ƒ</a>ã€‚</li><li><strong>Memory Barries</strong>ï¼šåœ¨å•çº¿ç¨‹ä¸­ï¼Œç”±äºç¡¬ä»¶ä¼šæ‰§è¡Œå¿…è¦çš„è®°å½•ï¼Œä»¥ç¡®ä¿ç¨‹åºçš„å†…å­˜æ“ä½œçš„æ‰§è¡Œé¡ºåºå°±åƒä»£ç é¡ºåºä¸€æ ·ï¼›ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œç”±äºç¼–è¯‘å™¨ä¸ºäº†ä¼˜åŒ–ç»å¸¸å¯¹æ±‡ç¼–çº§æŒ‡ä»¤è¿›è¡Œé‡æ’ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´äº§ç”Ÿæ½œåœ¨çš„é”™è¯¯ã€‚å†…å­˜å±éšœæ˜¯ä¸€ç§éé˜»å¡åŒæ­¥å·¥å…·ï¼Œç”¨äºç¡®ä¿å†…å­˜æ“ä½œä»¥æ­£ç¡®é¡ºåºå‘ç”Ÿã€‚ä¾‹å¦‚ï¼š</li></ul><pre><code class="swift">// thread1:while f == 0 {}print(x)// thread2:x = 5f = 1</code></pre><p>å¹¶éæ¯æ¬¡éƒ½æ‰“å°æ•°å­— <strong>5</strong>ï¼Œå¦‚æœ <strong>thread2</strong> ä¹±åºæ‰§è¡Œï¼Œå…ˆæ‰§è¡Œ <code>f = 1</code>ï¼Œåæ‰§è¡Œ <code>x = 5</code>ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°æ„å¤–çš„å€¼ï¼Œå› æ­¤å¼•å…¥äº†å†…å­˜å±éšœï¼Œåœ¨éœ€è¦ç¡®ä¿æ‰§è¡Œé¡ºåºä¸­æ’å…¥ <code>OSMemoryBarrier</code>ï¼Œå…·ä½“å¯<a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSMemoryBarrier.3.html#//apple_ref/doc/man/3/OSMemoryBarrier">å‚è€ƒ</a>ã€‚</p><ul><li><strong>Volatile Variables</strong>ï¼šå£°æ˜ä¸º <strong>volatile</strong> çš„å˜é‡ä¸ä¼šè¢«ä¼˜åŒ–ã€‚ä¾‹å¦‚å˜é‡è¢«ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œè¢«æ”¾ç½®äºå¯„å­˜å™¨ä¸­å¹¶è¯»å–ï¼Œè¿™å°±æœ‰æ½œåœ¨è¯»å–é£é™©ï¼Œè€Œ <strong>volatile</strong> é˜»æ­¢äº†è¿™ç§ä¼˜åŒ–ï¼Œæ¯æ¬¡éƒ½ä¼šä»å†…å­˜ä¸­è¯»å–å˜é‡çš„å½“å‰å€¼ã€‚</li></ul><p>å†…å­˜å±éšœ å’Œ **volatile **å˜é‡éƒ½ä¼šå‡å°‘ç¼–è¯‘å™¨çš„ä¼˜åŒ–æ¬¡æ•°ï¼Œå› æ­¤åªéœ€è¦åœ¨ç¡®ä¿æ­£ç¡®çš„åœ°æ–¹ä½¿ç”¨å®ƒä»¬ã€‚åœ¨ <strong>GCD</strong>ã€ <strong>NSOperation</strong> ä¸­æœ‰ç€è®¸å¤šå†…å­˜å±éšœä»£ç ï¼Œè®©æˆ‘ä»¬èƒ½é‡ä¸Šè¿™ç§æƒ…å†µå¾®ä¹å…¶å¾®ã€‚</p><h2 id="iOS-ä¸­çš„é”"><a href="#iOS-ä¸­çš„é”" class="headerlink" title="iOS ä¸­çš„é”"></a>iOS ä¸­çš„é”</h2><p>åœ¨ <strong>iOS</strong> ä¸­ï¼Œå®ç°çº¿ç¨‹å®‰å…¨ä¸€èˆ¬ä»¥é”æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥ï¼Œä¸‹é¢å¯¹ä¸»è¦çš„å‡ ç§é”è¿›è¡Œç®€è¦ä»‹ç»ä»¥åŠæ€§èƒ½å¯¹æ¯”ã€‚</p><h3 id="synchronized"><a href="#synchronized" class="headerlink" title="@synchronized"></a>@synchronized</h3><pre><code class="objective-c">@synchronized (obj) {    // éœ€è¦åŒæ­¥çš„ä»£ç       NSLog(@"nihao")!}</code></pre><p><strong>@synchronized</strong> æ˜¯ä¸€ä¸ªé€’å½’é”ï¼Œå…¶å®ç°é‡‡ç”¨äº† <strong>recursive_mutex_t</strong> ï¼Œé€’å½’é”å³åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è·å–é”å¤šæ¬¡ï¼Œåªèƒ½ä¼ é€’ä¸€ä¸ª <strong>NSObject</strong> å¯¹è±¡ï¼Œåœ¨ <strong>Swift</strong> ä¸­å°†æ­¤è¯­æ³•ç§»é™¤ï¼Œå°†å…¶è¿˜åŸä¸º <strong>C++</strong> åå¯ä»¥å‘ç°å…¶æºç ç±»ä¼¼å¦‚ä¸‹ï¼š</p><pre><code class="objective-c">objc_sync_enter(_sync_obj);// éœ€åŒæ­¥çš„ä»£ç NSLog(@"nihao")!objc_sync_exit(_sync_obj);</code></pre><p>å› æ­¤åœ¨ <strong>Swift</strong> ä¸­å¯ä»¥åˆ©ç”¨è¿™ä¸¤ä¸ªå‡½æ•°æ¨¡æ‹Ÿå‡º <strong>@synchronized</strong></p><pre><code class="swift">func synchronized(lock: AnyObject, closure: () -&gt; Void) {    objc_sync_enter(lock)    closure()    objc_sync_exit(lock)}</code></pre><h3 id="NSLock-amp-NSRecursiveLock"><a href="#NSLock-amp-NSRecursiveLock" class="headerlink" title="NSLock &amp; NSRecursiveLock"></a>NSLock &amp; NSRecursiveLock</h3><pre><code class="swift">let lock = NSLock()lock.lock()// éœ€åŒæ­¥çš„ä»£ç lock.unlock()let recursiveLock = NSRecursiveLock()recursiveLock.lock()// éœ€åŒæ­¥çš„ä»£ç recursiveLock.unlock()</code></pre><p><strong>NSLock</strong> å’Œ <strong>NSRecursiveLock</strong> åœ¨ä½¿ç”¨ä¸Šä¸€è‡´ï¼Œ<strong>NSLock</strong> æ˜¯ä¸€ä¸ªäº’æ–¥é”ï¼Œè€Œ <strong>NSRecursiveLock</strong> æ˜¯ä¸€ä¸ªé€’å½’é”ï¼Œéƒ½å¯¹ <strong>pthread_mutex</strong> çš„å°è£…ï¼Œåœ¨ä½¿ç”¨åœºæ™¯ä¸­éœ€è€ƒè™‘æ˜¯å¦åœ¨åŒä¸€çº¿ç¨‹ä¸­å¤šæ¬¡åŠ é”ã€‚</p><h3 id="NSCondition-amp-NSConditionLock"><a href="#NSCondition-amp-NSConditionLock" class="headerlink" title="NSCondition &amp; NSConditionLock"></a>NSCondition &amp; NSConditionLock</h3><p><strong>NSCondition</strong> åŸºäº <code>pthread_mutex</code> å®ç°ï¼Œæ˜¯ä¸€ä¸ªæ¡ä»¶é”ï¼Œå…¶å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªé”ä»¥åŠä¸€ä¸ªçº¿ç¨‹æ£€æŸ¥å™¨ï¼šé”ä¸»è¦æ˜¯ä¸ºäº†åŒæ­¥ä¸´ç•ŒåŒºï¼›çº¿ç¨‹æ£€æŸ¥å™¨ä¸»è¦æ˜¯æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦ç»§ç»­è¿è¡Œã€‚</p><ul><li><code>wait()</code>ï¼šè®©å½“å‰çº¿ç¨‹å¤„äºç­‰å¾…ä¸­</li><li><code>singal()</code>ï¼šé€šçŸ¥æŸä¸€ä¸ªçº¿ç¨‹ä»é˜»å¡çŠ¶æ€æ¢å¤åˆ°å°±ç»ªçŠ¶æ€</li><li><code>broadcast()</code>ï¼šé€šçŸ¥å…¶ä»–æ‰€æœ‰çº¿ç¨‹ä»é˜»å¡çŠ¶æ€æ¢å¤åˆ°å°±ç»ªçŠ¶æ€</li></ul><p>æ¯”è¾ƒå¸¸è§çš„ä¾‹å­å¦‚ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼š</p><pre><code class="swift">var condition = NSCondition() // é”var money = 5 // å…±äº«å˜é‡// thread1func consume() {    condition.lock()    while money == 0 {        condition.wait()    }    money -= 1    condition.unlock()}// thread2func product() {    condition.lock()    money += 1    condition.wait()    condition.unlock()}</code></pre><p><strong>NSConditionLock</strong> å®šä¹‰äº†ä¸€ä¸ªäº’æ–¥é”ï¼Œå¯ä»¥ç”¨äºç‰¹å®šçš„å€¼é”å®šä¸è§£å†³ã€‚å…¶ä¸ <strong>NSCondition</strong> çš„è¡Œä¸ºæœ‰äº›ç±»ä¼¼ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥è½¬æ¢ä¸ºï¼š</p><pre><code class="swift">var condition = NSConditionLock(condition: 0)var money = 0// 0è¡¨ç¤ºæ— æ•°æ® 1è¡¨ç¤ºæœ‰æ•°æ®func consume() {    condition.lock(whenCondition: 1)    money -= 1    condition.unlock(withCondition: money == 0 ? 0 : 1) }func product() {    condition.lock()    money += 1    condition.unlock(withCondition: 1)}</code></pre><h3 id="NSDistrubutedLock"><a href="#NSDistrubutedLock" class="headerlink" title="NSDistrubutedLock"></a>NSDistrubutedLock</h3><p><strong>NSDistrubutedLock</strong> æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼Œé€šå¸¸åœ¨å¤šä¸ªä¸»æœºä¸Šçš„å¤šä¸ªåº”ç”¨ç¨‹åºç”¨æ¥é™åˆ¶å¯¹æŸäº›å…±äº«èµ„æºçš„è®¿é—®ï¼Œæ¯”å¦‚æ–‡ä»¶ï¼Œå®ƒç”±æ–‡ä»¶ç³»ç»Ÿé¡¹(ä¾‹å¦‚æ–‡ä»¶æˆ–ç›®å½•)å®ç°ï¼Œä¸è¿‡ç”±äº <strong>iOS</strong> åº”ç”¨çš„æ²™ç›’æœºåˆ¶ï¼Œå¹¶æœªæœ‰ç›¸åº” <strong>API</strong>ï¼Œåœ¨ <strong>OS X</strong> ä¸­å¯ä»¥ä½¿ç”¨ã€‚</p><h3 id="DispatchSemaphore"><a href="#DispatchSemaphore" class="headerlink" title="DispatchSemaphore"></a>DispatchSemaphore</h3><p>ä¸Šæ–‡æœ‰å¯¹ <strong>DispatchSemaphore</strong> åšä»‹ç»ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°ã€‚</p><h3 id="OSSpinLock"><a href="#OSSpinLock" class="headerlink" title="OSSpinLock"></a>OSSpinLock</h3><p><strong>OSSpinLock</strong> æ˜¯è‡ªé€‰é”ï¼Œä½†ç”±äº <strong>iOS</strong> ç³»ç»Ÿä¸­çº¿ç¨‹å¯ä»¥æ‹¥æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œå¯èƒ½ä¼šäº§ç”Ÿä¼˜å…ˆçº§åè½¬é—®é¢˜ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹è·å¾—é”å¹¶è®¿é—®å…±äº«èµ„æºï¼Œæ­¤æ—¶é«˜ä¼˜å…ˆçº§çº¿ç¨‹ä¹Ÿå°è¯•è·å–ï¼Œç”±äº <strong>OSSpinLock</strong> æ˜¯è‡ªé€‰é”ï¼Œå®ƒä¼šè¿›å…¥å¿™ç­‰çŠ¶æ€å¹¶å ç”¨å¤§é‡ <strong>CPU</strong>ï¼Œè¿›è€Œå¯¼è‡´ä½ä¼˜å…ˆçº§çº¿ç¨‹æ— æ³•ä¸é«˜ä¼˜å…ˆçº§çº¿ç¨‹æŠ¢å  <strong>CPU</strong>ï¼Œè¿›è€Œå¯¼è‡´ä»»åŠ¡è¿Ÿè¿Ÿæ— æ³•å®Œæˆã€æ— æ³•é‡Šæ”¾ <strong>lock</strong>ï¼Œå› æ­¤ <strong>OSSpinLock</strong> å·²ç»è¢«å¼ƒç”¨äº†ï¼Œä½¿ç”¨ <strong>os_unfair_lock</strong> ä»£æ›¿ï¼Œè¿™ä¹Ÿæ˜¯ä¸ªäº’æ–¥é”ã€‚</p><pre><code class="objective-c">OSSpinLockLock(&amp;spinlock) // è·å–é”ï¼Œçº¿ç¨‹ä¸€ç›´å¿™ç­‰å¾…ã€‚é˜»å¡å½“å‰çº¿ç¨‹æ‰§è¡Œã€‚OSSpinLockTry(&amp;spinlock) // å°è¯•è·å–é”ï¼Œè¿”å›boolã€‚å½“å‰çº¿ç¨‹é”å¤±è´¥ï¼Œä¹Ÿå¯ä»¥ç»§ç»­å…¶å®ƒä»»åŠ¡ï¼Œä¸é˜»å¡å½“å‰çº¿ç¨‹ã€‚OSSpinLockUnlock(&amp;spinlock) // è§£é”ï¼Œå‚æ•°æ˜¯OSSpinLockåœ°å€ã€‚</code></pre><h3 id="atomic"><a href="#atomic" class="headerlink" title="atomic"></a>atomic</h3><p><strong>Objective-C</strong> ä¸­å±æ€§ä¸­çš„å…³é”®å­—ï¼Œä¼šå¯¹å±æ€§çš„å­˜å€¼ä¸å–å€¼è¿›è¡ŒåŠ é”å¤„ç†ã€‚å®ƒæ˜¯åŸºäº<code>os_unfair_lock</code>è¿›è¡Œå®ç°ï¼Œä¸Šæ–‡æåˆ°è¿‡ï¼Œè¿™æ˜¯ä¸€ä¸ªäº’æ–¥é”ï¼Œå®ƒä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåªèƒ½ä¿è¯å­˜å–å€¼çš„å®‰å…¨æ€§ã€‚</p><h3 id="å„ç§é”çš„æ€§èƒ½æ¯”è¾ƒ"><a href="#å„ç§é”çš„æ€§èƒ½æ¯”è¾ƒ" class="headerlink" title="å„ç§é”çš„æ€§èƒ½æ¯”è¾ƒ"></a>å„ç§é”çš„æ€§èƒ½æ¯”è¾ƒ</h3><p>å›¾ç‰‡æˆªå–è‡ª <a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/#more-41952">ä¸å†å®‰å…¨çš„ OSSpinLock</a>ï¼Œåšä¸€ä¸ªå°çš„æ¨æµ‹ï¼š</p><p>å…ˆè®¨è®ºé”ï¼Œç„¶åå†åˆ†æä¿¡å·é‡ã€‚</p><p><strong>OSSpinLock</strong> ç”±äºè‡ªé€‰é”çš„ç‰¹æ€§ä¸ä¼šçº¿ç¨‹çŠ¶æ€åˆ‡æ¢å› æ­¤æ’åœ¨ç¬¬ä¸€ï¼›</p><p>ä¹‹åçš„é”éƒ½æ˜¯åŸºäº <strong>POSIX thread</strong> çš„ç›¸å…³çº¿ç¨‹ <strong>API</strong>è¿›è¡Œå°è£…ï¼Œæ€§èƒ½æ ¹æ®å°è£…å¼ºåº¦ä¸åŒè€Œæœ‰æ‰€ä¸åŒï¼Œæ¯”å¦‚äº’æ–¥é”æ€§èƒ½å¥½äºé€’å½’é”ï¼ŒåŒæ—¶ä¹Ÿå¥½äºæ¡ä»¶é”ï¼›</p><p>ä¿¡å·é‡å…¶å®ä¸é”ç±»ä¼¼ï¼Œä½†<code>pthread_mutex</code>æ”¯æŒå¤šç§ç±»å‹ï¼Œå› æ­¤ä¼šæœ‰é¢å¤–çš„åˆ¤æ–­ï¼Œå°±é€ æˆäº†æ•ˆç‡ç•¥ä½åŸå› ã€‚</p><p>ä½†è¿™äº›é”è™½æ€§èƒ½æœ‰æ‰€å·®å¼‚ï¼Œä½†éƒ½å·®è·ä¸å¤§ï¼Œåœ¨ç¼–ç è¿‡ç¨‹ä¸­è¿˜å› è€ƒè™‘å…·ä½“çš„åœºæ™¯å’Œä»£ç å¥å£®æ€§ç­‰æ–¹é¢ã€‚</p><img src="/images/blog/lock_benchmark.png" alt="lock_benchmark" style="zoom:75%;"><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡å°± <strong>iOS</strong> ä¸­å¤šçº¿ç¨‹è¿™ä¸€ç‚¹ï¼Œæ¦‚è¿°äº† <strong>NSThread</strong>ã€<strong>GCD</strong>ã€<strong>NSOperation</strong> è¿™ä¸‰ç§å¤šçº¿ç¨‹ä½¿ç”¨è¯´æ˜å’Œå®ƒä»¬çš„ç‰¹ç‚¹ï¼Œä»¥åŠå…³äºçº¿ç¨‹å®‰å…¨ä»‹ç»äº†ä¸€äº›åŒæ­¥æ‰‹æ®µå’Œå…³äºé”çš„ä¸€äº›ä½¿ç”¨ã€‚å°±æœ¬äººè€Œè¨€ï¼Œåœ¨å¹³æ—¶å·¥ä½œä¸­ä½¿ç”¨ <strong>GCD</strong> è¾ƒå¤šï¼Œå®ƒæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œåº”è¯¥æ›´å¤šçš„å…³æ³¨å®ƒï¼ŒåŒæ—¶å…³äºå®ƒä»¬çš„æºç ï¼Œç¬”è€…ç”±äºæ°´å¹³æœ‰é™ï¼Œä¸èƒ½åšå‡ºè¾ƒä¸ºæœ‰ç†è§£çš„çœ‹æ³•ï¼Œå°±ä¸åšè¿‡å¤šæ¢è®¨ï¼Œå¸Œæœ›åœ¨åç»­è¿‡ç¨‹ä¸­èƒ½å¤ŸåŠ å¼ºè¿™æ–¹é¢çš„å­¦ä¹ ã€‚</p><h2 id="ğŸ”—"><a href="#ğŸ”—" class="headerlink" title="ğŸ”—"></a>ğŸ”—</h2><ul><li><p>ã€Š<strong>Objective-C</strong> é«˜çº§ç¼–ç¨‹ - <strong>iOS</strong> ä¸ <strong>OS X</strong> å¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹</p></li><li><p><a href="https://ming1016.github.io/2016/01/13/how-to-use-gcd/">ç»†è¯´GCD(Grand Central Dispatch)</a></p></li><li><p><a href="http://yulingtianxia.com/blog/2015/11/01/More-than-you-want-to-know-about-synchronized/">å…³äº @synchronizedï¼Œè¿™å„¿æ¯”ä½ æƒ³çŸ¥é“çš„è¿˜å¤š</a></p></li><li><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/ThreadSafety/ThreadSafety.html#//apple_ref/doc/uid/10000057i-CH8-SW1">Threading Programming Guide</a></p></li><li><p><a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/#more-41952">ä¸å†å®‰å…¨çš„ OSSpinLock</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
            <tag> GCD </tag>
            
            <tag> é” </tag>
            
            <tag> NSThread </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Swift å†…å­˜æ¨¡å‹ä¸æ–¹æ³•è°ƒåº¦</title>
      <link href="/2022/03/13/SwiftMemoryLayoutMethodDispatch/"/>
      <url>/2022/03/13/SwiftMemoryLayoutMethodDispatch/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡ä»å†…å­˜åˆ†åŒºã€å†…å­˜å¯¹é½ã€å†…å­˜æ¨¡å‹ä¸æ–¹æ³•æ´¾å‘è§’åº¦ä»‹ç»äº†å…³äº Swift ä¸­çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚</p><span id="more"></span><h2 id="å†…å­˜åˆ†åŒº"><a href="#å†…å­˜åˆ†åŒº" class="headerlink" title="å†…å­˜åˆ†åŒº"></a>å†…å­˜åˆ†åŒº</h2><p>iOS åº”ç”¨å†…å­˜åˆ†ä¸º 5 ä¸ªåŒºåŸŸï¼Œå…¶ä¸­â€œå…¨å±€åŒºâ€ã€â€œå¸¸é‡åŒºâ€ å’Œ â€œä»£ç åŒºâ€çš„å†…å­˜ç©ºé—´åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œâ€œæ ˆâ€ã€â€œå †â€çš„å†…å­˜ç©ºé—´åœ¨è¿è¡Œæ—¶ç¡®å®šã€‚</p><p><img src="/images/blog/iOS%E5%BA%94%E7%94%A8%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA.png" alt="iOSåº”ç”¨å†…å­˜åˆ†åŒº"></p><ul><li>æ ˆåŒºï¼šå­˜å‚¨å€¼ç±»å‹çš„å±€éƒ¨å˜é‡ï¼Œå‡½æ•°å‚æ•°ï¼Œå…¶å¤§å°æœ‰é™ï¼Œè¿ç»­åˆ†é…ï¼Œå‘ä½åœ°å€æ‹“å±•ï¼›ç”±åœ¨è¿è¡Œæ—¶ç³»ç»Ÿè‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰å…¶å¯¹åº”çš„æ ˆã€‚</li><li>å †åŒºï¼šå­˜å‚¨å¼•ç”¨ç±»å‹ï¼Œä¸è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œå‘é«˜åœ°å€æ‹“å±•ï¼Œå¤§å°å—é™äºç³»ç»Ÿä¸­çš„è™šæ‹Ÿå†…å­˜ï¼›ç”±ç¨‹åºå‘˜åŠ¨æ€åˆ›å»ºå’Œé‡Šæ”¾å¯¹è±¡ï¼Œåœ¨è¿è¡Œæ—¶åˆ†é…ã€‚</li><li>å…¨å±€/é™æ€åŒºï¼šå­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œå³ .bss ï¼›å’Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œå³ .dataã€‚</li><li>å¸¸é‡åŒºï¼šå­˜å‚¨å­—ç¬¦ä¸²å¸¸é‡</li><li>ä»£ç åŒºï¼šå­˜å‚¨ç¨‹åºè¿è¡Œæ—¶çš„ä»£ç </li></ul><h2 id="å†…å­˜å¯¹é½"><a href="#å†…å­˜å¯¹é½" class="headerlink" title="å†…å­˜å¯¹é½"></a>å†…å­˜å¯¹é½</h2><p><strong>ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜å¯¹é½ï¼š</strong></p><ol><li>æŸäº›ç¡¬ä»¶ä¸èƒ½éšæ„è®¿é—®ä»»æ„åœ°å€</li><li>æé«˜è®¿é—®æ•ˆç‡</li></ol><p><strong>å†…å­˜å¯¹é½åŸåˆ™ï¼š</strong></p><ol><li>ç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜çš„<strong>åç§»é‡ï¼ˆoffsetï¼‰</strong>ä¸º0ï¼Œä»¥åæ¯ä¸ªæˆå‘˜ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„ <strong>offset</strong> éƒ½æ˜¯<strong>è¯¥æˆå‘˜å¤§å°ä¸å¯¹é½ç³»æ•°ä¸­è¾ƒå°å€¼</strong>çš„æ•´æ•°å€ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æˆå‘˜ä¹‹é—´åŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</li><li><strong>ç»“æ„ä½“çš„æ€»å¤§å°</strong>ä¸ºå¯¹é½ç³»æ•°çš„<strong>æ•´æ•°å€</strong>ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æœ€æœ«ä¸€ä¸ªæˆå‘˜ä¹‹ååŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</li></ol><p>æ³¨ï¼šç»“æ„ä½“å¯ä»£æ›¿ä¸º <strong>class</strong>ã€<strong>protocol</strong>ç­‰ä»»æ„ç±»å‹ï¼Œåªæ˜¯å…¶ä»–ç±»å‹å†…å­˜åˆ†å¸ƒä¸ç»“æ„ä½“ä¸åŒã€‚</p><p>åœ¨ <strong>Swift</strong> ä¸­ï¼š</p><pre><code class="Swift">MemoryLayout&lt;T&gt;.size // å±æ€§å ç”¨å¤§å°(ä¸å…¶å±æ€§åŒ¹é…)MemoryLayout&lt;T&gt;.stride // å®é™…å ç”¨å¤§å°MemoryLayout&lt;T&gt;.alignment // å¯¹é½ç³»æ•°</code></pre><h2 id="å†…å­˜æ¨¡å‹"><a href="#å†…å­˜æ¨¡å‹" class="headerlink" title="å†…å­˜æ¨¡å‹"></a>å†…å­˜æ¨¡å‹</h2><h3 id="struct"><a href="#struct" class="headerlink" title="struct"></a><strong>struct</strong></h3><p>ä¾‹ï¼š</p><pre><code class="swift">struct Foo {    let a: Int8 = 2   // 1 byte    let b: Int16 = 4  // 2 bytes    let c: Int32 = 6  // 4 bytes    let d: Int = 8    // 8 bytes        func foo() {        print("Hello")    }}let foo = Foo()print(MemoryLayout&lt;Foo&gt;.size)print("===end===")</code></pre><img src="/images/blog/æˆªå±2021-12-26 10.27.40.png" alt="image-20211226103015351" style="zoom: 67%;"><p>å¯ä»¥çœ‹å‡ºï¼Œ<strong>struct</strong> çš„å†…å­˜æ˜¯è¿ç»­åˆ†å¸ƒçš„ï¼Œä½†æ˜¯ç”±äº<strong>å†…å­˜å¯¹é½åŸåˆ™</strong>ï¼Œå±æ€§ <strong>a</strong> æ‰€å ç”¨å†…å­˜ç©ºé—´ä¸º <strong>2 byte</strong>ï¼Œå¯¹äºå®ä¾‹æ–¹æ³•å…¶å†…éƒ¨å¹¶ä¸ä¼šåšå­˜å‚¨ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘åç›´æ¥æŒ‡å‘æ–¹æ³•çš„åœ°å€ã€‚</p><h3 id="class"><a href="#class" class="headerlink" title="class"></a><strong>class</strong></h3><p><strong>Swift</strong> ä¸ <strong>Objective-C</strong> ä¸­çš„ <strong>Class</strong> ç±»å‹ï¼Œä¸ºäº†å…¼å®¹ <strong>Objective-C</strong> ä¸”å…·æœ‰æ›´å¤šçš„ <strong>Swift</strong> ç‰¹æ€§ï¼Œåœ¨ <strong>Swift</strong> æºç ä¸­ï¼Œå…¶ç±»å‹ä¸º <code>swift_class_t</code> çš„ç»“æ„ä½“ï¼Œç»§æ‰¿äº <code>objc_class</code>ã€‚å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/images/blog/image-20220313210720322-7176842.png" alt="image-20220313210720322"></p><p><strong>isa</strong>ï¼šä¸ <strong>Objective-C</strong> ä¸­ <strong>isa</strong> ä¸€æ ·ï¼ŒåŒ…å«äº†è¿™ä¸ªç±»å‹çš„ä¿¡æ¯ï¼Œå¦‚ çˆ¶ç±»çš„ <strong>isa</strong> ä¿¡æ¯ã€æ˜¯å¦å­˜åœ¨å…³è”å¯¹è±¡ã€ä»¥åŠ <strong>virtual table</strong> ç”¨ä»¥æ–¹æ³•è°ƒç”¨ç­‰å†…å®¹ã€‚</p><p><strong>retain count</strong>ï¼šè®°å½•å…¶å¼•ç”¨è®¡æ•°å€¼</p><h3 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a><strong>protocol</strong></h3><p>çœ‹ä¸‹é¢æºç </p><pre><code class="swift">protocol Drawable { func draw() }struct Point : Drawable {    var x: Int    var y: Int    func draw() { print("Point") }}struct Line : Drawable {    var x1, y1, x2, y2: Int    func draw() { print("Line") }}class Cricle: Drawable {    var r: Int = 5    func draw() { print("SharedLine") }}struct Simple {    var drawable1: Drawable    var drawable2: Drawable    var drawable3: Drawable    func printMemoryLayout() {        MemoryLayout.size(ofValue: drawable1)        MemoryLayout.size(ofValue: drawable2)        MemoryLayout.size(ofValue: drawable3)    }}</code></pre><p>é¦–å…ˆåœ¨ <strong>Build Setting</strong> ä¸­ï¼Œå°† <strong>Reflection Metadata Level</strong> æ”¹ä¸º <strong>None</strong>ï¼Œè°ƒç”¨ <code>printMemoryLayout</code> å†è¿›è¡Œè°ƒè¯•ã€‚</p><pre><code>404040</code></pre><p><img src="/images/blog/image-20220313200904959-7173347.png" alt="image-20220313200904959"></p><p><strong>Reflection Metadata Level</strong> æ”¹ä¸º <strong>None</strong>ï¼Œæ˜¯é˜²æ­¢ç¼–è¯‘å™¨å°†åå°„å…ƒæ•°æ®å‘é€åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œä¼šå¯¹åˆ†æé€ æˆå¹²æ‰°ã€‚</p><p>å¯¹äºåè®®ç±»å‹æ¥è¯´ï¼Œä¸ºäº†å®ç°è¯­ä¹‰ä¸Šçš„å¤šæ€ï¼Œä¸”åˆ›å»ºæ—¶å…¶å†…å­˜å¤§å°æ˜¯ä¸å›ºå®šçš„ï¼Œå› æ­¤å¼•å…¥äº†æ–°çš„å†…å­˜ç»“æ„è¿›è¡Œå¤„ç†ã€‚</p><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºå†…å­˜å ç”¨å¤§å°å…¨éƒ¨ä¸º 40ï¼Œä¸”éƒ½æ‹¥æœ‰ç›¸åŒçš„æ•°æ®ç»“æ„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/images/blog/image-20220311002137424-6929301.png" alt="image-20220311002137424"></p><p><strong>valueBuffer</strong>ï¼š3ä½ï¼Œå¯¹äºç©ºé—´å°äºæˆ–ç­‰äº <strong>valueBuffer</strong> çš„å€¼ï¼Œç›´æ¥å­˜å‚¨åœ¨ <strong>valueBuffer</strong> ä¸­ï¼›å¯¹äºç©ºé—´å¤§äº valueBufferçš„å€¼ï¼Œåˆ™ä¼šåœ¨å †ä¸­å¼€è¾Ÿå†…å­˜ç©ºé—´ï¼Œ<strong>valueBuffer</strong> åˆ™å­˜å‚¨å…¶å¼•ç”¨åœ°å€ã€‚å¯¹åº” <code>drawable1</code> ä¸ <code>drawable2</code>ã€‚</p><p><strong>value witness table</strong>ï¼šç”±äºæ¯ä¸ªåè®®ç±»å‹çš„åˆå§‹åŒ–ä¸å°½ç›¸åŒï¼Œæ‰€ä»¥æ¯ä¸€ç§ç±»å‹(ä¸Šä¸Šå›¾çš„ <strong>metadata</strong> )éƒ½ä¼šæœ‰ä¸€ä¸ª <strong>value witness table</strong>ï¼Œç”¨äºè¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæœ‰ <code>alloc</code>ã€<code>copy</code>ã€<code>destruct</code>ã€<code>deallocate</code> ç­‰æ–¹æ³•ã€‚</p><p><strong>protocol witness table</strong>ï¼šç±»ä¼¼äº <strong>class</strong> çš„ <strong>virtual table</strong>ï¼Œç”¨ä»¥å­˜å‚¨æ¯ä¸ªåè®®ç±»å‹çš„æ–¹æ³•ã€‚æ¯ç§ç±»å‹ä¼šåˆ›é€  <code>PWT</code> è¡¨ï¼Œå†…éƒ¨åŒ…å«æŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•å…·ä½“å®ç°ã€‚</p><h2 id="æ–¹æ³•æ´¾å‘"><a href="#æ–¹æ³•æ´¾å‘" class="headerlink" title="æ–¹æ³•æ´¾å‘"></a>æ–¹æ³•æ´¾å‘</h2><p>æ–¹æ³•æ´¾å‘æ˜¯æŒ‡å‘Šè¯‰ <strong>CPU</strong> å¦‚ä½•å»æ‰¾åˆ°è¯¥å‡½æ•°åœ°å€å¹¶è¿›è¡Œè°ƒç”¨çš„è¿‡ç¨‹ï¼Œåœ¨ <strong>Swift</strong> ä¸­åˆ†ä¸º 3 ç§æ´¾å‘æœºåˆ¶ï¼Œåˆ†åˆ«æ˜¯é™æ€æ´¾å‘ã€å‡½æ•°è¡¨æ´¾å‘ä¸åŠ¨æ€æ´¾å‘ã€‚é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šæ˜¯ä»€ä¹ˆæ ·çš„æ–¹æ³•æ´¾å‘å‘¢ï¼Ÿä¸»è¦æœ‰ä¸¤æ–¹é¢çº¬åº¦çš„è€ƒé‡ï¼š</p><h3 id="å£°æ˜ç±»å‹"><a href="#å£°æ˜ç±»å‹" class="headerlink" title="å£°æ˜ç±»å‹"></a>å£°æ˜ç±»å‹</h3><p>å¯¹äºä¸åŒçš„å£°æ˜ä½ç½®æ¥è¯´ï¼Œå…¶æ–¹æ³•æ´¾å‘çš„æ˜¯ä¸åŒçš„ï¼Œè‹¥ä¸‹å›¾æ‰€ç¤ºï¼š</p><table><thead><tr><th></th><th>ç±»ä¸­å£°æ˜</th><th>æ‹“å±•å£°æ˜</th></tr></thead><tbody><tr><td>value type</td><td>static</td><td>static</td></tr><tr><td>protocol</td><td>table</td><td>static</td></tr><tr><td>class</td><td>table</td><td>static</td></tr><tr><td>NSObject SubClass</td><td>table</td><td>message</td></tr></tbody></table><p><strong>è§„å¾‹ï¼š</strong></p><p>å€¼ç±»å‹éƒ½æ˜¯é™æ€æ´¾å‘</p><p>åè®®å’Œç±»ä¸­çš„æ‹“å±•éƒ½æ˜¯é™æ€æ´¾å‘</p><p><strong>NSObject</strong> æ‹“å±•é‡‡ç”¨æ¶ˆæ¯æ´¾å‘ï¼Œç±»ä¸­å£°æ˜é‡‡ç”¨å‡½æ•°è¡¨æ´¾å‘</p><p>åè®®ä¸­é»˜è®¤å®ç°ä½¿ç”¨å‡½æ•°è¡¨æ´¾å‘</p><h3 id="å…³é”®å­—"><a href="#å…³é”®å­—" class="headerlink" title="å…³é”®å­—"></a>å…³é”®å­—</h3><p>å¯¹äºæŸäº›å…³é”®å­—æ¥è¯´ï¼Œä¹Ÿèƒ½å¤Ÿæ”¹å˜å…¶æ´¾å‘æ–¹å¼ï¼š</p><table><thead><tr><th>å…³é”®å­—</th><th>æ´¾å‘æ–¹å¼</th></tr></thead><tbody><tr><td>final</td><td>static</td></tr><tr><td>dynamic</td><td>Message</td></tr><tr><td>@objc &amp; @nonobjc</td><td>ä¿®æ”¹ Objective-C å¯è§æ€§</td></tr><tr><td>@inline</td><td>Static</td></tr></tbody></table><p><strong>è§„å¾‹ï¼š</strong></p><p>final - é™æ€æ´¾å‘</p><p>dynamic - æ¶ˆæ¯æ´¾å‘</p><p>@objc &amp; @nonobjc - å£°æ˜å‡½æ•°èƒ½å¦è¢« objective-c runtimeæ•æ‰åˆ°</p><p>final @objc - è°ƒç”¨æ—¶é™æ€æ´¾å‘ï¼Œä½†ä¼šå°†å‡½æ•°æ³¨å†Œåˆ° objective-c runtimeä¸­</p><p>@inline - ç›´æ¥æ´¾å‘ï¼Œä½†å¦‚æœæ˜¯ dynamic @inlineï¼Œåˆ™ä¼šé‡‡ç”¨æ¶ˆæ¯æ´¾å‘</p><p>ç»“åˆä¸Šä¸¤å›¾æ€»ç»“å¦‚ä¸‹ï¼š</p><table><thead><tr><th></th><th>ç›´æ¥æ´¾å‘</th><th>å‡½æ•°è¡¨æ´¾å‘</th><th>æ¶ˆæ¯æ´¾å‘</th></tr></thead><tbody><tr><td>NSObject</td><td>@nonobjc / final</td><td>ç±»ä¸­å£°æ˜</td><td>æ‹“å±•ç”³æ˜ ä¸” dynamic</td></tr><tr><td>class</td><td>æ‹“å±•å£°æ˜ ä¸” final</td><td>ç±»ä¸­å£°æ˜</td><td>dynamic</td></tr><tr><td>protocol</td><td>æ‹“å±•å£°æ˜</td><td>ç±»ä¸­å£°æ˜</td><td>@objc</td></tr><tr><td>value type</td><td>æ‰€æœ‰æ–¹æ³•</td><td>æ— </td><td>æ— </td></tr></tbody></table><h3 id="é™æ€æ´¾å‘ï¼š"><a href="#é™æ€æ´¾å‘ï¼š" class="headerlink" title="é™æ€æ´¾å‘ï¼š"></a><strong>é™æ€æ´¾å‘</strong>ï¼š</h3><p>æŒ‡ç¼–è¯‘æ—¶ç›´æ¥è·³è½¬åˆ°å‡½æ•°çš„åœ°å€ï¼Œè°ƒç”¨é€Ÿåº¦æœ€å¿«ï¼ŒåŒæ—¶å¯èƒ½ç»è¿‡ç¼–è¯‘å™¨ä¼˜åŒ–æˆ <strong>inline</strong>ã€‚</p><p>åœ¨ <strong>Swift</strong> ä¸­ï¼Œå€¼ç±»å‹çš„æ–¹æ³•è°ƒç”¨ä¸ <strong>final</strong> ä¿®é¥°çš„æ˜¯é™æ€æ´¾å‘ã€‚ï¼ˆå€¼ç±»å‹ä¸ <strong>final</strong> ä¸æ”¯æŒç»§æ‰¿ä¸ <strong>override</strong>ï¼‰</p><h3 id="å‡½æ•°è¡¨æ´¾å‘ï¼š"><a href="#å‡½æ•°è¡¨æ´¾å‘ï¼š" class="headerlink" title="å‡½æ•°è¡¨æ´¾å‘ï¼š"></a><strong>å‡½æ•°è¡¨æ´¾å‘ï¼š</strong></h3><p>ä¸ºåœ¨ç±»ä¸­ç”³æ˜è¿‡çš„æ‰€æœ‰æ–¹æ³•ç”Ÿæˆä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„</p><p><strong>virtual table / protocol witness table</strong></p><img src="/images/blog/1_4YaI2HPK48IqgyK3DpU_VQ.png" alt="A diagram showing the memory offsets for method1, method2, and method3 in ParentClass and ChildClass." style="zoom:80%;"><p>ç›¸è¾ƒäºé™æ€æ´¾å‘ï¼Œé€Ÿåº¦æ›´æ…¢ï¼Œéœ€è¦ä¸¤æ¬¡è¯»å–åœ°å€ä¸ä¸€æ¬¡è·³è½¬ï¼ŒåŒæ—¶ç¼–è¯‘å™¨æ— ä¼˜åŒ–æ“ä½œï¼Œå°†è‡ªèº«ä½œä¸ºå®ä¾‹ä½œä¸ºéšå«å‚æ•°ä¼ é€’åˆ°æ–¹æ³•ä¸­ã€‚ä¾‹å¦‚ä¸‹é¢ä¸€æ®µåè®®ç±»å‹çš„æ–¹æ³•è°ƒç”¨çš„ <strong>SIL</strong> ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="swift">// drawACopy(drawables:)sil hidden @$s14ViewController9drawACopy9drawablesyAA8Drawable_p_tF : $@convention(thin) (@in_guaranteed Drawable) -&gt; () {// %0 "drawables"                                 // users: %2, %1bb0(%0 : $*Drawable):  debug_value_addr %0 : $*Drawable, let, name "drawables", argno 1 // id: %1  %2 = open_existential_addr immutable_access %0 : $*Drawable to $*@opened("F57086CE-A07E-11EC-86EE-ACDE48001122") Drawable // users: %4, %4, %3  %3 = witness_method $@opened("F57086CE-A07E-11EC-86EE-ACDE48001122") Drawable, #Drawable.draw : &lt;Self where Self : Drawable&gt; (Self) -&gt; () -&gt; (), %2 : $*@opened("F57086CE-A07E-11EC-86EE-ACDE48001122") Drawable : $@convention(witness_method: Drawable) &lt;Ï„_0_0 where Ï„_0_0 : Drawable&gt; (@in_guaranteed Ï„_0_0) -&gt; () // type-defs: %2; user: %4  %4 = apply %3&lt;@opened("F57086CE-A07E-11EC-86EE-ACDE48001122") Drawable&gt;(%2) : $@convention(witness_method: Drawable) &lt;Ï„_0_0 where Ï„_0_0 : Drawable&gt; (@in_guaranteed Ï„_0_0) -&gt; () // type-defs: %2  %5 = tuple ()                                   // user: %6  return %5 : $()                                 // id: %6} // end sil function '$s14ViewController9drawACopy9drawablesyAA8Drawable_p_tF'</code></pre><p>å¯ä»¥çœ‹åˆ°å¯¹äºåè®®ç±»å‹ï¼Œä¼šé€šè¿‡ <code>open_existential_addr</code> åˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡ <code>%2</code>ï¼Œåœ¨é€šè¿‡ <code>%2</code> æ‰¾åˆ°å…¶å¯¹åº”<code>witness_method</code> - <code>%3</code>ï¼Œæœ€åå†é€šè¿‡ <code>%2</code> ä¸ä½œä¸ºå…¥å‚æ‰§è¡Œæ–¹æ³• ï¼ˆ<code>apply</code>ï¼‰ <code>%3</code>ã€‚</p><h3 id="åŠ¨æ€æ´¾å‘ï¼š"><a href="#åŠ¨æ€æ´¾å‘ï¼š" class="headerlink" title="åŠ¨æ€æ´¾å‘ï¼š"></a>åŠ¨æ€æ´¾å‘ï¼š</h3><p>ä¸ <strong>Objective-C</strong> ä¸€è‡´ï¼Œä¼šè¢«ç¿»è¯‘æˆ <strong>objc_send</strong> è¿™æ ·çš„ä»£ç ï¼Œä¼šç»è¿‡ <strong>cache</strong> æŸ¥æ‰¾ã€é€šè¿‡ <strong>isa</strong> æŒ‡é’ˆåœ¨å½“å‰ç±»ä¸çˆ¶ç±»çš„ <strong>method_list</strong> æŸ¥æ‰¾ã€æœ€ååˆ°æ¶ˆæ¯è½¬å‘æµç¨‹ã€‚åŠ¨æ€æ´¾å‘çš„é€Ÿåº¦æœ€æ…¢ï¼Œä½†å¯åŠŸèƒ½æ€§æœ€å¼ºã€‚</p><p>ç½‘ä¸Šå…³äºåŠ¨æ€æ´¾å‘çš„æ–‡ç« å¾ˆå¤šï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œè¯¦æƒ…å‚è€ƒï¼š<a href="https://juejin.cn/post/6844903575437606920#heading-6">iOS æ¶ˆæ¯å‘é€ä¸è½¬å‘è¯¦è§£</a></p><h2 id="ğŸ”—"><a href="#ğŸ”—" class="headerlink" title="ğŸ”—"></a>ğŸ”—</h2><p><a href="https://www.jianshu.com/p/e5a54813b93d">iOS-åº•å±‚åŸç† 24: å†…å­˜5å¤§åŒº</a></p><p><a href="https://swiftunboxed.com/internals/size-stride-alignment/">Size, Stride, Alignment</a></p><p><a href="https://github.com/LeoMobileDeveloper/Blogs/blob/master/Swift/Method%20Dispatch%20and%20Memory%20Layout.md#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D">Swift æ–¹æ³•è°ƒåº¦ä¸å†…å­˜å¸ƒå±€</a></p><p><a href="https://zhuanlan.zhihu.com/p/35696161">Swift ä¸­çš„æ–¹æ³•è°ƒç”¨ï¼ˆMethod Dispatchï¼‰ï¼ˆä¸€ï¼‰ - æ¦‚è¿°</a></p><p><a href="https://juejin.cn/post/6968799729853399053#note3">[è¯‘] Swift ä¸­çš„æ–¹æ³•æ´¾å‘</a></p><p><a href="https://www.rightpoint.com/rplabs/switch-method-dispatch-table">switch-method-dispatch-table</a></p><p><a href="https://academy.realm.io/posts/goto-mike-ash-exploring-swift-memory-layout/">Exploring Swift Memory Layout</a></p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Swift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS å¯åŠ¨ä¼˜åŒ–</title>
      <link href="/2022/03/07/iOS%20%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/"/>
      <url>/2022/03/07/iOS%20%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¯åŠ¨æ—¶é—´å¾€å¾€æ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹ APP çš„ç¬¬ä¸€å½±å“ï¼Œå¦‚ä½•ä¼˜åŒ–å¯åŠ¨æ—¶é—´ä¸€ç›´éƒ½æ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ã€‚æœ¬æ–‡ç»“åˆäº† WWDC16ã€WWDC17ä¸WWDC19çš„ç›¸å…³ Session ä¸å€Ÿé‰´è€å¸æœºçš„åšå®¢ï¼Œæ¢³ç†äº†å¯åŠ¨é˜¶æ®µã€dyldå˜åŒ–ã€Mach-Oã€è™šæ‹Ÿå†…å­˜ç­‰å†…å®¹ï¼Œç®€è¦é˜è¿°äº†å¦‚ä½•ä¼˜åŒ–ä¸æ£€æµ‹å¯åŠ¨æ—¶é—´ã€‚</p><span id="more"></span><h2 id="å¯åŠ¨æµç¨‹"><a href="#å¯åŠ¨æµç¨‹" class="headerlink" title="å¯åŠ¨æµç¨‹"></a>å¯åŠ¨æµç¨‹</h2><h3 id="å¯åŠ¨ç±»å‹"><a href="#å¯åŠ¨ç±»å‹" class="headerlink" title="å¯åŠ¨ç±»å‹"></a>å¯åŠ¨ç±»å‹</h3><ul><li><p>å†·å¯åŠ¨</p><ul><li>é‡å¯å / APP å¾ˆé•¿æ—¶é—´ä¸ºå¯åŠ¨è¿‡</li><li>å°†å®ƒä»ç£ç›˜åŠ è½½åˆ°å†…å­˜</li><li>å¯åŠ¨æ”¯æ’‘ APP è¿è¡Œçš„ç³»ç»Ÿä¾§æœåŠ¡(system-side service)</li><li>åˆ›å»º APP è¿›ç¨‹</li></ul></li><li><p>çƒ­å¯åŠ¨</p><ul><li>APP æœ€è¿‘å¯åŠ¨è¿‡</li><li>ç”±äºæœ‰APPéƒ¨åˆ†ä¸ç³»ç»Ÿä¾§æœåŠ¡åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥ä¼šæ¯”å†·å¯åŠ¨å¿«ä¸€äº›ã€‚</li></ul></li></ul><h3 id="å¯åŠ¨é˜¶æ®µ"><a href="#å¯åŠ¨é˜¶æ®µ" class="headerlink" title="å¯åŠ¨é˜¶æ®µ"></a>å¯åŠ¨é˜¶æ®µ</h3><ul><li><p>main å‡½æ•°ä¹‹å‰</p><ul><li><p>åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶</p></li><li><p>dyld åŠ è½½ dylibsï¼Œè¿›è¡Œ rebase æŒ‡é’ˆè°ƒæ•´ ä¸ bind ç¬¦å·ç»‘å®šã€‚</p><ul><li>rebase: ä¿®æ­£æŒ‡å‘å½“å‰ Mach-O æ–‡ä»¶çš„æŒ‡é’ˆã€‚æ‰€éœ€è¦çš„æŒ‡é’ˆä¿¡æ¯å·²ç»è¢«ç¼–ç åˆ° __LINKEDIT é‡Œï¼Œç„¶åå°±æ˜¯ä¸æ–­é‡å¤çš„å¯¹ __DATA çš„æŒ‡é’ˆåŠ ä¸Šè¿™ä¸ªåç§»é‡ã€‚</li><li>bind: å¯¹è°ƒç”¨å¤–éƒ¨ç¬¦å·è¿›è¡Œç»‘å®šå¤„ç†ã€‚</li></ul></li><li><p>Runtime åˆå§‹åŒ–</p></li></ul></li><li><p>main å‡½æ•°ä¹‹å</p><ul><li><p>å®ä¾‹åŒ– UIApplication ä¸ UIApplicationDelegate </p></li><li><p>å¼€å§‹äº‹ä»¶å¤„ç†ä¸ç³»ç»Ÿé›†æˆ</p></li><li><p>è°ƒç”¨ UIApplicationDelegate ä¸­ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</p><ul><li>æ™®é€šï¼š<br>application:willFinishLaunchingWithOptions:<br>application:didFinishLaunchingWithOptions:<br>applicationDidBecomeActive:</li><li>é’ˆå¯¹ UISceneDelegateï¼š<br>application:willFinishLaunchingWithOptions:<br>application:didFinishLaunchingWithOptions:<br>scene:willConnectToSession:options:<br>sceneWillEnterForeground:<br>sceneDidBecomeActive:</li></ul></li><li><p>é¦–å±æ¸²æŸ“</p><ul><li>loadView</li><li>viewDidLoad</li><li>layoutSubViews</li></ul></li><li><p>å¼‚æ­¥è·å–æ•°æ®å¹¶å‘ˆç°ç»™ç”¨æˆ·</p></li></ul></li></ul><h2 id="dyld"><a href="#dyld" class="headerlink" title="dyld"></a>dyld</h2><h3 id="dyld-1-x"><a href="#dyld-1-x" class="headerlink" title="dyld 1.x"></a>dyld 1.x</h3><ul><li>1996 - 2004</li><li>åŒ…å«åœ¨ NeXTStep 3.0 ä¸­ï¼Œä¸èƒ½å¾ˆå¥½æ”¯æŒç›¸åŒè¯­ä¹‰åŒæ—¶ä¸€äº›è¾¹ç•Œæ¡ä»¶æ— æ³•æ­£å¸¸è¿ä½œã€‚</li><li>é¢„ç»‘å®š(PreBuilding)ï¼šä¸º dylib å’Œ App æ‰¾åˆ°åˆé€‚çš„å›ºå®šåœ°å€ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½ä¼šæœ‰ã€‚</li></ul><h3 id="dyld-2-x"><a href="#dyld-2-x" class="headerlink" title="dyld 2.x"></a>dyld 2.x</h3><ul><li><p>2004 - 2017</p></li><li><p>ç‰¹æ€§</p><ul><li><p>Codesign</p><ul><li>ä»¥é¡µä¸ºå•ä½ï¼ŒMach-O æ–‡ä»¶çš„æ¯ä¸€é¡µéƒ½è¦è¢« hashï¼Œåœ¨è¢«è½½å…¥æ—¶è¿›è¡Œä¸  __LINKEDIT ä¸­çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒã€‚</li></ul></li><li><p>ASLR</p><ul><li>Mach-O æ–‡ä»¶è¢«åŠ è½½åˆ°éšæœºçš„åœ°å€ä¸Šã€‚</li></ul></li><li><p>Bounds Checking</p><ul><li>é¿å…æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„åŠ å…¥ã€‚</li></ul></li><li><p>Shared cache</p><ul><li>å…±äº«ç¼“å­˜æ˜¯åŒ…å«æ‰€æœ‰ç³»ç»Ÿ dylib çš„å•ä¸ªæ–‡ä»¶ï¼Œä»£æ›¿äº† PreBuildingã€‚</li></ul></li></ul></li><li><p>æµç¨‹</p><ul><li>è§£æ Mach-O çš„ Header ä¸ Load Commandsï¼Œé€’å½’åŠ è½½å…¶ä¾èµ–çš„åŠ¨æ€åº“ã€‚</li><li>æ˜ å°„æ‰€æœ‰ Mach-O æ–‡ä»¶åˆ° App çš„åœ°å€ç©ºé—´ã€‚</li><li>ç¬¦å·æŸ¥æ‰¾</li><li>Rebase &amp; Bind</li><li>è¿è¡Œåˆå§‹åŒ–ç¨‹åº</li></ul></li></ul><h3 id="dyld-3-x"><a href="#dyld-3-x" class="headerlink" title="dyld 3.x"></a>dyld 3.x</h3><ul><li><p>2017 - è‡³ä»Š</p></li><li><p>å¯ç¼“å­˜é˜¶æ®µ â€œè§£æMach-Oæ–‡ä»¶ã€æ‰¾åˆ°å¯¹åº”ä¾èµ–åº“ã€æ‰§è¡Œç¬¦å·æŸ¥æ‰¾â€ï¼Œé™¤äº†è½¯ä»¶æ›´æ–°æˆ–è€…æ›´æ”¹äº†ç£ç›˜ä¸Šçš„åº“ï¼Œè´Ÿè´£æ¯æ¬¡å¯åŠ¨çš„Appä¾èµ–åº“ç¬¦å·ä¸å˜ã€åº“ä¸­ç¬¦å·å§‹ç»ˆå¤„äºç›¸åŒåç§»é‡ã€‚å› æ­¤å°†å¯ç¼“å­˜æŒªåˆ°äº†æœ€å‰é¢ï¼Œå¹¶å°†æ‰§è¡Œç»“æœä»¥é—­åŒ…å½¢å¼å†™å…¥åˆ°ç£ç›˜ã€‚</p></li><li><p>dyld è¢«åˆ†ä¸º 3 ä¸ªç»„ä»¶</p><ul><li>è¿›ç¨‹å¤–çš„ Mach-O è§£æå™¨ / ç¼–è¯‘å™¨</li><li>è¿›ç¨‹å†…çš„å¼•æ“ï¼Œç”¨æ¥å¯åŠ¨é—­åŒ…ç¼“å­˜</li><li>å¯åŠ¨é—­åŒ…ç¼“å­˜æœåŠ¡</li></ul></li><li><p>æµç¨‹</p><ul><li>è§£æ Mach-Oæ–‡ä»¶</li><li>æ‰¾åˆ°æ‰€æœ‰ä¾èµ–åº“</li><li>ç¬¦å·æŸ¥æ‰¾</li><li>è¯»å–å¯åŠ¨é—­åŒ…</li><li>éªŒè¯å¯åŠ¨é—­åŒ…</li><li>æ˜ å°„ Mach-O æ–‡ä»¶åˆ° Appçš„åœ°å€ç©ºé—´</li><li>Rebase &amp; Bind</li><li>è¿è¡Œåˆå§‹åŒ–ç¨‹åº</li></ul></li></ul><h2 id="Mach-O"><a href="#Mach-O" class="headerlink" title="Mach-O"></a>Mach-O</h2><h3 id="Mach-O-æ˜¯ç³»ç»Ÿä¸åŒè¿è¡Œæ—¶æœŸå¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ç»Ÿç§°ï¼Œä¸»è¦åˆ†ä¸º-3-ç§"><a href="#Mach-O-æ˜¯ç³»ç»Ÿä¸åŒè¿è¡Œæ—¶æœŸå¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ç»Ÿç§°ï¼Œä¸»è¦åˆ†ä¸º-3-ç§" class="headerlink" title="Mach-O æ˜¯ç³»ç»Ÿä¸åŒè¿è¡Œæ—¶æœŸå¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ç»Ÿç§°ï¼Œä¸»è¦åˆ†ä¸º 3 ç§"></a>Mach-O æ˜¯ç³»ç»Ÿä¸åŒè¿è¡Œæ—¶æœŸå¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ç»Ÿç§°ï¼Œä¸»è¦åˆ†ä¸º 3 ç§</h3><ul><li>Executableï¼šå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ˜¯ APP ä¸­çš„ä¸»è¦ 2 è¿›åˆ¶æ–‡ä»¶</li><li>Dylibï¼šåŠ¨æ€åº“ï¼Œåœ¨å…¶ä»–å¹³å°ä¹Ÿå« DSO / DLL</li><li>Bundleï¼šè‹¹æœå¹³å°ç‰¹æœ‰çš„ç±»å‹ï¼Œæ˜¯æ— æ³•è¢«é“¾æ¥çš„ Dylibã€‚æ˜¯èƒ½åœ¨è¿è¡Œæ—¶é€šè¿‡ dlopen() åŠ è½½</li></ul><h3 id="æ–‡ä»¶æ ¼å¼"><a href="#æ–‡ä»¶æ ¼å¼" class="headerlink" title="æ–‡ä»¶æ ¼å¼"></a>æ–‡ä»¶æ ¼å¼</h3><ul><li><p>Headerï¼šåŒ…å«äº† Mach-O æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ã€‚å¦‚ï¼šCPU æ¶æ„ã€æ–‡ä»¶ç±»å‹ã€åŠ è½½æŒ‡ä»¤æ•°é‡ç­‰</p></li><li><p>Load Commandsï¼šè·Ÿåœ¨ Header åé¢çš„åŠ è½½å‘½ä»¤åŒºï¼ŒåŒ…å«æ–‡ä»¶çš„ç»„ç»‡æ¶æ„ã€åœ¨è™šæ‹Ÿå†…å­˜çš„å¸ƒå±€æ–¹å¼ï¼Œåœ¨è°ƒç”¨æ—¶çŸ¥é“å¦‚ä½•è®¾ç½®å’ŒåŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p></li><li><p>Dataï¼šåŒ…å« Load Commands ä¸­éœ€è¦çš„å„ä¸ª  Segment çš„æ•°æ®ã€‚</p></li><li><p>ç»å¤§å¤šæ•° Mach-O åŒ…å«ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„ Segment</p><ul><li>__TEXTï¼šä»£ç æ®µï¼ŒåŒ…å«å¤´æ–‡ä»¶ã€ä»£ç ã€å¸¸é‡ã€‚åªè¯»ä¸å¯ä¿®æ”¹</li><li>__DATAï¼šæ•°æ®æ®µï¼ŒåŒ…å«å…¨å±€å˜é‡ã€é™æ€å˜é‡ã€‚å¯è¯»å¯å†™</li><li>__LINKEDITï¼šå¦‚ä½•åŠ è½½ç¨‹åºï¼ŒåŒ…å«æ–¹æ³•å’Œå˜é‡çš„å…ƒæ•°æ®(ä½ç½®ã€åç§»é‡)ï¼Œä»¥åŠä»£ç ç­¾åç­‰ä¿¡æ¯ã€‚åªè¯»ä¸å¯ä¿®æ”¹</li></ul></li></ul><h3 id="Mach-O-Universal-Files"><a href="#Mach-O-Universal-Files" class="headerlink" title="Mach-O Universal  Files"></a>Mach-O Universal  Files</h3><ul><li>æ”¯æŒå¤šä¸ªæ¶æ„çš„ Mach-O æ–‡ä»¶é€šå¸¸è¢«ç§°ä¸ºé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿç§°èƒ–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li><li>èƒ–äºŒè¿›åˆ¶æ–‡ä»¶èµ·å§‹å¤„æœ‰ä¸€ä¸ª Fat Headerï¼ŒåŒ…å«æ‰€æœ‰çš„æ¶æ„ä»¥åŠå®ƒä»¬åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ã€‚</li></ul><h2 id="è™šæ‹Ÿå†…å­˜"><a href="#è™šæ‹Ÿå†…å­˜" class="headerlink" title="è™šæ‹Ÿå†…å­˜"></a>è™šæ‹Ÿå†…å­˜</h2><h3 id="è™šæ‹Ÿå†…å­˜æ˜¯å»ºç«‹åœ¨ç‰©ç†å†…å­˜å’Œè¿›ç¨‹ä¹‹é—´çš„ä¸­é—´å±‚ã€‚æ˜¯ä¸€ä¸ªè¿ç»­çš„é€»è¾‘åœ°å€ç©ºé—´ï¼Œè€Œä¸”é€»è¾‘åœ°å€å¯ä»¥æ²¡æœ‰å¯¹åº”çš„å®é™…ç‰©ç†åœ°å€ï¼Œä¹Ÿå¯ä»¥è®©å¤šä¸ªé€»è¾‘åœ°å€å¯¹åº”åˆ°åŒä¸€ä¸ªç‰©ç†åœ°å€ä¸Šã€‚"><a href="#è™šæ‹Ÿå†…å­˜æ˜¯å»ºç«‹åœ¨ç‰©ç†å†…å­˜å’Œè¿›ç¨‹ä¹‹é—´çš„ä¸­é—´å±‚ã€‚æ˜¯ä¸€ä¸ªè¿ç»­çš„é€»è¾‘åœ°å€ç©ºé—´ï¼Œè€Œä¸”é€»è¾‘åœ°å€å¯ä»¥æ²¡æœ‰å¯¹åº”çš„å®é™…ç‰©ç†åœ°å€ï¼Œä¹Ÿå¯ä»¥è®©å¤šä¸ªé€»è¾‘åœ°å€å¯¹åº”åˆ°åŒä¸€ä¸ªç‰©ç†åœ°å€ä¸Šã€‚" class="headerlink" title="è™šæ‹Ÿå†…å­˜æ˜¯å»ºç«‹åœ¨ç‰©ç†å†…å­˜å’Œè¿›ç¨‹ä¹‹é—´çš„ä¸­é—´å±‚ã€‚æ˜¯ä¸€ä¸ªè¿ç»­çš„é€»è¾‘åœ°å€ç©ºé—´ï¼Œè€Œä¸”é€»è¾‘åœ°å€å¯ä»¥æ²¡æœ‰å¯¹åº”çš„å®é™…ç‰©ç†åœ°å€ï¼Œä¹Ÿå¯ä»¥è®©å¤šä¸ªé€»è¾‘åœ°å€å¯¹åº”åˆ°åŒä¸€ä¸ªç‰©ç†åœ°å€ä¸Šã€‚"></a>è™šæ‹Ÿå†…å­˜æ˜¯å»ºç«‹åœ¨ç‰©ç†å†…å­˜å’Œè¿›ç¨‹ä¹‹é—´çš„ä¸­é—´å±‚ã€‚æ˜¯ä¸€ä¸ªè¿ç»­çš„é€»è¾‘åœ°å€ç©ºé—´ï¼Œè€Œä¸”é€»è¾‘åœ°å€å¯ä»¥æ²¡æœ‰å¯¹åº”çš„å®é™…ç‰©ç†åœ°å€ï¼Œä¹Ÿå¯ä»¥è®©å¤šä¸ªé€»è¾‘åœ°å€å¯¹åº”åˆ°åŒä¸€ä¸ªç‰©ç†åœ°å€ä¸Šã€‚</h3><h3 id="ç¼ºé¡µä¸­æ–­-Page-Fault"><a href="#ç¼ºé¡µä¸­æ–­-Page-Fault" class="headerlink" title="ç¼ºé¡µä¸­æ–­(Page Fault)"></a>ç¼ºé¡µä¸­æ–­(Page Fault)</h3><ul><li>å½“è¿›ç¨‹è®¿é—®ä¸€ä¸ªæ²¡æœ‰å¯¹åº”ç‰©ç†åœ°å€çš„é€»è¾‘åœ°å€æ—¶ï¼Œä¼šå‘ç”Ÿ Page Fault</li></ul><h3 id="æ‡’åŠ è½½-Lazy-Reading"><a href="#æ‡’åŠ è½½-Lazy-Reading" class="headerlink" title="æ‡’åŠ è½½(Lazy Reading)"></a>æ‡’åŠ è½½(Lazy Reading)</h3><ul><li>æŸä¸ªæƒ³è¦è¯»å–çš„é¡µæ²¡æœ‰å­˜åœ¨äºå†…å­˜ä¼šè§¦å‘ Page Faultï¼Œç³»ç»Ÿé€šè¿‡ mmap() å‡½æ•°è¯»å–æŒ‡å®šé¡µï¼Œè¿™ä¸ªè¿‡ç¨‹æˆä¸º Lazy Readingã€‚mmap() å‡½æ•°å¯ä»¥å°†æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹æ˜ å°„åˆ°åœ°å€èŒƒå›´ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ–‡ä»¶ã€‚</li></ul><h3 id="å†™æ—¶å¤åˆ¶-Copy-On-Write"><a href="#å†™æ—¶å¤åˆ¶-Copy-On-Write" class="headerlink" title="å†™æ—¶å¤åˆ¶(Copy On Write)"></a>å†™æ—¶å¤åˆ¶(Copy On Write)</h3><ul><li>å½“è¿›ç¨‹éœ€è¦å¯¹æŸä¸€é¡µçš„å†…å®¹è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå†…æ ¸ä¼šæŠŠéœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†å…ˆå¤åˆ¶ä¸€ä»½ï¼Œç„¶åå†ä¿®æ”¹ï¼Œé‚£ä¸ªé‡æ–°æŠŠé€»è¾‘åœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ä¸Šå»ã€‚</li></ul><h3 id="Dirty-Page-amp-Clean-Page"><a href="#Dirty-Page-amp-Clean-Page" class="headerlink" title="Dirty Page &amp; Clean Page"></a>Dirty Page &amp; Clean Page</h3><ul><li>Dirty Pageï¼šåŒ…å«ç‰¹å®šè¿›ç¨‹ä¿¡æ¯çš„é¡µ</li><li>Clean Pageï¼šä¸åŒ…å«ç‰¹å®šè¿›ç¨‹ä¿¡æ¯çš„é¡µã€‚å¦‚æœéœ€è¦ï¼Œå†…æ ¸å¯ä»¥é‡æ–°ç”Ÿæˆ Clean Pageã€‚</li></ul><h3 id="å…±äº«å†…å­˜-Shared-RAM"><a href="#å…±äº«å†…å­˜-Shared-RAM" class="headerlink" title="å…±äº«å†…å­˜(Shared RAM)"></a>å…±äº«å†…å­˜(Shared RAM)</h3><ul><li>å½“å¤šä¸ª Mach-O ä¾èµ–åŒä¸€ä¸ª Dylib(eg. UIKit) æ—¶ï¼Œç³»ç»Ÿä¼šè®©å‡ ä¸ª Mach-O çš„è°ƒç”¨ Dylib çš„é€»è¾‘åœ°å€æŒ‡å‘åŒä¸€å—ç‰©ç†å†…å­˜ç©ºé—´ï¼Œä»è€Œå®ç°å†…å­˜å…±äº«ã€‚Dirty Page ä¸ºè¿›ç¨‹ç‹¬æœ‰ï¼Œä¸èƒ½è¢«å…±äº«ã€‚</li></ul><h2 id="ä¼˜åŒ–æ–¹å¼"><a href="#ä¼˜åŒ–æ–¹å¼" class="headerlink" title="ä¼˜åŒ–æ–¹å¼"></a>ä¼˜åŒ–æ–¹å¼</h2><p>å‡å°‘åŠ¨æ€åº“æˆ–å°†å¤šä¸ªåŠ¨æ€åº“åˆå¹¶æˆä¸€ä¸ª</p><p>å‡å°‘é™æ€åˆå§‹åŒ–</p><p>+load æ–¹æ³•å†…å®¹æ”¾åˆ°é¦–å±æ¸²æŸ“åå†æ‰§è¡Œï¼Œæˆ–ä½¿ç”¨ +initialize() æ–¹æ³•æ›¿æ¢ã€‚</p><p>åœ¨ didFinishLaunchingWithOptions å’Œé¦–å±æ¸²æŸ“ä¸­åªä¿ç•™å¿…è¦çš„åˆå§‹åŒ–ä»»åŠ¡ã€‚</p><h2 id="å¦‚ä½•æ£€æµ‹"><a href="#å¦‚ä½•æ£€æµ‹" class="headerlink" title="å¦‚ä½•æ£€æµ‹"></a>å¦‚ä½•æ£€æµ‹</h2><p>hook</p><p>Instrument - App Lunch / æœ¬åœ°æµ‹é‡</p><p>Organizer - Launch Time / çº¿ä¸Šæ•°æ®</p><p>å¯åŠ¨å‚æ•°- DYLD_PRINT_STATISTICS=ture</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://xiaozhuanlan.com/topic/4690823715">è€å¸æœºæŠ€æœ¯å‘¨æŠ¥ - ä¼˜åŒ– APP å¯åŠ¨</a></p><p><a href="https://developer.apple.com/videos/play/wwdc2019/423/">WWDC19 / 423 - ä¼˜åŒ– APP å¯åŠ¨</a></p><p><a href="https://developer.apple.com/videos/play/wwdc2017/413">WWDC17 / 413 - App å¯åŠ¨æ—¶é—´: è¿‡å»ã€ç°åœ¨å’Œå°†æ¥</a></p><p><a href="https://huang-libo.github.io/posts/Optimizing-App-Startup-Time/#%E7%9B%AE%E5%BD%95">WWDC16 / 406 - ä¼˜åŒ– App å¯åŠ¨æ—¶é—´</a></p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Appå¯åŠ¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Swift ç¼–è¯‘æµç¨‹</title>
      <link href="/2022/02/07/2022-02-07-Swift%20%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/"/>
      <url>/2022/02/07/2022-02-07-Swift%20%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹¦æ¥ä¸Šæ–‡ï¼Œæœ¬æ–‡å°†ä»‹ç» <strong>Swift</strong> è¯­è¨€çš„ç¼–è¯‘ä¸»è¦å‰ç«¯æµç¨‹ï¼Œåç«¯çš„æµç¨‹ä¸ä¸Šæ–‡åŒæ­¥ï¼Œå°±ä¸è¿‡å¤šèµ˜è¿°ï¼Œè¯¦æƒ…è§ <a href="https://xuhaodong1.github.io/2021/11/03/2021-11-03-iOS%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/">iOS ç¼–è¯‘è¿‡ç¨‹</a>ï¼ŒåŒæ—¶æœ¬æ–‡å°± <strong>SIL</strong> ä»‹ç»å…¶ç‰¹ç‚¹ã€‚</p><span id="more"></span><h2 id="Clang-ä¸-SwiftC"><a href="#Clang-ä¸-SwiftC" class="headerlink" title="Clang ä¸ SwiftC"></a>Clang ä¸ SwiftC</h2><p>ä¸ºä»€ä¹ˆè¦å¼•å…¥ä¸€ç§æ–°çš„ç¼–è¯‘å™¨ï¼Œæ•´ä½“è€Œè¨€ <strong>Swift</strong> ä½œä¸ºä¸€ç§é«˜çº§è¯­è¨€ï¼Œå…¶å¾ˆå¤šé«˜çº§ç‰¹æ€§ <strong>Clang</strong> ä¸æ”¯æŒï¼ŒåŒæ—¶ä¹Ÿç”±äº <strong>Clang</strong> è‡ªèº«çš„ä¸€äº›å¼Šç«¯ã€‚è¿›è€Œå‚¬ç”Ÿå‡ºäº† <strong>SwiftC</strong>ï¼Œå°† <strong>Clang</strong> å’Œ <strong>SwiftC</strong> çš„ç¼–è¯‘æµç¨‹è¿›è¡Œå¯¹æ¯”ï¼š</p><p>å…¶ä¸­ <strong>Clang</strong> çš„åŠ£åŠ¿å¦‚ä¸‹ï¼š</p><ul><li>è¯­ä¹‰ä¸å¯é‡å¤è¡¨ç¤ºï¼Œå¯¼è‡´äºˆä»¥åˆ†æä¼šä¾èµ–äº Parse(å¯çœ‹æˆç”Ÿæˆ <strong>token</strong> è¡¨ï¼Œè¿›è¡Œè¯æ³•åˆ†æ)ã€‚</li><li>IR ä¸­é—´ä»£ç ä¸é€‚ç”¨äºè¿›è¡Œ <strong>Analysis</strong>ï¼Œé‡‡ç”¨ <strong>CFG</strong> è¿›è¡Œåˆ†æï¼Œå¯¼è‡´ç”Ÿæˆ <strong>IR</strong> å’Œ <strong>Analysis</strong> æ˜¯ä¸¤éƒ¨åˆ† ï¼ˆAnalysis æœ‰åˆ«ä¸è¯è¯­åˆ†æä¸è¯­æ³•åˆ†æï¼Œå®ƒå•ç‹¬å¯¹æºä»£ç è¿›è¡Œåˆ†æï¼Œå¦‚æŸ¥æ‰¾ã€ä¸ä¼šæ‰§è¡Œçš„ä»£ç ã€‘ã€ã€ä¸ä¼šè¢«åˆå§‹åŒ–çš„å˜é‡ã€‘ã€ã€é™æ€åˆ†æã€‘ç­‰ï¼‰ã€‚</li><li>åœ¨ <strong>CFG</strong> å’Œ <strong>IR</strong> é™çº§çš„æ—¶å€™ä¼šåšå¾ˆå¤šé‡å¤åˆ†æï¼Œåšæ— ç”¨åŠŸã€‚</li></ul><p>ç›¸è¾ƒè€Œè¨€ <strong>Swift</strong> è§£å†³äº† <strong>Clang</strong> ä¸­çš„å¾ˆå¤šé—®é¢˜ï¼Œå¼•å…¥äº† <strong>SIL</strong>ï¼ˆ <strong>Swift Intermediate Language</strong> ï¼‰ ä¸­é—´ä»£ç ï¼Œæ—¢å¯è¿›è¡Œ åˆ†æ åˆå¯è¿›è¡Œ <strong>IR</strong> ä»£ç ç”Ÿæˆï¼Œå¹¶å¼•å…¥äº†è®¸å¤šæ–°çš„é«˜çº§ä¼˜åŒ–ç‰¹æ€§ã€‚</p><p><img src="/images/blog/webp.png" alt="img"></p><p><img src="/images/blog/Swift%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B.png" alt="img"></p><h2 id="SwiftC-ç¼–è¯‘æµç¨‹-Frontend"><a href="#SwiftC-ç¼–è¯‘æµç¨‹-Frontend" class="headerlink" title="SwiftC ç¼–è¯‘æµç¨‹(Frontend)"></a>SwiftC ç¼–è¯‘æµç¨‹(Frontend)</h2><h3 id="æºç ï¼š"><a href="#æºç ï¼š" class="headerlink" title="æºç ï¼š"></a><strong>æºç ï¼š</strong></h3><pre><code class="swift">class Person {    var name = "nihao"    func getName() -&gt; String {        print(name)        return name    }}</code></pre><h3 id="Parse-è¯æ³•åˆ†æ"><a href="#Parse-è¯æ³•åˆ†æ" class="headerlink" title="Parse(è¯æ³•åˆ†æ):"></a>Parse(è¯æ³•åˆ†æ):</h3><p>å‘½ä»¤ï¼š<code>swiftc -dump-parse main.swift &gt;&gt; ./main.parse</code></p><pre><code class="shell">(source_file "main.swift"  (class_decl range=[main.swift:8:1 - line:15:1] "Person"    (pattern_binding_decl range=[main.swift:9:5 - line:9:16]      (pattern_named 'name')      Original init:      (string_literal_expr type='&lt;null&gt;' encoding=utf8 value="nihao" builtin_initializer=**NULL** initializer=**NULL**)      Processed init:      (string_literal_expr type='&lt;null&gt;' encoding=utf8 value="nihao" builtin_initializer=**NULL** initializer=**NULL**))    (var_decl range=[main.swift:9:9 - line:9:9] "name" type='&lt;null type&gt;')    (func_decl range=[main.swift:11:5 - line:14:5] "getName()"      (parameter "self")      (parameter_list range=[main.swift:11:17 - line:11:18])      (result        (type_ident          (component id='String' bind=none)))      (brace_stmt range=[main.swift:11:30 - line:14:5]        (call_expr type='&lt;null&gt;' arg_labels=_:          (unresolved_decl_ref_expr type='&lt;null&gt;' name=print function_ref=unapplied)          (paren_expr type='&lt;null&gt;'            (unresolved_decl_ref_expr type='&lt;null&gt;' name=name function_ref=unapplied)))        (return_stmt range=[main.swift:13:9 - line:13:16]          (unresolved_decl_ref_expr type='&lt;null&gt;' name=name function_ref=unapplied))))))</code></pre><p>å¯ä»¥çœ‹åˆ°æœ‰åˆ«äº Clang ç”Ÿæˆ token æµçš„çš„å½¢å¼ï¼ŒParseé˜¶æ®µæ˜¯ä¸€ä¸ªé€’å½’è‡³é¡¶å‘ä¸‹çš„è§£æè¿‡ç¨‹ï¼Œè¿™ä¹Ÿè§£é‡Šäº†å…¶è¯­ä¹‰å¯é‡å¤è¡¨ç¤ºçš„åŸå› ã€‚</p><h3 id="è¯­ä¹‰åˆ†æå¹¶ç”ŸæˆAST"><a href="#è¯­ä¹‰åˆ†æå¹¶ç”ŸæˆAST" class="headerlink" title="è¯­ä¹‰åˆ†æå¹¶ç”ŸæˆAST"></a>è¯­ä¹‰åˆ†æå¹¶ç”ŸæˆAST</h3><p>å‘½ä»¤ï¼š<code>swiftc -dump-ast main.swift &gt;&gt; ./main.ast</code></p><pre><code class="shell">(source_file "main.swift"  (class_decl range=[main.swift:8:1 - line:15:1] "Person" interface type='Person.Type' access=internal non-resilient    (pattern_binding_decl range=[main.swift:9:5 - line:9:16]      (pattern_named type='String' 'name')      Original init:      (string_literal_expr type='String' location=main.swift:9:16 range=[main.swift:9:16 - line:9:16] encoding=utf8 value="nihao" builtin_initializer=Swift.(file).String extension.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:) initializer=**NULL**)      Processed init:      (string_literal_expr type='String' location=main.swift:9:16 range=[main.swift:9:16 - line:9:16] encoding=utf8 value="nihao" builtin_initializer=Swift.(file).String extension.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:) initializer=**NULL**))    (var_decl range=[main.swift:9:9 - line:9:9] "name" type='String' interface type='String' access=internal readImpl=stored writeImpl=stored readWriteImpl=stored      (accessor_decl implicit range=[main.swift:9:9 - line:9:9] 'anonname=0x7fcbc202f0d8' interface type='(Person) -&gt; () -&gt; String' access=internal get_for=name        (parameter "self" type='Person' interface type='Person')        (parameter_list)        (brace_stmt implicit range=[main.swift:9:9 - line:9:9]          (return_stmt implicit            (member_ref_expr implicit type='String' decl=main.(file).Person.name@main.swift:9:9 direct_to_storage              (declref_expr implicit type='Person' decl=main.(file).Person.&lt;anonymous&gt;.self@main.swift:9:9 function_ref=unapplied)))))      (accessor_decl implicit range=[main.swift:9:9 - line:9:9] 'anonname=0x7fcbc202f330' interface type='(Person) -&gt; (String) -&gt; ()' access=internal set_for=name        (parameter "self" type='Person' interface type='Person')        (parameter_list range=[main.swift:9:9 - line:9:9]          (parameter "value" type='String' interface type='String'))......</code></pre><p>æ­¤æ­¥è¿›è¡Œè¯­æ³•åˆ†æï¼Œå¹¶ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ AST ä¸ Parse é˜¶æ®µçš„äº§äºè¯­æ³•ä¸€ç›´ï¼Œä¸è¿‡åœ¨å…¶åŸºç¡€ä¸Šè¡¥å……äº†å¾ˆå¤šå†…å®¹ï¼Œå¦‚ç±»å‹ã€è®¿é—®æƒé™ã€æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ç­‰ã€‚</p><h3 id="Raw-åŸå§‹-SIL-ç”Ÿæˆ"><a href="#Raw-åŸå§‹-SIL-ç”Ÿæˆ" class="headerlink" title="Raw(åŸå§‹) SIL ç”Ÿæˆ"></a>Raw(åŸå§‹) SIL ç”Ÿæˆ</h3><p>å‘½ä»¤ï¼š<code>swiftc -emit-silgen main.swift &gt;&gt; ./main.silgen</code></p><pre><code class="swift">sil_stage rawimport Builtinimport Swiftimport SwiftShimsclass Person {  @_hasStorage @_hasInitialValue var name: String { get set }  func getName() -&gt; String  @objc deinit  init()}// mainsil [ossa] @main : $@convention(c) (Int32, UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;) -&gt; Int32 {bb0(%0 : $Int32, %1 : $UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;):  %2 = integer_literal $Builtin.Int32, 0          // user: %3  %3 = struct $Int32 (%2 : $Builtin.Int32)        // user: %4  return %3 : $Int32                              // id: %4} // end sil function 'main'// variable initialization expression of Person.namesil hidden [transparent] [ossa] @$s4main6PersonC4nameSSvpfi : $@convention(thin) () -&gt; @owned String {bb0:  %0 = string_literal utf8 "nihao"                // user: %5  %1 = integer_literal $Builtin.Word, 5           // user: %5  %2 = integer_literal $Builtin.Int1, -1          // user: %5  %3 = metatype $@thin String.Type                // user: %5  // function_ref String.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:)  %4 = function_ref @$sSS21_builtinStringLiteral17utf8CodeUnitCount7isASCIISSBp_BwBi1_tcfC : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String // user: %5  %5 = apply %4(%0, %1, %2, %3) : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String // user: %6  return %5 : $String                             // id: %6} // end sil function '$s4main6PersonC4nameSSvpfi'    ......</code></pre><p><strong>Raw SIL</strong>ï¼Œç”±äº ç›®å‰çš„ <strong>SIL</strong> è¿˜æœªè¿›è¡Œç¡®ä¿ä¼˜åŒ–ä¸è¯Šæ–­æ£€æŸ¥ï¼Œæ­¤æ—¶çš„ <strong>SIL</strong> è¿˜æ¯”è¾ƒè„†å¼±ï¼Œæ‰€ä»¥ç§°å…¶ä¸º <strong>Raw SIL</strong>ã€‚</p><h3 id="Canonical-æ­£å¼-SILç”Ÿæˆ"><a href="#Canonical-æ­£å¼-SILç”Ÿæˆ" class="headerlink" title="Canonical(æ­£å¼) SILç”Ÿæˆ"></a>Canonical(æ­£å¼) SILç”Ÿæˆ</h3><p>å‘½ä»¤ï¼š<code>swiftc -emit-sil main.swift &gt;&gt; ./main.sil</code></p><pre><code class="Swift">sil_stage canonicalimport Builtinimport Swiftimport SwiftShimsclass Person {  @_hasStorage @_hasInitialValue var name: String { get set }  func getName() -&gt; String  @objc deinit  init()}// mainsil @main : $@convention(c) (Int32, UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;) -&gt; Int32 {bb0(%0 : $Int32, %1 : $UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;):  %2 = integer_literal $Builtin.Int32, 0          // user: %3  %3 = struct $Int32 (%2 : $Builtin.Int32)        // user: %4  return %3 : $Int32                              // id: %4} // end sil function 'main'// variable initialization expression of Person.namesil hidden [transparent] @$s4main6PersonC4nameSSvpfi : $@convention(thin) () -&gt; @owned String {bb0:  %0 = string_literal utf8 "nihao"                // user: %5  %1 = integer_literal $Builtin.Word, 5           // user: %5  %2 = integer_literal $Builtin.Int1, -1          // user: %5  %3 = metatype $@thin String.Type                // user: %5  // function_ref String.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:)  %4 = function_ref @$sSS21_builtinStringLiteral17utf8CodeUnitCount7isASCIISSBp_BwBi1_tcfC : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String // user: %5  %5 = apply %4(%0, %1, %2, %3) : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String // user: %6  return %5 : $String                             // id: %6} // end sil function '$s4main6PersonC4nameSSvpfi'// String.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:)sil [always_inline] [readonly] [_semantics "string.makeUTF8"] @$sSS21_builtinStringLiteral17utf8CodeUnitCount7isASCIISSBp_BwBi1_tcfC : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String......</code></pre><p>è¿™ä¸€æ­¥ä¸»è¦è¿›è¡Œç¡®ä¿ä¼˜åŒ–ä»¥åŠè¯Šæ–­æ£€æŸ¥å·¥ä½œï¼š</p><p>ç‰¹å®šæµç¨‹ï¼š</p><ul><li><strong>å¼ºåˆ¶å†…è”</strong>ï¼šå¯¹äºé€æ˜å‡½æ•°è¿›è¡Œå†…è”(é€æ˜å‡½æ•°ï¼šå¦‚æœä¸€ä¸ªå‡½æ•°å€¼å—åˆ°å…¥å‚çš„å˜åŒ–ï¼Œæ¯æ¬¡è°ƒç”¨ç›¸åŒçš„å…¥å‚ä¼šæœ‰ç›¸åŒçš„è¿”å›å€¼ã€‚)</li><li><strong>å†…å­˜æå‡</strong>ï¼š1. å°†<code>alloc_box</code>ç»“æ„ä¼˜åŒ–ä¸º<code>alloc_stack</code> 2. æå‡æ— æš´éœ²åœ°å€(<code>non_address-exposed</code>)çš„<code>alloc_stack</code>è¯´æ˜åˆ°SSAæ³¨å†Œã€‚</li><li><strong>å¸¸æ•°ä¼ æ’­</strong>ï¼šä¸€ç§ä¼˜åŒ–å¸¸æ•°æ‰‹æ®µï¼Œå¦‚è¡¨è¾¾å¼å¯ä»¥åœ¨ç¼–è¯‘å™¨æ±‚å€¼ï¼›å¸¸é‡å€¼å¯ä»£æ›¿å¸¸é‡å˜é‡ï¼›è¿‡ç¨‹çš„éƒ¨åˆ†å‚æ•°æ˜¯å¸¸é‡ï¼Œå‡å°‘æ¶‰åŠçŠ¶æ€å‘é‡çš„å¤§å°å¯ä»¥é¿å…ä»£ç çš„æ‰©å±•ç­‰å†…å®¹ã€‚å…·ä½“å¯å‚è€ƒ<a href="https://blog.csdn.net/qq_36287943/article/details/104974597">è¿™é‡Œ</a>ã€‚</li><li><strong>è¿”å›åˆ†æ</strong>ï¼šéªŒè¯æ¯ä¸ªæ–¹æ³•åœ¨æ¯ä¸ªä»£ç è·¯å¾„åªè¿”å›ä¸€ä¸ªå€¼ï¼Œå¹¶ä¸”ä¸ä¼šåœ¨å®šä¹‰çš„æœ«ç«¯å‡ºç°æ— è¿”å›å€¼çš„é”™è¯¯ã€‚</li><li><strong>ä¸´ç•Œæ‹†åˆ†</strong>ï¼šä¸æ”¯æŒä»»æ„çš„åŸºç¡€blockå‚æ•°é€šè¿‡ç»ˆç«¯è¿›è¡Œä¸´ç•Œæ‹†åˆ†ï¼Œä½¿å¾—è¿ç®—æ›´åŠ é«˜æ•ˆã€‚</li></ul><h3 id="ä¼˜åŒ–SIL"><a href="#ä¼˜åŒ–SIL" class="headerlink" title="ä¼˜åŒ–SIL"></a>ä¼˜åŒ–SIL</h3><p>å‘½ä»¤ï¼š<code>swiftc -emit-sil main.swift &gt;&gt; ./main.sil -O</code></p><p>ä¹Ÿæ˜¯åœ¨ä¸ä¸Šä¸€æ­¥å‘½ä»¤ç›¸åŒï¼Œä½†åŠ ä¸Š -Oå‚æ•°ï¼Œè¿™ä¸€æ­¥ä¸æ˜¯å¿…è¦çš„ï¼Œå¦‚æœåœ¨ <strong>Xcode</strong> ä¸­è®¾ç½® -Ononeï¼Œåˆ™ä¸ä¼šè¿›è¡Œã€‚</p><p>ç‰¹å®šä¼˜åŒ–ï¼š</p><ul><li>æ³›å‹ç‰¹åŒ–ï¼šåˆ†ææ³›å‹å‡½æ•°çš„ç‰¹å®šè°ƒç”¨ï¼Œå¹¶ç”Ÿæˆæ–°çš„ç‰¹å®šç‰ˆæœ¬çš„å‡½æ•°ï¼Œå°†æ³›å‹çš„ç‰¹å®šç”¨æ³•å…¨éƒ¨é‡å†™ä¸ºå¯¹åº”çš„ç‰¹å®šå‡½æ•°è°ƒç”¨ã€‚</li><li><strong>witness</strong>å’Œè™šå‡½æ•°è¡¨çš„å»è™šæ‹ŸåŒ–ï¼šé€šè¿‡ç»™å®šç±»å‹å»æŸ¥æ‰¾å…³è”çš„ç±»çš„è™šå‡½æ•°è¡¨æˆ–è€…ç±»å‹çš„witnessè¡¨ï¼Œå¹¶å°†è™šå‡½æ•°è°ƒç”¨æ›¿æ¢ä¸ºè°ƒç”¨å‡½æ•°æ˜ å°„ï¼Œç®€åŒ–äº†æŸ¥æ‰¾æµç¨‹ä»è€Œæé«˜äº†æ•ˆç‡ã€‚</li><li><strong>æ€§èƒ½å†…è”</strong></li><li><strong>å¼•ç”¨è®¡æ•°ä¼˜åŒ–</strong></li><li><strong>å†…å­˜æå‡/ä¼˜åŒ–</strong></li><li><strong>é«˜çº§é¢†åŸŸç‰¹å®šä¼˜åŒ–</strong>ï¼šswiftç¼–è¯‘å™¨å¯¹åŸºç¡€çš„swiftç±»å‹å®¹å™¨(ç±»ä¼¼Arrayæˆ–String)å®ç°äº†é«˜çº§ä¼˜åŒ–ï¼Œå¦‚ <strong>Copy On Wirte</strong>ã€‚</li></ul><h3 id="IRä»£ç ç”Ÿæˆ"><a href="#IRä»£ç ç”Ÿæˆ" class="headerlink" title="IRä»£ç ç”Ÿæˆ"></a>IRä»£ç ç”Ÿæˆ</h3><p>å‘½ä»¤ï¼š<code>swiftc -emit-ir main.swift &gt;&gt; ./main.ir</code></p><pre><code class="swift">; ModuleID = '&lt;swift-imported-modules&gt;'source_filename = "&lt;swift-imported-modules&gt;"target datalayout = "e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"target triple = "x86_64-apple-macosx12.0.0"%T4main6PersonC = type &lt;{ %swift.refcounted, %TSS }&gt;%swift.refcounted = type { %swift.type*, i64 }%swift.type = type { i64 }%TSS = type &lt;{ %Ts11_StringGutsV }&gt;%Ts11_StringGutsV = type &lt;{ %Ts13_StringObjectV }&gt;%Ts13_StringObjectV = type &lt;{ %Ts6UInt64V, %swift.bridge* }&gt;%Ts6UInt64V = type &lt;{ i64 }&gt;%swift.bridge = type opaque%swift.full_type = type { i8**, %swift.type }%objc_class = type { %objc_class*, %objc_class*, %swift.opaque*, %swift.opaque*, i64 }%swift.opaque = type opaque%swift.method_descriptor = type { i32, i32 }%swift.type_metadata_record = type { i32 }%swift.metadata_response = type { %swift.type*, i64 }%"$s4main6PersonC4nameSSvM.Frame" = type { [24 x i8] }%Any = type { [24 x i8], %swift.type* }%TSa = type &lt;{ %Ts12_ArrayBufferV }&gt;%Ts12_ArrayBufferV = type &lt;{ %Ts14_BridgeStorageV }&gt;%Ts14_BridgeStorageV = type &lt;{ %swift.bridge* }&gt;</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œç”Ÿæˆçš„è¯­æ³•ç»“æ„å’Œ <strong>Objective-C</strong> æ–‡ä»¶ç”Ÿæˆçš„ç»“æ„ä¸€è‡´ã€‚</p><p>è‡³æ­¤ï¼Œ<strong>SwiftC</strong> ç¼–è¯‘æµç¨‹å°±å·²ç»å…¨éƒ¨æ¢³ç†å®Œäº†ï¼Œå…¶ä¸­è¿˜æœ‰ <strong>clang importer</strong> æ¨¡å—çš„å·¥ä½œå¹¶æœªä»‹ç»ï¼Œ<strong>clang importer</strong> è´Ÿè´£å¯¼å…¥ <strong>Clang</strong> æ¨¡å—ï¼Œå¹¶å°† <strong>C</strong> æˆ– <strong>Objective-C</strong> çš„APIæ˜ å°„åˆ° <strong>Swift API</strong> ä¸­ã€‚</p><h2 id="SIL-ä»‹ç»"><a href="#SIL-ä»‹ç»" class="headerlink" title="SIL ä»‹ç»"></a>SIL ä»‹ç»</h2><p><strong>Swift</strong> ä¸­é—´è¯­è¨€ï¼ˆSwift Intermediate Languageï¼ŒSILï¼‰æ˜¯ä¸€é—¨é«˜çº§ä¸”ä¸“ç”¨äº Swift çš„ä¸­é—´è¯­è¨€ï¼Œé€‚ç”¨äºå¯¹ Swift ä»£ç çš„è¿›ä¸€æ­¥åˆ†æå’Œä¼˜åŒ–ã€‚SIL ä¾èµ–äº Swift çš„ç±»å‹ç³»ç»Ÿå’Œå£°æ˜ï¼Œæ‰€ä»¥ SIL è¯­æ³•æ˜¯ Swift çš„å»¶ä¼¸ã€‚ä¸€ä¸ª <code>.sil</code> æ–‡ä»¶æ˜¯ä¸€ä¸ªå¢åŠ äº† SIL å®šä¹‰çš„ Swift æºæ–‡ä»¶ã€‚ <code>.swift</code> æºæ–‡ä»¶åªé’ˆå¯¹å£°æ˜è¿›è¡Œè¯­æ³•åˆ†æï¼Œå…¶ <code>func</code> æ–¹æ³•ä½“å’Œæœ€é«˜é˜¶ä»£ç å°†ä¼šè¢« SIL è¯­æ³•åˆ†æå™¨å¿½ç•¥ã€‚ åœ¨ <code>.sil</code> æ–‡ä»¶ä¸­æ²¡æœ‰éšå¼ importã€‚å¦‚æœä½¿ç”¨ swift æˆ–è€… Buildin æ ‡å‡†ç»„ä»¶çš„è¯å¿…é¡»æ˜ç¡®çš„å¼•ç”¨ã€‚</p><h3 id="åœ°å€ç±»å‹"><a href="#åœ°å€ç±»å‹" class="headerlink" title="åœ°å€ç±»å‹"></a>åœ°å€ç±»å‹</h3><p>åœ°å€ç±»å‹ <code>$*T</code> æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä»»æ„å¼•ç”¨çš„å€¼æˆ–è€… <code>$T</code>ã€‚åœ°å€ä¸æ˜¯å¼•ç”¨è®¡æ•°æŒ‡é’ˆï¼Œä¸èƒ½è¢« <code>retained</code> æˆ–<code>released</code>ã€‚</p><h3 id="Boxç±»å‹"><a href="#Boxç±»å‹" class="headerlink" title="Boxç±»å‹"></a>Boxç±»å‹</h3><p>æœ¬åœ°å˜é‡å’Œéç›´æ¥çš„æ•°å€¼ç±»å‹éƒ½æ˜¯å­˜å‚¨åœ¨å †ä¸Šï¼Œ@box T æ˜¯ä¸€ä¸ªå¼•ç”¨è®¡æ•°ç±»å‹ï¼ŒæŒ‡å‘çš„æ˜¯åŒ…å«äº†å¤šä¸ª T çš„ç›’å­ã€‚ç›’å­ä½¿ç”¨çš„æ˜¯ Swift çš„åŸç”Ÿå¼•ç”¨è®¡æ•°ã€‚</p><h3 id="Metatype-ç±»å‹"><a href="#Metatype-ç±»å‹" class="headerlink" title="Metatype ç±»å‹"></a>Metatype ç±»å‹</h3><p>SIL å†…çš„ <code>metatype</code> ç±»å‹å¿…é¡»æè¿°è‡ªèº«è¡¨ç¤ºï¼š</p><ul><li><code>@thin</code> è¡¨ç¤ºä¸éœ€è¦å†…å­˜ç©ºé—´</li><li><code>@thick</code> æŒ‡å­˜å‚¨çš„æ˜¯ç±»å‹çš„å¼•ç”¨æˆ–è€…ç±»å‹å­ç±»çš„å¼•ç”¨</li><li><code>@objc</code> æŒ‡å­˜å‚¨çš„æ˜¯ä¸€ä¸ª OC ç±»å¯¹è±¡çš„è¡¨ç¤ºã€‚</li></ul><h3 id="VTables"><a href="#VTables" class="headerlink" title="VTables"></a>VTables</h3><p>ç”¨æ¥è¡¨ç¤ºç±»å¯¹è±¡æ–¹æ³•çš„åŠ¨æ€æ´¾å‘ï¼Œå¦‚æœçœ‹åˆ° SIL ä»£ç ä¸­å‡ºç° <code>class_method</code> æˆ–è€… <code>super_method</code>ï¼Œè¿™äº›éƒ½æ˜¯é€šè¿‡ <code>sil_vtable</code> è¿›è¡Œè¿½è¸ªçš„ï¼›<code>sil_table</code> ä¸­åŒ…å«ç±»å¯¹è±¡ä¸­çš„æ‰€æœ‰æ–¹æ³•çš„æ˜ å°„ï¼ŒåŒ…æ‹¬ä»çˆ¶å¯¹è±¡ç»§æ‰¿çš„æ–¹æ³•ã€‚</p><h3 id="Witness-Table"><a href="#Witness-Table" class="headerlink" title="Witness Table"></a>Witness Table</h3><p>ç”¨æ¥ä»£è¡¨æ³›å‹ç±»å‹çš„æ–¹æ³•åŠ¨æ€æ´¾å‘ï¼Œä¸€ä¸ªæ³›å‹ç±»å‹çš„æ‰€æœ‰çš„æ‰€æœ‰æ³›å‹å®ä¾‹å…±äº«ä¸€ä¸ª <code>Witness Table</code>ï¼ŒåŒæ ·è¡ç”Ÿç±»ä¹Ÿéƒ½ä¼šé›†æˆåŸºç±»çš„ <code>Witness Table</code>ã€‚</p><p>æ¯ä¸ªéµå¾ªåè®®çš„å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œä¼šç”Ÿæˆä¸€å¼  <code>Witness table</code>ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡æ¢³ç†äº† Swift çš„ç¼–è¯‘æµç¨‹ï¼Œå¯ä»¥çœ‹å‡ºï¼ŒSwift ä½œä¸ºä¸€ç§é«˜çº§çš„å®‰å…¨ç±»å‹è¯­è¨€ï¼Œç¼–è¯‘å™¨å¯¹å…¶åšäº†è®¸å¤šä¼˜åŒ–ï¼Œç®—æ˜¯å¼¥è¡¥äº†å¯¹ Clang è®¸å¤šä¸è¶³ã€‚SIL æ˜¯ Swift ç¼–è¯‘çš„é‡ç‚¹ï¼Œä»ä¸­å¯ä»¥çª¥æ¢ä¸€äº›å¹³æ—¶å¼€å‘ä¸­éš¾ä»¥ç¢ç£¨çš„é—®é¢˜ï¼Œå¦‚æ–¹æ³•æ´¾å‘ã€å¼•ç”¨è®¡æ•°ç­‰å†…å®¹ã€‚ä»¥ä¸‹é™„swiftc çš„å‘½ä»¤è¡Œå¸®åŠ©ã€‚</p><pre><code class="shell">USAGE: swiftcMODES:  -dump-ast               Parse and type-check input file(s) and dump AST(s)  -dump-parse             Parse input file(s) and dump AST(s)  -dump-pcm               Dump debugging information about a precompiled Clang module  -dump-scope-maps &lt;expanded-or-list-of-line:column&gt;                          Parse and type-check input file(s) and dump the scope map(s)  -dump-type-info         Output YAML dump of fixed-size types from all imported modules  -dump-type-refinement-contexts                          Type-check input file(s) and dump type refinement contexts(s)  -emit-assembly          Emit assembly file(s) (-S)  -emit-bc                Emit LLVM BC file(s)  -emit-executable        Emit a linked executable  -emit-imported-modules  Emit a list of the imported modules  -emit-irgen             Emit LLVM IR file(s) before LLVM optimizations  -emit-ir                Emit LLVM IR file(s) after LLVM optimizations  -emit-library           Emit a linked library  -emit-object            Emit object file(s) (-c)  -emit-pcm               Emit a precompiled Clang module from a module map  -emit-sibgen            Emit serialized AST + raw SIL file(s)  -emit-sib               Emit serialized AST + canonical SIL file(s)  -emit-silgen            Emit raw SIL file(s)  -emit-sil               Emit canonical SIL file(s)  -emit-supported-features                          Emit a JSON file including all supported compiler features  -index-file             Produce index data for a source file  -parse                  Parse input file(s)  -print-ast              Parse and type-check input file(s) and pretty print AST(s)  -resolve-imports        Parse and resolve imports in input file(s)  -scan-dependencies      Scan dependencies of the given Swift sources  -typecheck              Parse and type-check input file(s)</code></pre><p>ğŸ”—ï¼š</p><p><a href="https://www.jianshu.com/p/c2880460c6cd">Swiftçš„é«˜çº§ä¸­é—´è¯­è¨€ï¼šSIL</a></p><p><a href="https://www.swift.org/swift-compiler/">Swift-Compiler å®˜æ–¹</a></p><p><a href="https://zhuanlan.zhihu.com/p/353732257">Swift - æºç ç¼–è¯‘</a></p><p><a href="https://blog.csdn.net/qq_36287943/article/details/104974597">ç¼–è¯‘ä¼˜åŒ–ä¹‹ - å¸¸æ•°ä¼ æ’­å…¥é—¨</a></p><p><a href="https://github.com/apple/swift/blob/2ddc92a51a4c6d216a9b2dc3a2e41e9b592afbdf/docs/SIL.rst">Apple - Swift Intermediate Language</a></p><p><a href="https://blog.csdn.net/Hello_Hwc/article/details/85226147">æ·±å…¥æµ…å‡ºiOSç¼–è¯‘</a></p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Compile </tag>
            
            <tag> Swift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS ç¼–è¯‘è¿‡ç¨‹</title>
      <link href="/2021/11/03/2021-11-03-iOS%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/"/>
      <url>/2021/11/03/2021-11-03-iOS%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å­¦ä¹  <strong>iOS</strong> ç¼–è¯‘è¿‡ç¨‹ï¼ˆ<strong>Compile</strong>ï¼‰æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½ç†è§£ä»£ç æ˜¯å¦‚ä½•è¢«è®¡ç®—æœºè¿ä½œèµ·æ¥ï¼Œç¼–è¯‘å™¨ä¸ºä»£ç åšäº†å“ªäº›ä¼˜åŒ–ï¼Œè®©æˆ‘ä»¬å­¦ä¼šä»å¦ä¸€ä¸ªè§’åº¦æ¥çœ‹å¾…é—®é¢˜ã€‚</p><span id="more"></span><h2 id="ç¼–è¯‘å™¨ç»“æ„"><a href="#ç¼–è¯‘å™¨ç»“æ„" class="headerlink" title="ç¼–è¯‘å™¨ç»“æ„"></a>ç¼–è¯‘å™¨ç»“æ„</h2><p>ç°ä»£ç¼–è¯‘å™¨æ˜¯å°†æºä»£ç è½¬æ¢æˆå¯æ‰§è¡Œæ–‡ä»¶çš„ç¨‹åºï¼Œå·¥ä½œæµç¨‹ä¸»è¦åˆ†ä¸º <strong>å‰ç«¯</strong> å’Œ <strong>åç«¯</strong> ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>å‰ç«¯ï¼šå¯¹æºä»£ç è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆä¸­é—´ä»£ç ã€‚</li><li>åç«¯ï¼šé’ˆå¯¹ä¸­é—´ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå¹¶è½¬æ¢æˆç›®æ ‡æœºå™¨çš„ä»£ç æŒ‡ä»¤ã€‚</li></ol><pre class="mermaid">graph LR    A(SourceCode) --&gt; B(Frontend)    B(Frontend) --&gt; C(Backend)    C(Backend) --&gt; D(Machine Code)</pre><p>é’ˆå¯¹iOSå¹³å°ï¼Œä¸åŒè¯­è¨€é‡‡ç”¨äº†ä¸åŒçš„ç¼–è¯‘å™¨å‰ç«¯ï¼š</p><ol><li><p><strong>Frontendï¼šClang / SwiftC</strong></p><p>å¯¹äº <strong>Objective-C / C / C++ / Objective-C++</strong>  æ¥è¯´é‡‡ç”¨ <strong>Clang</strong> ç¼–è¯‘å™¨å‰ç«¯ï¼›</p><p>å¯¹äº <strong>Swift</strong> æ¥è¯´åˆ™é‡‡ç”¨ <strong>SwiftC</strong>ï¼›</p></li><li><p><strong>Backendï¼šLLVM</strong></p><p>æ— è®ºæ˜¯ <strong>C</strong> ç³»è¯­è¨€è¿˜æ˜¯ <strong>Swift</strong> éƒ½é‡‡ç”¨ <strong>LLVM</strong> ä½œä¸ºç¼–è¯‘å™¨åç«¯ï¼›</p></li></ol><p>å€¼å¾—æ³¨æ„çš„æ˜¯åœ¨ <strong>Xcode3</strong> ä»¥å‰ï¼Œéƒ½é‡‡ç”¨ <strong>GCC</strong> ä½œä¸ºç¼–è¯‘å™¨å‰ç«¯ï¼Œä½†ä¸º <strong>Apple</strong> å¿«é€Ÿå‘å±•éœ€è¦åŠŸèƒ½æ›´å¼ºå¤§å’Œæ€§èƒ½æ›´å¥½çš„ç¼–è¯‘å™¨ï¼Œæ‰€ä»¥ <strong>Apple</strong> è‡ªå·±å¼€å‘äº† <strong>Clang</strong> ä½œä¸ºç¼–è¯‘å™¨å‰ç«¯ã€‚ä¸‹é¢å¯¹ç¼–è¯‘å™¨åšä¸€ä¸ªç®€è¦ä»‹ç»ï¼š</p><ul><li><strong>GCC</strong></li></ul><p><strong>GCC</strong>ï¼ˆ<strong>GNU Compile Collection</strong>ï¼Œ**GNU **ç¼–è¯‘å™¨å¥—è£…ï¼‰ï¼Œæ˜¯ä¸€å¥—ç”± <strong>GNU</strong> å¼€å‘çš„ç¼–ç¨‹è¯­è¨€ç¼–è¯‘å™¨ã€‚æ¥æœ¬åªèƒ½å¤„ç† <em>C</em> è¯­è¨€ï¼Œåæ¥å¿«é€Ÿæ¼”è¿›ï¼Œå˜å¾—å¯å¤„ç† <strong>C++ã€Objective-Cã€Javaã€Fortran</strong> ç­‰å…¶ä»–è¯­è¨€ã€‚ä½†ç”±äºä¸€äº›ç¼ºé™·ï¼Œå¯¼è‡´äº† <strong>Apple</strong> æŠ›å¼ƒäº† <strong>GCC</strong> ï¼Œå¼€å‘å‡ºäº† <strong>Clang</strong> ä½œä¸ºå…¶å‰ç«¯ç¼–è¯‘å™¨ã€‚</p><ol><li><strong>GCC</strong> çš„ <strong>Objective-C Frontend</strong> ä¸æ˜¯ <strong>Apple</strong> ç»´æŠ¤ï¼Œå¯¼è‡´æƒ³è¦æ·»åŠ ä¸€äº›è¯­æ³•æç¤ºç­‰åŠŸèƒ½å¾—å»è¦æ±‚ <strong>GCC</strong> å›¢é˜Ÿåšã€‚</li><li><strong>GCC</strong> çš„æ’ä»¶ã€å·¥å…·ã€<strong>IDE</strong> çš„æ”¯æŒè–„å¼±ã€‚</li><li><strong>GCC</strong> çš„ç¼–è¯‘æ•ˆç‡å’Œæ€§èƒ½ä¸è¶³ã€‚</li></ol><ul><li><strong>Clang</strong></li></ul><p><strong>Clang1.0</strong> äº <strong>2009</strong> å¹´æ­£å¼ä¸ <strong>LLVM2.6</strong> æ­£å¼å‘å¸ƒï¼Œæ—¨åœ¨æä¾› <strong>GCC</strong> çš„æ›¿ä»£å“ï¼Œæ”¯æŒäº† <strong>GUN</strong> ç¼–è¯‘å™¨å¤§å¤šæ•°çš„ç¼–è¯‘å™¨è®¾ç½®ä»¥åŠéå®˜æ–¹è¯­è¨€çš„æ‹“å±•ï¼Œç›¸è¾ƒäº <strong>GCC</strong> ï¼Œ<strong>Clang</strong> å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ol><li>ç¼–è¯‘é€Ÿåº¦æ›´å¿«ã€‚</li><li>å ç”¨å†…å­˜æ›´å°ã€‚</li><li>æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‹“å±•ä¸é‡ç”¨ã€‚</li><li>è¯Šæ–­ä¿¡æ¯å¯è¯»æ€§å¼ºã€‚</li></ol><ul><li><strong>SwiftC</strong></li></ul><p><strong>SwiftC</strong> åœ¨å‰ç«¯é‡‡ç”¨äº† <strong>SIL</strong> ä¸­é—´è¯­è¨€ï¼Œè¿™æ˜¯å› ä¸º <strong>Swift</strong> ä½œä¸ºä¸€ç§é«˜çº§è¯­è¨€ï¼Œæœ‰è®¸å¤šç‰¹æ€§ï¼Œå¦‚ <strong>protocol</strong> çš„æ³›å‹ï¼Œä¹Ÿæ˜¯ä¸€é—¨å®‰å…¨çš„è¯­è¨€ï¼Œç¡®ä¿å˜é‡åœ¨ä½¿ç”¨ä¹‹å‰è¢«åˆå§‹åŒ–ã€æ£€æµ‹ä¸å¯æ‰§è¡Œçš„ä»£ç ï¼Œäºæ˜¯å¢åŠ äº†ä¸€å±‚ <strong>SIL</strong> æ¥åšè¿™äº›äº‹æƒ…ã€‚</p><ul><li><strong>LLVM</strong></li></ul><p><strong>LLVM</strong> æ˜¯ä¸€å¥—ç¼–è¯‘å™¨åŸºç¡€è®¾å¤‡é¡¹ç›®ï¼Œç”± <strong>C++</strong> å†™æˆï¼ŒåŒ…å«ä¸€ç³»åˆ—æ¨¡å—åŒ–çš„ç¼–è¯‘å™¨ç»„ä»¶å’Œå·¥å…·é“¾ï¼Œç”¨æ¥å¼€å‘ç¼–è¯‘å™¨çš„å‰ç«¯å’Œåç«¯ã€‚åœ¨ <strong>iOS</strong> ä¸­ï¼Œ<strong>LLVM</strong> ä½œä¸ºç¼–è¯‘å™¨åç«¯ä¸»è¦æä¾› <strong>Optimizer</strong> å’Œ <strong>Code Generator</strong> ï¼Œå°†æ¥æ”¶åˆ°çš„ <strong>IR</strong> ä¸­é—´ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œä»¥åŠæœºå™¨ä»£ç ç”Ÿæˆã€‚</p><h2 id="ç¼–è¯‘è¿‡ç¨‹"><a href="#ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘è¿‡ç¨‹"></a>ç¼–è¯‘è¿‡ç¨‹</h2><h3 id="æµç¨‹æ¢³ç†"><a href="#æµç¨‹æ¢³ç†" class="headerlink" title="æµç¨‹æ¢³ç†"></a>æµç¨‹æ¢³ç†</h3><pre class="mermaid">graph TD    subgraph Clang    id1(æºä»£ç ) --&gt; id2(é¢„å¤„ç†)     id2(é¢„å¤„ç†) --&gt; id3(è¯­æ³•åˆ†æ)       id3(è¯æ³•åˆ†æ) --  token  --&gt; id4(è¯­æ³•åˆ†æ)    id4(è¯­æ³•åˆ†æ) --  AST  --&gt; id5(ä¸­é—´ä»£ç ç”Ÿæˆ)    end        subgraph Optimizer, Backend    id6(ä¸­é—´ä»£ç ä¼˜åŒ–) --&gt; id7(BitCodeç”Ÿæˆ)    id7(BitCodeç”Ÿæˆ) --&gt; id8(æ±‡ç¼–æŒ‡ä»¤ç”Ÿæˆ)    id8(æ±‡ç¼–æŒ‡ä»¤ç”Ÿæˆ) --&gt; id9(æœºå™¨ç ç”Ÿæˆ)    id9(æœºå™¨ç ç”Ÿæˆ) --&gt; id11(é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶)    end        subgraph SwiftC    id12(æºä»£ç ) --&gt; id13(è§£æ)    id13(è§£æ) --&gt; id14(è¯­ä¹‰åˆ†æ)    id14(è¯­ä¹‰åˆ†æ) --&gt; id16(Raw SILç”Ÿæˆ)    id16(Raw SILç”Ÿæˆ) --&gt; id17(Canonical SILç”Ÿæˆ)    id17 --&gt; id18(SILä¼˜åŒ–)    id18(SILä¼˜åŒ–) --&gt; id19(ä¸­é—´ä»£ç ç”Ÿæˆ)    end        id5 --  IR  --&gt; id6    id19 --  IR  --&gt; id6</pre><p>åœ¨å‰ç«¯ <strong>Objective-C</strong> å’Œ <strong>Swift</strong> åˆ†åˆ«ç”±è‡ªå·±çš„å¤„ç†é˜¶æ®µï¼Œä½†æœ€åéƒ½ä¼šç”Ÿæˆ <strong>IR</strong> ä¸­é—´ä»£ç ï¼Œäº¤ç”±åç«¯è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„.mæ–‡ä»¶è¿›è¡Œç¼–è¯‘è¿‡ç¨‹æ¢³ç†ï¼Œé¦–å…ˆåœ¨æŸä¸€ä¸ªç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª <strong>nihao.m</strong>æ–‡ä»¶</p><pre><code class="shell">touch nihao.m</code></pre><p><strong>nihao.mï¼š</strong></p><pre><code class="objective-c">#import &lt;Foundation/Foundation.h&gt;int main(int argc, char *argv[]){    @autoreleasepool {        NSLog(@"nihao!!!");        return 0;    }}</code></pre><h3 id="Clangé˜¶æ®µï¼ˆObjective-C-C-C-Objective-C-ï¼‰"><a href="#Clangé˜¶æ®µï¼ˆObjective-C-C-C-Objective-C-ï¼‰" class="headerlink" title="Clangé˜¶æ®µï¼ˆObjective-C / C++ / C / Objective-C++ï¼‰"></a>Clangé˜¶æ®µï¼ˆObjective-C / C++ / C / Objective-C++ï¼‰</h3><h4 id="é¢„å¤„ç†é˜¶æ®µï¼š"><a href="#é¢„å¤„ç†é˜¶æ®µï¼š" class="headerlink" title="é¢„å¤„ç†é˜¶æ®µï¼š"></a>é¢„å¤„ç†é˜¶æ®µï¼š</h4><pre><code class="shell">xcrun clang -E helloworld.c | open -f</code></pre><pre><code># 1 "nihao.m"# 1 "&lt;built-in&gt;" 1# 1 "&lt;built-in&gt;" 3# 380 "&lt;built-in&gt;" 3# 1 "&lt;command line&gt;" 1# 1 "&lt;built-in&gt;" 2# 1 "nihao.m" 2# 1 "/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h" 1 3.........int main(int argc, char *argv[]){    @autoreleasepool {        NSLog(@"nihao!!!");        return 0;    }}</code></pre><p>å°†é¢„å¤„ç†é˜¶æ®µè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œ å¯ä»¥çœ‹åˆ°å¾ˆå¤šä»¥ <strong>#</strong> å¼€å¤´çš„è¯­å¥ï¼Œè¿™äº›è¯­å¥å‘Šè¯‰æˆ‘ä»¬åé¢è·Ÿç€çš„å†…å®¹æ¥è‡ªå“ªé‡Œï¼Œè¿™é‡Œå¯ä»¥çœ‹è§ <strong>Foundation.h</strong> æ–‡ä»¶çš„å†…å®¹ä¹ŸåŒ…å«äº†è¿›æ¥ã€‚åœ¨ <strong>Xcode</strong> ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <strong>Product -&gt;  Perfrom Action -&gt; Preprocess</strong> æŸ¥çœ‹é¢„å¤„ç†é˜¶æ®µä¹‹åçš„ä»£ç ã€‚åœ¨é¢„å¤„ç†é˜¶æ®µåšäº†ä»¥ä¸‹è¿™äº›äº‹æƒ…ï¼š</p><ul><li>å°†å¤´æ–‡ä»¶å¼•å…¥çš„å…¶ä»–æ–‡ä»¶åŠ å…¥æºæ–‡ä»¶ä¸­ï¼Œæ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ã€‚</li><li>è¿›è¡Œæ¡ä»¶ç¼–è¯‘å¤„ç†ã€‚</li><li>å°†å®å®šä¹‰ç›´æ¥æ›¿æ¢ï¼Œä¸è¿›è¡Œè¯­æ³•æ£€æŸ¥ã€‚</li><li>å°†æ³¨é‡Šè¿›è¡Œåˆ é™¤å¤„ç†ã€‚</li></ul><h4 id="è¯æ³•åˆ†æé˜¶æ®µ"><a href="#è¯æ³•åˆ†æé˜¶æ®µ" class="headerlink" title="è¯æ³•åˆ†æé˜¶æ®µ"></a>è¯æ³•åˆ†æé˜¶æ®µ</h4><pre><code class="shell">xcrun clang -fmodules -fsyntax-only -Xclang -dump-tokens nihao.m</code></pre><pre><code>annot_module_include '#import &lt;Foundation/Foundation.h&gt;'        Loc=&lt;nihao.m:1:1&gt;int 'int'     [StartOfLine]    Loc=&lt;nihao.m:3:1&gt;identifier 'main'     [LeadingSpace]    Loc=&lt;nihao.m:3:5&gt;l_paren '('        Loc=&lt;nihao.m:3:9&gt;int 'int'        Loc=&lt;nihao.m:3:10&gt;identifier 'argc'     [LeadingSpace]    Loc=&lt;nihao.m:3:14&gt;comma ','        Loc=&lt;nihao.m:3:18&gt;char 'char'     [LeadingSpace]    Loc=&lt;nihao.m:3:20&gt;star '*'     [LeadingSpace]    Loc=&lt;nihao.m:3:25&gt;identifier 'argv'        Loc=&lt;nihao.m:3:26&gt;l_square '['        Loc=&lt;nihao.m:3:30&gt;r_square ']'        Loc=&lt;nihao.m:3:31&gt;r_paren ')'        Loc=&lt;nihao.m:3:32&gt;l_brace '{'     [StartOfLine]    Loc=&lt;nihao.m:4:1&gt;at '@'     [StartOfLine] [LeadingSpace]    Loc=&lt;nihao.m:5:5&gt;identifier 'autoreleasepool'        Loc=&lt;nihao.m:5:6&gt;...</code></pre><p>è¯æ³•åˆ†æé˜¶æ®µå…¶å®æ˜¯å°†æºä»£ç ä»¥å­—ç¬¦æ–‡æœ¬çš„å½¢å¼è½¬æ¢æˆ <strong>Token</strong> æµçš„å½¢å¼ï¼Œä¸æ¶‰åŠè¯­ä¹‰æ ¡éªŒï¼Œç”¨æ¥æ ‡è¯†å‡ºè¿™ä¸ªå­—ç¬¦æ˜¯æ ‡è¯†ç¬¦ã€æ‹¬å·ã€ifè¯­å¥â€¦ï¼Œæœ€åè¿˜ä¼šæ ‡è¯†å‡ºå…¶æ‰€åœ¨ä½ç½®ï¼Œæ–¹ä¾¿åç»­åˆ†æèƒ½å¤Ÿæ‰¾å‡ºå‡ºé”™çš„åŸå§‹ä½ç½®ã€‚</p><h4 id="è¯­æ³•åˆ†æé˜¶æ®µ"><a href="#è¯­æ³•åˆ†æé˜¶æ®µ" class="headerlink" title="è¯­æ³•åˆ†æé˜¶æ®µ"></a>è¯­æ³•åˆ†æé˜¶æ®µ</h4><pre><code>xcrun clang -fsyntax-only -Xclang -ast-dump nihao.m | open -f</code></pre><pre><code>...`-FunctionDecl 0x7f9eb4bd61a0 &lt;nihao.m:3:1, line:9:1&gt; line:3:5 main 'int (int, char **)'  |-ParmVarDecl 0x7f9eb4bd5fc0 &lt;col:10, col:14&gt; col:14 argc 'int'  |-ParmVarDecl 0x7f9eb4bd6080 &lt;col:20, col:31&gt; col:26 argv 'char **':'char **'  `-CompoundStmt 0x7f9eb4bd63d0 &lt;line:4:1, line:9:1&gt;    `-ObjCAutoreleasePoolStmt 0x7f9eb4bd63b8 &lt;line:5:5, line:8:5&gt;      `-CompoundStmt 0x7f9eb4bd6398 &lt;line:5:22, line:8:5&gt;        |-CallExpr 0x7f9eb4bd6328 &lt;line:6:9, col:26&gt; 'void'        | |-ImplicitCastExpr 0x7f9eb4bd6310 &lt;col:9&gt; 'void (*)(id, ...)' &lt;FunctionToPointerDecay&gt;        | | `-DeclRefExpr 0x7f9eb4bd6250 &lt;col:9&gt; 'void (id, ...)' Function 0x7f9eb0c8d6c8 'NSLog' 'void (id, ...)'        | `-ImplicitCastExpr 0x7f9eb4bd6350 &lt;col:15, col:16&gt; 'id':'id' &lt;BitCast&gt;        |   `-ObjCStringLiteral 0x7f9eb4bd6290 &lt;col:15, col:16&gt; 'NSString *'        |     `-StringLiteral 0x7f9eb4bd6270 &lt;col:16&gt; 'char [9]' lvalue "nihao!!!"        `-ReturnStmt 0x7f9eb4bd6388 &lt;line:7:9, col:16&gt;          `-IntegerLiteral 0x7f9eb4bd6368 &lt;col:16&gt; 'int' 0</code></pre><p>è¯­æ³•åˆ†æé˜¶æ®µä¼šè¾“å‡º <strong>AST</strong>ï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œå®ƒæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚å®ƒä»¥æ ‘çŠ¶çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚é€šè¿‡å®ƒï¼Œå¯ä»¥è¿›è¡Œè¯­æ³•é”™è¯¯åˆ†æï¼Œä»¥åŠé™æ€åˆ†ææ“ä½œï¼Œæ¶µç›–å†…å­˜æ“ä½œå’Œå®‰å…¨ç­‰æ–¹é¢ã€‚</p><h4 id="CodeGené˜¶æ®µ"><a href="#CodeGené˜¶æ®µ" class="headerlink" title="CodeGené˜¶æ®µ"></a>CodeGené˜¶æ®µ</h4><pre><code class="shell">xcrun clang -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll</code></pre><pre><code>; ModuleID = 'nihao.m'source_filename = "nihao.m"target datalayout = "e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"target triple = "x86_64-apple-macosx11.0.0"%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }@__CFConstantStringClassReference = external global [0 x i32]@.str = private unnamed_addr constant [9 x i8] c"nihao!!!\00", section "__TEXT,__cstring,cstring_literals", align 1@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section "__DATA,__cfstring", align 8 #0; Function Attrs: noinline optnone ssp uwtabledefine i32 @main(i32 %0, i8** %1) #1 {  %3 = alloca i32, align 4  %4 = alloca i32, align 4  %5 = alloca i8**, align 8  store i32 0, i32* %3, align 4  store i32 %0, i32* %4, align 4  store i8** %1, i8*** %5, align 8  %6 = call i8* @llvm.objc.autoreleasePoolPush() #2  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*))  store i32 0, i32* %3, align 4  call void @llvm.objc.autoreleasePoolPop(i8* %6)  %7 = load i32, i32* %3, align 4  ret i32 %7}; Function Attrs: nounwinddeclare i8* @llvm.objc.autoreleasePoolPush() #2declare void @NSLog(i8*, ...) #3; Function Attrs: nounwinddeclare void @llvm.objc.autoreleasePoolPop(i8*) #2attributes #0 = { "objc_arc_inert" }attributes #1 = { noinline optnone ssp uwtable "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }attributes #2 = { nounwind }attributes #3 = { "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}!llvm.ident = !{!8}!0 = !{i32 2, !"SDK Version", [2 x i32] [i32 12, i32 0]}!1 = !{i32 1, !"Objective-C Version", i32 2}!2 = !{i32 1, !"Objective-C Image Info Version", i32 0}!3 = !{i32 1, !"Objective-C Image Info Section", !"__DATA,__objc_imageinfo,regular,no_dead_strip"}!4 = !{i32 1, !"Objective-C Garbage Collection", i8 0}!5 = !{i32 1, !"Objective-C Class Properties", i32 64}!6 = !{i32 1, !"wchar_size", i32 4}!7 = !{i32 7, !"PIC Level", i32 2}!8 = !{!"Apple clang version 13.0.0 (clang-1300.0.29.3)"}</code></pre><p><strong>CodeGen</strong> é˜¶æ®µè´Ÿè´£å°† <strong>AST</strong> è‡ªé¡¶å‘ä¸‹éå†é€æ­¥ç¿»è¯‘æˆ <strong>LLVM IR</strong>ï¼Œä¹Ÿå°±æ˜¯ç¼–è¯‘å™¨åç«¯æ‰€éœ€è¦çš„ä¸­é—´ä»£ç ï¼ŒåŒæ—¶ <strong>Objective-C</strong> ä»£ç ä¹Ÿä¼šåœ¨è¿™ä¸€æ­¥è¿›è¡Œ <strong>Runtime</strong> æ¡¥æ¥ï¼š <strong>property</strong> åˆæˆï¼Œ<strong>ARC</strong> å¤„ç†ç­‰ï¼Œå¦‚ä¸Šæ–¹å¯ä»¥çœ‹è§ <strong>autoreleasePoolPush</strong> ã€ <strong>autoreleasePoolPop</strong> æ“ä½œã€‚</p><p>è‡³æ­¤ <strong>Clang</strong> å‰ç«¯å·¥ä½œç®—æ˜¯å®Œæˆï¼Œæ¥ä¸‹æ¥å°±äº¤ç»™åç«¯è¿›è¡Œå¤„ç†ã€‚</p><h3 id="LLVM-Optimizer-é˜¶æ®µ"><a href="#LLVM-Optimizer-é˜¶æ®µ" class="headerlink" title="LLVM Optimizer é˜¶æ®µ"></a>LLVM Optimizer é˜¶æ®µ</h3><h4 id="IRä»£ç ä¼˜åŒ–"><a href="#IRä»£ç ä¼˜åŒ–" class="headerlink" title="IRä»£ç ä¼˜åŒ–"></a>IRä»£ç ä¼˜åŒ–</h4><pre><code class="shell">xcrun clang -Os -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll</code></pre><pre><code>; ModuleID = 'nihao.m'source_filename = "nihao.m"target datalayout = "e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"target triple = "x86_64-apple-macosx11.0.0"%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }@__CFConstantStringClassReference = external global [0 x i32]@.str = private unnamed_addr constant [9 x i8] c"nihao!!!\00", section "__TEXT,__cstring,cstring_literals", align 1@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section "__DATA,__cfstring", align 8 #0; Function Attrs: optsize ssp uwtabledefine i32 @main(i32 %0, i8** nocapture readnone %1) local_unnamed_addr #1 {  %3 = tail call i8* @llvm.objc.autoreleasePoolPush() #2  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*)) #4, !clang.arc.no_objc_arc_exceptions !9  tail call void @llvm.objc.autoreleasePoolPop(i8* %3) #2  ret i32 0}; Function Attrs: nounwinddeclare i8* @llvm.objc.autoreleasePoolPush() #2; Function Attrs: optsizedeclare void @NSLog(i8*, ...) local_unnamed_addr #3; Function Attrs: nounwinddeclare void @llvm.objc.autoreleasePoolPop(i8*) #2attributes #0 = { "objc_arc_inert" }attributes #1 = { optsize ssp uwtable "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }attributes #2 = { nounwind }attributes #3 = { optsize "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }attributes #4 = { optsize }!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}!llvm.ident = !{!8}!0 = !{i32 2, !"SDK Version", [2 x i32] [i32 12, i32 0]}!1 = !{i32 1, !"Objective-C Version", i32 2}!2 = !{i32 1, !"Objective-C Image Info Version", i32 0}!3 = !{i32 1, !"Objective-C Image Info Section", !"__DATA,__objc_imageinfo,regular,no_dead_strip"}!4 = !{i32 1, !"Objective-C Garbage Collection", i8 0}!5 = !{i32 1, !"Objective-C Class Properties", i32 64}!6 = !{i32 1, !"wchar_size", i32 4}!7 = !{i32 7, !"PIC Level", i32 2}!8 = !{!"Apple clang version 13.0.0 (clang-1300.0.29.3)"}!9 = !{}</code></pre><p><strong>IR</strong> ä»£ç ä¼˜åŒ–ä¼šè°ƒç”¨ç›¸åº” <strong>Pass</strong> è¿›è¡Œå¤„ç†ï¼Œ<strong>Pass</strong> ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼Œéƒ½æ˜¯ <strong>Pass</strong> ç±»çš„å­ç±»ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ç‰¹å®šçš„ä¼˜åŒ–ã€‚è¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿè‡ªä¸»çš„æ§åˆ¶ä¼˜åŒ–çš„å¼ºåº¦ï¼Œåœ¨<strong>Build Strrings -&gt; Optimization Level</strong> ä¸­å¯æŒ‡å®šä¼˜åŒ–ç¨‹åº¦ï¼Œä¸€äº›å¸¸è§çš„ä»£ç ä¼˜åŒ–æ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li>åˆ é™¤å…¬å…±å­è¡¨è¾¾å¼</li><li>åˆ é™¤æ— ç”¨ä»£ç </li><li>å¸¸é‡åˆå¹¶</li><li>ä»£ç ç§»åŠ¨</li><li>åˆ é™¤å½’çº³å˜é‡</li></ul><h4 id="ç”Ÿæˆ-BitCodeï¼ˆArchiveæ—¶ï¼‰"><a href="#ç”Ÿæˆ-BitCodeï¼ˆArchiveæ—¶ï¼‰" class="headerlink" title="ç”Ÿæˆ BitCodeï¼ˆArchiveæ—¶ï¼‰"></a>ç”Ÿæˆ BitCodeï¼ˆArchiveæ—¶ï¼‰</h4><pre><code class="shell">xrun clang -emit-llvm -c nihao.m -o nihao.bc</code></pre><pre><code>dec0 170b 0000 0000 1400 0000 0010 00000700 0001 4243 c0de 3514 0000 0700 0000620c 3024 9596 a6a5 f7d7 7f7d d3b4 4ffb76ef df3f 2d44 0132 0500 0000 210c 00004903 0000 0b02 2100 0200 0000 1600 00000781 2391 41c8 0449 0610 3239 9201 840c2505 0819 1e04 8b62 8014 4502 4292 0b42a410 3214 3808 184b 0a32 5288 4870 c421...</code></pre><p><strong>BitCode</strong> æ˜¯ <strong>LLVM</strong> å¼•å…¥çš„å¦ä¸€ç§ä¸­é—´ä»£ç ï¼Œè™½ç„¶çœ‹èµ·æ¥æ¯”è¾ƒæ¥è¿‘æœºå™¨ç ï¼Œä½†æ˜¯åœ¨å‡½æ•°å’ŒæŒ‡ä»¤å±‚é¢ä½¿ç”¨äº†å¾ˆå¤šé«˜çº§è¯­è¨€çš„ç‰¹æ€§ã€‚</p><p>ä½†åªä¼šåœ¨ <strong>Archive</strong> æ—¶ï¼Œ<strong>BitCode</strong> æ‰ä¼šè¢«åµŒå…¥åˆ°é“¾æ¥åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨äºæäº¤ç»™ <strong>App Store</strong>ï¼ŒåŒ…å« <strong>Bitcode</strong> é…ç½®çš„ç¨‹åºå°†ä¼šåœ¨ <strong>App Store</strong> ä¸Šè¢«é‡æ–°ç¼–è¯‘å’Œé“¾æ¥ï¼Œè¿›è€Œå¯¹å¯æ‰§è¡Œæ–‡ä»¶åšä¼˜åŒ–ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¼˜åŒ–è¿™ä¸€æ­¥æ˜¯åœ¨ <strong>App Store</strong> ä¸­åšçš„å¤„ç†ï¼Œæœ¬åœ°æ²¡æœ‰åšå¤„ç†ã€‚è¿›è¡Œå…¶ä»–ç±»å‹çš„ <strong>Build</strong> (é <strong>Archive</strong> )æ—¶ï¼Œç¼–è¯‘å™¨åªä¼šæ£€æŸ¥æ˜¯å¦æ»¡è¶³å¼€å¯ <strong>BitCode</strong> çš„æ¡ä»¶ï¼Œä½†å¹¶ä¸ä¼šçœŸæ­£ç”Ÿæˆ <strong>BitCode</strong> ã€‚</p><h3 id="LLVM-Code-Generatoré˜¶æ®µ"><a href="#LLVM-Code-Generatoré˜¶æ®µ" class="headerlink" title="LLVM Code Generatoré˜¶æ®µ"></a>LLVM Code Generatoré˜¶æ®µ</h3><h4 id="ç”Ÿæˆæ±‡ç¼–ä»£ç "><a href="#ç”Ÿæˆæ±‡ç¼–ä»£ç " class="headerlink" title="ç”Ÿæˆæ±‡ç¼–ä»£ç "></a>ç”Ÿæˆæ±‡ç¼–ä»£ç </h4><pre><code class="shell">xcrun clang -S -fobjc-arc nihao.m -o nihao.s</code></pre><pre><code>    .section    __TEXT,__text,regular,pure_instructions    .build_version macos, 11, 0    sdk_version 12, 0    .globl    _main                           ## -- Begin function main    .p2align    4, 0x90_main:                                  ## @main    .cfi_startproc## %bb.0:    pushq    %rbp    .cfi_def_cfa_offset 16    .cfi_offset %rbp, -16    movq    %rsp, %rbp    .cfi_def_cfa_register %rbp    subq    $32, %rsp    movl    $0, -4(%rbp)    movl    %edi, -8(%rbp)    movq    %rsi, -16(%rbp)    callq    _objc_autoreleasePoolPush    movq    %rax, -24(%rbp)                 ## 8-byte Spill    leaq    L__unnamed_cfstring_(%rip), %rdi    movb    $0, %al    callq    _NSLog    movq    -24(%rbp), %rdi                 ## 8-byte Reload    movl    $0, -4(%rbp)    callq    _objc_autoreleasePoolPop    movl    -4(%rbp), %eax    addq    $32, %rsp    popq    %rbp    retq    .cfi_endproc                                        ## -- End function    .section    __TEXT,__cstring,cstring_literalsL_.str:                                 ## @.str    .asciz    "nihao!!!"    .section    __DATA,__cfstring    .p2align    3                               ## @_unnamed_cfstring_L__unnamed_cfstring_:    .quad    ___CFConstantStringClassReference    .long    1992                            ## 0x7c8    .space    4    .quad    L_.str    .quad    8                               ## 0x8    .section    __DATA,__objc_imageinfo,regular,no_dead_stripL_OBJC_IMAGE_INFO:    .long    0    .long    64.subsections_via_symbols</code></pre><p>æ±‡ç¼–è¯­è¨€æ›´åŠ æ¥è¿‘æœºå™¨è¯­è¨€ï¼Œèƒ½å¤Ÿç›´æ¥å¯¹ç¡¬ä»¶è¿›è¡Œæ“ä½œï¼Œç”Ÿæˆçš„ç¨‹åºä¸å…¶ä»–çš„è¯­è¨€ç›¸æ¯”å…·æœ‰æ›´é«˜çš„è¿è¡Œé€Ÿåº¦ï¼Œå ç”¨æ›´å°çš„å†…å­˜ã€‚</p><p>ç›®å‰æ‰€æœ‰ <strong>iOS</strong> è®¾å¤‡éƒ½é‡‡ç”¨ <strong>ARM</strong> å¤„ç†å™¨ï¼Œè¿™æ„å‘³ç€éƒ½æ˜¯é‡‡ç”¨ <strong>ARM</strong> æŒ‡ä»¤é›†ï¼Œå¦‚ <strong>armv6 / armv7 / armv7s / arm64</strong>ï¼Œè¿™äº›æŒ‡ä»¤é›†éƒ½æ˜¯å‘ä¸‹å…¼å®¹çš„ã€‚</p><p>æ¯ç§ <strong>CPU</strong> æ¶æ„éƒ½æœ‰ç€ç›¸åº”çš„æŒ‡ä»¤é›†ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„æ¶æ„äº§ç”Ÿä¸åŒçš„æ±‡ç¼–æŒ‡ä»¤ï¼ŒåŠ ä¸Šä¸Šé¢ <strong>- arch arch_type</strong> é€‰é¡¹å³å¯ï¼Œæ›´å¤šè¯·å‚è§<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html">å®˜ç½‘</a>ã€‚åœ¨ <strong>Xcode</strong> ä¸­å¯åœ¨ <strong>Build Settings -&gt; Architectrues</strong> æŒ‡å®šäº§ç”Ÿçš„ <strong>CPU</strong> æŒ‡ä»¤é›†ã€‚</p><h4 id="ç”Ÿæˆæœºå™¨ä»£ç "><a href="#ç”Ÿæˆæœºå™¨ä»£ç " class="headerlink" title="ç”Ÿæˆæœºå™¨ä»£ç "></a>ç”Ÿæˆæœºå™¨ä»£ç </h4><pre><code class="shell">xcrun clang -fmodules -c nihao.s -o nihao.o</code></pre><p>å¯ä»¥å‘ç°æœºå™¨ç äºŒè¿›åˆ¶æ–‡ä»¶æ— æ³•é˜…è¯»ï¼Œå¯å€ŸåŠ© <strong>otool</strong> æˆ–è€… <strong>MachOView</strong> ç­‰å·¥å…·æŸ¥çœ‹æ–‡ä»¶ä¸­çš„ç›¸å…³å†…å®¹ï¼š</p><pre><code class="shell">otool -v -h nihao.o</code></pre><pre><code>nihao.o:Mach header      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flagsMH_MAGIC_64   X86_64        ALL  0x00      OBJECT     4        680 SUBSECTIONS_VIA_SYMBOLS</code></pre><p>å¯ä»¥çœ‹è§ <strong>.o</strong> æ–‡ä»¶å®é™…ä¸Šæ˜¯ <strong>mach-o</strong> æ ¼å¼ï¼Œè¿™é‡Œæˆ‘ä»¬è¾“å…¥å¯æ‰§è¡Œæ–‡ä»¶çš„å¤´éƒ¨ï¼Œè§„å®šäº†è¿™ä¸ªæ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Œé€‚åº”æ¶æ„çš„ç›¸å…³ä¿¡æ¯ï¼Œä»¥åŠæ–‡ä»¶æ˜¯å¦‚ä½•è¢«åŠ è½½çš„ã€‚æ›´å¤šå…³äº <strong>mach-o</strong> çš„çŸ¥è¯†<a href="https://www.jianshu.com/p/54d842db3f69">å‚è§</a>ã€‚</p><h4 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h4><pre><code class="shell">xcrun clang nihao.o -Wl,`xcrun --show-sdk-path`/System/Library/Frameworks/Foundation.framework/Foundation</code></pre><pre><code class="shell">./a.out</code></pre><pre><code>2021-11-03 16:06:41.734 a.out[6394:220026] nihao!!!</code></pre><p>ç”±äºæˆ‘ä»¬å¼•å…¥äº† <strong>Foundation</strong> é‡Œé¢çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦å°†ç›®æ ‡æ–‡ä»¶å’Œ <strong>Foundation framework</strong>è¿›è¡Œé“¾æ¥ï¼Œæ¥ç€å°±å¯ä»¥è¿è¡Œæˆ‘ä»¬çš„ç¨‹åºäº†ã€‚</p><p>è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼šç¬¦å·è¡¨ï¼Œé‡Œé¢å­˜å‚¨çš„å…ƒç´ å¦‚ä¸‹ï¼š</p><pre><code class="xml">&lt;èµ·å§‹åœ°å€&gt; &lt;ç»“æŸåœ°å€&gt; &lt;å‡½æ•°&gt; [&lt;æ–‡ä»¶å:è¡Œå·&gt;]</code></pre><p>è¿™é‡Œæˆ‘ä»¬è¾“å…¥a.outçš„ç¬¦å·ä¿¡æ¯</p><pre><code>nm -nm a.out</code></pre><pre><code>                 (undefined) external _NSLog (from Foundation)                 (undefined) external ___CFConstantStringClassReference (from CoreFoundation)                 (undefined) external _objc_autoreleasePoolPop (from libobjc)                 (undefined) external _objc_autoreleasePoolPush (from libobjc)                 (undefined) external dyld_stub_binder (from libSystem)0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header0000000100003f20 (__TEXT,__text) external _main0000000100008018 (__DATA,__data) non-external __dyld_private</code></pre><p>å¯¹äºåŠ¨æ€é“¾æ¥åº“çš„ç¬¦å·ï¼ˆå¦‚ <strong>Foundation</strong>ï¼‰ï¼Œæœ€ç»ˆä¼šè®°å½•ä¸‹è¿™ä¸ªç¬¦å·æ˜¯é€šè¿‡è¿›è¡Œé“¾æ¥çš„ï¼Œå¹¶è®°å½•ä¸‹ä¾èµ–äºå“ªä¸ªåŠ¨æ€é“¾æ¥åº“ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨ï¼ˆ<strong>dyld</strong>ï¼‰ä¼šå»è§£æè¿™äº› <strong>undefined</strong> ç¬¦å·ã€‚å¯¹äºå…¶ä»–ä½ç½®çš„ç¬¦å·ï¼Œä¼šç›´æ¥ä¿®æ­£è¿™äº›ç¬¦å·çš„å…·ä½“ä½ç½®ä¿¡æ¯ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä»‹ç»äº†å…³äº iOS ç¼–è¯‘å™¨ã€iOS ç¼–è¯‘è¿‡ç¨‹çš„åŸºç¡€çŸ¥è¯†ã€‚å­¦ä¹ äº†è¿™äº›ï¼Œå¯¹ iOS ç¼–è¯‘æœ‰ä¸ªæ•´ä½“è®¤è¯†ã€‚å°±æœ¬äººè€Œè¨€ï¼Œåœ¨ä¸€è·¯æœå¯»èµ„æ–™çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹ä¹‹å‰ä¸€äº›é›¶æ•£çš„çŸ¥è¯†ç‚¹æœ‰äº†ä¸€äº›æ›´åŠ æ·±å…¥çš„è®¤è¯†ã€‚ç”±äºç¯‡å¹…æœ‰é™ï¼Œå…³äº SwiftC çš„ç¼–è¯‘è¿‡ç¨‹æ²¡æœ‰å¤šåšä»‹ç»ï¼Œåé¢ä¼šå†å‡ºä¸€ç¯‡è¿›è¡Œä»‹ç»ã€‚</p><p>ğŸ”—ï¼š</p><p><a href="https://objccn.io/issue-6-3/">ObjC ä¸­å›½ - Mach-O å¯æ‰§è¡Œæ–‡ä»¶</a></p><p><a href="https://kiprey.github.io/2020/06/LLVM-IR-pass/">ä»£ç ä¼˜åŒ–ä¸LLVM IR pass</a></p><p><a href="http://xelz.info/blog/2018/11/24/all-you-need-to-know-about-bitcode/">å…³äºbitcode, çŸ¥é“è¿™äº›å°±å¤Ÿäº†</a></p><p><a href="https://zhuanlan.zhihu.com/p/340782811">iOS ç¼–è¯‘é“¾æ¥ï¼šObjective-C ç¼–è¯‘é“¾æ¥</a></p><p><a href="https://www.jianshu.com/p/54d842db3f69">è¶£æ¢ Mach-Oï¼šæ–‡ä»¶æ ¼å¼åˆ†æ</a></p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> Compile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NSTimerå¾ªç¯å¼•ç”¨åˆ†æä¸è§£å†³</title>
      <link href="/2021/09/29/2021-09-29-NSTimer%20%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3/"/>
      <url>/2021/09/29/2021-09-29-NSTimer%20%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æœ¬æ–‡å°†ä»å¦‚ä½•ä½¿ç”¨ <strong>NSTimer</strong> ã€ <strong>NSTimer</strong> ä½•ç§æƒ…å†µä¸‹ä¼šé€ æˆå¾ªç¯å¼•ç”¨ï¼Œä»¥åŠå¦‚ä½•é¿å…å¾ªç¯å¼•ç”¨å‡ ä¸ªè§’åº¦è¿›è¡Œä»‹ç»ã€‚</p><span id="more"></span><h3 id="NSTimer-å¦‚ä½•ä½¿ç”¨"><a href="#NSTimer-å¦‚ä½•ä½¿ç”¨" class="headerlink" title="NSTimer å¦‚ä½•ä½¿ç”¨"></a>NSTimer å¦‚ä½•ä½¿ç”¨</h3><blockquote><p>A timer that fires after a certain time interval has elapsed, sending a specified message to a target object.</p><p>ç¿»è¯‘ï¼šä¸€ç§è®¡æ—¶å™¨ï¼Œåœ¨ç»è¿‡ä¸€å®šçš„æ—¶é—´é—´éš”åè§¦å‘ï¼Œå‘ç›®æ ‡å¯¹è±¡å‘é€æŒ‡å®šçš„æ¶ˆæ¯ã€‚</p></blockquote><h4 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h4><p><strong>NSTimer</strong> æä¾›äº†ä¸‰ç§åˆ›å»ºæ–¹å¼ï¼š</p><ol><li><p>ä»¥ <code>scheduledTimerWithTimeInterval</code> ç±»æ–¹æ³•å¼€å¤´çš„åˆ›å»ºå®ä¾‹</p></li><li><p>ä»¥ <code>timerWithTimeInterval</code> å¼€å¤´çš„åˆ›å»ºå®ä¾‹</p></li><li><p>ä»¥ <code>init</code> æ–¹æ³•åˆå§‹åŒ–æ–¹æ³•åˆ›å»ºå®ä¾‹</p></li></ol><p>è‹¥é‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼åˆ›å»ºï¼Œä¼šä»¥ <strong>default mode</strong> æ–¹å¼è‡ªåŠ¨åŠ å…¥åˆ°å½“å‰çš„ <strong>RunLoop</strong> ä¸­ã€‚</p><p>è‹¥é‡‡ç”¨ç¬¬äºŒã€ä¸‰ç§æ–¹å¼åˆ›å»ºï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨NSRunLoopå¯¹è±¡çš„ <code>addTimer:forMode:</code> æ–¹æ³•ã€‚</p><pre><code class="swift">let timer = Timer.init(timeInterval: 1.0, repeats: true) { timer in   print("This")}RunLoop.main.add(timer, forMode: .default)</code></pre><h4 id="é”€æ¯"><a href="#é”€æ¯" class="headerlink" title="é”€æ¯"></a>é”€æ¯</h4><p><code>invalidate()</code> </p><p>è¯¥æ–¹æ³•æ˜¯åœ¨å…¶åŠ å…¥çš„ <strong>RunLoop</strong> å¯¹è±¡ä¸­ç§»é™¤timerçš„å”¯ä¸€æ–¹æ³•ï¼ŒåŒæ—¶ä¼š <strong>RunLoop</strong> å¯¹è±¡ä¼šç§»é™¤å…¶å¯¹å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œè‹¥é…ç½®äº† <strong>target</strong> å’Œ <strong>user info</strong> å¯¹è±¡ï¼Œ <strong>timer</strong> ä¹Ÿä¼šç§»é™¤å¯¹è¿™äº›å¯¹è±¡çš„å¼ºå¼•ç”¨ã€‚</p><h3 id="ä¸ºä½•ä¼šé€ æˆå¾ªç¯å¼•ç”¨"><a href="#ä¸ºä½•ä¼šé€ æˆå¾ªç¯å¼•ç”¨" class="headerlink" title="ä¸ºä½•ä¼šé€ æˆå¾ªç¯å¼•ç”¨"></a>ä¸ºä½•ä¼šé€ æˆå¾ªç¯å¼•ç”¨</h3><h4 id="å¾ªç¯å¼•ç”¨"><a href="#å¾ªç¯å¼•ç”¨" class="headerlink" title="å¾ªç¯å¼•ç”¨"></a>å¾ªç¯å¼•ç”¨</h4><p>è€ƒè™‘ä¸€ä¸ªå¸¸è§ä½¿ç”¨ <strong>NSTimer</strong> çš„åœºæ™¯ï¼šåœ¨ <strong>ViewController</strong> ä¸­å°† <strong>timer</strong> ä½œä¸ºå±æ€§ï¼Œè€Œ <strong>timer</strong> åœ¨åˆ›å»ºé‡‡ç”¨äº† <strong>target-action</strong> çš„æ–¹å¼ï¼Œæ ¹æ® <strong>Apple</strong> æ–‡æ¡£ï¼Œ<strong>timer</strong> ä¼šå¯¹ <strong>target</strong> äº§ç”Ÿå¼ºå¼•ç”¨ï¼Œè¿™å°±äº§ç”Ÿäº†æœ‰å‘ç¯ï¼Œå¯¼è‡´å¾ªç¯å¼•ç”¨ï¼Œä¸‹å›¾æ˜¯ä¸Šä¾‹å¯¹è±¡å¼•ç”¨å›¾ï¼š</p><img src="/images/blog/image-20210817112104936.png" alt="image-20210817112104936" style="zoom:40%;"><h4 id="RunLoopæŒæœ‰timer"><a href="#RunLoopæŒæœ‰timer" class="headerlink" title="RunLoopæŒæœ‰timer"></a>RunLoopæŒæœ‰timer</h4><p>è¿˜æ˜¯ä¸Šä¾‹çš„åœºæ™¯ï¼Œè‹¥åœ¨ <strong>timer</strong> åˆ›å»ºæ—¶ä¸é‡‡ç”¨ <strong>target-action</strong> ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥è§£å†³äº†ï¼Ÿ</p><p>ç¡®å®å¯ä»¥è§£å†³ï¼Œä½†è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç”±äº <strong>RunLoop</strong> å¯¹è±¡è¿˜æŒæœ‰ç€ <strong>timer</strong> å¯¹è±¡ï¼Œè¿™æ—¶ <strong>ViewController</strong> èƒ½è¢«æ­£å¸¸é‡Šæ”¾ï¼Œä½† <strong>timer</strong> çš„å¼•ç”¨è®¡æ•°ç”±äºä¸ä¸º <strong>1</strong> ï¼Œæ— æ³•è¢«é‡Šæ”¾ï¼Œè¿™ç§æƒ…å†µåªæ˜¯ <strong>timer</strong> æ— æ³•è¢«é‡Šæ”¾ï¼Œå¹¶ä¸ç®—å¾ªç¯å¼•ç”¨èŒƒç•´ï¼Œå½“ç„¶è‹¥ <strong>RunLoop</strong> å¯¹è±¡è¢«é‡Šæ”¾äº†ï¼Œåˆ™è¿™ä¸ª <strong>timer</strong> ä¹Ÿä¼šè¢«é‡Šæ”¾æ‰ã€‚</p><img src="/images/blog/image-20210817145841853.png" alt="image-20210817145841853" style="zoom:40%;"><p>å½“ç„¶æ­¤ä¸Šä¸¤ç§æƒ…å†µéƒ½æ˜¯å°† <strong>timer</strong> çš„ <code>repeat</code> å‚æ•°è®¾ç½®ä¸º <code>true</code> æ—¶ï¼Œè‹¥ä¸º <code>false</code> åˆ™åœ¨å®šæ—¶å™¨ç¬¬ä¸€æ¬¡è§¦å‘åï¼Œä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œå³ <strong>RunLoop</strong> ä¼šç§»é™¤å¯¹ <strong>timer</strong> çš„å¼ºå¼•ç”¨ï¼Œ <strong>timer</strong> ä¹Ÿä¼šç§»é™¤å¯¹ <strong>target</strong> å’Œ <strong>user info</strong> å¯¹è±¡çš„å¼ºå¼•ç”¨ã€‚</p><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><h4 id="åˆé€‚çš„æ—¶æœºè°ƒç”¨-invalidate"><a href="#åˆé€‚çš„æ—¶æœºè°ƒç”¨-invalidate" class="headerlink" title="åˆé€‚çš„æ—¶æœºè°ƒç”¨ invalidate()"></a>åˆé€‚çš„æ—¶æœºè°ƒç”¨ <code>invalidate()</code></h4><p>åœ¨ä¸Šæ–‡ä»‹ç»äº†<code>invalidate()</code> ï¼Œ æˆ‘ä»¬åªéœ€è¦åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨ <code>invalidate()</code>å³å¯ã€‚</p><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯åˆé€‚çš„æ—¶æœºå‘¢ï¼Ÿ</p><ol><li>è‹¥æ¸…æ¥šçŸ¥é“ä»€ä¹ˆæ—¶å€™ <strong>timer</strong> ä¸å†ä½¿ç”¨ï¼Œåˆ™åº”ç«‹å³è°ƒç”¨ã€‚</li><li>è‹¥ä¸æ¸…æ¥šåˆ™åº”ç ´é™¤å¾ªç¯å¼•ç”¨ï¼Œæœ€ååœ¨ <strong>ViewController</strong> çš„ <code>deinit</code> ä¸­è¿›è¡Œè°ƒç”¨ã€‚</li></ol><h4 id="é’ˆå¯¹å¾ªç¯å¼•ç”¨ï¼Œéœ€ç ´é™¤æœ‰å‘ç¯"><a href="#é’ˆå¯¹å¾ªç¯å¼•ç”¨ï¼Œéœ€ç ´é™¤æœ‰å‘ç¯" class="headerlink" title="é’ˆå¯¹å¾ªç¯å¼•ç”¨ï¼Œéœ€ç ´é™¤æœ‰å‘ç¯"></a>é’ˆå¯¹å¾ªç¯å¼•ç”¨ï¼Œéœ€ç ´é™¤æœ‰å‘ç¯</h4><ol><li>é‡‡ç”¨ <code>weak</code> å…³é”®å­—ä¿®é¥° <strong>timer</strong> ï¼Œä½†éœ€é‡‡ç”¨<code>scheduledTimerWithTimeInterval</code> ç±»æ–¹æ³•å¼€å¤´çš„åˆ›å»ºå®ä¾‹ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¼šå°† <strong>timer</strong> åŠ å…¥åˆ° <strong>RunLoop</strong> å¯¹è±¡ä¸­ï¼Œå¦åˆ™ç”±äº <code>weak</code> ä¿®é¥°ï¼Œ <strong>timer</strong> ä¼šè¢«è‡ªåŠ¨è®¾ä¸º<code>nil</code>ã€‚</li><li>é‡‡ç”¨ <code>weak</code> å…³é”®å­—ä¿®é¥° <strong>target</strong> å¯¹è±¡ï¼Œä½†éœ€åœ¨ <strong>block</strong> ä¸­è¿›è¡Œä½¿ç”¨ï¼ŒåŸç†å¤§æ¦‚æ˜¯ <strong>block</strong> ä¸­çš„ <strong>weakSelf</strong> ç›¸å½“äºä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œè¿›è€Œé˜»æ­¢äº†å¾ªç¯å¼•ç”¨ã€‚</li><li>é‡‡ç”¨ä¸­ä»‹è€…æ¨¡å¼ï¼Œè®©å…¶ä»–å¯¹è±¡æ‰¿æ‹… <code>target</code> è§’è‰²ï¼Œä»è€Œé˜»æ­¢å¾ªç¯å¼•ç”¨ã€‚</li><li>åŸºäº <strong>NSProxy</strong> æ–¹å¼ï¼Œä¸ <strong>3</strong> ç±»ä¼¼ï¼Œé€šè¿‡å…¶ä»–å¯¹è±¡æ¥é˜»æ­¢å¾ªç¯å¼•ç”¨ï¼Œéœ€æ³¨æ„çš„æ˜¯ <strong>NSProxy</strong> æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚</li><li>ä¹Ÿå¯ç›´æ¥ä½¿ç”¨ <strong>Apple</strong> æä¾›çš„æ–° <strong>API</strong>ï¼š</li></ol><pre><code class="swift">class func scheduledTimer(withTimeInterval interval: TimeInterval, repeats: Bool, block: @escaping (Timer) -&gt; Void) -&gt; Timerinit(timeInterval interval: TimeInterval, repeats: Bool, block: @escaping (Timer) -&gt; Void)convenience init(fire date: Date, interval: TimeInterval, repeats: Bool, block: @escaping (Timer) -&gt; Void)</code></pre><blockquote><p>the timer itself is passed as the parameter to this block when executed to aid in avoiding cyclical referencesã€‚</p><p>ç¿»è¯‘ï¼šåœ¨æ‰§è¡Œæ—¶ï¼Œå®šæ—¶å™¨æœ¬èº«ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿™ä¸ªå—ï¼Œä»¥å¸®åŠ©é¿å…å¾ªç¯å¼•ç”¨ã€‚</p></blockquote><h3 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h3><p><a href="https://juejin.cn/post/6844903968250789896#heading-5">iOSä¹‹NSTimerå¾ªç¯å¼•ç”¨çš„è§£å†³æ–¹æ¡ˆ</a></p><p><a href="https://www.jianshu.com/p/e8fc6c2b3afa">iOSä¸­Timerå¾ªç¯å¼•ç”¨åŸå› åŠè§£å†³æ–¹æ¡ˆ</a></p><p><a href="https://developer.apple.com/documentation/foundation/nstimer/">Appleæ–‡æ¡£ - NSTimer</a></p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NSTimer </tag>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸ä»¥åŠŸåˆ©ä¸ºç›®çš„</title>
      <link href="/2021/08/29/2021-11-9-%E4%B8%8D%E4%BB%A5%E5%8A%9F%E5%88%A9%E4%B8%BA%E7%9B%AE%E7%9A%84/"/>
      <url>/2021/08/29/2021-11-9-%E4%B8%8D%E4%BB%A5%E5%8A%9F%E5%88%A9%E4%B8%BA%E7%9B%AE%E7%9A%84/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©çªç„¶å¿ƒè¡€æ¥æ½®æƒ³å†™ç‚¹ä»€ä¹ˆï¼Œæœ¬æ¥çœ‹ç€ã€Šè®¡ç®—æœºç½‘ç»œ - è‡ªé¡¶å‘ä¸‹æ–¹æ³•ã€‹ã€‚çªç„¶è§‰å¾—æˆ‘ä¸ºä»€ä¹ˆè¦çœ‹æœ¬ä¹¦ï¼Œè¿™å°±è®©æˆ‘ä¸æ–­çš„åé—®ï¼Œä¸æ–­çš„åˆ¨æ ¹ï¼Œæˆ‘æ˜¯ä¸ºäº†é¢è¯•ã€ä¸ºäº†ç³»ç»Ÿçš„å­¦ä¹ ã€ä¸ºäº†å‘å…¶ä»–äººå±•ç¤ºä»€ä¹ˆâ€¦ï¼Œæœ€ç»ˆæˆ‘æƒ³åˆ°äº†ï¼Œæˆ‘åœ¨ä¹°è¿™æœ¬ä¹¦çš„æ—¶å€™ï¼Œæˆ‘ä»…æ˜¯ä¸ºäº†ç»™å¤§å­¦çš„è‡ªå·±è¡¥ä¸€ä¸‹é—æ†¾ï¼Œæ²¡æœ‰è¯»å‡ æœ¬ç»å…¸çš„ä¹¦ï¼Œæ²¡æœ‰å»ç³»ç»Ÿçš„å­¦ä¹ ä¸€äº›çŸ¥è¯†ï¼Œæ²¡æœ‰æ¢ç´¢è®¡ç®—æœºé‚£ä»¤äººå¹ä¸ºè§‚æ­¢çš„åœ°æ–¹ã€‚å›æƒ³å¤§å­¦æ—¶ä»£ï¼Œè‡ªå·±ä»æ²¡æƒ³è¿‡ä¼šå»å®Œå®Œæ•´æ•´çš„è¯»ä¸€æœ¬ä¹¦ã€‚å°±å¦‚â€œé‡æ„â€ä¸€èˆ¬ï¼ŒçŸ¥é“å®ƒé‡è¦ï¼Œä½†ä»æœªæœ‰â€œæ°å½“â€çš„æ—¶é—´è¿›è¡Œä¸‹å»ï¼ŒæŠ‘æˆ–æ˜¯é’ˆå¯¹å…¶ä¸­é‡è¦çš„éƒ¨åˆ†ï¼Œè¿›è¡Œâ€œç†Ÿè¯»ä¸èƒŒè¯µâ€ï¼ŒæŠ‘æˆ–æ˜¯ç›´æ¥æ‹¿é˜Ÿå‹çš„é‡ç‚¹ç¬”è®°è¿›è¡ŒæŸ¥é˜…ï¼Œä½†æˆ‘ä»æ²¡å®Œæ•´çš„è¯»è¿‡ä¸€æœ¬ä¹¦ã€‚</p><span id="more"></span><p>æˆ‘åœ¨æƒ³ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œæˆ‘è®¤è¯†åˆ°æˆ‘è¯»ä¹¦æ˜¯ä¸ºä»€ä¹ˆï¼Œæ˜¯ä¸ºäº†è€ƒä¸€ä¸ªå¥½é«˜ä¸­ã€è€ƒä¸€ä¸ªå¥½å¤§å­¦ã€æ‰¾ä¸€ä»½å¥½å·¥ä½œï¼Œè¿˜æ˜¯èƒ½å¤Ÿé¢†ç•¥ä¸€ç•ªä¹¦ä¸­çš„ç»®ä¸½ç‘°å®ï¼Œå¯èƒ½ä¹Ÿåªæ˜¯æ— èŠæ‰“å‘æ—¶é—´ç½¢äº†ã€‚ä½†æˆ‘æƒ³ï¼Œä¸åº”ä»¥åŠŸåˆ©çš„å¿ƒæ€å»è¯»ä¹¦äº†ï¼Œé‚£æ ·å¤ªç´¯ã€åˆå¤ªæœºæ¢°ï¼Œæˆ‘æ€»æƒ³ç«‹å³ä»ä¹¦ä¸­è·å–ä»€ä¹ˆï¼Œä»¿ä½›æœ‰ä»·å€¼åƒé‡‘çš„å®è—èˆ¬ï¼Œè®©æˆ‘é©¬ä¸Šè¶…è¶Šå…¶ä»–äººã€‚å¯äº‹å®å“ªæœ‰é‚£ä¹ˆå®¹æ˜“ï¼Œæ¯ä¸€ä¸ªäººä¸éƒ½æ˜¯æ—¥ç§¯æœˆç´¯ï¼Œæœ‰é‡å˜å¼•èµ·è´¨å˜æ‰è·å¾—æˆåŠŸçš„å—ã€‚</p><p>æ¯•ä¸šä»¥æ¥å¤§æ¦‚5ä¸ªæœˆäº†ï¼Œæˆ‘å¸¸å¸¸åœ¨æƒ³ï¼Œæˆ‘ä»Šåä¼šæˆä¸ºæ€æ ·çš„äººï¼Œæˆ‘å¦‚ä½•æ‰èƒ½åƒå…¶ä»–äººä¸€æ ·ä¼˜ç§€ï¼Œå¯ä»¥ä¾ƒä¾ƒè€Œè°ˆï¼Œå¯ä»¥è°ˆç¬‘é£ç”Ÿã€‚ä½†æˆ‘æƒ³å…ˆæˆä¸ºé‚£ä¸ªä¸€ç›´éƒ½æƒ³æˆä¸ºçš„äººï¼Œåšå¥½è‡ªå·±ã€ä¸æ–­åŠªåŠ›ã€é‚£ä¸ªéšæ€§ä½†åˆåšå®šçš„é‚£ä¸ªäººã€‚æˆ‘æƒ³è¯´å¾ˆå¤šè¯ï¼Œä½†æ€»è§‰å¾—äººå¾®è¨€è½»ï¼Œæ‰€ä»¥åœ¨æˆ‘æ²¡æ³•æ‚é‡è½»é‡æ—¶ï¼Œè¿˜æ˜¯å°‘ä¸€äº›è¨€è¯­ï¼Œå¤šä¸€åˆ†å®å¹²ã€‚</p><p>æœ€åï¼Œä»é«˜è€ƒä½œæ–‡ä¹‹åï¼Œè¾¹å†ä¹Ÿæ²¡æœ‰èƒ½å¤ŸæŠ’å‘æƒ…æ„Ÿæˆ–æ˜¯è®°å½•ç”Ÿæ´»çš„åœ°æ–¹äº†ï¼Œç»™è‡ªå·±ç«‹ä¸€ä¸ªç›®æ ‡ï¼Œèƒ½å¤Ÿä»¥åŠå¹´æˆ–è€…æ¯ä¸ªå­£åº¦æˆ–è€…æ¯ä¸ªæœˆéƒ½èƒ½å¤Ÿå†™ä¸€äº›ä¸œè¥¿æ€»ç»“ä¸‹è‡ªå·±çš„ç”Ÿæ´»ï¼Œä¸‹ä¸€æ­¥è¯¥æ€ä¹ˆèµ°ï¼Œè‡ªå·±æœ‰å“ªäº›ä¸è¶³ã€‚</p><p>æœ€åçš„æœ€åï¼Œä¸ä»¥åŠŸåˆ©ä¸ºç›®çš„ï¼Œæˆ‘æƒ³å»å¤šçœ‹ã€å¤šæƒ³ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> éšç¬” </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>

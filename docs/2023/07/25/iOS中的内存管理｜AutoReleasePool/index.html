<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>iOSä¸­çš„å†…å­˜ç®¡ç†ï½œAutoreleasePool</title><meta name="description" content="ä¸ä»¥åŠŸåˆ©ä¸ºç›®çš„."><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><meta name="google-site-verification" content="GmOiGEvbpJTlBAXAXlJZrGhRTZOlLBC_CZ2yJaZ_Ktk"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/avatar.jpeg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="åŸºæœ¬ä½¿ç”¨åœ¨ ARC ä¸­ï¼Œä½¿ç”¨ AutoreleasePool éå¸¸ç®€å•ï¼Œåªéœ€å½¢å¦‚ä»¥ä¸‹æ–¹å¼è°ƒç”¨å³å¯ï¼Œç¼–è¯‘å™¨ä¼šå°†å—ä¸­çš„å¯¹è±¡æ’å…¥ç±»ä¼¼å¦‚ [obj autorelease]; ä¸€æ ·çš„ä»£ç ï¼Œåœ¨è¶…å‡º AutoreleasePool å—ä½œç”¨åŸŸåä¼šè‡ªåŠ¨è°ƒç”¨å¯¹è±¡çš„ release æ–¹æ³•ï¼Œè¿™èƒ½å»¶è¿Ÿå¯¹è±¡çš„é‡Šæ”¾ã€‚ä½†ä¸€èˆ¬æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ @autoreleasepool{ }ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä¸»çº¿ç¨‹ RunLoop çš„æ¯ä¸ªå‘¨æœŸä¸­éƒ½ä¼šè‡ªåŠ¨è¿›è¡Œè‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºå’Œé”€æ¯ã€‚


@autoreleasepool {
        
}

ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ° AutoreleasePool ä¸­ï¼Ÿé™¤äº†æ˜¾å¼åŠ å…¥ __autoreleasing æ‰€æœ‰æƒä¿®é¥°å¯¹è±¡å¤–ï¼Œè¿˜æœ‰äº›å¯¹è±¡ä¼šç›´æ¥è¢«éšå¼çº³å…¥ AutoReleasePool ç®¡ç†ã€‚

éè‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰çš„.."><meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="nihao' Blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">nihao's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">iOSä¸­çš„å†…å­˜ç®¡ç†ï½œAutoreleasePool</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E5%AF%B9%E8%B1%A1%E4%BC%9A%E7%BA%B3%E5%85%A5%E5%88%B0-AutoreleasePool-%E4%B8%AD%EF%BC%9F"><span class="toc-text">ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ° AutoreleasePool ä¸­ï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E6%98%BE%E5%BC%8F%E4%BD%BF%E7%94%A8-autoreleasepool%EF%BC%9F"><span class="toc-text">ä»€ä¹ˆæ—¶å€™æ˜¾å¼ä½¿ç”¨ @autoreleasepoolï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8E-RunLoop-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">ä¸ RunLoop çš„å…³ç³»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AutoReleasePool-%E6%BA%90%E7%A0%81"><span class="toc-text">AutoReleasePool æºç </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AutoreleasePoolPage-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">AutoreleasePoolPage çš„æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AutoreleasePoolPage-push"><span class="toc-text">AutoreleasePoolPage::push()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AutoreleasePoolPage-pop-ctxt"><span class="toc-text">AutoreleasePoolPage::pop(ctxt)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#objc-autorelease"><span class="toc-text">objc_autorelease</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%97"><span class="toc-text">ğŸ”—</span></a></li></ol></div><div class="column is-9"><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">iOSä¸­çš„å†…å­˜ç®¡ç†ï½œAutoreleasePool</h1><header class="my-5"><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><i class="tag post-item-tag">å†…å­˜ç®¡ç†</i></a><time class="has-text-grey" datetime="2023-07-25T01:49:00.000Z">2023-07-25</time></header><article class="mt-2 post-content"><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>åœ¨ ARC ä¸­ï¼Œä½¿ç”¨ AutoreleasePool éå¸¸ç®€å•ï¼Œåªéœ€å½¢å¦‚ä»¥ä¸‹æ–¹å¼è°ƒç”¨å³å¯ï¼Œç¼–è¯‘å™¨ä¼šå°†å—ä¸­çš„å¯¹è±¡æ’å…¥ç±»ä¼¼å¦‚ <code>[obj autorelease];</code> ä¸€æ ·çš„ä»£ç ï¼Œåœ¨è¶…å‡º AutoreleasePool å—ä½œç”¨åŸŸåä¼šè‡ªåŠ¨è°ƒç”¨å¯¹è±¡çš„ <code>release</code> æ–¹æ³•ï¼Œè¿™èƒ½å»¶è¿Ÿå¯¹è±¡çš„é‡Šæ”¾ã€‚ä½†ä¸€èˆ¬æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ <code>@autoreleasepool{ }</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä¸»çº¿ç¨‹ RunLoop çš„æ¯ä¸ªå‘¨æœŸä¸­éƒ½ä¼šè‡ªåŠ¨è¿›è¡Œè‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºå’Œé”€æ¯ã€‚</p>
<span id="more"></span>

<pre><code class="objc">@autoreleasepool {
        
}
</code></pre>
<h2 id="ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ°-AutoreleasePool-ä¸­ï¼Ÿ"><a href="#ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ°-AutoreleasePool-ä¸­ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ° AutoreleasePool ä¸­ï¼Ÿ"></a>ä»€ä¹ˆå¯¹è±¡ä¼šçº³å…¥åˆ° AutoreleasePool ä¸­ï¼Ÿ</h2><p>é™¤äº†æ˜¾å¼åŠ å…¥ <code>__autoreleasing</code> æ‰€æœ‰æƒä¿®é¥°å¯¹è±¡å¤–ï¼Œè¿˜æœ‰äº›å¯¹è±¡ä¼šç›´æ¥è¢«éšå¼çº³å…¥ AutoReleasePool ç®¡ç†ã€‚</p>
<ul>
<li>éè‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰çš„å¯¹è±¡</li>
</ul>
<p>ç¼–è¯‘å™¨ä¼šæ£€æŸ¥æ–¹æ³•åæ˜¯å¦ä»¥ <code>alloc</code>ã€<code>new</code>ã€<code>copy</code>ã€<code>mutableCopy</code> å¼€å§‹ï¼Œå¦‚æœä¸æ˜¯åˆ™è‡ªåŠ¨å°†å…¶è¿”å›å€¼æ³¨å†Œåˆ° AutoreleasePool ä¸­ã€‚ARC é€šè¿‡å‘½åçº¦å®šå°†å†…å­˜ç®¡ç†æ ‡å‡†åŒ–ï¼Œæœ¬æ¥ ARC ä¹Ÿå¯ä»¥ç›´æ¥èˆå¼ƒ autorelease è¿™ä¸ªæ¦‚å¿µï¼Œå¹¶ä¸”è§„å®šï¼Œæ‰€æœ‰ä»æ–¹æ³•ä¸­è¿”å›çš„å¯¹è±¡å…¶å¼•ç”¨è®¡æ•°æ¯”é¢„æœŸçš„å¤š 1ï¼Œä½†è¿™æ ·åšå°±ç ´åäº†å‘åå…¼å®¹æ€§ï¼ˆbackward compatibilityï¼‰ï¼Œæ— æ³•ä¸ä¸ä½¿ç”¨ ARC çš„ä»£ç å…¼å®¹ã€‚</p>
<p>ä¸è¿‡åˆ©ç”¨ <code>clang attribute</code> ï¼Œå¦‚ <code>- (id)allocObject __attribute__((objc_method_family(none)))</code>ï¼Œä¼šå°†<code>allocObject</code> è¿™ä¸ªæ–¹æ³•å½“åšæ™®é€šæ–¹æ³•è¿”å›å¯¹è±¡çœ‹å¾…ã€‚</p>
<p>åœ¨æ™®é€šæ–¹æ³•è¿”å›å¯¹è±¡åï¼Œå¯èƒ½ä¼šå°†å¯¹è±¡ <code>retain</code> ä¸€æ¬¡ä»¥è¿›è¡Œå¼ºæŒæœ‰ã€‚ä¾‹å¦‚ä»¥ä¸‹çš„ä»£ç ä¼šè¢«ç¿»è¯‘ä¸ºï¼š</p>
<pre><code class="objc">EOCPerson _myPerson = [EOCPerson personWithName: @"Bob Smith"]; // ä¼šè°ƒç”¨ `autorelease`

// è¢«ç¿»è¯‘ä¸º
EOCPerson *tmp = [EOCPerson personWithName: @"Bob Smith"];
_myPerson = [tmp retain];
</code></pre>
<p>å…¶ä¸­ <code>autorelease</code> å’Œ <code>retain</code> ç»“å¯¹å‡ºç°ï¼Œæ˜¯å¤šä½™çš„ï¼Œä¸ºäº†æå‡æ€§èƒ½å¯ä»¥å°†å…¶åˆ é™¤ã€‚äºæ˜¯ç¼–è¯‘å™¨åœ¨è¢«è°ƒç”¨æ–¹é‡‡ç”¨ <code>objc_retainAutoreleaseReturnValue</code> æ–¹æ³•å–ä»£ <code>autorelease</code> ï¼Œä¼šæ£€æŸ¥å³å°†æ‰§è¡Œçš„é‚£æ®µä»£ç æ˜¯å¦ä¼šæ‰§è¡Œ <code>retain</code> æ“ä½œï¼Œè‹¥æœ‰åˆ™ä¼šåœ¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆTLSï¼ŒThread Local Storageï¼‰ä¸­å­˜å‚¨è¿™ä¸ªå¯¹è±¡ï¼Œä¸æ‰§è¡Œ <code>autorelease </code> æ“ä½œï¼›åœ¨è°ƒç”¨æ–¹é‡‡ç”¨ <code>objc_retainAutoreleasedReturnValue</code> æ–¹æ³•å–ä»£ <code>retain</code> ï¼Œä¼šæ£€æµ‹ TLS æ˜¯å¦å­˜äº†è¿™ä¸ªå¯¹è±¡ï¼Œè‹¥æœ‰åˆ™ç›´æ¥è¿”å›è¿™ä¸ªå¯¹è±¡ï¼Œä¸è¿›è¡Œ <code>retain</code> æ“ä½œã€‚</p>
<ul>
<li>id çš„æŒ‡é’ˆæˆ–å¯¹è±¡çš„æŒ‡é’ˆ</li>
</ul>
<p>id çš„æŒ‡é’ˆï¼ˆ<code>id **</code>ï¼‰å’Œå¯¹è±¡çš„æŒ‡é’ˆï¼ˆ<code>NSError **</code>ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šï¼Œä¼šè‡ªåŠ¨åŠ ä¸Šå…³é”®å­— <code>__autoreleasing</code>ï¼Œæ³¨å†Œåˆ° AutoreleasePool ä¸­ã€‚</p>
<ul>
<li>å…³äº <code>__weak1</code> ä¿®é¥°çš„å¯¹è±¡</li>
</ul>
<p>åœ¨ LLVM 8.0 ä¹‹å‰çš„ç¼–è¯‘å™¨ï¼Œå…³é”®å­— <code>__weak</code> ä¿®é¥°çš„å¯¹è±¡ï¼Œä¼šè‡ªåŠ¨æ³¨å†Œåˆ° AutoreleasePool ä¸­ï¼›åœ¨ LLVM 8.0 ä»¥åŠä¹‹åçš„ç¼–è¯‘å™¨ï¼Œåˆ™ä¼šç›´æ¥è°ƒç”¨ <code>release</code> æ–¹æ³•ã€‚</p>
<h2 id="ä»€ä¹ˆæ—¶å€™æ˜¾å¼ä½¿ç”¨-autoreleasepoolï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™æ˜¾å¼ä½¿ç”¨-autoreleasepoolï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™æ˜¾å¼ä½¿ç”¨ @autoreleasepoolï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™æ˜¾å¼ä½¿ç”¨ @autoreleasepoolï¼Ÿ</h2><ul>
<li>CLIï¼ˆCommand-line interfaceï¼‰ç¨‹åº</li>
</ul>
<p>åœ¨ Cocoa æ¡†æ¶ä¸­ç”±äºæœ‰ RunLoop æœºåˆ¶çš„åŸå› ï¼Œæ¯ä¸ªå‘¨æœŸéƒ½ä¼šè¿›è¡Œè‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºä¸é‡Šæ”¾ï¼Œä½†åœ¨ CLI ä¸­æ„å‘³ç€ä¸ä¼šå®šæœŸæ¸…ç†å†…å­˜ï¼Œå› æ­¤éœ€è¦æ›´å¤šå…³æ³¨ã€‚</p>
<ul>
<li>å¾ªç¯ä¸­ä½¿ç”Ÿæˆå¤§é‡å±€éƒ¨å˜é‡</li>
</ul>
<p>å†å¾ªç¯è¿‡ç¨‹ä¸­äº§ç”Ÿäº†å¤§é‡çš„å±€éƒ¨å˜é‡ï¼Œä¼šå¯¼è‡´å†…å­˜å³°å€¼è¿‡é«˜ï¼Œå› æ­¤æ‰‹åŠ¨åŠ å…¥ <code>@autoreleasepool</code> å¯ä»¥é™ä½å†…å­˜ä½¿ç”¨å³°å€¼ã€‚</p>
<p>è™½ç„¶åªæœ‰ Autorelease å¯¹è±¡ï¼ˆä¹Ÿå³ä¸Šæ–‡æåˆ°çš„å“ªäº›å¯¹è±¡ä¼šçº³å…¥ AutoreleasePool ç®¡ç†ï¼‰ä¼šçº³å…¥AutoreleasePool ç®¡ç†ï¼Œä½†è¿™å¯ä»¥åˆ©ç”¨å—æœºåˆ¶ï¼Œè®©ç¼–è¯‘å™¨å°†åœ¨å—æœ«å°¾è‡ªåŠ¨æ’å…¥ <code>release</code> ä»£ç ã€‚</p>
<pre><code class="swift">func loadBigData() {
    if let path = NSBundle.mainBundle().pathForResource("big", ofType: "jpg") {
        for i in 1...10000 {
            autoreleasepool {
                let data = NSData.dataWithContentsOfFile(path, options: nil, error: nil)
                let person = Person("nihao") //ä¹Ÿä¼šé‡Šæ”¾
                NSThread.sleepForTimeInterval(0.5)
            }
        }
    }
}
</code></pre>
<ul>
<li>å¸¸é©»çº¿ç¨‹</li>
</ul>
<p>ä¸»çº¿ç¨‹çš„ RunLoop ä¼šåœ¨æ¯ä¸ªå‘¨æœŸè¿›è¡Œè‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºä¸é‡Šæ”¾ï¼Œå­çº¿ç¨‹åˆ™ä¸ä¼šï¼ŒåŒæ—¶å­çº¿ç¨‹ä¹Ÿä¸ä¸€å®šä¼šæœ‰ RunLoopã€‚ä½†åªè¦æ˜¯ Autorelease å¯¹è±¡ï¼Œå°±ä¼šè‡ªåŠ¨çº³å…¥ AutoreleasePool ç®¡ç†ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºå¹¶ç®¡ç†è‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œç­‰åˆ°çº¿ç¨‹é”€æ¯çš„æ—¶å€™é‡Šæ”¾ã€‚ä½†å¸¸é©»çº¿ç¨‹ä¸­çš„å¯¹è±¡å› çº¿ç¨‹æ— æ³•é”€æ¯è¿Ÿè¿Ÿå¾—ä¸åˆ°é‡Šæ”¾ï¼Œè¿™å°±éœ€è¦æ‰‹åŠ¨æ·»åŠ  AutoreleasePoolï¼š</p>
<pre><code class="swift">class KeepAliveThreadManager {
    private init() {}
    static let shared = KeepAliveThreadManager()

    private(set) var thread: Thread?

    /// å¼€å¯å¸¸é©»çº¿ç¨‹
    public func start() {
        if thread != nil, thread!.isExecuting {
            return
        }
        thread = Thread {
            autoreleasepool {
                let currentRunLoop = RunLoop.current
                // å¦‚æœæƒ³è¦åŠ å¯¹è¯¥RunLoopçš„çŠ¶æ€è§‚å¯Ÿï¼Œéœ€è¦åœ¨è·å–åæ·»åŠ ï¼Œè€Œä¸æ˜¯ç­‰åˆ°å¯åŠ¨ä¹‹åå†æ·»åŠ ï¼Œ
                currentRunLoop.add(Port(), forMode: .common)
                currentRunLoop.run()
            }
        }
        thread?.start()
    }

    /// å…³é—­å¸¸é©»çº¿ç¨‹
    public func end() {
        thread?.cancel()
        thread = nil
    }
}

class Test: NSObject {
    func test() {
        if let thread = KeepAliveThreadManager.shared.thread {
            perform(#selector(task), on: thread, with: nil, waitUntilDone: false)
        }
    }

    @objc
    func task() {
        /// åœ¨ä»»åŠ¡å¤–åŠ ä¸€å±‚ autoreleasepool
        autoreleasepool {

        }
    }
}
</code></pre>
<h2 id="ä¸-RunLoop-çš„å…³ç³»"><a href="#ä¸-RunLoop-çš„å…³ç³»" class="headerlink" title="ä¸ RunLoop çš„å…³ç³»"></a>ä¸ RunLoop çš„å…³ç³»</h2><p>ä¸»çº¿ç¨‹åœ¨ RunLoop ä¸­æ³¨å†Œäº†ä¸¤ä¸ª Observerï¼Œå…¶å›è°ƒéƒ½æ˜¯ <code>_wrapRunLoopWithAutoreleasePoolHandler</code>ã€‚</p>
<ul>
<li>ç¬¬ä¸€ä¸ª Observer ç›‘æµ‹ <code>Entry</code> äº‹ä»¶ï¼ˆå³å°†è¿›å…¥ RunLoopï¼‰</li>
</ul>
<p>å›è°ƒå†…éƒ¨ä¼šè°ƒç”¨ <code>_objc_autoreleasePoolPush</code> åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå…¶ order = -214748364ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± åœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚</p>
<ul>
<li>ç¬¬äºŒä¸ª Observer ç›‘æµ‹ <code>BeforeWaiting</code> åŠ <code>Exit</code> äº‹ä»¶</li>
</ul>
<p><code>BeforeWaiting</code> æ—¶è°ƒç”¨ <code>_objc_autoreleasePoolPop()</code> å’Œ <code>_objc_autoreleasePoolPush()</code> é‡Šæ”¾æ—§çš„è‡ªåŠ¨é‡Šæ”¾æ± å¹¶åˆ›å»ºæ–°çš„è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>
<p><code>Exit</code> æ—¶è°ƒç”¨ <code>_objc_autoreleasePoolPop</code> æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå…¶ order = 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶å…¶å®ƒå›è°ƒéƒ½åœ¨é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ä¹‹å‰ã€‚</p>
<h2 id="AutoReleasePool-æºç "><a href="#AutoReleasePool-æºç " class="headerlink" title="AutoReleasePool æºç "></a>AutoReleasePool æºç </h2><p>å½¢å¦‚ <code>_objc_autoreleasePoolPush</code> ã€ <code>_objc_autoreleasePoolPush</code> å’Œ <code>objc_autorelease</code> å…¶å†…éƒ¨éƒ½æ˜¯è°ƒç”¨ <code>AutoreleasePoolPage</code> çš„ç›¸å…³é™æ€æ–¹æ³•ã€‚å› æ­¤å…¶æºç ä¸»è¦æ˜¯å¯¹ <code>AutoreleasePoolPage</code> çš„æ¢ç´¢ã€‚</p>
<p>ä»¥ä¸‹å‚è€ƒçš„æºç ä¸º objc4-838ã€‚</p>
<pre><code class="c++">void *objc_autoreleasePoolPush(void) {
    return AutoreleasePoolPage::push();
} 

void objc_autoreleasePoolPop(void *ctxt) {
    AutoreleasePoolPage::pop(ctxt);
}

__attribute__((noinline,used))
id 
objc_object::rootAutorelease2()
{
    ASSERT(!isTaggedPointer());
    return AutoreleasePoolPage::autorelease((id)this);
}
</code></pre>
<h3 id="AutoreleasePoolPage-çš„æ•°æ®ç»“æ„"><a href="#AutoreleasePoolPage-çš„æ•°æ®ç»“æ„" class="headerlink" title="AutoreleasePoolPage çš„æ•°æ®ç»“æ„"></a>AutoreleasePoolPage çš„æ•°æ®ç»“æ„</h3><p><code>AutoreleasePoolPage</code> ç»§æ‰¿è‡ª <code>AutoreleasePoolPageData</code>ï¼Œ<code>AutoreleasePoolPageData</code> å­˜å‚¨äº†è‡ªåŠ¨é‡Šæ”¾æ± å®ä¾‹å¯¹è±¡çš„ä¿¡æ¯ï¼Œè€Œ <code>AutoreleasePoolPage</code> é‡Œåˆ™å­˜å‚¨äº†å…¨å±€æ‰€æœ‰çš„è‡ªåŠ¨é‡Šæ”¾æ± çš„æ‰€éœ€ä¿¡æ¯ï¼Œå› æ­¤å…¶å±æ€§ç±»å‹ä¹Ÿéƒ½æ˜¯ <code>static const</code>ã€‚</p>
<pre><code class="c++">struct AutoreleasePoolPageData
{
#if SUPPORT_AUTORELEASEPOOL_DEDUP_PTRS
    // ç”¨æ¥ä¼˜åŒ–åŒä¸€å¯¹è±¡å¤šæ¬¡åŠ å…¥ AutoreleasePoolPageï¼Œåªéœ€è®°å½•å…¶åœ°å€ä¸æ•°é‡ï¼Œæ— éœ€é‡å¤é€’å¢ï¼ŒèŠ‚çœç©ºé—´
    struct AutoreleasePoolEntry {
        uintptr_t ptr: 48;
        uintptr_t count: 16;

        static const uintptr_t maxCount = 65535; // 2^16 - 1
    };
#endif
  // å¯¹å½“å‰ AutoreleasePool å®Œæ•´æ€§æ ¡éªŒ
    magic_t const magic;
  // æŒ‡å‘ä¸‹ä¸€ä¸ªå³å°†äº§ç”Ÿçš„ autorelease å¯¹è±¡çš„ä½ç½®
    __unsafe_unretained id *next;
  // å…³è”çš„çº¿ç¨‹
    pthread_t const thread;
  // æŒ‡å‘çˆ¶èŠ‚ç‚¹
    AutoreleasePoolPage * const parent;
  // æŒ‡å‘å­—èŠ‚ç‚¹
    AutoreleasePoolPage *child;
  // é“¾è¡¨çš„æ·±åº¦
    uint32_t const depth;
  // æ°´ä½çº¿(DEBUG ä½¿ç”¨ï¼Œç”¨ä½œåˆ¤æ–­ä¸Šæ¬¡å’Œè¿™æ¬¡çš„å¯¹è±¡å¢åŠ æ•°é‡)
    uint32_t hiwat;
};
</code></pre>
<p>ä» <code>next</code>ã€<code>parent</code>ã€<code>child</code> çš„ç»“æ„æ¥çœ‹ï¼Œæ„æˆäº†ä»¥æ ˆä½œä¸ºèŠ‚ç‚¹çš„åŒå‘é“¾è¡¨ï¼Œæ¯ä¸ª <code>AutorleasePoolPage</code> çš„å¤§å°ä¸º 4096 ä¸ªå­—èŠ‚ã€‚</p>
<p><img src="/images/blog/image-20230724164816710.png" alt="image-20230724164816710"></p>
<p>å€¼çš„æ³¨æ„çš„æ˜¯ï¼Œå¼•å…¥äº† <code>AutoreleasePoolEntry</code> ç»“æ„ï¼Œç”¨ä½œå°†åŒä¸€å¯¹è±¡å¤šæ¬¡è¿›è¡Œ <code>autorelease</code> æ“ä½œæ—¶çš„ä¼˜åŒ–ï¼Œè¿™æ—¶ä¸ä¼šå°† <code>next</code> é€’å¢ï¼Œè€Œæ˜¯å°† <code>AutoreleasePoolEntry</code> ä¸­ <code>count</code> é€’å¢ï¼Œå¾—ä»¥ä¼˜åŒ–å†…å­˜ç©ºé—´ã€‚è¿™é‡Œå°† <code>ptr</code> å’Œ <code>count</code> æŒ‡å®šå­˜å‚¨å¤§å°ï¼Œå…¶æ€»å¤§å°ä¸º 64 å­—èŠ‚ï¼Œä¸ <code>id</code> ç±»å‹æŒ‡é’ˆå¤§å°ç›¸åŒï¼Œä½¿å¾— <code>AutoreleasePoolEntry</code> å’Œ æ™®é€šçš„ <code>id</code> ç±»å‹å¯ä»¥äº’æ“ä½œã€‚</p>
<pre><code class="c++">class AutoreleasePoolPage : private AutoreleasePoolPageData
{
public:
  // æ¯ä¸ª Page çš„å¤§å°ï¼Œä¸º 4096 å­—èŠ‚(è™šæ‹Ÿå†…å­˜ä¸€é¡µçš„å¤§å°)
    static size_t const SIZE = PAGE_MIN_SIZE;
    
private:
  // å…³äº AutoreleasePool çš„ Keyï¼Œç”¨æ¥æŸ¥æ‰¾å­˜å‚¨åœ¨ TLS ä¸­çº¿ç¨‹çš„ HotPage
    static pthread_key_t const key = AUTORELEASE_POOL_KEY;
  // é‡Šæ”¾å¯¹è±¡åç”¨ 0xA3A3A3A3 å ä½
    static uint8_t const SCRIBBLE = 0xA3;
  // å­˜å‚¨å¯¹è±¡ä¸ªæ•°
    static size_t const COUNT = SIZE / sizeof(id);
  // æœ€å¤§é”™è¯¯æ•°é‡(DEBUG ä½¿ç”¨)
  static size_t const MAX_FAULTS = 2;
}
</code></pre>
<p>å…³äº <code>AutoreleasePoolPage</code> çš„é™æ€å±æ€§ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„ï¼š</p>
<ul>
<li><code>size</code> å›ºå®šä¸º <code>4096</code>ï¼Œåˆšå¥½ä¸ºè™šæ‹Ÿå†…å­˜å¤§å°çš„ä¸€é¡µã€‚</li>
<li><code>key</code> ä¸º <code>43</code>ï¼Œç”¨ä½œçº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ <code>Key</code>ï¼Œå­˜å‚¨çš„æ˜¯çº¿ç¨‹æ‰€å±çš„ <code>hotPage</code>ï¼Œéš”ç¦»åŒºåˆ†å…¶ä»–çº¿ç¨‹çš„ <code>AutoreleasePoolPage</code>ã€‚</li>
<li><code>SCRIBBLE</code> ä¸º <code>0xA3A3A3A3</code>ï¼Œåœ¨ç”¨ä½œå ä½é‡Šæ”¾æ‰çš„ <code>next</code> æŒ‡é’ˆï¼Œæ ‡è¯†ä¸ºæœªåˆå§‹åŒ–çš„åœ°å€ã€‚</li>
</ul>
<h3 id="AutoreleasePoolPage-push"><a href="#AutoreleasePoolPage-push" class="headerlink" title="AutoreleasePoolPage::push()"></a>AutoreleasePoolPage::push()</h3><p><code>AutoreleasePoolPage::push() </code> åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå®é™…ä¸Šæ˜¯æ’å…¥ä¸€ä¸ª <code>POOL_BOUNDARY</code> ï¼ˆå“¨å…µå¯¹è±¡ï¼ŒæŒ‡å‘ <code>nil</code>ï¼‰ç”¨æ¥è¡¨ç¤ºä¸åŒçš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå»é™¤æ‰ <code>DEBUG</code> è°ƒè¯•å’Œä¸€äº›è¾¹ç•Œæ¡ä»¶ï¼Œå…¶ä¸»è¦é€»è¾‘é›†ä¸­åœ¨ <code>autoreleaseFast</code> æ–¹æ³•ä¸­ï¼Œæ ¹æ® <code>hotPage</code> çš„çŠ¶æ€åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p>
<p>å…³äº <code>hotPage</code>ï¼Œå…¶å­˜å‚¨åœ¨ TLS ä¸­ï¼Œè¡¨ç¤ºå½“å‰æ­£æ´»è·ƒçš„ <code>Page</code>ï¼›ä¸ä¹‹ç›¸å¯¹åº”æ˜¯ <code>coldPage</code>ï¼ŒæŒ‡å‘çš„æ˜¯åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚</p>
<pre><code class="c++">// æ­¤å¤„çš„ obj ä¸º POOL_BOUNDARY
static inline id *autoreleaseFast(id obj) 
{
    AutoreleasePoolPage *page = hotPage();
    if (page &amp;&amp; !page-&gt;full()) {
        return page-&gt;add(obj);
    } else if (page) {
        return autoreleaseFullPage(obj, page);
    } else {
        return autoreleaseNoPage(obj);
    }
}
</code></pre>
<ul>
<li>å­˜åœ¨ <code>hotPage</code> å¹¶ä¸” <code>hotPage</code> æœªæ»¡</li>
</ul>
<p>è¿™æ˜¯ç›´æ¥è°ƒç”¨ <code>hotPage</code> çš„ <code>add</code> å®ä¾‹æ–¹æ³•ï¼Œæ ¹æ®å®å®šä¹‰ï¼Œåˆ¤æ–­æ˜¯å¦åˆ©ç”¨ <code>AutoreleasePoolEntry</code> ç±»å‹ä¼˜åŒ–åŒä¸€å¯¹è±¡çš„å¤šæ¬¡ <code>autorelease</code>ï¼Œå¦åˆ™ç›´æ¥åŠ å…¥ï¼Œ<code>next</code> æŒ‡å‘ä¸‹ä¸€ä¸ªå°†è¦åŠ å…¥ <code>AutoreleasePoolPage</code> çš„åœ°å€ã€‚</p>
<ul>
<li>å­˜åœ¨ <code>hotPage</code> å¹¶ä¸” <code>hotPage</code> å·²æ»¡</li>
</ul>
<p>ä» <code>hotPage</code> ï¼Œéå†æ‰¾ä¸€ä¸ªæœªæ»¡çš„å­èŠ‚ç‚¹ï¼Œè‹¥æ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ª <code>AutoreleasePoolPage</code> ï¼Œéšåå°†æ‰¾åˆ°æˆ–ç”Ÿæˆçš„ <code>page</code> ç½®ä¸º <code>hotPage</code> ï¼ˆåˆ©ç”¨ TLS æœºåˆ¶ï¼‰ï¼Œå¹¶å°†å¯¹è±¡ <code>add</code> åˆ° <code>hotPage</code> ä¸­ã€‚</p>
<ul>
<li>ä¸å­˜åœ¨ <code>hotPage</code></li>
</ul>
<p>åˆ›å»ºä¸€ä¸ª <code>AutoreleasePoolPage</code> ï¼Œå°†å…¶è®¾ç½®ä¸º <code>hotPage</code>ï¼Œå¹¶å°†å¯¹è±¡åŠ å…¥åˆ° <code>hotPage</code> ä¸­ã€‚</p>
<h3 id="AutoreleasePoolPage-pop-ctxt"><a href="#AutoreleasePoolPage-pop-ctxt" class="headerlink" title="AutoreleasePoolPage::pop(ctxt)"></a>AutoreleasePoolPage::pop(ctxt)</h3><p><code>pop</code> æ–¹æ³•éœ€è¦ä¼ å…¥å‚æ•°ï¼Œåœ¨ <code>_objc_autoreleasePoolPush</code> ä¸­æ˜¯ä¼ å…¥ <code>push</code> æ–¹æ³•è¿”å›çš„å‚æ•°ï¼Œ<code>push</code> è¿”å›çš„æ˜¯å­˜å‚¨çš„å“¨å…µå¯¹è±¡çš„åœ°å€ï¼Œå› æ­¤ä¼ å…¥çš„ä¹Ÿæ˜¯å“¨å…µå¯¹è±¡çš„åœ°å€ã€‚</p>
<p>ä¸è¿‡è¯¥æ–¹æ³•ä¹Ÿå¯èƒ½åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼Œå¦‚æœæ˜¯å“¨å…µå¯¹è±¡çš„åœ°å€ä¼šé”€æ¯æ•´ä¸ªä»¥å“¨å…µå¯¹è±¡å¼€å§‹çš„å•ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œè¿˜æœ‰å¯èƒ½é”€æ¯æ•´ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå…¶æ–¹æ³•ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p>
<pre><code class="c++">static inline void
pop(void *token)
{
    AutoreleasePoolPage *page;
    id *stop;
    if (token == (void*)EMPTY_POOL_PLACEHOLDER) {
        page = hotPage();
        if (!page) {
            // å¦‚æœæ•´ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ä¸ºç©ºï¼Œä»…æœ‰å ä½ç¬¦ï¼Œä»¥ nil å¡«å……
            return setHotPage(nil);
        }
        // ä»å¤´èŠ‚ç‚¹å¼€å§‹ï¼Œç§»é™¤è‡ªåŠ¨é‡Šæ”¾æ± ä¸­çš„æ‰€æœ‰å†…å®¹
        page = coldPage();
        token = page-&gt;begin();
    } else {
        page = pageForPointer(token);
    }

    stop = (id *)token;

    return popPage&lt;false&gt;(token, page, stop);
}
</code></pre>
<p>å¦‚ä½•é€šè¿‡åˆ° <code>token</code>ï¼ˆä¹Ÿå³ä¼ å…¥çš„å“¨å…µå¯¹è±¡çš„åœ°å€ï¼‰ æŸ¥æ‰¾åˆ°æ‰€å¯¹åº”çš„ <code>AutoreleasePoolPage</code> ï¼Œåœ¨ <code>pageForPointer</code> æ–¹æ³•ä¸­ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸ªå‰ç½®æ¡ä»¶ï¼Œ<code>AutoreleasePoolPage</code> ä¼šé€šè¿‡ <code>malloc_zone_memalign</code> æ–¹å¼åˆ†é…å†…å­˜ï¼Œå› æ­¤æ¯ä¸ª <code>AutoreleasePoolPage</code> çš„åœ°å€éƒ½æ˜¯ <code>SIZE</code>ï¼ˆ4096ï¼‰çš„å€æ•°ï¼Œä¹Ÿå°±æ˜¯åœ°å€ä¼šè¿›è¡Œå¯¹é½ï¼Œåœ¨ä¸ <code>SIZE</code> è¿›è¡Œå–ä½™æ“ä½œåï¼Œå¾—åˆ°ç›¸å¯¹äº <code>token</code> æ‰€åœ¨çš„ <code>AutoreleasePoolPage</code> çš„åç§»ï¼Œç›¸å‡åˆ™å°±èƒ½å¾—åˆ°å…¶é¦–åœ°å€ã€‚</p>
<pre><code class="c++">static AutoreleasePoolPage *pageForPointer(uintptr_t p) 
{
    AutoreleasePoolPage *result;
    uintptr_t offset = p % SIZE;

    ASSERT(offset &gt;= sizeof(AutoreleasePoolPage));

    result = (AutoreleasePoolPage *)(p - offset);
    result-&gt;fastcheck();

    return result;
}
</code></pre>
<p>åœ¨ <code>popPage</code> æ–¹æ³•ä¸­ï¼Œä» <code>hotPage</code> å¼€å§‹ï¼Œä¸€ç›´è¿›è¡Œå‡ºæ ˆæ“ä½œï¼Œä¹Ÿå³ä¼š <code>objc_release(obj);</code>ï¼Œç›´åˆ°æ»¡è¶³æ ˆé¦–çš„åœ°å€ä¸ <code>stop</code> çš„åœ°å€ä¸€è‡´ï¼Œä¹‹åä¼šè°ƒç”¨ <code>child</code> / <code>child-&gt; child</code> çš„ <code>kill</code> æ–¹æ³•ï¼Œå°†æ‰€æœ‰çš„å­èŠ‚ç‚¹é”€æ¯ã€‚</p>
<p>æœ‰æ„æ€çš„æ˜¯ï¼Œä¼šæ ¹æ®å­èŠ‚ç‚¹çš„çŠ¶æ€ï¼ˆå­èŠ‚ç‚¹ä¸­å·²å­˜å‚¨å¤§å°å°äºæ€»å¤§å°çš„ä¸€åŠï¼‰è¿›è¡ŒåŒºåˆ†ï¼Œæ›´æœ‰æ„æ€çš„æ˜¯ï¼Œåœ¨è¿›è¡Œ <code>releaseUntil</code> æ–¹æ³•æ—¶ï¼Œä¼šå°†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹æ¸…ç©ºï¼Œé‡Œé¢ä¹Ÿä¼šåˆ¤æ–­ <code>ASSERT(page-&gt;empty());</code>ï¼Œå› æ­¤åªä¼šè°ƒç”¨ <code>page-&gt;child-&gt;kill();</code>ã€‚</p>
<p>ä¸è¿‡è¿™é‡Œæåˆ°ä¸€ä¸ªæ¦‚å¿µï¼Œè¿Ÿæ»ç°è±¡ï¼ˆhysteresisï¼‰ï¼Œwiki æ˜¯è¿™æ ·è§£é‡Šçš„ï¼š</p>
<blockquote>
<p>ä¸€ç³»ç»Ÿç»è¿‡æŸä¸€è¾“å…¥è·¯å¾„ä¹‹è¿ä½œåï¼Œå³ä½¿æ¢å›æœ€åˆçš„çŠ¶æ€æ—¶åŒæ ·çš„è¾“å…¥å€¼ï¼ŒçŠ¶æ€ä¹Ÿä¸èƒ½å›åˆ°å…¶åˆå§‹ã€‚</p>
</blockquote>
<p>æ¨æµ‹æ˜¯è™½ç„¶éœ€è¦å°†æ‰€æœ‰å­èŠ‚ç‚¹æ¸…ç©ºï¼Œä½†æ˜¯ç³»ç»Ÿä¸åŒä»¥å¾€äº†ï¼Œå¯èƒ½åç»­éœ€è¦é‡æ–°åˆ›å»ºå­èŠ‚ç‚¹ï¼Œè¿™é‡Œå…ˆä¸æ¸…ç©ºï¼Œä¸ºåç»­ä½¿ç”¨æé«˜æ•ˆç‡ã€‚</p>
<pre><code class="c++">template&lt;bool allowDebug&gt;
static void
popPage(void *token, AutoreleasePoolPage *page, id *stop)
{
    page-&gt;releaseUntil(stop);
    if (page-&gt;child) {
        // hysteresis: keep one empty child if page is more than half full
        if (page-&gt;lessThanHalfFull()) {
            page-&gt;child-&gt;kill();
        }
        else if (page-&gt;child-&gt;child) {
            page-&gt;child-&gt;child-&gt;kill();
        }
    }
}
</code></pre>
<h3 id="objc-autorelease"><a href="#objc-autorelease" class="headerlink" title="objc_autorelease"></a>objc_autorelease</h3><p>å»é™¤æ‰ä¸€äº›ä¼˜åŒ–æ¡ä»¶ï¼Œå¦‚æ˜¯å¦æ˜¯ <code>taggedPointer</code> æŒ‡é’ˆï¼Œæ˜¯å¦é‡‡ç”¨ TLS ä¼˜åŒ– <code>autorelease</code> æ­¥éª¤ ï¼ˆä¸Šæ–‡æåˆ°ï¼‰ï¼Œæ˜¯å¦æ˜¯ç±»å¯¹è±¡ç­‰ã€‚</p>
<p>ä¸€èˆ¬æœ€ç»ˆä¼šæŒ‡å‘ <code>AutoreleasePoolPage::autorelease((id)this);</code> ï¼Œè¿™ä¸ <code>AutoreleasePoolPage::push()</code> çš„åˆ†ææƒ…å†µä¸€è‡´ã€‚</p>
<pre><code class="c++">static inline id autorelease(id obj)
{
    ASSERT(!_objc_isTaggedPointerOrNil(obj));
    id *dest __unused = autoreleaseFast(obj);
#if SUPPORT_AUTORELEASEPOOL_DEDUP_PTRS
    ASSERT(!dest  ||  dest == EMPTY_POOL_PLACEHOLDER  ||  (id)((AutoreleasePoolEntry *)dest)-&gt;ptr == obj);
#else
    ASSERT(!dest  ||  dest == EMPTY_POOL_PLACEHOLDER  ||  *dest == obj);
#endif
    return obj;
}
</code></pre>
<h2 id="ğŸ”—"><a href="#ğŸ”—" class="headerlink" title="ğŸ”—"></a>ğŸ”—</h2><p>[1] <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9086913/why-is-autoreleasepool-still-needed-with-arc#:~:text=(%2D1)%20%40autoreleasepool%20Forces%20process,footprint%20will%20be%20constantly%20increasing">Why is @autoreleasepool still needed with arc</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://book.douban.com/subject/24720270/">Objective-C é«˜çº§ç¼–ç¨‹ iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Z3MWUxR2SLtmzFZ3e5WzYQ">AutoreleasePool</a></p>
<p>[4] <a target="_blank" rel="noopener" href="https://book.douban.com/subject/25829244/">Effective Objective-C 2.0 ç¼–å†™é«˜è´¨é‡iOSä¸OS Xä»£ç çš„52ä¸ªæœ‰æ•ˆæ–¹æ³•</a></p>
<p>[5] <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/40993809/why-weak-object-will-be-added-to-autorelease-pool">Why __weak object will be added to autorelease pool?</a></p>
<p>[6] <a target="_blank" rel="noopener" href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/">é»‘å¹•åçš„Autorelease</a></p>
<p>[7] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/323200445">iOS AutoreleasePool</a></p>
<p>[8] <a target="_blank" rel="noopener" href="https://github.com/xuhaodong1/objc4_838_source_code">nihao_objc4_838</a></p>
<p>[9] <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-sg/%E9%81%B2%E6%BB%AF%E7%8F%BE%E8%B1%A1">è¿Ÿæ»ç°è±¡</a></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em><a class="button is-default" href="/2023/07/20/iOS%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BD%9CARC/" title="iOSä¸­çš„å†…å­˜ç®¡ç†ï½œARC"><span class="has-text-weight-semibold">Next: iOSä¸­çš„å†…å­˜ç®¡ç†ï½œARC</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="xuhaodong1/xuhaodong1.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/xuhaodong1"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- çŸ¥ä¹--><!-- é¢†è‹±--><!-- è„¸ä¹¦--></section><p> <span>PV:</span><span id="busuanzi_value_site_pv"></span><span>  UV: </span><span id="busuanzi_value_site_uv"></span></p><p><span>Copyright Â©</span><span> nihao 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>
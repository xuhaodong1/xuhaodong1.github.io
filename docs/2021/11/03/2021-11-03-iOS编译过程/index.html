<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>iOS ç¼–è¯‘è¿‡ç¨‹</title><meta name="description" content="ä¸ä»¥åŠŸåˆ©ä¸ºç›®çš„."><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><meta name="google-site-verification" content="GmOiGEvbpJTlBAXAXlJZrGhRTZOlLBC_CZ2yJaZ_Ktk"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/avatar.jpeg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="å‰è¨€å­¦ä¹  iOS ç¼–è¯‘è¿‡ç¨‹ï¼ˆCompileï¼‰æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½ç†è§£ä»£ç æ˜¯å¦‚ä½•è¢«è®¡ç®—æœºè¿ä½œèµ·æ¥ï¼Œç¼–è¯‘å™¨ä¸ºä»£ç åšäº†å“ªäº›ä¼˜åŒ–ï¼Œè®©æˆ‘ä»¬å­¦ä¼šä»å¦ä¸€ä¸ªè§’åº¦æ¥çœ‹å¾…é—®é¢˜ã€‚

ç¼–è¯‘å™¨ç»“æ„ç°ä»£ç¼–è¯‘å™¨æ˜¯å°†æºä»£ç è½¬æ¢æˆå¯æ‰§è¡Œæ–‡ä»¶çš„ç¨‹åºï¼Œå·¥ä½œæµç¨‹ä¸»è¦åˆ†ä¸º å‰ç«¯ å’Œ åç«¯ ä¸¤ä¸ªéƒ¨åˆ†ï¼š

å‰ç«¯ï¼šå¯¹æºä»£ç è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆä¸­é—´ä»£ç ã€‚
åç«¯ï¼šé’ˆå¯¹ä¸­é—´ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå¹¶è½¬æ¢æˆç›®æ ‡æœºå™¨çš„ä»£ç æŒ‡ä»¤ã€‚

graph LR
    A(SourceCode) --&amp;gt; B(Frontend)
    B(Frontend) --&amp;gt; C(Backend)
    C(Backend) --&amp;gt; D(Machine Code)

é’ˆå¯¹iOSå¹³å°ï¼Œä¸åŒè¯­è¨€é‡‡ç”¨äº†ä¸åŒçš„ç¼–è¯‘å™¨å‰ç«¯ï¼š

Frontendï¼šClang / SwiftC
å¯¹äº Objecti.."><meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="nihao' Blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">nihao's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">iOS ç¼–è¯‘è¿‡ç¨‹</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E7%BB%93%E6%9E%84"><span class="toc-text">ç¼–è¯‘å™¨ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B"><span class="toc-text">ç¼–è¯‘è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86"><span class="toc-text">æµç¨‹æ¢³ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Clang%E9%98%B6%E6%AE%B5%EF%BC%88Objective-C-C-C-Objective-C-%EF%BC%89"><span class="toc-text">Clangé˜¶æ®µï¼ˆObjective-C &#x2F; C++ &#x2F; C &#x2F; Objective-C++ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5%EF%BC%9A"><span class="toc-text">é¢„å¤„ç†é˜¶æ®µï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E9%98%B6%E6%AE%B5"><span class="toc-text">è¯æ³•åˆ†æé˜¶æ®µ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E9%98%B6%E6%AE%B5"><span class="toc-text">è¯­æ³•åˆ†æé˜¶æ®µ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CodeGen%E9%98%B6%E6%AE%B5"><span class="toc-text">CodeGené˜¶æ®µ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LLVM-Optimizer-%E9%98%B6%E6%AE%B5"><span class="toc-text">LLVM Optimizer é˜¶æ®µ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IR%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="toc-text">IRä»£ç ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90-BitCode%EF%BC%88Archive%E6%97%B6%EF%BC%89"><span class="toc-text">ç”Ÿæˆ BitCodeï¼ˆArchiveæ—¶ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LLVM-Code-Generator%E9%98%B6%E6%AE%B5"><span class="toc-text">LLVM Code Generatoré˜¶æ®µ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81"><span class="toc-text">ç”Ÿæˆæ±‡ç¼–ä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%9C%BA%E5%99%A8%E4%BB%A3%E7%A0%81"><span class="toc-text">ç”Ÿæˆæœºå™¨ä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5"><span class="toc-text">é“¾æ¥</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li></ol></div><div class="column is-9"><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">iOS ç¼–è¯‘è¿‡ç¨‹</h1><header class="my-5"><a href="/tags/iOS"><i class="tag post-item-tag">iOS</i></a><a href="/tags/Compile"><i class="tag post-item-tag">Compile</i></a><time class="has-text-grey" datetime="2021-11-03T14:54:49.000Z">2021-11-03</time></header><article class="mt-2 post-content"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å­¦ä¹  <strong>iOS</strong> ç¼–è¯‘è¿‡ç¨‹ï¼ˆ<strong>Compile</strong>ï¼‰æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½ç†è§£ä»£ç æ˜¯å¦‚ä½•è¢«è®¡ç®—æœºè¿ä½œèµ·æ¥ï¼Œç¼–è¯‘å™¨ä¸ºä»£ç åšäº†å“ªäº›ä¼˜åŒ–ï¼Œè®©æˆ‘ä»¬å­¦ä¼šä»å¦ä¸€ä¸ªè§’åº¦æ¥çœ‹å¾…é—®é¢˜ã€‚</p>
<span id="more"></span>
<h2 id="ç¼–è¯‘å™¨ç»“æ„"><a href="#ç¼–è¯‘å™¨ç»“æ„" class="headerlink" title="ç¼–è¯‘å™¨ç»“æ„"></a>ç¼–è¯‘å™¨ç»“æ„</h2><p>ç°ä»£ç¼–è¯‘å™¨æ˜¯å°†æºä»£ç è½¬æ¢æˆå¯æ‰§è¡Œæ–‡ä»¶çš„ç¨‹åºï¼Œå·¥ä½œæµç¨‹ä¸»è¦åˆ†ä¸º <strong>å‰ç«¯</strong> å’Œ <strong>åç«¯</strong> ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>å‰ç«¯ï¼šå¯¹æºä»£ç è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆä¸­é—´ä»£ç ã€‚</li>
<li>åç«¯ï¼šé’ˆå¯¹ä¸­é—´ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå¹¶è½¬æ¢æˆç›®æ ‡æœºå™¨çš„ä»£ç æŒ‡ä»¤ã€‚</li>
</ol>
<pre class="mermaid">graph LR
    A(SourceCode) --&gt; B(Frontend)
    B(Frontend) --&gt; C(Backend)
    C(Backend) --&gt; D(Machine Code)</pre>

<p>é’ˆå¯¹iOSå¹³å°ï¼Œä¸åŒè¯­è¨€é‡‡ç”¨äº†ä¸åŒçš„ç¼–è¯‘å™¨å‰ç«¯ï¼š</p>
<ol>
<li><p><strong>Frontendï¼šClang / SwiftC</strong></p>
<p>å¯¹äº <strong>Objective-C / C / C++ / Objective-C++</strong>  æ¥è¯´é‡‡ç”¨ <strong>Clang</strong> ç¼–è¯‘å™¨å‰ç«¯ï¼›</p>
<p>å¯¹äº <strong>Swift</strong> æ¥è¯´åˆ™é‡‡ç”¨ <strong>SwiftC</strong>ï¼›</p>
</li>
<li><p><strong>Backendï¼šLLVM</strong></p>
<p>æ— è®ºæ˜¯ <strong>C</strong> ç³»è¯­è¨€è¿˜æ˜¯ <strong>Swift</strong> éƒ½é‡‡ç”¨ <strong>LLVM</strong> ä½œä¸ºç¼–è¯‘å™¨åç«¯ï¼›</p>
</li>
</ol>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯åœ¨ <strong>Xcode3</strong> ä»¥å‰ï¼Œéƒ½é‡‡ç”¨ <strong>GCC</strong> ä½œä¸ºç¼–è¯‘å™¨å‰ç«¯ï¼Œä½†ä¸º <strong>Apple</strong> å¿«é€Ÿå‘å±•éœ€è¦åŠŸèƒ½æ›´å¼ºå¤§å’Œæ€§èƒ½æ›´å¥½çš„ç¼–è¯‘å™¨ï¼Œæ‰€ä»¥ <strong>Apple</strong> è‡ªå·±å¼€å‘äº† <strong>Clang</strong> ä½œä¸ºç¼–è¯‘å™¨å‰ç«¯ã€‚ä¸‹é¢å¯¹ç¼–è¯‘å™¨åšä¸€ä¸ªç®€è¦ä»‹ç»ï¼š</p>
<ul>
<li><strong>GCC</strong></li>
</ul>
<p><strong>GCC</strong>ï¼ˆ<strong>GNU Compile Collection</strong>ï¼Œ**GNU **ç¼–è¯‘å™¨å¥—è£…ï¼‰ï¼Œæ˜¯ä¸€å¥—ç”± <strong>GNU</strong> å¼€å‘çš„ç¼–ç¨‹è¯­è¨€ç¼–è¯‘å™¨ã€‚æ¥æœ¬åªèƒ½å¤„ç† <em>C</em> è¯­è¨€ï¼Œåæ¥å¿«é€Ÿæ¼”è¿›ï¼Œå˜å¾—å¯å¤„ç† <strong>C++ã€Objective-Cã€Javaã€Fortran</strong> ç­‰å…¶ä»–è¯­è¨€ã€‚ä½†ç”±äºä¸€äº›ç¼ºé™·ï¼Œå¯¼è‡´äº† <strong>Apple</strong> æŠ›å¼ƒäº† <strong>GCC</strong> ï¼Œå¼€å‘å‡ºäº† <strong>Clang</strong> ä½œä¸ºå…¶å‰ç«¯ç¼–è¯‘å™¨ã€‚</p>
<ol>
<li><strong>GCC</strong> çš„ <strong>Objective-C Frontend</strong> ä¸æ˜¯ <strong>Apple</strong> ç»´æŠ¤ï¼Œå¯¼è‡´æƒ³è¦æ·»åŠ ä¸€äº›è¯­æ³•æç¤ºç­‰åŠŸèƒ½å¾—å»è¦æ±‚ <strong>GCC</strong> å›¢é˜Ÿåšã€‚</li>
<li><strong>GCC</strong> çš„æ’ä»¶ã€å·¥å…·ã€<strong>IDE</strong> çš„æ”¯æŒè–„å¼±ã€‚</li>
<li><strong>GCC</strong> çš„ç¼–è¯‘æ•ˆç‡å’Œæ€§èƒ½ä¸è¶³ã€‚</li>
</ol>
<ul>
<li><strong>Clang</strong></li>
</ul>
<p><strong>Clang1.0</strong> äº <strong>2009</strong> å¹´æ­£å¼ä¸ <strong>LLVM2.6</strong> æ­£å¼å‘å¸ƒï¼Œæ—¨åœ¨æä¾› <strong>GCC</strong> çš„æ›¿ä»£å“ï¼Œæ”¯æŒäº† <strong>GUN</strong> ç¼–è¯‘å™¨å¤§å¤šæ•°çš„ç¼–è¯‘å™¨è®¾ç½®ä»¥åŠéå®˜æ–¹è¯­è¨€çš„æ‹“å±•ï¼Œç›¸è¾ƒäº <strong>GCC</strong> ï¼Œ<strong>Clang</strong> å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ol>
<li>ç¼–è¯‘é€Ÿåº¦æ›´å¿«ã€‚</li>
<li>å ç”¨å†…å­˜æ›´å°ã€‚</li>
<li>æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‹“å±•ä¸é‡ç”¨ã€‚</li>
<li>è¯Šæ–­ä¿¡æ¯å¯è¯»æ€§å¼ºã€‚</li>
</ol>
<ul>
<li><strong>SwiftC</strong></li>
</ul>
<p><strong>SwiftC</strong> åœ¨å‰ç«¯é‡‡ç”¨äº† <strong>SIL</strong> ä¸­é—´è¯­è¨€ï¼Œè¿™æ˜¯å› ä¸º <strong>Swift</strong> ä½œä¸ºä¸€ç§é«˜çº§è¯­è¨€ï¼Œæœ‰è®¸å¤šç‰¹æ€§ï¼Œå¦‚ <strong>protocol</strong> çš„æ³›å‹ï¼Œä¹Ÿæ˜¯ä¸€é—¨å®‰å…¨çš„è¯­è¨€ï¼Œç¡®ä¿å˜é‡åœ¨ä½¿ç”¨ä¹‹å‰è¢«åˆå§‹åŒ–ã€æ£€æµ‹ä¸å¯æ‰§è¡Œçš„ä»£ç ï¼Œäºæ˜¯å¢åŠ äº†ä¸€å±‚ <strong>SIL</strong> æ¥åšè¿™äº›äº‹æƒ…ã€‚</p>
<ul>
<li><strong>LLVM</strong></li>
</ul>
<p><strong>LLVM</strong> æ˜¯ä¸€å¥—ç¼–è¯‘å™¨åŸºç¡€è®¾å¤‡é¡¹ç›®ï¼Œç”± <strong>C++</strong> å†™æˆï¼ŒåŒ…å«ä¸€ç³»åˆ—æ¨¡å—åŒ–çš„ç¼–è¯‘å™¨ç»„ä»¶å’Œå·¥å…·é“¾ï¼Œç”¨æ¥å¼€å‘ç¼–è¯‘å™¨çš„å‰ç«¯å’Œåç«¯ã€‚åœ¨ <strong>iOS</strong> ä¸­ï¼Œ<strong>LLVM</strong> ä½œä¸ºç¼–è¯‘å™¨åç«¯ä¸»è¦æä¾› <strong>Optimizer</strong> å’Œ <strong>Code Generator</strong> ï¼Œå°†æ¥æ”¶åˆ°çš„ <strong>IR</strong> ä¸­é—´ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œä»¥åŠæœºå™¨ä»£ç ç”Ÿæˆã€‚</p>
<h2 id="ç¼–è¯‘è¿‡ç¨‹"><a href="#ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘è¿‡ç¨‹"></a>ç¼–è¯‘è¿‡ç¨‹</h2><h3 id="æµç¨‹æ¢³ç†"><a href="#æµç¨‹æ¢³ç†" class="headerlink" title="æµç¨‹æ¢³ç†"></a>æµç¨‹æ¢³ç†</h3><pre class="mermaid">graph TD
    subgraph Clang
    id1(æºä»£ç ) --&gt; id2(é¢„å¤„ç†) 
    id2(é¢„å¤„ç†) --&gt; id3(è¯­æ³•åˆ†æ)   
    id3(è¯æ³•åˆ†æ) --  token  --&gt; id4(è¯­æ³•åˆ†æ)
    id4(è¯­æ³•åˆ†æ) --  AST  --&gt; id5(ä¸­é—´ä»£ç ç”Ÿæˆ)
    end
    
    subgraph Optimizer, Backend
    id6(ä¸­é—´ä»£ç ä¼˜åŒ–) --&gt; id7(BitCodeç”Ÿæˆ)
    id7(BitCodeç”Ÿæˆ) --&gt; id8(æ±‡ç¼–æŒ‡ä»¤ç”Ÿæˆ)
    id8(æ±‡ç¼–æŒ‡ä»¤ç”Ÿæˆ) --&gt; id9(æœºå™¨ç ç”Ÿæˆ)
    id9(æœºå™¨ç ç”Ÿæˆ) --&gt; id11(é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶)
    end
    
    subgraph SwiftC
    id12(æºä»£ç ) --&gt; id13(è§£æ)
    id13(è§£æ) --&gt; id14(è¯­ä¹‰åˆ†æ)
    id14(è¯­ä¹‰åˆ†æ) --&gt; id16(Raw SILç”Ÿæˆ)
    id16(Raw SILç”Ÿæˆ) --&gt; id17(Canonical SILç”Ÿæˆ)
    id17 --&gt; id18(SILä¼˜åŒ–)
    id18(SILä¼˜åŒ–) --&gt; id19(ä¸­é—´ä»£ç ç”Ÿæˆ)
    end
    
    id5 --  IR  --&gt; id6
    id19 --  IR  --&gt; id6</pre>

<p>åœ¨å‰ç«¯ <strong>Objective-C</strong> å’Œ <strong>Swift</strong> åˆ†åˆ«ç”±è‡ªå·±çš„å¤„ç†é˜¶æ®µï¼Œä½†æœ€åéƒ½ä¼šç”Ÿæˆ <strong>IR</strong> ä¸­é—´ä»£ç ï¼Œäº¤ç”±åç«¯è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„.mæ–‡ä»¶è¿›è¡Œç¼–è¯‘è¿‡ç¨‹æ¢³ç†ï¼Œé¦–å…ˆåœ¨æŸä¸€ä¸ªç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª <strong>nihao.m</strong>æ–‡ä»¶</p>
<pre><code class="shell">touch nihao.m
</code></pre>
<p><strong>nihao.mï¼š</strong></p>
<pre><code class="objective-c">#import &lt;Foundation/Foundation.h&gt;
int main(int argc, char *argv[])
{
    @autoreleasepool {
        NSLog(@"nihao!!!");
        return 0;
    }
}
</code></pre>
<h3 id="Clangé˜¶æ®µï¼ˆObjective-C-C-C-Objective-C-ï¼‰"><a href="#Clangé˜¶æ®µï¼ˆObjective-C-C-C-Objective-C-ï¼‰" class="headerlink" title="Clangé˜¶æ®µï¼ˆObjective-C / C++ / C / Objective-C++ï¼‰"></a>Clangé˜¶æ®µï¼ˆObjective-C / C++ / C / Objective-C++ï¼‰</h3><h4 id="é¢„å¤„ç†é˜¶æ®µï¼š"><a href="#é¢„å¤„ç†é˜¶æ®µï¼š" class="headerlink" title="é¢„å¤„ç†é˜¶æ®µï¼š"></a>é¢„å¤„ç†é˜¶æ®µï¼š</h4><pre><code class="shell">xcrun clang -E helloworld.c | open -f
</code></pre>
<pre><code># 1 "nihao.m"
# 1 "&lt;built-in&gt;" 1
# 1 "&lt;built-in&gt;" 3
# 380 "&lt;built-in&gt;" 3
# 1 "&lt;command line&gt;" 1
# 1 "&lt;built-in&gt;" 2
# 1 "nihao.m" 2
# 1 "/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h" 1 3

...
...
...

int main(int argc, char *argv[])
{
    @autoreleasepool {
        NSLog(@"nihao!!!");
        return 0;
    }
}
</code></pre>
<p>å°†é¢„å¤„ç†é˜¶æ®µè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œ å¯ä»¥çœ‹åˆ°å¾ˆå¤šä»¥ <strong>#</strong> å¼€å¤´çš„è¯­å¥ï¼Œè¿™äº›è¯­å¥å‘Šè¯‰æˆ‘ä»¬åé¢è·Ÿç€çš„å†…å®¹æ¥è‡ªå“ªé‡Œï¼Œè¿™é‡Œå¯ä»¥çœ‹è§ <strong>Foundation.h</strong> æ–‡ä»¶çš„å†…å®¹ä¹ŸåŒ…å«äº†è¿›æ¥ã€‚åœ¨ <strong>Xcode</strong> ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <strong>Product -&gt;  Perfrom Action -&gt; Preprocess</strong> æŸ¥çœ‹é¢„å¤„ç†é˜¶æ®µä¹‹åçš„ä»£ç ã€‚åœ¨é¢„å¤„ç†é˜¶æ®µåšäº†ä»¥ä¸‹è¿™äº›äº‹æƒ…ï¼š</p>
<ul>
<li>å°†å¤´æ–‡ä»¶å¼•å…¥çš„å…¶ä»–æ–‡ä»¶åŠ å…¥æºæ–‡ä»¶ä¸­ï¼Œæ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ã€‚</li>
<li>è¿›è¡Œæ¡ä»¶ç¼–è¯‘å¤„ç†ã€‚</li>
<li>å°†å®å®šä¹‰ç›´æ¥æ›¿æ¢ï¼Œä¸è¿›è¡Œè¯­æ³•æ£€æŸ¥ã€‚</li>
<li>å°†æ³¨é‡Šè¿›è¡Œåˆ é™¤å¤„ç†ã€‚</li>
</ul>
<h4 id="è¯æ³•åˆ†æé˜¶æ®µ"><a href="#è¯æ³•åˆ†æé˜¶æ®µ" class="headerlink" title="è¯æ³•åˆ†æé˜¶æ®µ"></a>è¯æ³•åˆ†æé˜¶æ®µ</h4><pre><code class="shell">xcrun clang -fmodules -fsyntax-only -Xclang -dump-tokens nihao.m
</code></pre>
<pre><code>annot_module_include '#import &lt;Foundation/Foundation.h&gt;

'        Loc=&lt;nihao.m:1:1&gt;
int 'int'     [StartOfLine]    Loc=&lt;nihao.m:3:1&gt;
identifier 'main'     [LeadingSpace]    Loc=&lt;nihao.m:3:5&gt;
l_paren '('        Loc=&lt;nihao.m:3:9&gt;
int 'int'        Loc=&lt;nihao.m:3:10&gt;
identifier 'argc'     [LeadingSpace]    Loc=&lt;nihao.m:3:14&gt;
comma ','        Loc=&lt;nihao.m:3:18&gt;
char 'char'     [LeadingSpace]    Loc=&lt;nihao.m:3:20&gt;
star '*'     [LeadingSpace]    Loc=&lt;nihao.m:3:25&gt;
identifier 'argv'        Loc=&lt;nihao.m:3:26&gt;
l_square '['        Loc=&lt;nihao.m:3:30&gt;
r_square ']'        Loc=&lt;nihao.m:3:31&gt;
r_paren ')'        Loc=&lt;nihao.m:3:32&gt;
l_brace '{'     [StartOfLine]    Loc=&lt;nihao.m:4:1&gt;
at '@'     [StartOfLine] [LeadingSpace]    Loc=&lt;nihao.m:5:5&gt;
identifier 'autoreleasepool'        Loc=&lt;nihao.m:5:6&gt;
...
</code></pre>
<p>è¯æ³•åˆ†æé˜¶æ®µå…¶å®æ˜¯å°†æºä»£ç ä»¥å­—ç¬¦æ–‡æœ¬çš„å½¢å¼è½¬æ¢æˆ <strong>Token</strong> æµçš„å½¢å¼ï¼Œä¸æ¶‰åŠè¯­ä¹‰æ ¡éªŒï¼Œç”¨æ¥æ ‡è¯†å‡ºè¿™ä¸ªå­—ç¬¦æ˜¯æ ‡è¯†ç¬¦ã€æ‹¬å·ã€ifè¯­å¥â€¦ï¼Œæœ€åè¿˜ä¼šæ ‡è¯†å‡ºå…¶æ‰€åœ¨ä½ç½®ï¼Œæ–¹ä¾¿åç»­åˆ†æèƒ½å¤Ÿæ‰¾å‡ºå‡ºé”™çš„åŸå§‹ä½ç½®ã€‚</p>
<h4 id="è¯­æ³•åˆ†æé˜¶æ®µ"><a href="#è¯­æ³•åˆ†æé˜¶æ®µ" class="headerlink" title="è¯­æ³•åˆ†æé˜¶æ®µ"></a>è¯­æ³•åˆ†æé˜¶æ®µ</h4><pre><code>xcrun clang -fsyntax-only -Xclang -ast-dump nihao.m | open -f
</code></pre>
<pre><code>...
`-FunctionDecl 0x7f9eb4bd61a0 &lt;nihao.m:3:1, line:9:1&gt; line:3:5 main 'int (int, char **)'
  |-ParmVarDecl 0x7f9eb4bd5fc0 &lt;col:10, col:14&gt; col:14 argc 'int'
  |-ParmVarDecl 0x7f9eb4bd6080 &lt;col:20, col:31&gt; col:26 argv 'char **':'char **'
  `-CompoundStmt 0x7f9eb4bd63d0 &lt;line:4:1, line:9:1&gt;
    `-ObjCAutoreleasePoolStmt 0x7f9eb4bd63b8 &lt;line:5:5, line:8:5&gt;
      `-CompoundStmt 0x7f9eb4bd6398 &lt;line:5:22, line:8:5&gt;
        |-CallExpr 0x7f9eb4bd6328 &lt;line:6:9, col:26&gt; 'void'
        | |-ImplicitCastExpr 0x7f9eb4bd6310 &lt;col:9&gt; 'void (*)(id, ...)' &lt;FunctionToPointerDecay&gt;
        | | `-DeclRefExpr 0x7f9eb4bd6250 &lt;col:9&gt; 'void (id, ...)' Function 0x7f9eb0c8d6c8 'NSLog' 'void (id, ...)'
        | `-ImplicitCastExpr 0x7f9eb4bd6350 &lt;col:15, col:16&gt; 'id':'id' &lt;BitCast&gt;
        |   `-ObjCStringLiteral 0x7f9eb4bd6290 &lt;col:15, col:16&gt; 'NSString *'
        |     `-StringLiteral 0x7f9eb4bd6270 &lt;col:16&gt; 'char [9]' lvalue "nihao!!!"
        `-ReturnStmt 0x7f9eb4bd6388 &lt;line:7:9, col:16&gt;
          `-IntegerLiteral 0x7f9eb4bd6368 &lt;col:16&gt; 'int' 0
</code></pre>
<p>è¯­æ³•åˆ†æé˜¶æ®µä¼šè¾“å‡º <strong>AST</strong>ï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œå®ƒæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚å®ƒä»¥æ ‘çŠ¶çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚é€šè¿‡å®ƒï¼Œå¯ä»¥è¿›è¡Œè¯­æ³•é”™è¯¯åˆ†æï¼Œä»¥åŠé™æ€åˆ†ææ“ä½œï¼Œæ¶µç›–å†…å­˜æ“ä½œå’Œå®‰å…¨ç­‰æ–¹é¢ã€‚</p>
<h4 id="CodeGené˜¶æ®µ"><a href="#CodeGené˜¶æ®µ" class="headerlink" title="CodeGené˜¶æ®µ"></a>CodeGené˜¶æ®µ</h4><pre><code class="shell">xcrun clang -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll
</code></pre>
<pre><code>; ModuleID = 'nihao.m'
source_filename = "nihao.m"
target datalayout = "e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-apple-macosx11.0.0"

%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }

@__CFConstantStringClassReference = external global [0 x i32]
@.str = private unnamed_addr constant [9 x i8] c"nihao!!!\00", section "__TEXT,__cstring,cstring_literals", align 1
@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section "__DATA,__cfstring", align 8 #0

; Function Attrs: noinline optnone ssp uwtable
define i32 @main(i32 %0, i8** %1) #1 {
  %3 = alloca i32, align 4
  %4 = alloca i32, align 4
  %5 = alloca i8**, align 8
  store i32 0, i32* %3, align 4
  store i32 %0, i32* %4, align 4
  store i8** %1, i8*** %5, align 8
  %6 = call i8* @llvm.objc.autoreleasePoolPush() #2
  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*))
  store i32 0, i32* %3, align 4
  call void @llvm.objc.autoreleasePoolPop(i8* %6)
  %7 = load i32, i32* %3, align 4
  ret i32 %7
}

; Function Attrs: nounwind
declare i8* @llvm.objc.autoreleasePoolPush() #2

declare void @NSLog(i8*, ...) #3

; Function Attrs: nounwind
declare void @llvm.objc.autoreleasePoolPop(i8*) #2

attributes #0 = { "objc_arc_inert" }
attributes #1 = { noinline optnone ssp uwtable "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #2 = { nounwind }
attributes #3 = { "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }

!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}
!llvm.ident = !{!8}

!0 = !{i32 2, !"SDK Version", [2 x i32] [i32 12, i32 0]}
!1 = !{i32 1, !"Objective-C Version", i32 2}
!2 = !{i32 1, !"Objective-C Image Info Version", i32 0}
!3 = !{i32 1, !"Objective-C Image Info Section", !"__DATA,__objc_imageinfo,regular,no_dead_strip"}
!4 = !{i32 1, !"Objective-C Garbage Collection", i8 0}
!5 = !{i32 1, !"Objective-C Class Properties", i32 64}
!6 = !{i32 1, !"wchar_size", i32 4}
!7 = !{i32 7, !"PIC Level", i32 2}
!8 = !{!"Apple clang version 13.0.0 (clang-1300.0.29.3)"}
</code></pre>
<p><strong>CodeGen</strong> é˜¶æ®µè´Ÿè´£å°† <strong>AST</strong> è‡ªé¡¶å‘ä¸‹éå†é€æ­¥ç¿»è¯‘æˆ <strong>LLVM IR</strong>ï¼Œä¹Ÿå°±æ˜¯ç¼–è¯‘å™¨åç«¯æ‰€éœ€è¦çš„ä¸­é—´ä»£ç ï¼ŒåŒæ—¶ <strong>Objective-C</strong> ä»£ç ä¹Ÿä¼šåœ¨è¿™ä¸€æ­¥è¿›è¡Œ <strong>Runtime</strong> æ¡¥æ¥ï¼š <strong>property</strong> åˆæˆï¼Œ<strong>ARC</strong> å¤„ç†ç­‰ï¼Œå¦‚ä¸Šæ–¹å¯ä»¥çœ‹è§ <strong>autoreleasePoolPush</strong> ã€ <strong>autoreleasePoolPop</strong> æ“ä½œã€‚</p>
<p>è‡³æ­¤ <strong>Clang</strong> å‰ç«¯å·¥ä½œç®—æ˜¯å®Œæˆï¼Œæ¥ä¸‹æ¥å°±äº¤ç»™åç«¯è¿›è¡Œå¤„ç†ã€‚</p>
<h3 id="LLVM-Optimizer-é˜¶æ®µ"><a href="#LLVM-Optimizer-é˜¶æ®µ" class="headerlink" title="LLVM Optimizer é˜¶æ®µ"></a>LLVM Optimizer é˜¶æ®µ</h3><h4 id="IRä»£ç ä¼˜åŒ–"><a href="#IRä»£ç ä¼˜åŒ–" class="headerlink" title="IRä»£ç ä¼˜åŒ–"></a>IRä»£ç ä¼˜åŒ–</h4><pre><code class="shell">xcrun clang -Os -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll
</code></pre>
<pre><code>; ModuleID = 'nihao.m'
source_filename = "nihao.m"
target datalayout = "e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-apple-macosx11.0.0"

%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }

@__CFConstantStringClassReference = external global [0 x i32]
@.str = private unnamed_addr constant [9 x i8] c"nihao!!!\00", section "__TEXT,__cstring,cstring_literals", align 1
@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section "__DATA,__cfstring", align 8 #0

; Function Attrs: optsize ssp uwtable
define i32 @main(i32 %0, i8** nocapture readnone %1) local_unnamed_addr #1 {
  %3 = tail call i8* @llvm.objc.autoreleasePoolPush() #2
  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*)) #4, !clang.arc.no_objc_arc_exceptions !9
  tail call void @llvm.objc.autoreleasePoolPop(i8* %3) #2
  ret i32 0
}

; Function Attrs: nounwind
declare i8* @llvm.objc.autoreleasePoolPush() #2

; Function Attrs: optsize
declare void @NSLog(i8*, ...) local_unnamed_addr #3

; Function Attrs: nounwind
declare void @llvm.objc.autoreleasePoolPop(i8*) #2

attributes #0 = { "objc_arc_inert" }
attributes #1 = { optsize ssp uwtable "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #2 = { nounwind }
attributes #3 = { optsize "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #4 = { optsize }

!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}
!llvm.ident = !{!8}

!0 = !{i32 2, !"SDK Version", [2 x i32] [i32 12, i32 0]}
!1 = !{i32 1, !"Objective-C Version", i32 2}
!2 = !{i32 1, !"Objective-C Image Info Version", i32 0}
!3 = !{i32 1, !"Objective-C Image Info Section", !"__DATA,__objc_imageinfo,regular,no_dead_strip"}
!4 = !{i32 1, !"Objective-C Garbage Collection", i8 0}
!5 = !{i32 1, !"Objective-C Class Properties", i32 64}
!6 = !{i32 1, !"wchar_size", i32 4}
!7 = !{i32 7, !"PIC Level", i32 2}
!8 = !{!"Apple clang version 13.0.0 (clang-1300.0.29.3)"}
!9 = !{}
</code></pre>
<p><strong>IR</strong> ä»£ç ä¼˜åŒ–ä¼šè°ƒç”¨ç›¸åº” <strong>Pass</strong> è¿›è¡Œå¤„ç†ï¼Œ<strong>Pass</strong> ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼Œéƒ½æ˜¯ <strong>Pass</strong> ç±»çš„å­ç±»ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ç‰¹å®šçš„ä¼˜åŒ–ã€‚è¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿè‡ªä¸»çš„æ§åˆ¶ä¼˜åŒ–çš„å¼ºåº¦ï¼Œåœ¨<strong>Build Strrings -&gt; Optimization Level</strong> ä¸­å¯æŒ‡å®šä¼˜åŒ–ç¨‹åº¦ï¼Œä¸€äº›å¸¸è§çš„ä»£ç ä¼˜åŒ–æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ é™¤å…¬å…±å­è¡¨è¾¾å¼</li>
<li>åˆ é™¤æ— ç”¨ä»£ç </li>
<li>å¸¸é‡åˆå¹¶</li>
<li>ä»£ç ç§»åŠ¨</li>
<li>åˆ é™¤å½’çº³å˜é‡</li>
</ul>
<h4 id="ç”Ÿæˆ-BitCodeï¼ˆArchiveæ—¶ï¼‰"><a href="#ç”Ÿæˆ-BitCodeï¼ˆArchiveæ—¶ï¼‰" class="headerlink" title="ç”Ÿæˆ BitCodeï¼ˆArchiveæ—¶ï¼‰"></a>ç”Ÿæˆ BitCodeï¼ˆArchiveæ—¶ï¼‰</h4><pre><code class="shell">xrun clang -emit-llvm -c nihao.m -o nihao.bc
</code></pre>
<pre><code>dec0 170b 0000 0000 1400 0000 0010 0000
0700 0001 4243 c0de 3514 0000 0700 0000
620c 3024 9596 a6a5 f7d7 7f7d d3b4 4ffb
76ef df3f 2d44 0132 0500 0000 210c 0000
4903 0000 0b02 2100 0200 0000 1600 0000
0781 2391 41c8 0449 0610 3239 9201 840c
2505 0819 1e04 8b62 8014 4502 4292 0b42
a410 3214 3808 184b 0a32 5288 4870 c421
...
</code></pre>
<p><strong>BitCode</strong> æ˜¯ <strong>LLVM</strong> å¼•å…¥çš„å¦ä¸€ç§ä¸­é—´ä»£ç ï¼Œè™½ç„¶çœ‹èµ·æ¥æ¯”è¾ƒæ¥è¿‘æœºå™¨ç ï¼Œä½†æ˜¯åœ¨å‡½æ•°å’ŒæŒ‡ä»¤å±‚é¢ä½¿ç”¨äº†å¾ˆå¤šé«˜çº§è¯­è¨€çš„ç‰¹æ€§ã€‚</p>
<p>ä½†åªä¼šåœ¨ <strong>Archive</strong> æ—¶ï¼Œ<strong>BitCode</strong> æ‰ä¼šè¢«åµŒå…¥åˆ°é“¾æ¥åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨äºæäº¤ç»™ <strong>App Store</strong>ï¼ŒåŒ…å« <strong>Bitcode</strong> é…ç½®çš„ç¨‹åºå°†ä¼šåœ¨ <strong>App Store</strong> ä¸Šè¢«é‡æ–°ç¼–è¯‘å’Œé“¾æ¥ï¼Œè¿›è€Œå¯¹å¯æ‰§è¡Œæ–‡ä»¶åšä¼˜åŒ–ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¼˜åŒ–è¿™ä¸€æ­¥æ˜¯åœ¨ <strong>App Store</strong> ä¸­åšçš„å¤„ç†ï¼Œæœ¬åœ°æ²¡æœ‰åšå¤„ç†ã€‚è¿›è¡Œå…¶ä»–ç±»å‹çš„ <strong>Build</strong> (é <strong>Archive</strong> )æ—¶ï¼Œç¼–è¯‘å™¨åªä¼šæ£€æŸ¥æ˜¯å¦æ»¡è¶³å¼€å¯ <strong>BitCode</strong> çš„æ¡ä»¶ï¼Œä½†å¹¶ä¸ä¼šçœŸæ­£ç”Ÿæˆ <strong>BitCode</strong> ã€‚</p>
<h3 id="LLVM-Code-Generatoré˜¶æ®µ"><a href="#LLVM-Code-Generatoré˜¶æ®µ" class="headerlink" title="LLVM Code Generatoré˜¶æ®µ"></a>LLVM Code Generatoré˜¶æ®µ</h3><h4 id="ç”Ÿæˆæ±‡ç¼–ä»£ç "><a href="#ç”Ÿæˆæ±‡ç¼–ä»£ç " class="headerlink" title="ç”Ÿæˆæ±‡ç¼–ä»£ç "></a>ç”Ÿæˆæ±‡ç¼–ä»£ç </h4><pre><code class="shell">xcrun clang -S -fobjc-arc nihao.m -o nihao.s
</code></pre>
<pre><code>    .section    __TEXT,__text,regular,pure_instructions
    .build_version macos, 11, 0    sdk_version 12, 0
    .globl    _main                           ## -- Begin function main
    .p2align    4, 0x90
_main:                                  ## @main
    .cfi_startproc
## %bb.0:
    pushq    %rbp
    .cfi_def_cfa_offset 16
    .cfi_offset %rbp, -16
    movq    %rsp, %rbp
    .cfi_def_cfa_register %rbp
    subq    $32, %rsp
    movl    $0, -4(%rbp)
    movl    %edi, -8(%rbp)
    movq    %rsi, -16(%rbp)
    callq    _objc_autoreleasePoolPush
    movq    %rax, -24(%rbp)                 ## 8-byte Spill
    leaq    L__unnamed_cfstring_(%rip), %rdi
    movb    $0, %al
    callq    _NSLog
    movq    -24(%rbp), %rdi                 ## 8-byte Reload
    movl    $0, -4(%rbp)
    callq    _objc_autoreleasePoolPop
    movl    -4(%rbp), %eax
    addq    $32, %rsp
    popq    %rbp
    retq
    .cfi_endproc
                                        ## -- End function
    .section    __TEXT,__cstring,cstring_literals
L_.str:                                 ## @.str
    .asciz    "nihao!!!"

    .section    __DATA,__cfstring
    .p2align    3                               ## @_unnamed_cfstring_
L__unnamed_cfstring_:
    .quad    ___CFConstantStringClassReference
    .long    1992                            ## 0x7c8
    .space    4
    .quad    L_.str
    .quad    8                               ## 0x8

    .section    __DATA,__objc_imageinfo,regular,no_dead_strip
L_OBJC_IMAGE_INFO:
    .long    0
    .long    64

.subsections_via_symbols
</code></pre>
<p>æ±‡ç¼–è¯­è¨€æ›´åŠ æ¥è¿‘æœºå™¨è¯­è¨€ï¼Œèƒ½å¤Ÿç›´æ¥å¯¹ç¡¬ä»¶è¿›è¡Œæ“ä½œï¼Œç”Ÿæˆçš„ç¨‹åºä¸å…¶ä»–çš„è¯­è¨€ç›¸æ¯”å…·æœ‰æ›´é«˜çš„è¿è¡Œé€Ÿåº¦ï¼Œå ç”¨æ›´å°çš„å†…å­˜ã€‚</p>
<p>ç›®å‰æ‰€æœ‰ <strong>iOS</strong> è®¾å¤‡éƒ½é‡‡ç”¨ <strong>ARM</strong> å¤„ç†å™¨ï¼Œè¿™æ„å‘³ç€éƒ½æ˜¯é‡‡ç”¨ <strong>ARM</strong> æŒ‡ä»¤é›†ï¼Œå¦‚ <strong>armv6 / armv7 / armv7s / arm64</strong>ï¼Œè¿™äº›æŒ‡ä»¤é›†éƒ½æ˜¯å‘ä¸‹å…¼å®¹çš„ã€‚</p>
<p>æ¯ç§ <strong>CPU</strong> æ¶æ„éƒ½æœ‰ç€ç›¸åº”çš„æŒ‡ä»¤é›†ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„æ¶æ„äº§ç”Ÿä¸åŒçš„æ±‡ç¼–æŒ‡ä»¤ï¼ŒåŠ ä¸Šä¸Šé¢ <strong>- arch arch_type</strong> é€‰é¡¹å³å¯ï¼Œæ›´å¤šè¯·å‚è§<a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html">å®˜ç½‘</a>ã€‚åœ¨ <strong>Xcode</strong> ä¸­å¯åœ¨ <strong>Build Settings -&gt; Architectrues</strong> æŒ‡å®šäº§ç”Ÿçš„ <strong>CPU</strong> æŒ‡ä»¤é›†ã€‚</p>
<h4 id="ç”Ÿæˆæœºå™¨ä»£ç "><a href="#ç”Ÿæˆæœºå™¨ä»£ç " class="headerlink" title="ç”Ÿæˆæœºå™¨ä»£ç "></a>ç”Ÿæˆæœºå™¨ä»£ç </h4><pre><code class="shell">xcrun clang -fmodules -c nihao.s -o nihao.o
</code></pre>
<p>å¯ä»¥å‘ç°æœºå™¨ç äºŒè¿›åˆ¶æ–‡ä»¶æ— æ³•é˜…è¯»ï¼Œå¯å€ŸåŠ© <strong>otool</strong> æˆ–è€… <strong>MachOView</strong> ç­‰å·¥å…·æŸ¥çœ‹æ–‡ä»¶ä¸­çš„ç›¸å…³å†…å®¹ï¼š</p>
<pre><code class="shell">otool -v -h nihao.o
</code></pre>
<pre><code>nihao.o:
Mach header
      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
MH_MAGIC_64   X86_64        ALL  0x00      OBJECT     4        680 SUBSECTIONS_VIA_SYMBOLS
</code></pre>
<p>å¯ä»¥çœ‹è§ <strong>.o</strong> æ–‡ä»¶å®é™…ä¸Šæ˜¯ <strong>mach-o</strong> æ ¼å¼ï¼Œè¿™é‡Œæˆ‘ä»¬è¾“å…¥å¯æ‰§è¡Œæ–‡ä»¶çš„å¤´éƒ¨ï¼Œè§„å®šäº†è¿™ä¸ªæ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Œé€‚åº”æ¶æ„çš„ç›¸å…³ä¿¡æ¯ï¼Œä»¥åŠæ–‡ä»¶æ˜¯å¦‚ä½•è¢«åŠ è½½çš„ã€‚æ›´å¤šå…³äº <strong>mach-o</strong> çš„çŸ¥è¯†<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/54d842db3f69">å‚è§</a>ã€‚</p>
<h4 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h4><pre><code class="shell">xcrun clang nihao.o -Wl,`xcrun --show-sdk-path`/System/Library/Frameworks/Foundation.framework/Foundation
</code></pre>
<pre><code class="shell">./a.out
</code></pre>
<pre><code>2021-11-03 16:06:41.734 a.out[6394:220026] nihao!!!
</code></pre>
<p>ç”±äºæˆ‘ä»¬å¼•å…¥äº† <strong>Foundation</strong> é‡Œé¢çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦å°†ç›®æ ‡æ–‡ä»¶å’Œ <strong>Foundation framework</strong>è¿›è¡Œé“¾æ¥ï¼Œæ¥ç€å°±å¯ä»¥è¿è¡Œæˆ‘ä»¬çš„ç¨‹åºäº†ã€‚</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼šç¬¦å·è¡¨ï¼Œé‡Œé¢å­˜å‚¨çš„å…ƒç´ å¦‚ä¸‹ï¼š</p>
<pre><code class="xml">&lt;èµ·å§‹åœ°å€&gt; &lt;ç»“æŸåœ°å€&gt; &lt;å‡½æ•°&gt; [&lt;æ–‡ä»¶å:è¡Œå·&gt;]
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬è¾“å…¥a.outçš„ç¬¦å·ä¿¡æ¯</p>
<pre><code>nm -nm a.out
</code></pre>
<pre><code>                 (undefined) external _NSLog (from Foundation)
                 (undefined) external ___CFConstantStringClassReference (from CoreFoundation)
                 (undefined) external _objc_autoreleasePoolPop (from libobjc)
                 (undefined) external _objc_autoreleasePoolPush (from libobjc)
                 (undefined) external dyld_stub_binder (from libSystem)
0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header
0000000100003f20 (__TEXT,__text) external _main
0000000100008018 (__DATA,__data) non-external __dyld_private
</code></pre>
<p>å¯¹äºåŠ¨æ€é“¾æ¥åº“çš„ç¬¦å·ï¼ˆå¦‚ <strong>Foundation</strong>ï¼‰ï¼Œæœ€ç»ˆä¼šè®°å½•ä¸‹è¿™ä¸ªç¬¦å·æ˜¯é€šè¿‡è¿›è¡Œé“¾æ¥çš„ï¼Œå¹¶è®°å½•ä¸‹ä¾èµ–äºå“ªä¸ªåŠ¨æ€é“¾æ¥åº“ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨ï¼ˆ<strong>dyld</strong>ï¼‰ä¼šå»è§£æè¿™äº› <strong>undefined</strong> ç¬¦å·ã€‚å¯¹äºå…¶ä»–ä½ç½®çš„ç¬¦å·ï¼Œä¼šç›´æ¥ä¿®æ­£è¿™äº›ç¬¦å·çš„å…·ä½“ä½ç½®ä¿¡æ¯ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä»‹ç»äº†å…³äº iOS ç¼–è¯‘å™¨ã€iOS ç¼–è¯‘è¿‡ç¨‹çš„åŸºç¡€çŸ¥è¯†ã€‚å­¦ä¹ äº†è¿™äº›ï¼Œå¯¹ iOS ç¼–è¯‘æœ‰ä¸ªæ•´ä½“è®¤è¯†ã€‚å°±æœ¬äººè€Œè¨€ï¼Œåœ¨ä¸€è·¯æœå¯»èµ„æ–™çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹ä¹‹å‰ä¸€äº›é›¶æ•£çš„çŸ¥è¯†ç‚¹æœ‰äº†ä¸€äº›æ›´åŠ æ·±å…¥çš„è®¤è¯†ã€‚ç”±äºç¯‡å¹…æœ‰é™ï¼Œå…³äº SwiftC çš„ç¼–è¯‘è¿‡ç¨‹æ²¡æœ‰å¤šåšä»‹ç»ï¼Œåé¢ä¼šå†å‡ºä¸€ç¯‡è¿›è¡Œä»‹ç»ã€‚</p>
<p>ğŸ”—ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://objccn.io/issue-6-3/">ObjC ä¸­å›½ - Mach-O å¯æ‰§è¡Œæ–‡ä»¶</a></p>
<p><a target="_blank" rel="noopener" href="https://kiprey.github.io/2020/06/LLVM-IR-pass/">ä»£ç ä¼˜åŒ–ä¸LLVM IR pass</a></p>
<p><a target="_blank" rel="noopener" href="http://xelz.info/blog/2018/11/24/all-you-need-to-know-about-bitcode/">å…³äºbitcode, çŸ¥é“è¿™äº›å°±å¤Ÿäº†</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/340782811">iOS ç¼–è¯‘é“¾æ¥ï¼šObjective-C ç¼–è¯‘é“¾æ¥</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/54d842db3f69">è¶£æ¢ Mach-Oï¼šæ–‡ä»¶æ ¼å¼åˆ†æ</a></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2022/02/07/2022-02-07-Swift%20%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/" title="Swift ç¼–è¯‘æµç¨‹"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: Swift ç¼–è¯‘æµç¨‹</span></a><a class="button is-default" href="/2021/09/29/2021-09-29-NSTimer%20%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3/" title="NSTimerå¾ªç¯å¼•ç”¨åˆ†æä¸è§£å†³"><span class="has-text-weight-semibold">Next: NSTimerå¾ªç¯å¼•ç”¨åˆ†æä¸è§£å†³</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="xuhaodong1/xuhaodong1.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/xuhaodong1"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- çŸ¥ä¹--><!-- é¢†è‹±--><!-- è„¸ä¹¦--></section><p> <span>PV:</span><span id="busuanzi_value_site_pv"></span><span>  UV: </span><span id="busuanzi_value_site_uv"></span></p><p><span>Copyright Â©</span><span> nihao 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>
<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>Swift å†…å­˜æ¨¡å‹ä¸æ–¹æ³•è°ƒåº¦</title><meta name="description" content="ä¸ä»¥åŠŸåˆ©ä¸ºç›®çš„."><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><meta name="google-site-verification" content="GmOiGEvbpJTlBAXAXlJZrGhRTZOlLBC_CZ2yJaZ_Ktk"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/avatar.jpeg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="å‰è¨€æœ¬æ–‡ä»å†…å­˜åˆ†åŒºã€å†…å­˜å¯¹é½ã€å†…å­˜æ¨¡å‹ä¸æ–¹æ³•æ´¾å‘è§’åº¦ä»‹ç»äº†å…³äº Swift ä¸­çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚

å†…å­˜åˆ†åŒºiOS åº”ç”¨å†…å­˜åˆ†ä¸º 5 ä¸ªåŒºåŸŸï¼Œå…¶ä¸­â€œå…¨å±€åŒºâ€ã€â€œå¸¸é‡åŒºâ€ å’Œ â€œä»£ç åŒºâ€çš„å†…å­˜ç©ºé—´åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œâ€œæ ˆâ€ã€â€œå †â€çš„å†…å­˜ç©ºé—´åœ¨è¿è¡Œæ—¶ç¡®å®šã€‚


æ ˆåŒºï¼šå­˜å‚¨å€¼ç±»å‹çš„å±€éƒ¨å˜é‡ï¼Œå‡½æ•°å‚æ•°ï¼Œå…¶å¤§å°æœ‰é™ï¼Œè¿ç»­åˆ†é…ï¼Œå‘ä½åœ°å€æ‹“å±•ï¼›ç”±åœ¨è¿è¡Œæ—¶ç³»ç»Ÿè‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰å…¶å¯¹åº”çš„æ ˆã€‚
å †åŒºï¼šå­˜å‚¨å¼•ç”¨ç±»å‹ï¼Œä¸è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œå‘é«˜åœ°å€æ‹“å±•ï¼Œå¤§å°å—é™äºç³»ç»Ÿä¸­çš„è™šæ‹Ÿå†…å­˜ï¼›ç”±ç¨‹åºå‘˜åŠ¨æ€åˆ›å»ºå’Œé‡Šæ”¾å¯¹è±¡ï¼Œåœ¨è¿è¡Œæ—¶åˆ†é…ã€‚
å…¨å±€/é™æ€åŒºï¼šå­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œå³ .bss ï¼›å’Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œå³ .dataã€‚
å¸¸é‡åŒºï¼šå­˜å‚¨å­—ç¬¦ä¸²å¸¸é‡
ä»£ç åŒºï¼šå­˜å‚¨ç¨‹åºè¿è¡Œæ—¶çš„ä»£ç 

å†…å­˜å¯¹é½ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜å¯¹é½ï¼š

æŸ.."><meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="nihao' Blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">nihao's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Swift å†…å­˜æ¨¡å‹ä¸æ–¹æ³•è°ƒåº¦</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA"><span class="toc-text">å†…å­˜åˆ†åŒº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="toc-text">å†…å­˜å¯¹é½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-text">å†…å­˜æ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#struct"><span class="toc-text">struct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#class"><span class="toc-text">class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#protocol"><span class="toc-text">protocol</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E6%B4%BE%E5%8F%91"><span class="toc-text">æ–¹æ³•æ´¾å‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E7%B1%BB%E5%9E%8B"><span class="toc-text">å£°æ˜ç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-text">å…³é”®å­—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%B4%BE%E5%8F%91%EF%BC%9A"><span class="toc-text">é™æ€æ´¾å‘ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E8%A1%A8%E6%B4%BE%E5%8F%91%EF%BC%9A"><span class="toc-text">å‡½æ•°è¡¨æ´¾å‘ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B4%BE%E5%8F%91%EF%BC%9A"><span class="toc-text">åŠ¨æ€æ´¾å‘ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%97"><span class="toc-text">ğŸ”—</span></a></li></ol></div><div class="column is-9"><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Swift å†…å­˜æ¨¡å‹ä¸æ–¹æ³•è°ƒåº¦</h1><header class="my-5"><a href="/tags/Swift"><i class="tag post-item-tag">Swift</i></a><time class="has-text-grey" datetime="2022-03-13T14:54:49.000Z">2022-03-13</time></header><article class="mt-2 post-content"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡ä»å†…å­˜åˆ†åŒºã€å†…å­˜å¯¹é½ã€å†…å­˜æ¨¡å‹ä¸æ–¹æ³•æ´¾å‘è§’åº¦ä»‹ç»äº†å…³äº Swift ä¸­çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚</p>
<span id="more"></span>
<h2 id="å†…å­˜åˆ†åŒº"><a href="#å†…å­˜åˆ†åŒº" class="headerlink" title="å†…å­˜åˆ†åŒº"></a>å†…å­˜åˆ†åŒº</h2><p>iOS åº”ç”¨å†…å­˜åˆ†ä¸º 5 ä¸ªåŒºåŸŸï¼Œå…¶ä¸­â€œå…¨å±€åŒºâ€ã€â€œå¸¸é‡åŒºâ€ å’Œ â€œä»£ç åŒºâ€çš„å†…å­˜ç©ºé—´åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œâ€œæ ˆâ€ã€â€œå †â€çš„å†…å­˜ç©ºé—´åœ¨è¿è¡Œæ—¶ç¡®å®šã€‚</p>
<p><img src="/images/blog/iOS%E5%BA%94%E7%94%A8%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA.png" alt="iOSåº”ç”¨å†…å­˜åˆ†åŒº"></p>
<ul>
<li>æ ˆåŒºï¼šå­˜å‚¨å€¼ç±»å‹çš„å±€éƒ¨å˜é‡ï¼Œå‡½æ•°å‚æ•°ï¼Œå…¶å¤§å°æœ‰é™ï¼Œè¿ç»­åˆ†é…ï¼Œå‘ä½åœ°å€æ‹“å±•ï¼›ç”±åœ¨è¿è¡Œæ—¶ç³»ç»Ÿè‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰å…¶å¯¹åº”çš„æ ˆã€‚</li>
<li>å †åŒºï¼šå­˜å‚¨å¼•ç”¨ç±»å‹ï¼Œä¸è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œå‘é«˜åœ°å€æ‹“å±•ï¼Œå¤§å°å—é™äºç³»ç»Ÿä¸­çš„è™šæ‹Ÿå†…å­˜ï¼›ç”±ç¨‹åºå‘˜åŠ¨æ€åˆ›å»ºå’Œé‡Šæ”¾å¯¹è±¡ï¼Œåœ¨è¿è¡Œæ—¶åˆ†é…ã€‚</li>
<li>å…¨å±€/é™æ€åŒºï¼šå­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œå³ .bss ï¼›å’Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œå³ .dataã€‚</li>
<li>å¸¸é‡åŒºï¼šå­˜å‚¨å­—ç¬¦ä¸²å¸¸é‡</li>
<li>ä»£ç åŒºï¼šå­˜å‚¨ç¨‹åºè¿è¡Œæ—¶çš„ä»£ç </li>
</ul>
<h2 id="å†…å­˜å¯¹é½"><a href="#å†…å­˜å¯¹é½" class="headerlink" title="å†…å­˜å¯¹é½"></a>å†…å­˜å¯¹é½</h2><p><strong>ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜å¯¹é½ï¼š</strong></p>
<ol>
<li>æŸäº›ç¡¬ä»¶ä¸èƒ½éšæ„è®¿é—®ä»»æ„åœ°å€</li>
<li>æé«˜è®¿é—®æ•ˆç‡</li>
</ol>
<p><strong>å†…å­˜å¯¹é½åŸåˆ™ï¼š</strong></p>
<ol>
<li>ç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜çš„<strong>åç§»é‡ï¼ˆoffsetï¼‰</strong>ä¸º0ï¼Œä»¥åæ¯ä¸ªæˆå‘˜ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„ <strong>offset</strong> éƒ½æ˜¯<strong>è¯¥æˆå‘˜å¤§å°ä¸å¯¹é½ç³»æ•°ä¸­è¾ƒå°å€¼</strong>çš„æ•´æ•°å€ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æˆå‘˜ä¹‹é—´åŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</li>
<li><strong>ç»“æ„ä½“çš„æ€»å¤§å°</strong>ä¸ºå¯¹é½ç³»æ•°çš„<strong>æ•´æ•°å€</strong>ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æœ€æœ«ä¸€ä¸ªæˆå‘˜ä¹‹ååŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</li>
</ol>
<p>æ³¨ï¼šç»“æ„ä½“å¯ä»£æ›¿ä¸º <strong>class</strong>ã€<strong>protocol</strong>ç­‰ä»»æ„ç±»å‹ï¼Œåªæ˜¯å…¶ä»–ç±»å‹å†…å­˜åˆ†å¸ƒä¸ç»“æ„ä½“ä¸åŒã€‚</p>
<p>åœ¨ <strong>Swift</strong> ä¸­ï¼š</p>
<pre><code class="Swift">MemoryLayout&lt;T&gt;.size // å±æ€§å ç”¨å¤§å°(ä¸å…¶å±æ€§åŒ¹é…)
MemoryLayout&lt;T&gt;.stride // å®é™…å ç”¨å¤§å°
MemoryLayout&lt;T&gt;.alignment // å¯¹é½ç³»æ•°
</code></pre>
<h2 id="å†…å­˜æ¨¡å‹"><a href="#å†…å­˜æ¨¡å‹" class="headerlink" title="å†…å­˜æ¨¡å‹"></a>å†…å­˜æ¨¡å‹</h2><h3 id="struct"><a href="#struct" class="headerlink" title="struct"></a><strong>struct</strong></h3><p>ä¾‹ï¼š</p>
<pre><code class="swift">struct Foo {
    let a: Int8 = 2   // 1 byte
    let b: Int16 = 4  // 2 bytes
    let c: Int32 = 6  // 4 bytes
    let d: Int = 8    // 8 bytes
    
    func foo() {
        print("Hello")
    }
}

let foo = Foo()

print(MemoryLayout&lt;Foo&gt;.size)
print("===end===")
</code></pre>
<img src="/images/blog/æˆªå±2021-12-26 10.27.40.png" alt="image-20211226103015351" style="zoom: 67%;">

<p>å¯ä»¥çœ‹å‡ºï¼Œ<strong>struct</strong> çš„å†…å­˜æ˜¯è¿ç»­åˆ†å¸ƒçš„ï¼Œä½†æ˜¯ç”±äº<strong>å†…å­˜å¯¹é½åŸåˆ™</strong>ï¼Œå±æ€§ <strong>a</strong> æ‰€å ç”¨å†…å­˜ç©ºé—´ä¸º <strong>2 byte</strong>ï¼Œå¯¹äºå®ä¾‹æ–¹æ³•å…¶å†…éƒ¨å¹¶ä¸ä¼šåšå­˜å‚¨ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘åç›´æ¥æŒ‡å‘æ–¹æ³•çš„åœ°å€ã€‚</p>
<h3 id="class"><a href="#class" class="headerlink" title="class"></a><strong>class</strong></h3><p><strong>Swift</strong> ä¸ <strong>Objective-C</strong> ä¸­çš„ <strong>Class</strong> ç±»å‹ï¼Œä¸ºäº†å…¼å®¹ <strong>Objective-C</strong> ä¸”å…·æœ‰æ›´å¤šçš„ <strong>Swift</strong> ç‰¹æ€§ï¼Œåœ¨ <strong>Swift</strong> æºç ä¸­ï¼Œå…¶ç±»å‹ä¸º <code>swift_class_t</code> çš„ç»“æ„ä½“ï¼Œç»§æ‰¿äº <code>objc_class</code>ã€‚å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/images/blog/image-20220313210720322-7176842.png" alt="image-20220313210720322"></p>
<p><strong>isa</strong>ï¼šä¸ <strong>Objective-C</strong> ä¸­ <strong>isa</strong> ä¸€æ ·ï¼ŒåŒ…å«äº†è¿™ä¸ªç±»å‹çš„ä¿¡æ¯ï¼Œå¦‚ çˆ¶ç±»çš„ <strong>isa</strong> ä¿¡æ¯ã€æ˜¯å¦å­˜åœ¨å…³è”å¯¹è±¡ã€ä»¥åŠ <strong>virtual table</strong> ç”¨ä»¥æ–¹æ³•è°ƒç”¨ç­‰å†…å®¹ã€‚</p>
<p><strong>retain count</strong>ï¼šè®°å½•å…¶å¼•ç”¨è®¡æ•°å€¼</p>
<h3 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a><strong>protocol</strong></h3><p>çœ‹ä¸‹é¢æºç </p>
<pre><code class="swift">protocol Drawable { func draw() }
struct Point : Drawable {
    var x: Int
    var y: Int
    func draw() { print("Point") }
}
struct Line : Drawable {
    var x1, y1, x2, y2: Int
    func draw() { print("Line") }
}
class Cricle: Drawable {
    var r: Int = 5
    func draw() { print("SharedLine") }
}
struct Simple {
    var drawable1: Drawable
    var drawable2: Drawable
    var drawable3: Drawable
    func printMemoryLayout() {
        MemoryLayout.size(ofValue: drawable1)
        MemoryLayout.size(ofValue: drawable2)
        MemoryLayout.size(ofValue: drawable3)
    }
}
</code></pre>
<p>é¦–å…ˆåœ¨ <strong>Build Setting</strong> ä¸­ï¼Œå°† <strong>Reflection Metadata Level</strong> æ”¹ä¸º <strong>None</strong>ï¼Œè°ƒç”¨ <code>printMemoryLayout</code> å†è¿›è¡Œè°ƒè¯•ã€‚</p>
<pre><code>40
40
40
</code></pre>
<p><img src="/images/blog/image-20220313200904959-7173347.png" alt="image-20220313200904959"></p>
<p><strong>Reflection Metadata Level</strong> æ”¹ä¸º <strong>None</strong>ï¼Œæ˜¯é˜²æ­¢ç¼–è¯‘å™¨å°†åå°„å…ƒæ•°æ®å‘é€åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œä¼šå¯¹åˆ†æé€ æˆå¹²æ‰°ã€‚</p>
<p>å¯¹äºåè®®ç±»å‹æ¥è¯´ï¼Œä¸ºäº†å®ç°è¯­ä¹‰ä¸Šçš„å¤šæ€ï¼Œä¸”åˆ›å»ºæ—¶å…¶å†…å­˜å¤§å°æ˜¯ä¸å›ºå®šçš„ï¼Œå› æ­¤å¼•å…¥äº†æ–°çš„å†…å­˜ç»“æ„è¿›è¡Œå¤„ç†ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°è¾“å‡ºå†…å­˜å ç”¨å¤§å°å…¨éƒ¨ä¸º 40ï¼Œä¸”éƒ½æ‹¥æœ‰ç›¸åŒçš„æ•°æ®ç»“æ„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/images/blog/image-20220311002137424-6929301.png" alt="image-20220311002137424"></p>
<p><strong>valueBuffer</strong>ï¼š3ä½ï¼Œå¯¹äºç©ºé—´å°äºæˆ–ç­‰äº <strong>valueBuffer</strong> çš„å€¼ï¼Œç›´æ¥å­˜å‚¨åœ¨ <strong>valueBuffer</strong> ä¸­ï¼›å¯¹äºç©ºé—´å¤§äº valueBufferçš„å€¼ï¼Œåˆ™ä¼šåœ¨å †ä¸­å¼€è¾Ÿå†…å­˜ç©ºé—´ï¼Œ<strong>valueBuffer</strong> åˆ™å­˜å‚¨å…¶å¼•ç”¨åœ°å€ã€‚å¯¹åº” <code>drawable1</code> ä¸ <code>drawable2</code>ã€‚</p>
<p><strong>value witness table</strong>ï¼šç”±äºæ¯ä¸ªåè®®ç±»å‹çš„åˆå§‹åŒ–ä¸å°½ç›¸åŒï¼Œæ‰€ä»¥æ¯ä¸€ç§ç±»å‹(ä¸Šä¸Šå›¾çš„ <strong>metadata</strong> )éƒ½ä¼šæœ‰ä¸€ä¸ª <strong>value witness table</strong>ï¼Œç”¨äºè¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæœ‰ <code>alloc</code>ã€<code>copy</code>ã€<code>destruct</code>ã€<code>deallocate</code> ç­‰æ–¹æ³•ã€‚</p>
<p><strong>protocol witness table</strong>ï¼šç±»ä¼¼äº <strong>class</strong> çš„ <strong>virtual table</strong>ï¼Œç”¨ä»¥å­˜å‚¨æ¯ä¸ªåè®®ç±»å‹çš„æ–¹æ³•ã€‚æ¯ç§ç±»å‹ä¼šåˆ›é€  <code>PWT</code> è¡¨ï¼Œå†…éƒ¨åŒ…å«æŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•å…·ä½“å®ç°ã€‚</p>
<h2 id="æ–¹æ³•æ´¾å‘"><a href="#æ–¹æ³•æ´¾å‘" class="headerlink" title="æ–¹æ³•æ´¾å‘"></a>æ–¹æ³•æ´¾å‘</h2><p>æ–¹æ³•æ´¾å‘æ˜¯æŒ‡å‘Šè¯‰ <strong>CPU</strong> å¦‚ä½•å»æ‰¾åˆ°è¯¥å‡½æ•°åœ°å€å¹¶è¿›è¡Œè°ƒç”¨çš„è¿‡ç¨‹ï¼Œåœ¨ <strong>Swift</strong> ä¸­åˆ†ä¸º 3 ç§æ´¾å‘æœºåˆ¶ï¼Œåˆ†åˆ«æ˜¯é™æ€æ´¾å‘ã€å‡½æ•°è¡¨æ´¾å‘ä¸åŠ¨æ€æ´¾å‘ã€‚é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šæ˜¯ä»€ä¹ˆæ ·çš„æ–¹æ³•æ´¾å‘å‘¢ï¼Ÿä¸»è¦æœ‰ä¸¤æ–¹é¢çº¬åº¦çš„è€ƒé‡ï¼š</p>
<h3 id="å£°æ˜ç±»å‹"><a href="#å£°æ˜ç±»å‹" class="headerlink" title="å£°æ˜ç±»å‹"></a>å£°æ˜ç±»å‹</h3><p>å¯¹äºä¸åŒçš„å£°æ˜ä½ç½®æ¥è¯´ï¼Œå…¶æ–¹æ³•æ´¾å‘çš„æ˜¯ä¸åŒçš„ï¼Œè‹¥ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>ç±»ä¸­å£°æ˜</th>
<th>æ‹“å±•å£°æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>value type</td>
<td>static</td>
<td>static</td>
</tr>
<tr>
<td>protocol</td>
<td>table</td>
<td>static</td>
</tr>
<tr>
<td>class</td>
<td>table</td>
<td>static</td>
</tr>
<tr>
<td>NSObject SubClass</td>
<td>table</td>
<td>message</td>
</tr>
</tbody></table>
<p><strong>è§„å¾‹ï¼š</strong></p>
<p>å€¼ç±»å‹éƒ½æ˜¯é™æ€æ´¾å‘</p>
<p>åè®®å’Œç±»ä¸­çš„æ‹“å±•éƒ½æ˜¯é™æ€æ´¾å‘</p>
<p><strong>NSObject</strong> æ‹“å±•é‡‡ç”¨æ¶ˆæ¯æ´¾å‘ï¼Œç±»ä¸­å£°æ˜é‡‡ç”¨å‡½æ•°è¡¨æ´¾å‘</p>
<p>åè®®ä¸­é»˜è®¤å®ç°ä½¿ç”¨å‡½æ•°è¡¨æ´¾å‘</p>
<h3 id="å…³é”®å­—"><a href="#å…³é”®å­—" class="headerlink" title="å…³é”®å­—"></a>å…³é”®å­—</h3><p>å¯¹äºæŸäº›å…³é”®å­—æ¥è¯´ï¼Œä¹Ÿèƒ½å¤Ÿæ”¹å˜å…¶æ´¾å‘æ–¹å¼ï¼š</p>
<table>
<thead>
<tr>
<th>å…³é”®å­—</th>
<th>æ´¾å‘æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td>final</td>
<td>static</td>
</tr>
<tr>
<td>dynamic</td>
<td>Message</td>
</tr>
<tr>
<td>@objc &amp; @nonobjc</td>
<td>ä¿®æ”¹ Objective-C å¯è§æ€§</td>
</tr>
<tr>
<td>@inline</td>
<td>Static</td>
</tr>
</tbody></table>
<p><strong>è§„å¾‹ï¼š</strong></p>
<p>final - é™æ€æ´¾å‘</p>
<p>dynamic - æ¶ˆæ¯æ´¾å‘</p>
<p>@objc &amp; @nonobjc - å£°æ˜å‡½æ•°èƒ½å¦è¢« objective-c runtimeæ•æ‰åˆ°</p>
<p>final @objc - è°ƒç”¨æ—¶é™æ€æ´¾å‘ï¼Œä½†ä¼šå°†å‡½æ•°æ³¨å†Œåˆ° objective-c runtimeä¸­</p>
<p>@inline - ç›´æ¥æ´¾å‘ï¼Œä½†å¦‚æœæ˜¯ dynamic @inlineï¼Œåˆ™ä¼šé‡‡ç”¨æ¶ˆæ¯æ´¾å‘</p>
<p>ç»“åˆä¸Šä¸¤å›¾æ€»ç»“å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>ç›´æ¥æ´¾å‘</th>
<th>å‡½æ•°è¡¨æ´¾å‘</th>
<th>æ¶ˆæ¯æ´¾å‘</th>
</tr>
</thead>
<tbody><tr>
<td>NSObject</td>
<td>@nonobjc / final</td>
<td>ç±»ä¸­å£°æ˜</td>
<td>æ‹“å±•ç”³æ˜ ä¸” dynamic</td>
</tr>
<tr>
<td>class</td>
<td>æ‹“å±•å£°æ˜ ä¸” final</td>
<td>ç±»ä¸­å£°æ˜</td>
<td>dynamic</td>
</tr>
<tr>
<td>protocol</td>
<td>æ‹“å±•å£°æ˜</td>
<td>ç±»ä¸­å£°æ˜</td>
<td>@objc</td>
</tr>
<tr>
<td>value type</td>
<td>æ‰€æœ‰æ–¹æ³•</td>
<td>æ— </td>
<td>æ— </td>
</tr>
</tbody></table>
<h3 id="é™æ€æ´¾å‘ï¼š"><a href="#é™æ€æ´¾å‘ï¼š" class="headerlink" title="é™æ€æ´¾å‘ï¼š"></a><strong>é™æ€æ´¾å‘</strong>ï¼š</h3><p>æŒ‡ç¼–è¯‘æ—¶ç›´æ¥è·³è½¬åˆ°å‡½æ•°çš„åœ°å€ï¼Œè°ƒç”¨é€Ÿåº¦æœ€å¿«ï¼ŒåŒæ—¶å¯èƒ½ç»è¿‡ç¼–è¯‘å™¨ä¼˜åŒ–æˆ <strong>inline</strong>ã€‚</p>
<p>åœ¨ <strong>Swift</strong> ä¸­ï¼Œå€¼ç±»å‹çš„æ–¹æ³•è°ƒç”¨ä¸ <strong>final</strong> ä¿®é¥°çš„æ˜¯é™æ€æ´¾å‘ã€‚ï¼ˆå€¼ç±»å‹ä¸ <strong>final</strong> ä¸æ”¯æŒç»§æ‰¿ä¸ <strong>override</strong>ï¼‰</p>
<h3 id="å‡½æ•°è¡¨æ´¾å‘ï¼š"><a href="#å‡½æ•°è¡¨æ´¾å‘ï¼š" class="headerlink" title="å‡½æ•°è¡¨æ´¾å‘ï¼š"></a><strong>å‡½æ•°è¡¨æ´¾å‘ï¼š</strong></h3><p>ä¸ºåœ¨ç±»ä¸­ç”³æ˜è¿‡çš„æ‰€æœ‰æ–¹æ³•ç”Ÿæˆä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„</p>
<p><strong>virtual table / protocol witness table</strong></p>
<img src="/images/blog/1_4YaI2HPK48IqgyK3DpU_VQ.png" alt="A diagram showing the memory offsets for method1, method2, and method3 in ParentClass and ChildClass." style="zoom:80%;">

<p>ç›¸è¾ƒäºé™æ€æ´¾å‘ï¼Œé€Ÿåº¦æ›´æ…¢ï¼Œéœ€è¦ä¸¤æ¬¡è¯»å–åœ°å€ä¸ä¸€æ¬¡è·³è½¬ï¼ŒåŒæ—¶ç¼–è¯‘å™¨æ— ä¼˜åŒ–æ“ä½œï¼Œå°†è‡ªèº«ä½œä¸ºå®ä¾‹ä½œä¸ºéšå«å‚æ•°ä¼ é€’åˆ°æ–¹æ³•ä¸­ã€‚ä¾‹å¦‚ä¸‹é¢ä¸€æ®µåè®®ç±»å‹çš„æ–¹æ³•è°ƒç”¨çš„ <strong>SIL</strong> ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="swift">// drawACopy(drawables:)
sil hidden @$s14ViewController9drawACopy9drawablesyAA8Drawable_p_tF : $@convention(thin) (@in_guaranteed Drawable) -&gt; () {
// %0 "drawables"                                 // users: %2, %1
bb0(%0 : $*Drawable):
  debug_value_addr %0 : $*Drawable, let, name "drawables", argno 1 // id: %1
  %2 = open_existential_addr immutable_access %0 : $*Drawable to $*@opened("F57086CE-A07E-11EC-86EE-ACDE48001122") Drawable // users: %4, %4, %3
  %3 = witness_method $@opened("F57086CE-A07E-11EC-86EE-ACDE48001122") Drawable, #Drawable.draw : &lt;Self where Self : Drawable&gt; (Self) -&gt; () -&gt; (), %2 : $*@opened("F57086CE-A07E-11EC-86EE-ACDE48001122") Drawable : $@convention(witness_method: Drawable) &lt;Ï„_0_0 where Ï„_0_0 : Drawable&gt; (@in_guaranteed Ï„_0_0) -&gt; () // type-defs: %2; user: %4
  %4 = apply %3&lt;@opened("F57086CE-A07E-11EC-86EE-ACDE48001122") Drawable&gt;(%2) : $@convention(witness_method: Drawable) &lt;Ï„_0_0 where Ï„_0_0 : Drawable&gt; (@in_guaranteed Ï„_0_0) -&gt; () // type-defs: %2
  %5 = tuple ()                                   // user: %6
  return %5 : $()                                 // id: %6
} // end sil function '$s14ViewController9drawACopy9drawablesyAA8Drawable_p_tF'
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å¯¹äºåè®®ç±»å‹ï¼Œä¼šé€šè¿‡ <code>open_existential_addr</code> åˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡ <code>%2</code>ï¼Œåœ¨é€šè¿‡ <code>%2</code> æ‰¾åˆ°å…¶å¯¹åº”<code>witness_method</code> - <code>%3</code>ï¼Œæœ€åå†é€šè¿‡ <code>%2</code> ä¸ä½œä¸ºå…¥å‚æ‰§è¡Œæ–¹æ³• ï¼ˆ<code>apply</code>ï¼‰ <code>%3</code>ã€‚</p>
<h3 id="åŠ¨æ€æ´¾å‘ï¼š"><a href="#åŠ¨æ€æ´¾å‘ï¼š" class="headerlink" title="åŠ¨æ€æ´¾å‘ï¼š"></a>åŠ¨æ€æ´¾å‘ï¼š</h3><p>ä¸ <strong>Objective-C</strong> ä¸€è‡´ï¼Œä¼šè¢«ç¿»è¯‘æˆ <strong>objc_send</strong> è¿™æ ·çš„ä»£ç ï¼Œä¼šç»è¿‡ <strong>cache</strong> æŸ¥æ‰¾ã€é€šè¿‡ <strong>isa</strong> æŒ‡é’ˆåœ¨å½“å‰ç±»ä¸çˆ¶ç±»çš„ <strong>method_list</strong> æŸ¥æ‰¾ã€æœ€ååˆ°æ¶ˆæ¯è½¬å‘æµç¨‹ã€‚åŠ¨æ€æ´¾å‘çš„é€Ÿåº¦æœ€æ…¢ï¼Œä½†å¯åŠŸèƒ½æ€§æœ€å¼ºã€‚</p>
<p>ç½‘ä¸Šå…³äºåŠ¨æ€æ´¾å‘çš„æ–‡ç« å¾ˆå¤šï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œè¯¦æƒ…å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903575437606920#heading-6">iOS æ¶ˆæ¯å‘é€ä¸è½¬å‘è¯¦è§£</a></p>
<h2 id="ğŸ”—"><a href="#ğŸ”—" class="headerlink" title="ğŸ”—"></a>ğŸ”—</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e5a54813b93d">iOS-åº•å±‚åŸç† 24: å†…å­˜5å¤§åŒº</a></p>
<p><a target="_blank" rel="noopener" href="https://swiftunboxed.com/internals/size-stride-alignment/">Size, Stride, Alignment</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/LeoMobileDeveloper/Blogs/blob/master/Swift/Method%20Dispatch%20and%20Memory%20Layout.md#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D">Swift æ–¹æ³•è°ƒåº¦ä¸å†…å­˜å¸ƒå±€</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/35696161">Swift ä¸­çš„æ–¹æ³•è°ƒç”¨ï¼ˆMethod Dispatchï¼‰ï¼ˆä¸€ï¼‰ - æ¦‚è¿°</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6968799729853399053#note3">[è¯‘] Swift ä¸­çš„æ–¹æ³•æ´¾å‘</a></p>
<p><a target="_blank" rel="noopener" href="https://www.rightpoint.com/rplabs/switch-method-dispatch-table">switch-method-dispatch-table</a></p>
<p><a target="_blank" rel="noopener" href="https://academy.realm.io/posts/goto-mike-ash-exploring-swift-memory-layout/">Exploring Swift Memory Layout</a></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2022/04/02/iOS%20%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="iOSä¸­çš„å¤šçº¿ç¨‹ä¸çº¿ç¨‹å®‰å…¨"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: iOSä¸­çš„å¤šçº¿ç¨‹ä¸çº¿ç¨‹å®‰å…¨</span></a><a class="button is-default" href="/2022/03/07/iOS%20%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/" title="iOS å¯åŠ¨ä¼˜åŒ–"><span class="has-text-weight-semibold">Next: iOS å¯åŠ¨ä¼˜åŒ–</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="xuhaodong1/xuhaodong1.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/xuhaodong1"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- çŸ¥ä¹--><!-- é¢†è‹±--><!-- è„¸ä¹¦--></section><p> <span>PV:</span><span id="busuanzi_value_site_pv"></span><span>  UV: </span><span id="busuanzi_value_site_uv"></span></p><p><span>Copyright Â©</span><span> nihao 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>
---
title: "iOS ç¼–è¯‘è¿‡ç¨‹"
categories:
  - iOS
tags:
  - iOS
  - Compile
---

# iOS ç¼–è¯‘è¿‡ç¨‹ 

## 1. å‰è¨€

å­¦ä¹  **iOS** ç¼–è¯‘è¿‡ç¨‹ï¼ˆ**Compile**ï¼‰æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½ç†è§£ä»£ç æ˜¯å¦‚ä½•è¢«è®¡ç®—æœºè¿ä½œèµ·æ¥ï¼Œç¼–è¯‘å™¨ä¸ºä»£ç åšäº†å“ªäº›ä¼˜åŒ–ï¼Œè®©æˆ‘ä»¬å­¦ä¼šä»å¦ä¸€ä¸ªè§’åº¦æ¥çœ‹å¾…é—®é¢˜ã€‚
<!-- more -->
## 2. ç¼–è¯‘å™¨ç»“æ„

ç°ä»£ç¼–è¯‘å™¨æ˜¯å°†æºä»£ç è½¬æ¢æˆå¯æ‰§è¡Œæ–‡ä»¶çš„ç¨‹åºï¼Œå·¥ä½œæµç¨‹ä¸»è¦åˆ†ä¸º **å‰ç«¯** å’Œ **åç«¯** ä¸¤ä¸ªéƒ¨åˆ†ï¼š

1. å‰ç«¯ï¼šå¯¹æºä»£ç è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆä¸­é—´ä»£ç ã€‚
2. åç«¯ï¼šé’ˆå¯¹ä¸­é—´ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå¹¶è½¬æ¢æˆç›®æ ‡æœºå™¨çš„ä»£ç æŒ‡ä»¤ã€‚

```mermaid
graph LR
	A(SourceCode) --> B(Frontend)
    B(Frontend) --> C(Backend)
    C(Backend) --> D(Machine Code)
```

é’ˆå¯¹iOSå¹³å°ï¼Œä¸åŒè¯­è¨€é‡‡ç”¨äº†ä¸åŒçš„ç¼–è¯‘å™¨å‰ç«¯ï¼š

1. **Frontendï¼šClang / SwiftC**

   å¯¹äº **Objective-C / C / C++ / Objective-C++**  æ¥è¯´é‡‡ç”¨ **Clang** ç¼–è¯‘å™¨å‰ç«¯ï¼›

   å¯¹äº **Swift** æ¥è¯´åˆ™é‡‡ç”¨ **SwiftC**ï¼›

2. **Backendï¼šLLVM**

   æ— è®ºæ˜¯ **C** ç³»è¯­è¨€è¿˜æ˜¯ **Swift** éƒ½é‡‡ç”¨ **LLVM** ä½œä¸ºç¼–è¯‘å™¨åç«¯ï¼›

å€¼å¾—æ³¨æ„çš„æ˜¯åœ¨ **Xcode3** ä»¥å‰ï¼Œéƒ½é‡‡ç”¨ **GCC** ä½œä¸ºç¼–è¯‘å™¨å‰ç«¯ï¼Œä½†ä¸º **Apple** å¿«é€Ÿå‘å±•éœ€è¦åŠŸèƒ½æ›´å¼ºå¤§å’Œæ€§èƒ½æ›´å¥½çš„ç¼–è¯‘å™¨ï¼Œæ‰€ä»¥ **Apple** è‡ªå·±å¼€å‘äº† **Clang** ä½œä¸ºç¼–è¯‘å™¨å‰ç«¯ã€‚ä¸‹é¢å¯¹ç¼–è¯‘å™¨åšä¸€ä¸ªç®€è¦ä»‹ç»ï¼š

* **GCC**

**GCC**ï¼ˆ**GNU Compile Collection**ï¼Œ**GNU **ç¼–è¯‘å™¨å¥—è£…ï¼‰ï¼Œæ˜¯ä¸€å¥—ç”± **GNU** å¼€å‘çš„ç¼–ç¨‹è¯­è¨€ç¼–è¯‘å™¨ã€‚æ¥æœ¬åªèƒ½å¤„ç† *C* è¯­è¨€ï¼Œåæ¥å¿«é€Ÿæ¼”è¿›ï¼Œå˜å¾—å¯å¤„ç† **C++ã€Objective-Cã€Javaã€Fortran** ç­‰å…¶ä»–è¯­è¨€ã€‚ä½†ç”±äºä¸€äº›ç¼ºé™·ï¼Œå¯¼è‡´äº† **Apple** æŠ›å¼ƒäº† **GCC** ï¼Œå¼€å‘å‡ºäº† **Clang** ä½œä¸ºå…¶å‰ç«¯ç¼–è¯‘å™¨ã€‚

1. **GCC** çš„ **Objective-C Frontend** ä¸æ˜¯ **Apple** ç»´æŠ¤ï¼Œå¯¼è‡´æƒ³è¦æ·»åŠ ä¸€äº›è¯­æ³•æç¤ºç­‰åŠŸèƒ½å¾—å»è¦æ±‚ **GCC** å›¢é˜Ÿåšã€‚
2. **GCC** çš„æ’ä»¶ã€å·¥å…·ã€**IDE** çš„æ”¯æŒè–„å¼±ã€‚
3. **GCC** çš„ç¼–è¯‘æ•ˆç‡å’Œæ€§èƒ½ä¸è¶³ã€‚

* **Clang**

**Clang1.0** äº **2009** å¹´æ­£å¼ä¸ **LLVM2.6** æ­£å¼å‘å¸ƒï¼Œæ—¨åœ¨æä¾› **GCC** çš„æ›¿ä»£å“ï¼Œæ”¯æŒäº† **GUN** ç¼–è¯‘å™¨å¤§å¤šæ•°çš„ç¼–è¯‘å™¨è®¾ç½®ä»¥åŠéå®˜æ–¹è¯­è¨€çš„æ‹“å±•ï¼Œç›¸è¾ƒäº **GCC** ï¼Œ**Clang** å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. ç¼–è¯‘é€Ÿåº¦æ›´å¿«ã€‚
2. å ç”¨å†…å­˜æ›´å°ã€‚
3. æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‹“å±•ä¸é‡ç”¨ã€‚
4. è¯Šæ–­ä¿¡æ¯å¯è¯»æ€§å¼ºã€‚

* **SwiftC**

**SwiftC** åœ¨å‰ç«¯é‡‡ç”¨äº† **SIL** ä¸­é—´è¯­è¨€ï¼Œè¿™æ˜¯å› ä¸º **Swift** ä½œä¸ºä¸€ç§é«˜çº§è¯­è¨€ï¼Œæœ‰è®¸å¤šç‰¹æ€§ï¼Œå¦‚ **protocol** çš„æ³›å‹ï¼Œä¹Ÿæ˜¯ä¸€é—¨å®‰å…¨çš„è¯­è¨€ï¼Œç¡®ä¿å˜é‡åœ¨ä½¿ç”¨ä¹‹å‰è¢«åˆå§‹åŒ–ã€æ£€æµ‹ä¸å¯æ‰§è¡Œçš„ä»£ç ï¼Œäºæ˜¯å¢åŠ äº†ä¸€å±‚ **SIL** æ¥åšè¿™äº›äº‹æƒ…ã€‚

* **LLVM**

**LLVM** æ˜¯ä¸€å¥—ç¼–è¯‘å™¨åŸºç¡€è®¾å¤‡é¡¹ç›®ï¼Œç”± **C++** å†™æˆï¼ŒåŒ…å«ä¸€ç³»åˆ—æ¨¡å—åŒ–çš„ç¼–è¯‘å™¨ç»„ä»¶å’Œå·¥å…·é“¾ï¼Œç”¨æ¥å¼€å‘ç¼–è¯‘å™¨çš„å‰ç«¯å’Œåç«¯ã€‚åœ¨ **iOS** ä¸­ï¼Œ**LLVM** ä½œä¸ºç¼–è¯‘å™¨åç«¯ä¸»è¦æä¾› **Optimizer** å’Œ **Code Generator** ï¼Œå°†æ¥æ”¶åˆ°çš„ **IR** ä¸­é—´ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œä»¥åŠæœºå™¨ä»£ç ç”Ÿæˆã€‚

## 3. ç¼–è¯‘è¿‡ç¨‹

### 3.1 æµç¨‹æ¢³ç†

```mermaid
graph TD
    subgraph Clang
	id1(æºä»£ç ) --> id2(é¢„å¤„ç†) 
    id2(é¢„å¤„ç†) --> id3(è¯­æ³•åˆ†æ)   
    id3(è¯­æ³•åˆ†æ) --  token  --> id4(è¯­æ³•åˆ†æ)
    id4(è¯­æ³•åˆ†æ) --  AST  --> id5(ä¸­é—´ä»£ç ç”Ÿæˆ)
    end
    
    subgraph Optimizer, Backend
    id6(ä¸­é—´ä»£ç ä¼˜åŒ–) --> id7(BitCodeç”Ÿæˆ)
    id7(BitCodeç”Ÿæˆ) --> id8(æ±‡ç¼–æŒ‡ä»¤ç”Ÿæˆ)
    id8(æ±‡ç¼–æŒ‡ä»¤ç”Ÿæˆ) --> id9(æœºå™¨ç ç”Ÿæˆ)
    id9(æœºå™¨ç ç”Ÿæˆ) --> id11(é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶)
    end
    
    subgraph SwiftC
    id12(æºä»£ç ) --> id13(è§£æ)
    id13(è§£æ) --> id14(è¯­ä¹‰åˆ†æ)
    id14(è¯­ä¹‰åˆ†æ) --> id15(Clangå¯¼å…¥å™¨)
    id15(Clangå¯¼å…¥å™¨) --> id16(SILç”Ÿæˆ)
    id16(SILç”Ÿæˆ) --> id17(SILä¿è¯è½¬æ¢)
    id17 --> id18(SILä¼˜åŒ–)
    id18(SILä¼˜åŒ–) --> id19(ä¸­é—´ä»£ç ç”Ÿæˆ)
    end
    
    id5 --  IR  --> id6
    id19 --  IR  --> id6
```

åœ¨å‰ç«¯ **Objective-C** å’Œ **Swift** åˆ†åˆ«ç”±è‡ªå·±çš„å¤„ç†é˜¶æ®µï¼Œä½†æœ€åéƒ½ä¼šç”Ÿæˆ **IR** ä¸­é—´ä»£ç ï¼Œäº¤ç”±åç«¯è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚

ä¸‹é¢æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„.mæ–‡ä»¶è¿›è¡Œç¼–è¯‘è¿‡ç¨‹æ¢³ç†ï¼Œé¦–å…ˆåœ¨æŸä¸€ä¸ªç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª **nihao.m**æ–‡ä»¶

```shell
touch nihao.m
```

**nihao.mï¼š**

```objective-c
#import <Foundation/Foundation.h>
int main(int argc, char *argv[])
{
    @autoreleasepool {
        NSLog(@"nihao!!!");
        return 0;
    }
}
```

### 3.2 Clangé˜¶æ®µï¼ˆObjective-C / C++ / C / Objective-C++ï¼‰

#### é¢„å¤„ç†é˜¶æ®µï¼š

```shell
xcrun clang -E helloworld.c | open -f
```

```
# 1 "nihao.m"
# 1 "<built-in>" 1
# 1 "<built-in>" 3
# 380 "<built-in>" 3
# 1 "<command line>" 1
# 1 "<built-in>" 2
# 1 "nihao.m" 2
# 1 "/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h" 1 3

...
...
...

int main(int argc, char *argv[])
{
    @autoreleasepool {
        NSLog(@"nihao!!!");
        return 0;
    }
}
```

å°†é¢„å¤„ç†é˜¶æ®µè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œ å¯ä»¥çœ‹åˆ°å¾ˆå¤šä»¥ **#** å¼€å¤´çš„è¯­å¥ï¼Œè¿™äº›è¯­å¥å‘Šè¯‰æˆ‘ä»¬åé¢è·Ÿç€çš„å†…å®¹æ¥è‡ªå“ªé‡Œï¼Œè¿™é‡Œå¯ä»¥çœ‹è§ **Foundation.h** æ–‡ä»¶çš„å†…å®¹ä¹ŸåŒ…å«äº†è¿›æ¥ã€‚åœ¨ **Xcode** ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ **Product ->  Perfrom Action -> Preprocess** æŸ¥çœ‹é¢„å¤„ç†é˜¶æ®µä¹‹åçš„ä»£ç ã€‚åœ¨é¢„å¤„ç†é˜¶æ®µåšäº†ä»¥ä¸‹è¿™äº›äº‹æƒ…ï¼š

* å°†å¤´æ–‡ä»¶å¼•å…¥çš„å…¶ä»–æ–‡ä»¶åŠ å…¥æºæ–‡ä»¶ä¸­ï¼Œæ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ã€‚
* è¿›è¡Œæ¡ä»¶ç¼–è¯‘å¤„ç†ã€‚
* å°†å®å®šä¹‰ç›´æ¥æ›¿æ¢ï¼Œä¸è¿›è¡Œè¯­æ³•æ£€æŸ¥ã€‚
* å°†æ³¨é‡Šè¿›è¡Œåˆ é™¤å¤„ç†ã€‚

#### è¯æ³•åˆ†æé˜¶æ®µ

```shell
xcrun clang -fmodules -fsyntax-only -Xclang -dump-tokens nihao.m
```

```
annot_module_include '#import <Foundation/Foundation.h>

'		Loc=<nihao.m:1:1>
int 'int'	 [StartOfLine]	Loc=<nihao.m:3:1>
identifier 'main'	 [LeadingSpace]	Loc=<nihao.m:3:5>
l_paren '('		Loc=<nihao.m:3:9>
int 'int'		Loc=<nihao.m:3:10>
identifier 'argc'	 [LeadingSpace]	Loc=<nihao.m:3:14>
comma ','		Loc=<nihao.m:3:18>
char 'char'	 [LeadingSpace]	Loc=<nihao.m:3:20>
star '*'	 [LeadingSpace]	Loc=<nihao.m:3:25>
identifier 'argv'		Loc=<nihao.m:3:26>
l_square '['		Loc=<nihao.m:3:30>
r_square ']'		Loc=<nihao.m:3:31>
r_paren ')'		Loc=<nihao.m:3:32>
l_brace '{'	 [StartOfLine]	Loc=<nihao.m:4:1>
at '@'	 [StartOfLine] [LeadingSpace]	Loc=<nihao.m:5:5>
identifier 'autoreleasepool'		Loc=<nihao.m:5:6>
...
```

è¯æ³•åˆ†æé˜¶æ®µå…¶å®æ˜¯å°†æºä»£ç ä»¥å­—ç¬¦æ–‡æœ¬çš„å½¢å¼è½¬æ¢æˆ **Token** æµçš„å½¢å¼ï¼Œä¸æ¶‰åŠè¯­ä¹‰æ ¡éªŒï¼Œç”¨æ¥æ ‡è¯†å‡ºè¿™ä¸ªå­—ç¬¦æ˜¯æ ‡è¯†ç¬¦ã€æ‹¬å·ã€ifè¯­å¥...ï¼Œæœ€åè¿˜ä¼šæ ‡è¯†å‡ºå…¶æ‰€åœ¨ä½ç½®ï¼Œæ–¹ä¾¿åç»­åˆ†æèƒ½å¤Ÿæ‰¾å‡ºå‡ºé”™çš„åŸå§‹ä½ç½®ã€‚

#### è¯­æ³•åˆ†æé˜¶æ®µ

```
xcrun clang -fsyntax-only -Xclang -ast-dump nihao.m | open -f
```

```
...
`-FunctionDecl 0x7f9eb4bd61a0 <nihao.m:3:1, line:9:1> line:3:5 main 'int (int, char **)'
  |-ParmVarDecl 0x7f9eb4bd5fc0 <col:10, col:14> col:14 argc 'int'
  |-ParmVarDecl 0x7f9eb4bd6080 <col:20, col:31> col:26 argv 'char **':'char **'
  `-CompoundStmt 0x7f9eb4bd63d0 <line:4:1, line:9:1>
    `-ObjCAutoreleasePoolStmt 0x7f9eb4bd63b8 <line:5:5, line:8:5>
      `-CompoundStmt 0x7f9eb4bd6398 <line:5:22, line:8:5>
        |-CallExpr 0x7f9eb4bd6328 <line:6:9, col:26> 'void'
        | |-ImplicitCastExpr 0x7f9eb4bd6310 <col:9> 'void (*)(id, ...)' <FunctionToPointerDecay>
        | | `-DeclRefExpr 0x7f9eb4bd6250 <col:9> 'void (id, ...)' Function 0x7f9eb0c8d6c8 'NSLog' 'void (id, ...)'
        | `-ImplicitCastExpr 0x7f9eb4bd6350 <col:15, col:16> 'id':'id' <BitCast>
        |   `-ObjCStringLiteral 0x7f9eb4bd6290 <col:15, col:16> 'NSString *'
        |     `-StringLiteral 0x7f9eb4bd6270 <col:16> 'char [9]' lvalue "nihao!!!"
        `-ReturnStmt 0x7f9eb4bd6388 <line:7:9, col:16>
          `-IntegerLiteral 0x7f9eb4bd6368 <col:16> 'int' 0
```

è¯­æ³•åˆ†æé˜¶æ®µä¼šè¾“å‡º **AST**ï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œå®ƒæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚å®ƒä»¥æ ‘çŠ¶çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚é€šè¿‡å®ƒï¼Œå¯ä»¥è¿›è¡Œè¯­æ³•é”™è¯¯åˆ†æï¼Œä»¥åŠé™æ€åˆ†ææ“ä½œï¼Œæ¶µç›–å†…å­˜æ“ä½œå’Œå®‰å…¨ç­‰æ–¹é¢ã€‚

#### CodeGené˜¶æ®µ

```shell
xcrun clang -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll
```

```
; ModuleID = 'nihao.m'
source_filename = "nihao.m"
target datalayout = "e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-apple-macosx11.0.0"

%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }

@__CFConstantStringClassReference = external global [0 x i32]
@.str = private unnamed_addr constant [9 x i8] c"nihao!!!\00", section "__TEXT,__cstring,cstring_literals", align 1
@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section "__DATA,__cfstring", align 8 #0

; Function Attrs: noinline optnone ssp uwtable
define i32 @main(i32 %0, i8** %1) #1 {
  %3 = alloca i32, align 4
  %4 = alloca i32, align 4
  %5 = alloca i8**, align 8
  store i32 0, i32* %3, align 4
  store i32 %0, i32* %4, align 4
  store i8** %1, i8*** %5, align 8
  %6 = call i8* @llvm.objc.autoreleasePoolPush() #2
  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*))
  store i32 0, i32* %3, align 4
  call void @llvm.objc.autoreleasePoolPop(i8* %6)
  %7 = load i32, i32* %3, align 4
  ret i32 %7
}

; Function Attrs: nounwind
declare i8* @llvm.objc.autoreleasePoolPush() #2

declare void @NSLog(i8*, ...) #3

; Function Attrs: nounwind
declare void @llvm.objc.autoreleasePoolPop(i8*) #2

attributes #0 = { "objc_arc_inert" }
attributes #1 = { noinline optnone ssp uwtable "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #2 = { nounwind }
attributes #3 = { "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }

!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}
!llvm.ident = !{!8}

!0 = !{i32 2, !"SDK Version", [2 x i32] [i32 12, i32 0]}
!1 = !{i32 1, !"Objective-C Version", i32 2}
!2 = !{i32 1, !"Objective-C Image Info Version", i32 0}
!3 = !{i32 1, !"Objective-C Image Info Section", !"__DATA,__objc_imageinfo,regular,no_dead_strip"}
!4 = !{i32 1, !"Objective-C Garbage Collection", i8 0}
!5 = !{i32 1, !"Objective-C Class Properties", i32 64}
!6 = !{i32 1, !"wchar_size", i32 4}
!7 = !{i32 7, !"PIC Level", i32 2}
!8 = !{!"Apple clang version 13.0.0 (clang-1300.0.29.3)"}
```

**CodeGen** é˜¶æ®µè´Ÿè´£å°† **AST** è‡ªé¡¶å‘ä¸‹éå†é€æ­¥ç¿»è¯‘æˆ **LLVM IR**ï¼Œä¹Ÿå°±æ˜¯ç¼–è¯‘å™¨åç«¯æ‰€éœ€è¦çš„ä¸­é—´ä»£ç ï¼ŒåŒæ—¶ **Objective-C** ä»£ç ä¹Ÿä¼šåœ¨è¿™ä¸€æ­¥è¿›è¡Œ **Runtime** æ¡¥æ¥ï¼š **property** åˆæˆï¼Œ**ARC** å¤„ç†ç­‰ï¼Œå¦‚ä¸Šæ–¹å¯ä»¥çœ‹è§ **autoreleasePoolPush** ã€ **autoreleasePoolPop** æ“ä½œã€‚

è‡³æ­¤ **Clang** å‰ç«¯å·¥ä½œç®—æ˜¯å®Œæˆï¼Œæ¥ä¸‹æ¥å°±äº¤ç»™åç«¯è¿›è¡Œå¤„ç†ã€‚

### 3.3 LLVM Optimizer é˜¶æ®µ

#### IRä»£ç ä¼˜åŒ–

```shell
xcrun clang -Os -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll
```

```
; ModuleID = 'nihao.m'
source_filename = "nihao.m"
target datalayout = "e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-apple-macosx11.0.0"

%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }

@__CFConstantStringClassReference = external global [0 x i32]
@.str = private unnamed_addr constant [9 x i8] c"nihao!!!\00", section "__TEXT,__cstring,cstring_literals", align 1
@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section "__DATA,__cfstring", align 8 #0

; Function Attrs: optsize ssp uwtable
define i32 @main(i32 %0, i8** nocapture readnone %1) local_unnamed_addr #1 {
  %3 = tail call i8* @llvm.objc.autoreleasePoolPush() #2
  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*)) #4, !clang.arc.no_objc_arc_exceptions !9
  tail call void @llvm.objc.autoreleasePoolPop(i8* %3) #2
  ret i32 0
}

; Function Attrs: nounwind
declare i8* @llvm.objc.autoreleasePoolPush() #2

; Function Attrs: optsize
declare void @NSLog(i8*, ...) local_unnamed_addr #3

; Function Attrs: nounwind
declare void @llvm.objc.autoreleasePoolPop(i8*) #2

attributes #0 = { "objc_arc_inert" }
attributes #1 = { optsize ssp uwtable "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #2 = { nounwind }
attributes #3 = { optsize "darwin-stkchk-strong-link" "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "probe-stack"="___chkstk_darwin" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #4 = { optsize }

!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}
!llvm.ident = !{!8}

!0 = !{i32 2, !"SDK Version", [2 x i32] [i32 12, i32 0]}
!1 = !{i32 1, !"Objective-C Version", i32 2}
!2 = !{i32 1, !"Objective-C Image Info Version", i32 0}
!3 = !{i32 1, !"Objective-C Image Info Section", !"__DATA,__objc_imageinfo,regular,no_dead_strip"}
!4 = !{i32 1, !"Objective-C Garbage Collection", i8 0}
!5 = !{i32 1, !"Objective-C Class Properties", i32 64}
!6 = !{i32 1, !"wchar_size", i32 4}
!7 = !{i32 7, !"PIC Level", i32 2}
!8 = !{!"Apple clang version 13.0.0 (clang-1300.0.29.3)"}
!9 = !{}
```

**IR** ä»£ç ä¼˜åŒ–ä¼šè°ƒç”¨ç›¸åº” **Pass** è¿›è¡Œå¤„ç†ï¼Œ**Pass** ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼Œéƒ½æ˜¯ **Pass** ç±»çš„å­ç±»ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ç‰¹å®šçš„ä¼˜åŒ–ã€‚è¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿè‡ªä¸»çš„æ§åˆ¶ä¼˜åŒ–çš„å¼ºåº¦ï¼Œåœ¨**Build Strrings -> Optimization Level** ä¸­å¯æŒ‡å®šä¼˜åŒ–ç¨‹åº¦ï¼Œä¸€äº›å¸¸è§çš„ä»£ç ä¼˜åŒ–æ–¹æ³•å¦‚ä¸‹ï¼š

* åˆ é™¤å…¬å…±å­è¡¨è¾¾å¼
* åˆ é™¤æ— ç”¨ä»£ç 
* å¸¸é‡åˆå¹¶
* ä»£ç ç§»åŠ¨
* åˆ é™¤å½’çº³å˜é‡

#### ç”Ÿæˆ BitCodeï¼ˆArchiveæ—¶ï¼‰

```shell
xrun clang -emit-llvm -c nihao.m -o nihao.bc
```

```
dec0 170b 0000 0000 1400 0000 0010 0000
0700 0001 4243 c0de 3514 0000 0700 0000
620c 3024 9596 a6a5 f7d7 7f7d d3b4 4ffb
76ef df3f 2d44 0132 0500 0000 210c 0000
4903 0000 0b02 2100 0200 0000 1600 0000
0781 2391 41c8 0449 0610 3239 9201 840c
2505 0819 1e04 8b62 8014 4502 4292 0b42
a410 3214 3808 184b 0a32 5288 4870 c421
...
```

**BitCode** æ˜¯ **LLVM** å¼•å…¥çš„å¦ä¸€ç§ä¸­é—´ä»£ç ï¼Œè™½ç„¶çœ‹èµ·æ¥æ¯”è¾ƒæ¥è¿‘æœºå™¨ç ï¼Œä½†æ˜¯åœ¨å‡½æ•°å’ŒæŒ‡ä»¤å±‚é¢ä½¿ç”¨äº†å¾ˆå¤šé«˜çº§è¯­è¨€çš„ç‰¹æ€§ã€‚

ä½†åªä¼šåœ¨ **Archive** æ—¶ï¼Œ**BitCode** æ‰ä¼šè¢«åµŒå…¥åˆ°é“¾æ¥åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨äºæäº¤ç»™ **App Store**ï¼ŒåŒ…å« **Bitcode** é…ç½®çš„ç¨‹åºå°†ä¼šåœ¨ **App Store** ä¸Šè¢«é‡æ–°ç¼–è¯‘å’Œé“¾æ¥ï¼Œè¿›è€Œå¯¹å¯æ‰§è¡Œæ–‡ä»¶åšä¼˜åŒ–ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¼˜åŒ–è¿™ä¸€æ­¥æ˜¯åœ¨ **App Store** ä¸­åšçš„å¤„ç†ï¼Œæœ¬åœ°æ²¡æœ‰åšå¤„ç†ã€‚è¿›è¡Œå…¶ä»–ç±»å‹çš„ **Build** (é **Archive** )æ—¶ï¼Œç¼–è¯‘å™¨åªä¼šæ£€æŸ¥æ˜¯å¦æ»¡è¶³å¼€å¯ **BitCode** çš„æ¡ä»¶ï¼Œä½†å¹¶ä¸ä¼šçœŸæ­£ç”Ÿæˆ **BitCode** ã€‚

### 3.4 LLVM Code Generatoré˜¶æ®µ

#### ç”Ÿæˆæ±‡ç¼–ä»£ç 

```shell
xcrun clang -S -fobjc-arc nihao.m -o nihao.s
```

```
	.section	__TEXT,__text,regular,pure_instructions
	.build_version macos, 11, 0	sdk_version 12, 0
	.globl	_main                           ## -- Begin function main
	.p2align	4, 0x90
_main:                                  ## @main
	.cfi_startproc
## %bb.0:
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset %rbp, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register %rbp
	subq	$32, %rsp
	movl	$0, -4(%rbp)
	movl	%edi, -8(%rbp)
	movq	%rsi, -16(%rbp)
	callq	_objc_autoreleasePoolPush
	movq	%rax, -24(%rbp)                 ## 8-byte Spill
	leaq	L__unnamed_cfstring_(%rip), %rdi
	movb	$0, %al
	callq	_NSLog
	movq	-24(%rbp), %rdi                 ## 8-byte Reload
	movl	$0, -4(%rbp)
	callq	_objc_autoreleasePoolPop
	movl	-4(%rbp), %eax
	addq	$32, %rsp
	popq	%rbp
	retq
	.cfi_endproc
                                        ## -- End function
	.section	__TEXT,__cstring,cstring_literals
L_.str:                                 ## @.str
	.asciz	"nihao!!!"

	.section	__DATA,__cfstring
	.p2align	3                               ## @_unnamed_cfstring_
L__unnamed_cfstring_:
	.quad	___CFConstantStringClassReference
	.long	1992                            ## 0x7c8
	.space	4
	.quad	L_.str
	.quad	8                               ## 0x8

	.section	__DATA,__objc_imageinfo,regular,no_dead_strip
L_OBJC_IMAGE_INFO:
	.long	0
	.long	64

.subsections_via_symbols
```

æ±‡ç¼–è¯­è¨€æ›´åŠ æ¥è¿‘æœºå™¨è¯­è¨€ï¼Œèƒ½å¤Ÿç›´æ¥å¯¹ç¡¬ä»¶è¿›è¡Œæ“ä½œï¼Œç”Ÿæˆçš„ç¨‹åºä¸å…¶ä»–çš„è¯­è¨€ç›¸æ¯”å…·æœ‰æ›´é«˜çš„è¿è¡Œé€Ÿåº¦ï¼Œå ç”¨æ›´å°çš„å†…å­˜ã€‚

ç›®å‰æ‰€æœ‰ **iOS** è®¾å¤‡éƒ½é‡‡ç”¨ **ARM** å¤„ç†å™¨ï¼Œè¿™æ„å‘³ç€éƒ½æ˜¯é‡‡ç”¨ **ARM** æŒ‡ä»¤é›†ï¼Œå¦‚ **armv6 / armv7 / armv7s / arm64**ï¼Œè¿™äº›æŒ‡ä»¤é›†éƒ½æ˜¯å‘ä¸‹å…¼å®¹çš„ã€‚

æ¯ç§ **CPU** æ¶æ„éƒ½æœ‰ç€ç›¸åº”çš„æŒ‡ä»¤é›†ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„æ¶æ„äº§ç”Ÿä¸åŒçš„æ±‡ç¼–æŒ‡ä»¤ï¼ŒåŠ ä¸Šä¸Šé¢ **- arch arch_type** é€‰é¡¹å³å¯ï¼Œæ›´å¤šè¯·å‚è§[å®˜ç½‘](https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html)ã€‚åœ¨ **Xcode** ä¸­å¯åœ¨ **Build Settings -> Architectrues** æŒ‡å®šäº§ç”Ÿçš„ **CPU** æŒ‡ä»¤é›†ã€‚

#### ç”Ÿæˆæœºå™¨ä»£ç 

```shell
xcrun clang -fmodules -c nihao.s -o nihao.o
```

å¯ä»¥å‘ç°æœºå™¨ç äºŒè¿›åˆ¶æ–‡ä»¶æ— æ³•é˜…è¯»ï¼Œå¯å€ŸåŠ© **otool** æˆ–è€… **MachOView** ç­‰å·¥å…·æŸ¥çœ‹æ–‡ä»¶ä¸­çš„ç›¸å…³å†…å®¹ï¼š

```shell
otool -v -h nihao.o
```

```
nihao.o:
Mach header
      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
MH_MAGIC_64   X86_64        ALL  0x00      OBJECT     4        680 SUBSECTIONS_VIA_SYMBOLS
```

å¯ä»¥çœ‹è§ **.o** æ–‡ä»¶å®é™…ä¸Šæ˜¯ **mach-o** æ ¼å¼ï¼Œè¿™é‡Œæˆ‘ä»¬è¾“å…¥å¯æ‰§è¡Œæ–‡ä»¶çš„å¤´éƒ¨ï¼Œè§„å®šäº†è¿™ä¸ªæ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Œé€‚åº”æ¶æ„çš„ç›¸å…³ä¿¡æ¯ï¼Œä»¥åŠæ–‡ä»¶æ˜¯å¦‚ä½•è¢«åŠ è½½çš„ã€‚æ›´å¤šå…³äº **mach-o** çš„çŸ¥è¯†[å‚è§](https://www.jianshu.com/p/54d842db3f69)ã€‚

#### é“¾æ¥

```shell
xcrun clang nihao.o -Wl,`xcrun --show-sdk-path`/System/Library/Frameworks/Foundation.framework/Foundation
```

```shell
./a.out
```

```
2021-11-03 16:06:41.734 a.out[6394:220026] nihao!!!
```

ç”±äºæˆ‘ä»¬å¼•å…¥äº† **Foundation** é‡Œé¢çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦å°†ç›®æ ‡æ–‡ä»¶å’Œ **Foundation framework**è¿›è¡Œé“¾æ¥ï¼Œæ¥ç€å°±å¯ä»¥è¿è¡Œæˆ‘ä»¬çš„ç¨‹åºäº†ã€‚

è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼šç¬¦å·è¡¨ï¼Œé‡Œé¢å­˜å‚¨çš„å…ƒç´ å¦‚ä¸‹ï¼š

```xml
<èµ·å§‹åœ°å€> <ç»“æŸåœ°å€> <å‡½æ•°> [<æ–‡ä»¶å:è¡Œå·>]
```

è¿™é‡Œæˆ‘ä»¬è¾“å…¥a.outçš„ç¬¦å·ä¿¡æ¯

```
nm -nm a.out
```

```
                 (undefined) external _NSLog (from Foundation)
                 (undefined) external ___CFConstantStringClassReference (from CoreFoundation)
                 (undefined) external _objc_autoreleasePoolPop (from libobjc)
                 (undefined) external _objc_autoreleasePoolPush (from libobjc)
                 (undefined) external dyld_stub_binder (from libSystem)
0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header
0000000100003f20 (__TEXT,__text) external _main
0000000100008018 (__DATA,__data) non-external __dyld_private
```

å¯¹äºåŠ¨æ€é“¾æ¥åº“çš„ç¬¦å·ï¼ˆå¦‚ **Foundation**ï¼‰ï¼Œæœ€ç»ˆä¼šè®°å½•ä¸‹è¿™ä¸ªç¬¦å·æ˜¯é€šè¿‡è¿›è¡Œé“¾æ¥çš„ï¼Œå¹¶è®°å½•ä¸‹ä¾èµ–äºå“ªä¸ªåŠ¨æ€é“¾æ¥åº“ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨ï¼ˆ**dyld**ï¼‰ä¼šå»è§£æè¿™äº› **undefined** ç¬¦å·ã€‚å¯¹äºå…¶ä»–ä½ç½®çš„ç¬¦å·ï¼Œä¼šç›´æ¥ä¿®æ­£è¿™äº›ç¬¦å·çš„å…·ä½“ä½ç½®ä¿¡æ¯ã€‚

## 4. æ€»ç»“

æœ¬æ–‡ä»‹ç»äº†å…³äº iOS ç¼–è¯‘å™¨ã€iOS ç¼–è¯‘è¿‡ç¨‹çš„åŸºç¡€çŸ¥è¯†ã€‚å­¦ä¹ äº†è¿™äº›ï¼Œå¯¹ iOS ç¼–è¯‘æœ‰ä¸ªæ•´ä½“è®¤è¯†ã€‚å°±æœ¬äººè€Œè¨€ï¼Œåœ¨ä¸€è·¯æœå¯»èµ„æ–™çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹ä¹‹å‰ä¸€äº›é›¶æ•£çš„çŸ¥è¯†ç‚¹æœ‰äº†ä¸€äº›æ›´åŠ æ·±å…¥çš„è®¤è¯†ã€‚ç”±äºç¯‡å¹…æœ‰é™ï¼Œå…³äº SwiftC çš„ç¼–è¯‘è¿‡ç¨‹æ²¡æœ‰å¤šåšä»‹ç»ï¼Œåé¢ä¼šå†å‡ºä¸€ç¯‡è¿›è¡Œä»‹ç»ã€‚



ğŸ”—ï¼š

[ObjC ä¸­å›½ - Mach-O å¯æ‰§è¡Œæ–‡ä»¶](https://objccn.io/issue-6-3/)

[ä»£ç ä¼˜åŒ–ä¸LLVM IR pass](https://kiprey.github.io/2020/06/LLVM-IR-pass/)

[å…³äºbitcode, çŸ¥é“è¿™äº›å°±å¤Ÿäº†](http://xelz.info/blog/2018/11/24/all-you-need-to-know-about-bitcode/)

[iOS ç¼–è¯‘é“¾æ¥ï¼šObjective-C ç¼–è¯‘é“¾æ¥](https://zhuanlan.zhihu.com/p/340782811)

[è¶£æ¢ Mach-Oï¼šæ–‡ä»¶æ ¼å¼åˆ†æ](https://www.jianshu.com/p/54d842db3f69)


<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>Swift ç¼–è¯‘æµç¨‹</title><meta name="description" content="ä¸ä»¥åŠŸåˆ©ä¸ºç›®çš„."><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/avatar.jpeg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="å‰è¨€ä¹¦æ¥ä¸Šæ–‡ï¼Œæœ¬æ–‡å°†ä»‹ç» Swift è¯­è¨€çš„ç¼–è¯‘ä¸»è¦å‰ç«¯æµç¨‹ï¼Œåç«¯çš„æµç¨‹ä¸ä¸Šæ–‡åŒæ­¥ï¼Œå°±ä¸è¿‡å¤šèµ˜è¿°ï¼Œè¯¦æƒ…è§ iOS ç¼–è¯‘è¿‡ç¨‹ï¼ŒåŒæ—¶æœ¬æ–‡å°± SIL ä»‹ç»å…¶ç‰¹ç‚¹ã€‚


Clang ä¸ SwiftCä¸ºä»€ä¹ˆè¦å¼•å…¥ä¸€ç§æ–°çš„ç¼–è¯‘å™¨ï¼Œæ•´ä½“è€Œè¨€ Swift ä½œä¸ºä¸€ç§é«˜çº§è¯­è¨€ï¼Œå…¶å¾ˆå¤šé«˜çº§ç‰¹æ€§ Clang ä¸æ”¯æŒï¼ŒåŒæ—¶ä¹Ÿç”±äº Clang è‡ªèº«çš„ä¸€äº›å¼Šç«¯ã€‚è¿›è€Œå‚¬ç”Ÿå‡ºäº† SwiftCï¼Œå°† Clang å’Œ SwiftC çš„ç¼–è¯‘æµç¨‹è¿›è¡Œå¯¹æ¯”ï¼š
å…¶ä¸­ Clang çš„åŠ£åŠ¿å¦‚ä¸‹ï¼š

è¯­ä¹‰ä¸å¯é‡å¤è¡¨ç¤ºï¼Œå¯¼è‡´äºˆä»¥åˆ†æä¼šä¾èµ–äº Parse(å¯çœ‹æˆç”Ÿæˆ token è¡¨ï¼Œè¿›è¡Œè¯æ³•åˆ†æ)ã€‚
IR ä¸­é—´ä»£ç ä¸é€‚ç”¨äºè¿›è¡Œ Analysisï¼Œé‡‡ç”¨ CFG è¿›è¡Œåˆ†æï¼Œå¯¼è‡´ç”Ÿæˆ IR å’Œ Analysis æ˜¯ä¸¤éƒ¨åˆ† ï¼ˆAnalysis æœ‰åˆ«ä¸è¯è¯­åˆ†æä¸è¯­æ³•åˆ†æï¼Œå®ƒ.."><meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="nihao' Blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">nihao's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Swift ç¼–è¯‘æµç¨‹</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clang-%E4%B8%8E-SwiftC"><span class="toc-text">Clang ä¸ SwiftC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SwiftC-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B-Frontend"><span class="toc-text">SwiftC ç¼–è¯‘æµç¨‹(Frontend)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%EF%BC%9A"><span class="toc-text">æºç ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Parse-%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-text">Parse(è¯æ³•åˆ†æ):</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90%E5%B9%B6%E7%94%9F%E6%88%90AST"><span class="toc-text">è¯­ä¹‰åˆ†æå¹¶ç”ŸæˆAST</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Raw-%E5%8E%9F%E5%A7%8B-SIL-%E7%94%9F%E6%88%90"><span class="toc-text">Raw(åŸå§‹) SIL ç”Ÿæˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Canonical-%E6%AD%A3%E5%BC%8F-SIL%E7%94%9F%E6%88%90"><span class="toc-text">Canonical(æ­£å¼) SILç”Ÿæˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96SIL"><span class="toc-text">ä¼˜åŒ–SIL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IR%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="toc-text">IRä»£ç ç”Ÿæˆ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SIL-%E4%BB%8B%E7%BB%8D"><span class="toc-text">SIL ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E7%B1%BB%E5%9E%8B"><span class="toc-text">åœ°å€ç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Box%E7%B1%BB%E5%9E%8B"><span class="toc-text">Boxç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metatype-%E7%B1%BB%E5%9E%8B"><span class="toc-text">Metatype ç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VTables"><span class="toc-text">VTables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Witness-Table"><span class="toc-text">Witness Table</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li></ol></div><div class="column is-9"><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Swift ç¼–è¯‘æµç¨‹</h1><header class="my-5"><a href="/tags/Compile"><i class="tag post-item-tag">Compile</i></a><a href="/tags/Swift"><i class="tag post-item-tag">Swift</i></a><time class="has-text-grey" datetime="2022-02-07T22:54:49.000Z">2022-02-07</time></header><article class="mt-2 post-content"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹¦æ¥ä¸Šæ–‡ï¼Œæœ¬æ–‡å°†ä»‹ç» <strong>Swift</strong> è¯­è¨€çš„ç¼–è¯‘ä¸»è¦å‰ç«¯æµç¨‹ï¼Œåç«¯çš„æµç¨‹ä¸ä¸Šæ–‡åŒæ­¥ï¼Œå°±ä¸è¿‡å¤šèµ˜è¿°ï¼Œè¯¦æƒ…è§ <a href="https://xuhaodong1.github.io/2021/11/03/2021-11-03-iOS%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/">iOS ç¼–è¯‘è¿‡ç¨‹</a>ï¼ŒåŒæ—¶æœ¬æ–‡å°± <strong>SIL</strong> ä»‹ç»å…¶ç‰¹ç‚¹ã€‚</p>
<span id="more"></span>

<h2 id="Clang-ä¸-SwiftC"><a href="#Clang-ä¸-SwiftC" class="headerlink" title="Clang ä¸ SwiftC"></a>Clang ä¸ SwiftC</h2><p>ä¸ºä»€ä¹ˆè¦å¼•å…¥ä¸€ç§æ–°çš„ç¼–è¯‘å™¨ï¼Œæ•´ä½“è€Œè¨€ <strong>Swift</strong> ä½œä¸ºä¸€ç§é«˜çº§è¯­è¨€ï¼Œå…¶å¾ˆå¤šé«˜çº§ç‰¹æ€§ <strong>Clang</strong> ä¸æ”¯æŒï¼ŒåŒæ—¶ä¹Ÿç”±äº <strong>Clang</strong> è‡ªèº«çš„ä¸€äº›å¼Šç«¯ã€‚è¿›è€Œå‚¬ç”Ÿå‡ºäº† <strong>SwiftC</strong>ï¼Œå°† <strong>Clang</strong> å’Œ <strong>SwiftC</strong> çš„ç¼–è¯‘æµç¨‹è¿›è¡Œå¯¹æ¯”ï¼š</p>
<p>å…¶ä¸­ <strong>Clang</strong> çš„åŠ£åŠ¿å¦‚ä¸‹ï¼š</p>
<ul>
<li>è¯­ä¹‰ä¸å¯é‡å¤è¡¨ç¤ºï¼Œå¯¼è‡´äºˆä»¥åˆ†æä¼šä¾èµ–äº Parse(å¯çœ‹æˆç”Ÿæˆ <strong>token</strong> è¡¨ï¼Œè¿›è¡Œè¯æ³•åˆ†æ)ã€‚</li>
<li>IR ä¸­é—´ä»£ç ä¸é€‚ç”¨äºè¿›è¡Œ <strong>Analysis</strong>ï¼Œé‡‡ç”¨ <strong>CFG</strong> è¿›è¡Œåˆ†æï¼Œå¯¼è‡´ç”Ÿæˆ <strong>IR</strong> å’Œ <strong>Analysis</strong> æ˜¯ä¸¤éƒ¨åˆ† ï¼ˆAnalysis æœ‰åˆ«ä¸è¯è¯­åˆ†æä¸è¯­æ³•åˆ†æï¼Œå®ƒå•ç‹¬å¯¹æºä»£ç è¿›è¡Œåˆ†æï¼Œå¦‚æŸ¥æ‰¾ã€ä¸ä¼šæ‰§è¡Œçš„ä»£ç ã€‘ã€ã€ä¸ä¼šè¢«åˆå§‹åŒ–çš„å˜é‡ã€‘ã€ã€é™æ€åˆ†æã€‘ç­‰ï¼‰ã€‚</li>
<li>åœ¨ <strong>CFG</strong> å’Œ <strong>IR</strong> é™çº§çš„æ—¶å€™ä¼šåšå¾ˆå¤šé‡å¤åˆ†æï¼Œåšæ— ç”¨åŠŸã€‚</li>
</ul>
<p>ç›¸è¾ƒè€Œè¨€ <strong>Swift</strong> è§£å†³äº† <strong>Clang</strong> ä¸­çš„å¾ˆå¤šé—®é¢˜ï¼Œå¼•å…¥äº† <strong>SIL</strong>ï¼ˆ <strong>Swift Intermediate Language</strong> ï¼‰ ä¸­é—´ä»£ç ï¼Œæ—¢å¯è¿›è¡Œ åˆ†æ åˆå¯è¿›è¡Œ <strong>IR</strong> ä»£ç ç”Ÿæˆï¼Œå¹¶å¼•å…¥äº†è®¸å¤šæ–°çš„é«˜çº§ä¼˜åŒ–ç‰¹æ€§ã€‚</p>
<p><img src="/images/blog/webp.png" alt="img"></p>
<p><img src="/images/blog/Swift%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B.png" alt="img"></p>
<h2 id="SwiftC-ç¼–è¯‘æµç¨‹-Frontend"><a href="#SwiftC-ç¼–è¯‘æµç¨‹-Frontend" class="headerlink" title="SwiftC ç¼–è¯‘æµç¨‹(Frontend)"></a>SwiftC ç¼–è¯‘æµç¨‹(Frontend)</h2><h3 id="æºç ï¼š"><a href="#æºç ï¼š" class="headerlink" title="æºç ï¼š"></a><strong>æºç ï¼š</strong></h3><pre><code class="swift">class Person {
    var name = "nihao"
    func getName() -&gt; String {
        print(name)
        return name
    }
}
</code></pre>
<h3 id="Parse-è¯æ³•åˆ†æ"><a href="#Parse-è¯æ³•åˆ†æ" class="headerlink" title="Parse(è¯æ³•åˆ†æ):"></a>Parse(è¯æ³•åˆ†æ):</h3><p>å‘½ä»¤ï¼š<code>swiftc -dump-parse main.swift &gt;&gt; ./main.parse</code></p>
<pre><code class="shell">(source_file "main.swift"
  (class_decl range=[main.swift:8:1 - line:15:1] "Person"
    (pattern_binding_decl range=[main.swift:9:5 - line:9:16]
      (pattern_named 'name')
      Original init:
      (string_literal_expr type='&lt;null&gt;' encoding=utf8 value="nihao" builtin_initializer=**NULL** initializer=**NULL**)
      Processed init:
      (string_literal_expr type='&lt;null&gt;' encoding=utf8 value="nihao" builtin_initializer=**NULL** initializer=**NULL**))
    (var_decl range=[main.swift:9:9 - line:9:9] "name" type='&lt;null type&gt;')
    (func_decl range=[main.swift:11:5 - line:14:5] "getName()"
      (parameter "self")
      (parameter_list range=[main.swift:11:17 - line:11:18])
      (result
        (type_ident
          (component id='String' bind=none)))
      (brace_stmt range=[main.swift:11:30 - line:14:5]
        (call_expr type='&lt;null&gt;' arg_labels=_:
          (unresolved_decl_ref_expr type='&lt;null&gt;' name=print function_ref=unapplied)
          (paren_expr type='&lt;null&gt;'
            (unresolved_decl_ref_expr type='&lt;null&gt;' name=name function_ref=unapplied)))
        (return_stmt range=[main.swift:13:9 - line:13:16]
          (unresolved_decl_ref_expr type='&lt;null&gt;' name=name function_ref=unapplied))))))
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æœ‰åˆ«äº Clang ç”Ÿæˆ token æµçš„çš„å½¢å¼ï¼ŒParseé˜¶æ®µæ˜¯ä¸€ä¸ªé€’å½’è‡³é¡¶å‘ä¸‹çš„è§£æè¿‡ç¨‹ï¼Œè¿™ä¹Ÿè§£é‡Šäº†å…¶è¯­ä¹‰å¯é‡å¤è¡¨ç¤ºçš„åŸå› ã€‚</p>
<h3 id="è¯­ä¹‰åˆ†æå¹¶ç”ŸæˆAST"><a href="#è¯­ä¹‰åˆ†æå¹¶ç”ŸæˆAST" class="headerlink" title="è¯­ä¹‰åˆ†æå¹¶ç”ŸæˆAST"></a>è¯­ä¹‰åˆ†æå¹¶ç”ŸæˆAST</h3><p>å‘½ä»¤ï¼š<code>swiftc -dump-ast main.swift &gt;&gt; ./main.ast</code></p>
<pre><code class="shell">(source_file "main.swift"
  (class_decl range=[main.swift:8:1 - line:15:1] "Person" interface type='Person.Type' access=internal non-resilient
    (pattern_binding_decl range=[main.swift:9:5 - line:9:16]
      (pattern_named type='String' 'name')
      Original init:
      (string_literal_expr type='String' location=main.swift:9:16 range=[main.swift:9:16 - line:9:16] encoding=utf8 value="nihao" builtin_initializer=Swift.(file).String extension.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:) initializer=**NULL**)
      Processed init:
      (string_literal_expr type='String' location=main.swift:9:16 range=[main.swift:9:16 - line:9:16] encoding=utf8 value="nihao" builtin_initializer=Swift.(file).String extension.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:) initializer=**NULL**))
    (var_decl range=[main.swift:9:9 - line:9:9] "name" type='String' interface type='String' access=internal readImpl=stored writeImpl=stored readWriteImpl=stored
      (accessor_decl implicit range=[main.swift:9:9 - line:9:9] 'anonname=0x7fcbc202f0d8' interface type='(Person) -&gt; () -&gt; String' access=internal get_for=name
        (parameter "self" type='Person' interface type='Person')
        (parameter_list)
        (brace_stmt implicit range=[main.swift:9:9 - line:9:9]
          (return_stmt implicit
            (member_ref_expr implicit type='String' decl=main.(file).Person.name@main.swift:9:9 direct_to_storage
              (declref_expr implicit type='Person' decl=main.(file).Person.&lt;anonymous&gt;.self@main.swift:9:9 function_ref=unapplied)))))
      (accessor_decl implicit range=[main.swift:9:9 - line:9:9] 'anonname=0x7fcbc202f330' interface type='(Person) -&gt; (String) -&gt; ()' access=internal set_for=name
        (parameter "self" type='Person' interface type='Person')
        (parameter_list range=[main.swift:9:9 - line:9:9]
          (parameter "value" type='String' interface type='String'))
......
</code></pre>
<p>æ­¤æ­¥è¿›è¡Œè¯­æ³•åˆ†æï¼Œå¹¶ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ AST ä¸ Parse é˜¶æ®µçš„äº§äºè¯­æ³•ä¸€ç›´ï¼Œä¸è¿‡åœ¨å…¶åŸºç¡€ä¸Šè¡¥å……äº†å¾ˆå¤šå†…å®¹ï¼Œå¦‚ç±»å‹ã€è®¿é—®æƒé™ã€æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ç­‰ã€‚</p>
<h3 id="Raw-åŸå§‹-SIL-ç”Ÿæˆ"><a href="#Raw-åŸå§‹-SIL-ç”Ÿæˆ" class="headerlink" title="Raw(åŸå§‹) SIL ç”Ÿæˆ"></a>Raw(åŸå§‹) SIL ç”Ÿæˆ</h3><p>å‘½ä»¤ï¼š<code>swiftc -emit-silgen main.swift &gt;&gt; ./main.silgen</code></p>
<pre><code class="swift">sil_stage raw

import Builtin
import Swift
import SwiftShims

class Person {
  @_hasStorage @_hasInitialValue var name: String { get set }
  func getName() -&gt; String
  @objc deinit
  init()
}

// main
sil [ossa] @main : $@convention(c) (Int32, UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;) -&gt; Int32 {
bb0(%0 : $Int32, %1 : $UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;):
  %2 = integer_literal $Builtin.Int32, 0          // user: %3
  %3 = struct $Int32 (%2 : $Builtin.Int32)        // user: %4
  return %3 : $Int32                              // id: %4
} // end sil function 'main'

// variable initialization expression of Person.name
sil hidden [transparent] [ossa] @$s4main6PersonC4nameSSvpfi : $@convention(thin) () -&gt; @owned String {
bb0:
  %0 = string_literal utf8 "nihao"                // user: %5
  %1 = integer_literal $Builtin.Word, 5           // user: %5
  %2 = integer_literal $Builtin.Int1, -1          // user: %5
  %3 = metatype $@thin String.Type                // user: %5
  // function_ref String.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:)
  %4 = function_ref @$sSS21_builtinStringLiteral17utf8CodeUnitCount7isASCIISSBp_BwBi1_tcfC : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String // user: %5
  %5 = apply %4(%0, %1, %2, %3) : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String // user: %6
  return %5 : $String                             // id: %6
} // end sil function '$s4main6PersonC4nameSSvpfi'    
......
</code></pre>
<p><strong>Raw SIL</strong>ï¼Œç”±äº ç›®å‰çš„ <strong>SIL</strong> è¿˜æœªè¿›è¡Œç¡®ä¿ä¼˜åŒ–ä¸è¯Šæ–­æ£€æŸ¥ï¼Œæ­¤æ—¶çš„ <strong>SIL</strong> è¿˜æ¯”è¾ƒè„†å¼±ï¼Œæ‰€ä»¥ç§°å…¶ä¸º <strong>Raw SIL</strong>ã€‚</p>
<h3 id="Canonical-æ­£å¼-SILç”Ÿæˆ"><a href="#Canonical-æ­£å¼-SILç”Ÿæˆ" class="headerlink" title="Canonical(æ­£å¼) SILç”Ÿæˆ"></a>Canonical(æ­£å¼) SILç”Ÿæˆ</h3><p>å‘½ä»¤ï¼š<code>swiftc -emit-sil main.swift &gt;&gt; ./main.sil</code></p>
<pre><code class="Swift">sil_stage canonical

import Builtin
import Swift
import SwiftShims

class Person {
  @_hasStorage @_hasInitialValue var name: String { get set }
  func getName() -&gt; String
  @objc deinit
  init()
}

// main
sil @main : $@convention(c) (Int32, UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;) -&gt; Int32 {
bb0(%0 : $Int32, %1 : $UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;):
  %2 = integer_literal $Builtin.Int32, 0          // user: %3
  %3 = struct $Int32 (%2 : $Builtin.Int32)        // user: %4
  return %3 : $Int32                              // id: %4
} // end sil function 'main'

// variable initialization expression of Person.name
sil hidden [transparent] @$s4main6PersonC4nameSSvpfi : $@convention(thin) () -&gt; @owned String {
bb0:
  %0 = string_literal utf8 "nihao"                // user: %5
  %1 = integer_literal $Builtin.Word, 5           // user: %5
  %2 = integer_literal $Builtin.Int1, -1          // user: %5
  %3 = metatype $@thin String.Type                // user: %5
  // function_ref String.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:)
  %4 = function_ref @$sSS21_builtinStringLiteral17utf8CodeUnitCount7isASCIISSBp_BwBi1_tcfC : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String // user: %5
  %5 = apply %4(%0, %1, %2, %3) : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String // user: %6
  return %5 : $String                             // id: %6
} // end sil function '$s4main6PersonC4nameSSvpfi'

// String.init(_builtinStringLiteral:utf8CodeUnitCount:isASCII:)
sil [always_inline] [readonly] [_semantics "string.makeUTF8"] @$sSS21_builtinStringLiteral17utf8CodeUnitCount7isASCIISSBp_BwBi1_tcfC : $@convention(method) (Builtin.RawPointer, Builtin.Word, Builtin.Int1, @thin String.Type) -&gt; @owned String
......
</code></pre>
<p>è¿™ä¸€æ­¥ä¸»è¦è¿›è¡Œç¡®ä¿ä¼˜åŒ–ä»¥åŠè¯Šæ–­æ£€æŸ¥å·¥ä½œï¼š</p>
<p>ç‰¹å®šæµç¨‹ï¼š</p>
<ul>
<li><strong>å¼ºåˆ¶å†…è”</strong>ï¼šå¯¹äºé€æ˜å‡½æ•°è¿›è¡Œå†…è”(é€æ˜å‡½æ•°ï¼šå¦‚æœä¸€ä¸ªå‡½æ•°å€¼å—åˆ°å…¥å‚çš„å˜åŒ–ï¼Œæ¯æ¬¡è°ƒç”¨ç›¸åŒçš„å…¥å‚ä¼šæœ‰ç›¸åŒçš„è¿”å›å€¼ã€‚)</li>
<li><strong>å†…å­˜æå‡</strong>ï¼š1. å°†<code>alloc_box</code>ç»“æ„ä¼˜åŒ–ä¸º<code>alloc_stack</code> 2. æå‡æ— æš´éœ²åœ°å€(<code>non_address-exposed</code>)çš„<code>alloc_stack</code>è¯´æ˜åˆ°SSAæ³¨å†Œã€‚</li>
<li><strong>å¸¸æ•°ä¼ æ’­</strong>ï¼šä¸€ç§ä¼˜åŒ–å¸¸æ•°æ‰‹æ®µï¼Œå¦‚è¡¨è¾¾å¼å¯ä»¥åœ¨ç¼–è¯‘å™¨æ±‚å€¼ï¼›å¸¸é‡å€¼å¯ä»£æ›¿å¸¸é‡å˜é‡ï¼›è¿‡ç¨‹çš„éƒ¨åˆ†å‚æ•°æ˜¯å¸¸é‡ï¼Œå‡å°‘æ¶‰åŠçŠ¶æ€å‘é‡çš„å¤§å°å¯ä»¥é¿å…ä»£ç çš„æ‰©å±•ç­‰å†…å®¹ã€‚å…·ä½“å¯å‚è€ƒ<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36287943/article/details/104974597">è¿™é‡Œ</a>ã€‚</li>
<li><strong>è¿”å›åˆ†æ</strong>ï¼šéªŒè¯æ¯ä¸ªæ–¹æ³•åœ¨æ¯ä¸ªä»£ç è·¯å¾„åªè¿”å›ä¸€ä¸ªå€¼ï¼Œå¹¶ä¸”ä¸ä¼šåœ¨å®šä¹‰çš„æœ«ç«¯å‡ºç°æ— è¿”å›å€¼çš„é”™è¯¯ã€‚</li>
<li><strong>ä¸´ç•Œæ‹†åˆ†</strong>ï¼šä¸æ”¯æŒä»»æ„çš„åŸºç¡€blockå‚æ•°é€šè¿‡ç»ˆç«¯è¿›è¡Œä¸´ç•Œæ‹†åˆ†ï¼Œä½¿å¾—è¿ç®—æ›´åŠ é«˜æ•ˆã€‚</li>
</ul>
<h3 id="ä¼˜åŒ–SIL"><a href="#ä¼˜åŒ–SIL" class="headerlink" title="ä¼˜åŒ–SIL"></a>ä¼˜åŒ–SIL</h3><p>å‘½ä»¤ï¼š<code>swiftc -emit-sil main.swift &gt;&gt; ./main.sil -O</code></p>
<p>ä¹Ÿæ˜¯åœ¨ä¸ä¸Šä¸€æ­¥å‘½ä»¤ç›¸åŒï¼Œä½†åŠ ä¸Š -Oå‚æ•°ï¼Œè¿™ä¸€æ­¥ä¸æ˜¯å¿…è¦çš„ï¼Œå¦‚æœåœ¨ <strong>Xcode</strong> ä¸­è®¾ç½® -Ononeï¼Œåˆ™ä¸ä¼šè¿›è¡Œã€‚</p>
<p>ç‰¹å®šä¼˜åŒ–ï¼š</p>
<ul>
<li>æ³›å‹ç‰¹åŒ–ï¼šåˆ†ææ³›å‹å‡½æ•°çš„ç‰¹å®šè°ƒç”¨ï¼Œå¹¶ç”Ÿæˆæ–°çš„ç‰¹å®šç‰ˆæœ¬çš„å‡½æ•°ï¼Œå°†æ³›å‹çš„ç‰¹å®šç”¨æ³•å…¨éƒ¨é‡å†™ä¸ºå¯¹åº”çš„ç‰¹å®šå‡½æ•°è°ƒç”¨ã€‚</li>
<li><strong>witness</strong>å’Œè™šå‡½æ•°è¡¨çš„å»è™šæ‹ŸåŒ–ï¼šé€šè¿‡ç»™å®šç±»å‹å»æŸ¥æ‰¾å…³è”çš„ç±»çš„è™šå‡½æ•°è¡¨æˆ–è€…ç±»å‹çš„witnessè¡¨ï¼Œå¹¶å°†è™šå‡½æ•°è°ƒç”¨æ›¿æ¢ä¸ºè°ƒç”¨å‡½æ•°æ˜ å°„ï¼Œç®€åŒ–äº†æŸ¥æ‰¾æµç¨‹ä»è€Œæé«˜äº†æ•ˆç‡ã€‚</li>
<li><strong>æ€§èƒ½å†…è”</strong></li>
<li><strong>å¼•ç”¨è®¡æ•°ä¼˜åŒ–</strong></li>
<li><strong>å†…å­˜æå‡/ä¼˜åŒ–</strong></li>
<li><strong>é«˜çº§é¢†åŸŸç‰¹å®šä¼˜åŒ–</strong>ï¼šswiftç¼–è¯‘å™¨å¯¹åŸºç¡€çš„swiftç±»å‹å®¹å™¨(ç±»ä¼¼Arrayæˆ–String)å®ç°äº†é«˜çº§ä¼˜åŒ–ï¼Œå¦‚ <strong>Copy On Wirte</strong>ã€‚</li>
</ul>
<h3 id="IRä»£ç ç”Ÿæˆ"><a href="#IRä»£ç ç”Ÿæˆ" class="headerlink" title="IRä»£ç ç”Ÿæˆ"></a>IRä»£ç ç”Ÿæˆ</h3><p>å‘½ä»¤ï¼š<code>swiftc -emit-ir main.swift &gt;&gt; ./main.ir</code></p>
<pre><code class="swift">; ModuleID = '&lt;swift-imported-modules&gt;'
source_filename = "&lt;swift-imported-modules&gt;"
target datalayout = "e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-apple-macosx12.0.0"

%T4main6PersonC = type &lt;{ %swift.refcounted, %TSS }&gt;
%swift.refcounted = type { %swift.type*, i64 }
%swift.type = type { i64 }
%TSS = type &lt;{ %Ts11_StringGutsV }&gt;
%Ts11_StringGutsV = type &lt;{ %Ts13_StringObjectV }&gt;
%Ts13_StringObjectV = type &lt;{ %Ts6UInt64V, %swift.bridge* }&gt;
%Ts6UInt64V = type &lt;{ i64 }&gt;
%swift.bridge = type opaque
%swift.full_type = type { i8**, %swift.type }
%objc_class = type { %objc_class*, %objc_class*, %swift.opaque*, %swift.opaque*, i64 }
%swift.opaque = type opaque
%swift.method_descriptor = type { i32, i32 }
%swift.type_metadata_record = type { i32 }
%swift.metadata_response = type { %swift.type*, i64 }
%"$s4main6PersonC4nameSSvM.Frame" = type { [24 x i8] }
%Any = type { [24 x i8], %swift.type* }
%TSa = type &lt;{ %Ts12_ArrayBufferV }&gt;
%Ts12_ArrayBufferV = type &lt;{ %Ts14_BridgeStorageV }&gt;
%Ts14_BridgeStorageV = type &lt;{ %swift.bridge* }&gt;
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç”Ÿæˆçš„è¯­æ³•ç»“æ„å’Œ <strong>Objective-C</strong> æ–‡ä»¶ç”Ÿæˆçš„ç»“æ„ä¸€è‡´ã€‚</p>
<p>è‡³æ­¤ï¼Œ<strong>SwiftC</strong> ç¼–è¯‘æµç¨‹å°±å·²ç»å…¨éƒ¨æ¢³ç†å®Œäº†ï¼Œå…¶ä¸­è¿˜æœ‰ <strong>clang importer</strong> æ¨¡å—çš„å·¥ä½œå¹¶æœªä»‹ç»ï¼Œ<strong>clang importer</strong> è´Ÿè´£å¯¼å…¥ <strong>Clang</strong> æ¨¡å—ï¼Œå¹¶å°† <strong>C</strong> æˆ– <strong>Objective-C</strong> çš„APIæ˜ å°„åˆ° <strong>Swift API</strong> ä¸­ã€‚</p>
<h2 id="SIL-ä»‹ç»"><a href="#SIL-ä»‹ç»" class="headerlink" title="SIL ä»‹ç»"></a>SIL ä»‹ç»</h2><p><strong>Swift</strong> ä¸­é—´è¯­è¨€ï¼ˆSwift Intermediate Languageï¼ŒSILï¼‰æ˜¯ä¸€é—¨é«˜çº§ä¸”ä¸“ç”¨äº Swift çš„ä¸­é—´è¯­è¨€ï¼Œé€‚ç”¨äºå¯¹ Swift ä»£ç çš„è¿›ä¸€æ­¥åˆ†æå’Œä¼˜åŒ–ã€‚SIL ä¾èµ–äº Swift çš„ç±»å‹ç³»ç»Ÿå’Œå£°æ˜ï¼Œæ‰€ä»¥ SIL è¯­æ³•æ˜¯ Swift çš„å»¶ä¼¸ã€‚ä¸€ä¸ª <code>.sil</code> æ–‡ä»¶æ˜¯ä¸€ä¸ªå¢åŠ äº† SIL å®šä¹‰çš„ Swift æºæ–‡ä»¶ã€‚ <code>.swift</code> æºæ–‡ä»¶åªé’ˆå¯¹å£°æ˜è¿›è¡Œè¯­æ³•åˆ†æï¼Œå…¶ <code>func</code> æ–¹æ³•ä½“å’Œæœ€é«˜é˜¶ä»£ç å°†ä¼šè¢« SIL è¯­æ³•åˆ†æå™¨å¿½ç•¥ã€‚ åœ¨ <code>.sil</code> æ–‡ä»¶ä¸­æ²¡æœ‰éšå¼ importã€‚å¦‚æœä½¿ç”¨ swift æˆ–è€… Buildin æ ‡å‡†ç»„ä»¶çš„è¯å¿…é¡»æ˜ç¡®çš„å¼•ç”¨ã€‚</p>
<h3 id="åœ°å€ç±»å‹"><a href="#åœ°å€ç±»å‹" class="headerlink" title="åœ°å€ç±»å‹"></a>åœ°å€ç±»å‹</h3><p>åœ°å€ç±»å‹ <code>$*T</code> æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä»»æ„å¼•ç”¨çš„å€¼æˆ–è€… <code>$T</code>ã€‚åœ°å€ä¸æ˜¯å¼•ç”¨è®¡æ•°æŒ‡é’ˆï¼Œä¸èƒ½è¢« <code>retained</code> æˆ–<code>released</code>ã€‚</p>
<h3 id="Boxç±»å‹"><a href="#Boxç±»å‹" class="headerlink" title="Boxç±»å‹"></a>Boxç±»å‹</h3><p>æœ¬åœ°å˜é‡å’Œéç›´æ¥çš„æ•°å€¼ç±»å‹éƒ½æ˜¯å­˜å‚¨åœ¨å †ä¸Šï¼Œ@box T æ˜¯ä¸€ä¸ªå¼•ç”¨è®¡æ•°ç±»å‹ï¼ŒæŒ‡å‘çš„æ˜¯åŒ…å«äº†å¤šä¸ª T çš„ç›’å­ã€‚ç›’å­ä½¿ç”¨çš„æ˜¯ Swift çš„åŸç”Ÿå¼•ç”¨è®¡æ•°ã€‚</p>
<h3 id="Metatype-ç±»å‹"><a href="#Metatype-ç±»å‹" class="headerlink" title="Metatype ç±»å‹"></a>Metatype ç±»å‹</h3><p>SIL å†…çš„ <code>metatype</code> ç±»å‹å¿…é¡»æè¿°è‡ªèº«è¡¨ç¤ºï¼š</p>
<ul>
<li><code>@thin</code> è¡¨ç¤ºä¸éœ€è¦å†…å­˜ç©ºé—´</li>
<li><code>@thick</code> æŒ‡å­˜å‚¨çš„æ˜¯ç±»å‹çš„å¼•ç”¨æˆ–è€…ç±»å‹å­ç±»çš„å¼•ç”¨</li>
<li><code>@objc</code> æŒ‡å­˜å‚¨çš„æ˜¯ä¸€ä¸ª OC ç±»å¯¹è±¡çš„è¡¨ç¤ºã€‚</li>
</ul>
<h3 id="VTables"><a href="#VTables" class="headerlink" title="VTables"></a>VTables</h3><p>ç”¨æ¥è¡¨ç¤ºç±»å¯¹è±¡æ–¹æ³•çš„åŠ¨æ€æ´¾å‘ï¼Œå¦‚æœçœ‹åˆ° SIL ä»£ç ä¸­å‡ºç° <code>class_method</code> æˆ–è€… <code>super_method</code>ï¼Œè¿™äº›éƒ½æ˜¯é€šè¿‡ <code>sil_vtable</code> è¿›è¡Œè¿½è¸ªçš„ï¼›<code>sil_table</code> ä¸­åŒ…å«ç±»å¯¹è±¡ä¸­çš„æ‰€æœ‰æ–¹æ³•çš„æ˜ å°„ï¼ŒåŒ…æ‹¬ä»çˆ¶å¯¹è±¡ç»§æ‰¿çš„æ–¹æ³•ã€‚</p>
<h3 id="Witness-Table"><a href="#Witness-Table" class="headerlink" title="Witness Table"></a>Witness Table</h3><p>ç”¨æ¥ä»£è¡¨æ³›å‹ç±»å‹çš„æ–¹æ³•åŠ¨æ€æ´¾å‘ï¼Œä¸€ä¸ªæ³›å‹ç±»å‹çš„æ‰€æœ‰çš„æ‰€æœ‰æ³›å‹å®ä¾‹å…±äº«ä¸€ä¸ª <code>Witness Table</code>ï¼ŒåŒæ ·è¡ç”Ÿç±»ä¹Ÿéƒ½ä¼šé›†æˆåŸºç±»çš„ <code>Witness Table</code>ã€‚</p>
<p>æ¯ä¸ªéµå¾ªåè®®çš„å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œä¼šç”Ÿæˆä¸€å¼  <code>Witness table</code>ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡æ¢³ç†äº† Swift çš„ç¼–è¯‘æµç¨‹ï¼Œå¯ä»¥çœ‹å‡ºï¼ŒSwift ä½œä¸ºä¸€ç§é«˜çº§çš„å®‰å…¨ç±»å‹è¯­è¨€ï¼Œç¼–è¯‘å™¨å¯¹å…¶åšäº†è®¸å¤šä¼˜åŒ–ï¼Œç®—æ˜¯å¼¥è¡¥äº†å¯¹ Clang è®¸å¤šä¸è¶³ã€‚SIL æ˜¯ Swift ç¼–è¯‘çš„é‡ç‚¹ï¼Œä»ä¸­å¯ä»¥çª¥æ¢ä¸€äº›å¹³æ—¶å¼€å‘ä¸­éš¾ä»¥ç¢ç£¨çš„é—®é¢˜ï¼Œå¦‚æ–¹æ³•æ´¾å‘ã€å¼•ç”¨è®¡æ•°ç­‰å†…å®¹ã€‚ä»¥ä¸‹é™„swiftc çš„å‘½ä»¤è¡Œå¸®åŠ©ã€‚</p>
<pre><code class="shell">USAGE: swiftc

MODES:
  -dump-ast               Parse and type-check input file(s) and dump AST(s)
  -dump-parse             Parse input file(s) and dump AST(s)
  -dump-pcm               Dump debugging information about a precompiled Clang module
  -dump-scope-maps &lt;expanded-or-list-of-line:column&gt;
                          Parse and type-check input file(s) and dump the scope map(s)
  -dump-type-info         Output YAML dump of fixed-size types from all imported modules
  -dump-type-refinement-contexts
                          Type-check input file(s) and dump type refinement contexts(s)
  -emit-assembly          Emit assembly file(s) (-S)
  -emit-bc                Emit LLVM BC file(s)
  -emit-executable        Emit a linked executable
  -emit-imported-modules  Emit a list of the imported modules
  -emit-irgen             Emit LLVM IR file(s) before LLVM optimizations
  -emit-ir                Emit LLVM IR file(s) after LLVM optimizations
  -emit-library           Emit a linked library
  -emit-object            Emit object file(s) (-c)
  -emit-pcm               Emit a precompiled Clang module from a module map
  -emit-sibgen            Emit serialized AST + raw SIL file(s)
  -emit-sib               Emit serialized AST + canonical SIL file(s)
  -emit-silgen            Emit raw SIL file(s)
  -emit-sil               Emit canonical SIL file(s)
  -emit-supported-features
                          Emit a JSON file including all supported compiler features
  -index-file             Produce index data for a source file
  -parse                  Parse input file(s)
  -print-ast              Parse and type-check input file(s) and pretty print AST(s)
  -resolve-imports        Parse and resolve imports in input file(s)
  -scan-dependencies      Scan dependencies of the given Swift sources
  -typecheck              Parse and type-check input file(s)
</code></pre>
<p>ğŸ”—ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c2880460c6cd">Swiftçš„é«˜çº§ä¸­é—´è¯­è¨€ï¼šSIL</a></p>
<p><a target="_blank" rel="noopener" href="https://www.swift.org/swift-compiler/">Swift-Compiler å®˜æ–¹</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/353732257">Swift - æºç ç¼–è¯‘</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36287943/article/details/104974597">ç¼–è¯‘ä¼˜åŒ–ä¹‹ - å¸¸æ•°ä¼ æ’­å…¥é—¨</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/apple/swift/blob/2ddc92a51a4c6d216a9b2dc3a2e41e9b592afbdf/docs/SIL.rst">Apple - Swift Intermediate Language</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Hello_Hwc/article/details/85226147">æ·±å…¥æµ…å‡ºiOSç¼–è¯‘</a></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2022/03/07/iOS%20%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/" title="iOS å¯åŠ¨ä¼˜åŒ–"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: iOS å¯åŠ¨ä¼˜åŒ–</span></a><a class="button is-default" href="/2021/11/03/2021-11-03-iOS%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/" title="iOS ç¼–è¯‘è¿‡ç¨‹"><span class="has-text-weight-semibold">Next: iOS ç¼–è¯‘è¿‡ç¨‹</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="xuhaodong1/xuhaodong1.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/xuhaodong1"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- çŸ¥ä¹--><!-- é¢†è‹±--><!-- è„¸ä¹¦--></section><p> <span>PV:</span><span id="busuanzi_value_site_pv"></span><span>  UV: </span><span id="busuanzi_value_site_uv"></span></p><p><span>Copyright Â©</span><span> nihao 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>